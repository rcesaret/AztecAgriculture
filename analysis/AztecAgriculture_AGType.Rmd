---
title: "Aztec Agricultural Productivity Model"
subtitle: "Random Forest Model for Agriculture Type"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```


# Setup 

All of the data and scripts are downloadable from the [Aztec Agriculture github repository](https://https://github.com/rcesaret/AztecAgriculture), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/Huexotzinco/HuexTlaxAnal2022/HuexTlax2022Analysis/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", "dismo", 
              "purrr", "spatialEco", "whitebox", "classInt","ggnewscale", "lbmech", 
              "data.table", "tidyterra","gridExtra", "cowplot", "scam", "rmarkdown", 
              "spatialreg","spdep", "ggridges", "ggnewscale", "scales", "ggstatsplot",
              "stringi", "fuzzyjoin", "mgcv", "randomForest", "ranger", "kableExtra", 
              "Boruta", "mlbench", "caret", "readr")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R")#"splitByAttributes.R", 
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```




# Agriculture Type


## Prepare Data

### Predictor Variables
 


r.carve - Generates stream channels.
Takes vector stream data, transforms it to raster and subtracts depth from the output DEM.
r.watershed - Calculates hydrological parameters and RUSLE factors.
r.terraflow - Performs flow computation for massive grids.
r.stream.extract - Performs stream network extraction.
SAGA Valley Depth

--Distance from streams
r.grow.distance
wbt_average_upslope_flowpath_length

wbt_downslope_flowpath_length

```{r, label='Arable Area - Prepare Predictor Data', message=FALSE,warning=FALSE}

DEM <- rast(paste0(wd$data_p, "DEM_30m.tif"))

Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))



wbt_d_inf_pointer(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/FlowDirect_inf_30m.tif"))
FlowDirect_inf_30m <- rast(paste0(wd$data_p, "temp_rasts/FlowDirect_inf_30m.tif"))

wbt_d8_pointer(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/FlowDirect_d8_30m.tif"))
FlowDirect_d8_30m <- rast(paste0(wd$data_p, "temp_rasts/FlowDirect_d8_30m.tif"))

wbt_extract_streams(flow_accum = paste0(wd$data_p,"temp_rasts/Accum_fd8_30m.tif"), output = paste0(wd$data_p,"temp_rasts/Streams_30m.tif"), threshold =10000)
Streams <- rast(paste0(wd$data_p, "temp_rasts/Streams_30m.tif"))

#wbt_basins(d8_pntr = paste0(wd$data_p,"temp_rasts/FlowDirect_d8_30m.tif"), output = paste0(wd$data_p,"temp_rasts/Basins_30m.tif"))
#Basins_30m <- rast(paste0(wd$data_p, "temp_rasts/Basins_30m.tif"))



BasinsPoly <- st_read(paste0(wd$data_r, "BasinsPoly.gpkg"))
BasinsPoly <- rownames_to_column(BasinsPoly, var = "ID")
BasinsPoly$n_cells <- NA
for (i in 1:length(BasinsPoly$ID)){
  elev <- DEM
  bp <- BasinsPoly %>% filter(ID == i)
  bp <- vect(bp)
  elev <- mask(elev, bp)
  writeRaster(elev,paste0(wd$data_p,"elev.tif"), overwrite=TRUE)
  wbt_flood_order(dem = paste0(wd$data_p,"elev.tif"), output = paste0(wd$data_p,"BasinRasts/flood_order_basin",i,".tif"))
}
raster_files <- list.files(path = paste0(wd$data_p,"BasinRasts/"), pattern = ".tif$", full.names = TRUE)
raster_list <- list()
for (file in raster_files) {
  raster <- rast(file)
  raster_list[[file]] <- raster
}
rm(raster)
z = sprc(raster_list)
FloodOrder <- merge(z)

writeRaster(FloodOrder,paste0(wd$data_p,"FloodOrder_30m.tif"), overwrite=TRUE)
FloodOrder <- rast(paste0(wd$data_p, "FloodOrder_30m.tif"))
BP = extract(DEM, BasinsPoly, fun=ncell)
BasinsPoly$n_cells = BP$focal_mean
rm(BP)
bp <- terra::rasterize(BasinsPoly, DEM, field = "n_cells", background = NA)
writeRaster(bp,paste0(wd$data_p,"Basin_ncells_30m.tif"), overwrite=TRUE)
bp <- rast(paste0(wd$data_p, "Basin_ncells_30m.tif"))
FloodOrder_Rel = FloodOrder / bp
FloodOrder_Rel <- ifel(FloodOrder_Rel > 1, 1, FloodOrder_Rel)
writeRaster(FloodOrder_Rel,paste0(wd$data_p,"FloodOrder_Rel_30m.tif"), overwrite=TRUE)
FloodOrder_Rel <- rast(paste0(wd$data_p, "FloodOrder_Rel_30m.tif"))
#rm(out, bp, elev, clipped, bplist)

rm(BasinsPoly,i,bp, elev,BP,z,raster_list)


#BasinsPoly <- st_as_sf(BasinsPoly)
#clipped <- clamp(DEM, bp)
#  BasinsPoly[i,]$n_cells <- ncell(clipped)

#Streams
streams_sf <- st_read(paste0(wd$data_r, "CMex_Hydro_Streams_All.gpkg"))
streams_sf <- streams_sf %>% mutate(Order = case_when(
  ORDER_1 == -1 ~ 1,
  ORDER_1 == 1 ~ 1,
  ORDER_1 == 2 ~ 1,
  ORDER_1 == 3 ~ 1,
  ORDER_1 == 4 ~ 2,
  ORDER_1 == 5 ~ 2,
  ORDER_1 == 6 ~ 2,
  ORDER_1 == 7 ~ 3
))
Streams2 <- terra::rasterize(streams_sf, DEM, values = 1, background = NA)
writeRaster(Streams2,paste0(wd$data_p,"Streams2_30m.tif"), overwrite=TRUE)

#distance from streams
DistStreams <- distance(Streams)
writeRaster(DistStreams,paste0(wd$data_p,"DistStreams_30m.tif"), overwrite=TRUE)
DistStreams2 <- distance(Streams2)
writeRaster(DistStreams2,paste0(wd$data_p,"DistStreams2_30m.tif"), overwrite=TRUE)
#raster <- lines(DEM[], streams_sf, attrib=streams_sf$Order, width=streams_sf$Order, alongLines=TRUE)

wbt_elevation_above_stream(dem = paste0(wd$data_p,"DEM_30m.tif"), streams = paste0(wd$data_p,"temp_rasts/Streams_30m.tif"), output = paste0(wd$data_p,"temp_rasts/ElevAboveStreams_30m.tif"))
ElevAboveStreams <- rast(paste0(wd$data_p, "temp_rasts/ElevAboveStreams_30m.tif"))

wbt_elevation_above_stream(dem = paste0(wd$data_p,"DEM_30m.tif"), streams = paste0(wd$data_p,"Streams2_30m.tif"), output = paste0(wd$data_p,"ElevAboveStreams2_30m.tif"))
ElevAboveStreams2 <- rast(paste0(wd$data_p, "ElevAboveStreams2_30m.tif"))

wbt_extract_valleys(dem = paste0(wd$data_p,"DEM_30m.tif"), variant = 'JandR', line_thin = F, output =  paste0(wd$data_p,"temp_rasts/valleys_JandR_30m.tif"))
Valleys <- rast(paste0(wd$data_p, "temp_rasts/valleys_JandR_30m.tif"))

BasinsPoly <- st_read(paste0(wd$data_r, "BasinsPoly.gpkg"))
BasinsPoly <- rownames_to_column(BasinsPoly, var = "ID")
#BasinsPoly <- vect(BasinsPoly)
Basins <- terra::rasterize(BasinsPoly, DEM, field = "ID", background = NA)
writeRaster(Basins,paste0(wd$data_p,"Basins_30m.tif"), overwrite=TRUE)
Basins <- rast(paste0(wd$data_p, "Basins_30m.tif"))

wbt_elev_relative_to_watershed_min_max(dem = paste0(wd$data_p,"DEM_30m.tif"), watersheds = paste0(wd$data_p,"Basins_30m.tif"), output = paste0(wd$data_p,"temp_rasts/elev_watershed_30m.tif"))
elev_watershed <- rast(paste0(wd$data_p, "temp_rasts/elev_watershed_30m.tif"))

Topo_r_30m = subset(Topo_r_30m, c(names(Topo_r_30m)[1:7], names(Topo_r_30m)[9:11]))

Topo_r_30m = c(Topo_r_30m, DistStreams, DistStreams2, ElevAboveStreams, ElevAboveStreams2, Valleys, elev_watershed, FloodOrder_Rel, FloodOrder, FlowDirect_d8_30m, FlowDirect_inf_30m)#Streams, Streams2, 
names(Topo_r_30m) = c(names(Topo_r_30m), "DistStreams", "DistStreams2", "ElevAboveStreams", "ElevAboveStreams2", "Valleys", "elev_watershed", "FloodOrder_Rel", "FloodOrder", "FlowDirect_d8_30m", "FlowDirect_inf_30m")#, "Streams", "Streams2"
writeRaster(Topo_r_30m, paste0(wd$data_p,"Topo_r_30m_2.tif"))
Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m_2.tif"))

Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))

Geomorphons <- rast(paste0(wd$data_p, "CMex_30m_Geomorphons.tif"))


rm(Streams, Streams2, DistStreams, DistStreams2, ElevAboveStreams, ElevAboveStreams2, Valleys, elev_watershed, FloodOrder_Rel, FloodOrder, FlowDirect_d8_30m, FlowDirect_inf_30m, Basins, streams_sf)



```



### Dependent Variables

```{r, label='Arable Area - Prepare Dependent Variable Data', message=FALSE,warning=FALSE}

ArableAreaMask <- rast(paste0(wd$data_p,"ArableArea.tif"))
ArableAreaMask <- as.numeric(ArableAreaMask)
ArableAreaMask <- ifel(ArableAreaMask > 1, 1, NA) 
writeRaster(ArableAreaMask, filename = paste0(wd$data_p, "ArableAreaMask.tif"), overwrite=TRUE)

#CMex_Mask <- rast(paste0(wd$data_p,"CMex_Mask.tif"))

#ArableArea Cultivate d== 1, Uncultivated to NA
#CMex_Mask 1, else NA
#Mask = ArableArea * CMex_Mask



z <- st_read(paste0(wd$data_r, "Data2000s_poly_mod_Elevation.gpkg"))
z <- st_buffer(z, dist=-60)
#streams <- st_read(paste0(wd$data_r, "CMex_Streams.gpkg"))
#streams <- st_buffer(streams, dist=15)
#SIAP_LU_Fields <- st_difference(SIAP_LU_Fields, streams) 

SIAP_LU_Fields_AGType <- z %>% select(AGType) %>% 
  mutate(AGType = ifelse(AGType == "Riego", 2, 1))
SIAP_LU_Fields_AGType <- SIAP_LU_Fields_AGType %>% filter(!st_is_empty(.))
irrig <- SIAP_LU_Fields_AGType %>% filter(AGType == 2)
irrig = vect(irrig)
irrig <- terra::rasterize(irrig, DEM, values = 2, background = 0)
irrig <- ifel(irrig > 0, 2, 0)
temp <- SIAP_LU_Fields_AGType %>% filter(AGType == 1)
temp = vect(temp)
temp <- terra::rasterize(temp, DEM, values = 1, background = 0)
SIAP_LU_Fields_AGType <- irrig + temp
SIAP_LU_Fields_AGType <- ifel(SIAP_LU_Fields_AGType == 0, NA, SIAP_LU_Fields_AGType)
SIAP_LU_Fields_AGType <- as.factor(SIAP_LU_Fields_AGType)
levels(SIAP_LU_Fields_AGType) = levels(SIAP_LU_Fields_AGType)[[1]] %>% select(-layer) %>%
  mutate(SIAP_LU_Fields_AGType = case_when(
    ID == 1 ~ "Temporal",
    ID == 2 ~ "Irrigation"))
writeRaster(SIAP_LU_Fields_AGType, filename = paste0(wd$data_p, "SIAP_LU_Fields_AGType.tif"), overwrite=TRUE)
rm(SIAP_LU_Fields_AGType, streams, irrig, temp)
#SIAP_LU_Fields_AGType <- rast(paste0(wd$data_p,"SIAP_LU_Fields_AGType.tif"))
#SIAP_LU_Fields_AGType <- mask(SIAP_LU_Fields_AGType, CMex_Mask)

SIAP_LU_Fields_AGType <- rast(paste0(wd$data_p,"SIAP_LU_Fields_AGType.tif"))
#SIAP_LU_Fields_AGType <- mask(SIAP_LU_Fields_AGType, CMex_Mask)


```

"SIAP_LU_Fields_AGType"                                              
 [7]             
[13] "Streams_30m"           "layer"                 "Streams_30m"           "layer"                 "ElevAboveStreams_30m"  "ElevAboveStreams2_30m"
[19] "valleys_JandR_30m"     "elev_watershed_30m"    "flood_order_basin1"    "flood_order_basin1"    "FlowDirect_d8_30m"     "FlowDirect_inf_30m"   
[25]                    
[31]                       
### Combine Data

```{r, label='Combine Data', message=FALSE,warning=FALSE}
AGType <- SIAP_LU_Fields_AGType
x = c(AGType, Geomorphons, Topo_r_30m, Soil_30m)
names(x) = c("AGType", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "DistStreams", "DistStreams2", "ElevAboveStreams", "ElevAboveStreams2", "Valleys", "elev_watershed", "FloodOrder_Rel", "FloodOrder", "FlowDirect_d8_30m", "FlowDirect_inf_30m", "BDRICM", "BDRLOG", "BDTICM", "BD", "S", "Z", "C", "SOC", "CEC", "OCD", "N", "SOCS", "WRB")#"Streams", "Streams2", 
x = mask(x, ArableAreaMask)
#x = mask(x, SIAP_LU_Fields_AGType)
writeRaster(x, filename = paste0(wd$data_p, "AGType_Raster_Data.tif"), overwrite=TRUE)
x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))


#writeRaster(xa, filename = paste0(wd$data_p, "AGType_Raster_Data_FullArable.tif"), overwrite=TRUE)
#rm(Topo_r_30m, Soil_30m, SIAP_LU_Fields_AGType, CMex_Mask, x, Geomorphons)

```


### Convert Data from Raster Stack to Dataframe 

```{r, label='Convert Data from Raster Stack to Dataframe ', message=FALSE,warning=FALSE}

x_df <- as.data.frame(x[[1]])
names(x_df) <- "AGType"
x_df <- rownames_to_column(x_df, var = "Cells")

for (i in 2:nlyr(x)) {
  
  t = as.data.frame(x[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(x[[i]]))
  x_df <- x_df %>% left_join(t, by="Cells")

}
#x_df = x_df %>% select(-Streams, -Streams2)
#d = x_df[complete.cases(x_df), ]
#d <- x_df[complete.cases(x_df[, -which(names(x_df) == "AGType")]), ]

AGType_RF_df <- x_df %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")),
         #LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

rm(x_df)

AGType_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data4",
    TRUE ~ "AGType_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("AGType_RFModel_Data1", "AGType_RFModel_Data2", "AGType_RFModel_Data3", "AGType_RFModel_Data4", "AGType_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

```

#### Shortcut Import #1


```{r, label='Shortcut Import #1', message=FALSE,warning=FALSE}

x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))
names(x) = c("AGType", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "Streams", "Streams2", "DistStreams", "DistStreams2", "ElevAboveStreams", "ElevAboveStreams2", "Valleys", "elev_watershed", "FloodOrder_Rel", "FloodOrder", "FlowDirect_d8_30m", "FlowDirect_inf_30m", "BDRICM", "BDRLOG", "BDTICM", "BD", "S", "Z", "C", "SOC", "CEC", "OCD", "N", "SOCS", "WRB")

AGType <- x[[1]]
#CONABIO_2015_LandUse_30m <- x[[2]]
Geomorphons <- x[[3]]

l = 1:5
file_paths <- paste0(wd$data_p, "AGType_RFModel_Data", l, ".csv.gz")
AGType_RF_df <- file_paths %>%
  map_dfr(~ read_csv(.x))

AGType_RF_df <- AGType_RF_df %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")),
         #LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

```



### Exploratory Data Analysis

#### Descriptive Statistics

```{r, label='EDA Descriptive Statistics', message=FALSE,warning=FALSE}
AGType2 <- as.numeric(AGType)

#fLU = freq(CONABIO_2015_LandUse_30m, usenames=T, zones=AGType2, wide=T)
#fLU = fLU %>% mutate(zone = case_when(
#    zone == 1 ~ "Temporal",
#    zone == 2 ~ "Irrigation")) %>% rowwise() %>% 
#  mutate(Total = sum(c_across(Flat:Depression))) %>% ungroup()
#column_sums <- as.numeric(colSums(fLU[, -c(1:2)]))
#y = as.matrix(fLU[, -c(1, 2)])
#d = fLU[, c(1:2)]
#fLU_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
#row_sums <- as.numeric(rowSums(fLU[, -c(1:2)]))
#fLU_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fWRB = freq(x[["WRB"]], usenames=T, zones=AGType2, wide=T)
fWRB = fWRB %>% mutate(zone = case_when(
    zone == 1 ~ "Temporal",
    zone == 2 ~ "Irrigation")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(NoData:Vertisols))) %>% ungroup()
column_sums <- as.numeric(colSums(fWRB[, -c(1:2)]))
y = as.matrix(fWRB[, -c(1, 2)])
d = fWRB[, c(1:2)]
fWRB_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fWRB[, -c(1:2)]))
fWRB_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fgeo = freq(Geomorphons, usenames=T, zones=AGType2, wide=T)
fgeo = fgeo %>% mutate(zone = case_when(
    zone == 1 ~ "Temporal",
    zone == 2 ~ "Irrigation")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Flat:Depression))) %>% ungroup()
column_sums <- as.numeric(colSums(fgeo[, -c(1:2)]))
y = as.matrix(fgeo[, -c(1, 2)])
d = fgeo[, c(1:2)]
fgeo_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fgeo[, -c(1:2)]))
fgeo_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

rm(column_sums, row_sums, y, d )

z1 = zonal(c(Topo_r_30m, Soil_30m), AGType, fun="mean", na.rm=T)
z1$stat = "Mean"
z2 = zonal(c(Topo_r_30m, Soil_30m), AGType, fun="min", na.rm=T)
z2$stat = "Min"
z3 = zonal(c(Topo_r_30m, Soil_30m), AGType, fun="max", na.rm=T)
z3$stat = "Max"
z = rbind(z1, z2, z3) %>% mutate(zone = case_when(
    layer == 0 ~ "Temporal",
    layer == 1 ~ "Irrigation"))

rm(z1, z2, z3)
```


#### Histograms

```{r, label='EDA Histograms', message=FALSE,warning=FALSE}

#Hist_DEM <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = DEM, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Elevation (masl)", y = "Count") + theme_classic()

#Hist_Slope <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Slope, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Slope (degrees)", y = "Count") + theme_classic()

#Hist_TRI <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = TRI, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Topographic Roughness Index (TRI)", y = "Count") + theme_classic()

#Hist_TWI <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = TWI, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Topographic Wetness Index (TWI)", y = "Count") + theme_classic()

#Hist_STI <- 
AGType_RF_df %>% filter(STI <= 100) %>% ggplot() +
geom_histogram(aes(x = STI, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Sediment Transport Index (STI)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

#Hist_SPI <- 
AGType_RF_df %>% filter(SPI <= 1200) %>% ggplot() +
geom_histogram(aes(x = SPI, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Stream Power Index (SPI)", y = "Count") + theme_classic()

#Hist_BDRICM <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRICM, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Depth to bedrock up to 200cm (BDRICM)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRLOG, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Probability of R horizon (BDRLOG)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = BDTICM, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Absolute depth to bedrock in cm (BDTICM)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_min, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Minimum Curvature", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_max, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Maximum Curvature", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_mean, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Mean Curvature", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = SOC, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Soil Organic Carbon", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = OCD, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Organic Carbon Density", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = N, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Nitrogen", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = SOCS, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Soil Organic Carbon Stock", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = S, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Sand Fraction (Fine Earth)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Z, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Silt Fraction (Fine Earth)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = C, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Clay Fraction (Fine Earth)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Streams, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Streams (Accum)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Streams2, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Streams (INEGI)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = DistStreams, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Distance to Streams (Accum)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = DistStreams2, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Distance to Streams (INEGI)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = ElevAboveStreams, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Elevation Above Streams (Accum)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = ElevAboveStreams2, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Elevation Above Streams (INEGI)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Valleys, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Valleys (JandR)", y = "Count") + theme_classic()
#################################
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = elev_watershed, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Relative Elevation within Watersheds", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = FloodOrder, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Flood Order within Watersheds", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = FloodOrder_Rel, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Relative (%) Flood Order within Watersheds", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = FlowDirect_d8_30m, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="d8 Flow Direction (SFD)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = FlowDirect_inf_30m, color = AGType, fill = AGType), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Inf Flow Direction (MFD)", y = "Count") + theme_classic()
```










### Subset Predictors

```{r, label='Sampling the Dataframe', message=FALSE,warning=FALSE}
#TopoEnv_r_sub <- subset(x, c("DEM", "Slope","Accum", "TRI", "TWI", "STI", "SPI"))

x <- subset(x, c("AGType", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "DistStreams", "DistStreams2", "ElevAboveStreams", "ElevAboveStreams2", "elev_watershed", "FloodOrder_Rel", "BDRICM", "BDRLOG", "BDTICM", "SOC", "N", "SOCS", "WRB"))
writeRaster(x, filename = paste0(wd$data_p, "AGType_Raster_Data.tif"), overwrite=TRUE)

AGType_RF_df = AGType_RF_df %>% select(-CEC, -OCD, -BD, -S, -Z, -FlowDirect_inf_30m, -FlowDirect_d8_30m, -FloodOrder, -Valleys)

AGType_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data4",
    TRUE ~ "AGType_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("AGType_RFModel_Data1", "AGType_RFModel_Data2", "AGType_RFModel_Data3", "AGType_RFModel_Data4", "AGType_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

```


#### Shortcut Import #2


```{r, label='Shortcut Import #2', message=FALSE,warning=FALSE}
x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))
names(x) = c("AGType", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "DistStreams", "DistStreams2", "ElevAboveStreams", "ElevAboveStreams2", "elev_watershed", "FloodOrder_Rel", "BDRICM", "BDRLOG", "BDTICM", "SOC", "N", "SOCS", "WRB")

AGType <- x[[1]]


l = 1:5
file_paths <- paste0(wd$data_p, "AGType_RFModel_Data", l, ".csv.gz")
AGType_RF_df <- file_paths %>%
  map_dfr(~ read_csv(.x))

AGType_RF_df <- AGType_RF_df %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")),
         #LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

```


### Sampling the Dataframe

```{r, label='Sampling the Dataframe', message=FALSE,warning=FALSE}

AGType_RF_df <- AGType_RF_df %>% 
  mutate(Temporal_wt = 0,
         Temporal_wt = ifelse(AGType == "Temporal" & DEM > 2700, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & Slope > 5, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & Accum_fd8 > xxx, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & STI > 15, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & TRI > 2, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & SPI > XXX, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & TWI > XXX, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & flood_order > XXX, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & FloodOrder_Rel > 0.75, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & elev_watershed > 30, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & ElevAboveStreams2 > 100, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & ElevAboveStreams > 100, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & curv_min > 0.001, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & curv_min < -0.001, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & curv_max > 0.0005, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & curv_max < -0.0015, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & curv_mean > 0.0005, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & curv_mean < -0.0005, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & BDRLOG > 70, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & BDRICM < 62.87024, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & BDTICM <= 3.36, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & SOC > 250, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & BD < 108, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & OCD > 350, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & N > 300, (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & SOCS > 80, (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & Geomorphons == "Slope", (Temporal_wt+1), Temporal_wt),
         Temporal_wt = ifelse(AGType == "Temporal" & Geomorphons == "Spur", (Temporal_wt+1), Temporal_wt),
         #Temporal_wt = ifelse(AGType == "Temporal" & Geomorphons == "Valley", (Temporal_wt+1), Temporal_wt),
         Temporal = ifelse(Temporal_wt > 0, TRUE, FALSE),
         Irrigation = ifelse(AGType == "Irrigation", TRUE, FALSE),
         Irrigation_wt = ifelse(AGType == "Irrigation", 1, 0),
         wt = Temporal_wt + Irrigation_wt,
         Stratum = case_when(
                Irrigation == TRUE ~ "IrrigationSample",
                Temporal == TRUE ~ "TemporalSample",
                .default = "Unsampled"),
         SampSize = case_when(
                Stratum == "IrrigationSample" ~ 300000,
                Stratum == "TemporalSample" ~ 300000,
                .default = 0))
zzz <- AGType_RF_df[complete.cases(AGType_RF_df[, -which(names(AGType_RF_df) == "AGType")]), ]
zzz = zzz[complete.cases(zzz), ]

dt = setDT(zzz)

ir <- dt[Stratum == "IrrigationSample"][sample(.N, 300000, replace = FALSE)]

te <- dt[Stratum == "TemporalSample"][sample(.N, 300000, replace = FALSE, prob = wt)]

dt <- rbindlist(list(ir, te))

rm(ir, te)

AGType_RF_Train_df <- as.data.frame(dt)

rm(dt)

write_csv(AGType_RF_Train_df, paste0(wd$data_p,"AGType_RFModel_TrainData.csv.gz"))
rm(AGType_RF_Train_df)
AGType_RF_Train_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_TrainData.csv.gz"))

tt = AGType_RF_Train_df %>% select(Cells) %>% mutate(TraningSample = TRUE, Cells = as.character(Cells))

tt = AGType_RF_Train_df %>% select(Cells) %>% mutate(Cells = as.character(Cells))


AGType_RF_df = AGType_RF_df %>% left_join(tt, by = "Cells")
AGType_RF_df = AGType_RF_df %>% mutate(TraningSample = ifelse(is.na(TraningSample), F, TraningSample))

rm(tt)

#Arable_RF_df <- zzz

#rm(zzz)

AGType_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data4",
    TRUE ~ "AGType_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("AGType_RFModel_Data1", "AGType_RFModel_Data2", "AGType_RFModel_Data3", "AGType_RFModel_Data4", "AGType_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

rm(z, fgeo, fgeo_col_pc, fgeo_row_pc, fWRB_row_pc, fWRB_col_pc, fWRB, Geomorphons, z1, z2, z3, t, Soil_30m, Topo_r_30m, AGType2)

```



#### Shortcut Import #3


```{r}

x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))
AGType <- x[[1]]
x <- subset(x, c("SIAP_LU_Fields_AGType", "LandUseArchy", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "BDRICM", "BDRLOG", "BDTICM", "BD", "SOC", "OCD", "N", "SOCS", "WRB" ))


l = 1:5
file_paths <- paste0(wd$data_p, "AGType_RFModel_Data", l, ".csv.gz")
AGType_RF_df <- file_paths %>%
  map_dfr(~ read_csv(.x))

AGType_RF_df <- AGType_RF_df %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")),
         #LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

zzz = AGType_RF_df[complete.cases(AGType_RF_df), ]



AGType_RF_Train_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_TrainData.csv.gz"))

AGType_RF_Train_df <- AGType_RF_Train_df %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")),
         #LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))
#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)
```

## Random Forest Model

### Variable Selection

```{r, label='RF Model Variable Selection', message=FALSE,warning=FALSE}
#boruta = readRDS(paste0(wd$data_p,"AGType_RFModel_boruta.rda"))

boruta <- Boruta(AGType ~ ., data = AGType_RF_Train_df[,c(2:27)], maxRuns = 100)#, doTrace = 2
print(boruta)
boruta[["finalDecision"]]
plot(boruta, las = 2, cex.axis = 0.7)
#bor <- TentativeRoughFix(boruta)
#bor[["finalDecision"]]
attStats(boruta)
form=getConfirmedFormula(boruta)

# saving the model
saveRDS(boruta, file = paste0(wd$data_p,"AGType_RFModel_boruta.rda"))
#rm(boruta)
#loading the model
#boruta = readRDS(paste0(wd$data_p,"AGType_RFModel_boruta.rda"))
```


### Train the Model

```{r, label='RF Model Training', message=FALSE,warning=FALSE}

#AGType_RF_model = readRDS(paste0(wd$data_p,"AGType_RFModel_Ranger.rda"))
#AGType_RF_model_prob = readRDS(paste0(wd$data_p,"AGType_RFModel_Ranger_Prob.rda"))

AGType_RF_model <- ranger(formula = form, data = AGType_RF_Train_df)

print(AGType_RF_model)

# saving the model
saveRDS(AGType_RF_model, file = paste0(wd$data_p,"AGType_RFModel_Ranger.rda"))

### probability forest classification as in Malley et al. (2012)
###https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3250568/
### Malley JD, Kruppa J, Dasgupta A, Malley KG, Ziegler A. Probability machines: consistent probability estimation using nonparametric learning machines. Methods Inf Med. 2012;51(1):74-81. doi: 10.3414/ME00-01-0052. Epub 2011 Sep 14. PMID: 21915433; PMCID: PMC3250568.

AGType_RF_model_prob <- ranger(formula = form, data = AGType_RF_Train_df, probability = T)

print(AGType_RF_model_prob)

# saving the model
saveRDS(AGType_RF_model_prob, file = paste0(wd$data_p,"AGType_RFModel_Ranger_Prob.rda"))


#loading the model
#AGType_RF_model = readRDS(paste0(wd$data_p,"AGType_RFModel_Ranger.rda"))
#AGType_RF_model_prob = readRDS(paste0(wd$data_p,"AGType_RFModel_Ranger_Prob.rda"))

```


### Model Predictions

#### Binary Classification

```{r, label='RF Model Predictions: Binary Classification', message=FALSE,warning=FALSE}
parts = c("AGType_RFModel_Data1", "AGType_RFModel_Data2", "AGType_RFModel_Data3", "AGType_RFModel_Data4", "AGType_RFModel_Data5")

pred_list = list()

i=1
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=2
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=3
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=4
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=5
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)


pred_df <- do.call(rbind, pred_list)

rm(pred_list)

AGType_RF_df = AGType_RF_df %>% left_join(pred_df, by = "Cells")
zzz = zzz %>% left_join(pred_df, by = "Cells")

rm(pred_df)

```



#### Classification Probabilities

```{r, label='RF Model Predictions: Classification Probabilities', message=FALSE,warning=FALSE}
parts = c("AGType_RFModel_Data1", "AGType_RFModel_Data2", "AGType_RFModel_Data3", "AGType_RFModel_Data4", "AGType_RFModel_Data5")

pred_list = list()

i=1
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model_prob, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Prob_Temporal <- as.data.frame(RFModel_predict[["predictions"]])$Temporal
pred_df$Prob_Irrigation <- as.data.frame(RFModel_predict[["predictions"]])$Irrigation
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=2
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model_prob, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Prob_Temporal <- as.data.frame(RFModel_predict[["predictions"]])$Temporal
pred_df$Prob_Irrigation <- as.data.frame(RFModel_predict[["predictions"]])$Irrigation
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=3
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model_prob, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Prob_Temporal <- as.data.frame(RFModel_predict[["predictions"]])$Temporal
pred_df$Prob_Irrigation <- as.data.frame(RFModel_predict[["predictions"]])$Irrigation
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=4
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model_prob, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Prob_Temporal <- as.data.frame(RFModel_predict[["predictions"]])$Temporal
pred_df$Prob_Irrigation <- as.data.frame(RFModel_predict[["predictions"]])$Irrigation
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=5
pred_df = zzz %>% filter(part == parts[i])
RFModel_predict <- predict(AGType_RF_model_prob, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Prob_Temporal <- as.data.frame(RFModel_predict[["predictions"]])$Temporal
pred_df$Prob_Irrigation <- as.data.frame(RFModel_predict[["predictions"]])$Irrigation
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)


pred_df <- do.call(rbind, pred_list)

rm(pred_list)

AGType_RF_df = AGType_RF_df %>% left_join(pred_df, by = "Cells")
zzz = zzz %>% left_join(pred_df, by = "Cells")

rm(pred_df)

```



## Export Outputs


```{r, label='Merge and Export Outputs', message=FALSE,warning=FALSE}

AGType_RF_df$Cells <- as.numeric(AGType_RF_df$Cells)





#AGType <- x[[1]]
values(AGType) <- NA
AGType[AGType_RF_df$Cells] <- AGType_RF_df$Predictions
AGType = as.factor(AGType)
levels(AGType) = levels(AGType)[[1]] %>% 
  mutate(AGType = case_when(
    ID == 1 ~ "Temporal",
    ID == 2 ~ "Irrigated"))
names(AGType) <- "AGType"

AGType_Prob_Temp <- as.numeric(AGType)
names(AGType_Prob_Temp) <- "AGType_Prob_Temp"
AGType_Prob_Irrig <- as.numeric(AGType)
names(AGType_Prob_Irrig) <- "AGType_Prob_Irrig"

values(AGType_Prob_Temp) <- NA
AGType_Prob_Temp[AGType_RF_df$Cells] <- AGType_RF_df$Prob_Temporal
values(AGType_Prob_Irrig) <- NA
AGType_Prob_Irrig[AGType_RF_df$Cells] <- AGType_RF_df$Prob_Irrigation

writeRaster(AGType, filename = paste0(wd$data_p, "AGType_Predict.tif"), overwrite=TRUE)
rm(AGType)
AGType <- rast(paste0(wd$data_p,"AGType_Predict.tif"))

writeRaster(AGType_Prob_Temp, filename = paste0(wd$data_p, "AGType_Prob_Temp.tif"), overwrite=TRUE)
rm(AGType_Prob_Temp)
AGType_Prob_Temp <- rast(paste0(wd$data_p,"AGType_Prob_Temp.tif"))

writeRaster(AGType_Prob_Irrig, filename = paste0(wd$data_p, "AGType_Prob_Irrig.tif"), overwrite=TRUE)
rm(AGType_Prob_Irrig)
AGType_Prob_Irrig <- rast(paste0(wd$data_p,"AGType_Prob_Irrig.tif"))


AGType_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "AGType_RFModel_Data4",
    TRUE ~ "AGType_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("AGType_RFModel_Data1", "AGType_RFModel_Data2", "AGType_RFModel_Data3", "AGType_RFModel_Data4", "AGType_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

rm(AGType_RF_Train_df, AGType_RF_df, AGType_RF_model, x, form, i, l, parts, zzz, SIAP_LU_Fields_AGType, AGType_RF_model_prob, boruta, DEM, ArableAreaMask)


DEM_r <- rast(paste0(wd$data_r,"DEM_r.tif"))
AGType_Predict_100m <- resample(AGType, DEM_r, method = "near")
writeRaster(AGType_Predict_100m, filename = paste0(wd$data_p, "AGType_Predict_100m.tif"), overwrite=TRUE)
AGType_Prob_Temp_100m <- resample(AGType_Prob_Temp, DEM_r, method = "bilinear")
writeRaster(AGType_Prob_Temp_100m, filename = paste0(wd$data_p, "AGType_Prob_Temp_100m.tif"), overwrite=TRUE)
AGType_Prob_Irrig_100m <- resample(AGType_Prob_Irrig, DEM_r, method = "bilinear")
writeRaster(AGType_Prob_Irrig_100m, filename = paste0(wd$data_p, "AGType_Prob_Irrig_100m.tif"), overwrite=TRUE)

#rm(DEM_r,AGType_Predict_100m,AGType_Prob_Temp_100m,AGType_Prob_Irrig_100m)


#rm(Arable_RF_Train_df, Arable_RF_df, RF_pred, Arable_RF_Predict_df, RF_model, boruta, Cultiv)


```























