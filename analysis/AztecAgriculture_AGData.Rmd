---
title: "Aztec Agricultural Productivity Model"
subtitle: "Part 2: Agriculture Data"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```

This R markdown document prepares the data used in the Aztec agricultural productivity random forest model, which is undertaken in Part 2 (the subsequent R markdown script). This involves the following:

  1. Load, reorganize and integrate the modern agricultural analogue dataset, which includes:
      + Contemporary municipio polygons from INEGI
      + 2010 municipal population census statistics
      + 2007 municipal agricultural census statistics
      + FASII and INEGI geospatial land use polygons from the 2000s and 2010s
      + SIAP 2003-2021 crop yield data
      + 
 
CRS = WGS84 UTM Zone 14N (EPSG: 32614)


# Setup 

All of the data and scripts are downloadable from the [Aztec Agriculture github repository](https://https://github.com/rcesaret/AztecAgriculture), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/Huexotzinco/HuexTlaxAnal2022/HuexTlax2022Analysis/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "tidyr", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", "dismo", 
              "purrr", "spatialEco", "whitebox", "classInt","ggnewscale", "lbmech", 
              "data.table", "tidyterra","gridExtra", "cowplot", "scam", "rmarkdown", 
              "spatialreg","spdep", "ggridges", "ggnewscale", "scales", "ggstatsplot",
              "stringi", "fuzzyjoin", "mgcv", "randomForest", "ranger", "kableExtra", 
              "goft", "MASS", "NSM3", "ggsn", "rlang", "FSA", "philentropy", "sfdep",
              "spdep", "spatialreg", "DataExplorer", "tableone")


# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R", "linear_rescale.R", "CMex_AG_Map.R")#"splitByAttributes.R", 
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```



# 2000s Agricultural Data




## Municipios

```{r, 'Load Municipios Polygons', message=FALSE, warning=FALSE}
# Read-in municipio polygons for the focal region
Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))

# Remove Spanish accent marks from the municipality names
Municipios2000s$NOM_MUN <- stri_trans_general(str=Municipios2000s$NOM_MUN,id="Latin-ASCII")


Municipios2000s <- Municipios2000s %>% 
  # create variable for the written name of the state based on the state code in the polygon data
  mutate(State = case_when(
    CVE_ENT == "15" ~ "Mexico",
    CVE_ENT == "09" ~ "Distrito Federal",
    CVE_ENT == "13" ~ "Hidalgo",
    CVE_ENT == "17" ~ "Morelos",
    CVE_ENT == "21" ~ "Puebla",
    CVE_ENT == "29" ~ "Tlaxcala")) %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, NOM_MUN, State, sep = ", ", remove = F) %>%  
  # remove a number of municipalities that are not included in the focal region
  # (these polygons are tiny residual edges not removed by GIS pre-processing)
  filter(!(EstadoMunicipio %in% c("Almoloya de Alquisiras, Mexico", "Amanalco, Mexico", "Texcaltitlan, Mexico","Polotitlan, Mexico", "Temascalcingo, Mexico","Villa de Allende, Mexico", "Acambay de Ruiz Castaneda, Mexico", "Aculco, Mexico"))) %>% 
  # rename variables
  rename(Estado = State, Estado_ID = CVE_ENT, Municipio_ID = CVE_MUN, Municipio = NOM_MUN) %>% 
  # remove prior ID column
  select(-OID_1)

# calculate variable for the area of each municipality in square meters
Municipios2000s$Area_m2 <- st_area(Municipios2000s)
# calculate variable for the area of each municipality in hectares
Municipios2000s$Area_ha <- as.numeric(Municipios2000s$Area_m2)/10000

Municipios2000s <- Municipios2000s %>% mutate(
         Municipio = str_replace_all(Municipio, c(" De " = " de ",
                                                  " Del " = " del ",
                                                  " La " = " la ",
                                                  " Las " = " las ",
                                                  " Los " = " los ",
                                                  " El " = " el ",
                                                  "Ziltlaltepec" = "Zitlaltepec",
                                                  "Atltzayanca" = "Altzayanca")),
         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
                                                              " Del " = " del ",
                                                              " La " = " la ",
                                                              " Las " = " las ",
                                                              " Los " = " los ",
                                                              " El " = " el ",
                                                              "Ziltlaltepec" = "Zitlaltepec",
                                                              "Atltzayanca" = "Altzayanca")))

# create copy of municipality dataframe without the polygons
Municipios2000s_Cases = st_drop_geometry(Municipios2000s)
# save municipality polygon data
st_write(Municipios2000s, paste0(wd$data_p, "Municipios2000s_Data.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)

```




## 2000s Census Data


#### 2010 Population Census

```{r, 'Load/Organize 2010 Population Census', message=FALSE, warning=FALSE}

# read .csv file of 2010 population census data
PopCensus2010 <- read.csv(paste0(wd$data_r,"AG_Model_2000s/PopCensus2010.csv"))

PopCensus2010 <- PopCensus2010 %>% 
  # remove a number of unwanted variables
  select(-MUN, -ORD, -MUN_NUM, -INCLUDE) %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>% 
  mutate(Municipio = str_replace_all(Municipio, c(" De " = " de ",
                                                  " Del " = " del ",
                                                  " La " = " la ",
                                                  " Las " = " las ",
                                                  " Los " = " los ",
                                                  " El " = " el ",
                                                  "Ziltlaltepec" = "Zitlaltepec",
                                                  "Atltzayanca" = "Altzayanca")),
         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
                                                              " Del " = " del ",
                                                              " La " = " la ",
                                                              " Las " = " las ",
                                                              " Los " = " los ",
                                                              " El " = " el ",
                                                              "Ziltlaltepec" = "Zitlaltepec",
                                                              "Atltzayanca" = "Altzayanca")))

# left join the 2010 population census data with the municipality dataframe
PopCensus2010 <- Municipios2000s_Cases %>% left_join(PopCensus2010, by=c('EstadoMunicipio', 'Municipio', 'Estado'))
# export csv of the 2010 population census data
write.csv(PopCensus2010, paste0(wd$data_r,"AG_Model_2000s/testcensus.csv"))

```




#### 2007 Agricultural Census

```{r, 'Load/Organize 2007 Agricultural Census', message=FALSE, warning=FALSE}

# read .csv files of 2007 agricultural census data
AGCensus2007 <- read.csv(paste0(wd$data_r,"AG_Model_2000s/AGCensus2007.csv"))
AGCensus2007_Irrig <- read.csv(paste0(wd$data_r,"AG_Model_2000s/AGCensus2007_Irrig.csv"))

AGCensus2007 <- AGCensus2007 %>% left_join(AGCensus2007_Irrig, by="ORD") %>%
  # remove a number of unwanted variables
  select(-Region, -ORD, -Num, -INCLUDE, -Name, -State) %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>% 
  mutate(Municipio = str_replace_all(Municipio, c(" De " = " de ",
                                                  " Del " = " del ",
                                                  " La " = " la ",
                                                  " Las " = " las ",
                                                  " Los " = " los ",
                                                  " El " = " el ",
                                                  "Ziltlaltepec" = "Zitlaltepec",
                                                  "Atltzayanca" = "Altzayanca")),
         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
                                                              " Del " = " del ",
                                                              " La " = " la ",
                                                              " Las " = " las ",
                                                              " Los " = " los ",
                                                              " El " = " el ",
                                                              "Ziltlaltepec" = "Zitlaltepec",
                                                              "Atltzayanca" = "Altzayanca")))
rm(AGCensus2007_Irrig)
```




### Integrate 2000s Census Data

```{r, 'Integrate 2000s Cenusus Data', message=FALSE, warning=FALSE}

# create a combined 2000s census dataframe from the 2010 population census dataframe
# and the 2007 agricultural census dataframe
Census2000s <- PopCensus2010 %>% 
  # select desired 2010 population census variables to join with 2007 agricultural census data
  select(Estado_ID, Municipio_ID, EstadoMunicipio, Municipio, Estado, Area_ha, 
         Pop_Total, Pop_Rural, Pop_Urban, UrbRatio, Pop_Pct_Rural, Pop_Employed, 
         Primary, Pct_Primary, AG_Workers, Pct_AG_Workers) %>% 
  # left join the 2010 population census data with the 2007 agricultural census dataframe
  left_join(AGCensus2007, by=c('EstadoMunicipio', 'Municipio', 'Estado'))


```


#### Calculate Derived Census Variables

```{r, 'Calculate Derived 2000s Census Variables', message=FALSE, warning=FALSE}

# Calculate a number of derived variables from the combined 2000s census dataframe
Census2000s <- Census2000s %>% mutate(
  PopDens = Pop_Total / Area_ha, # population density
  PopDensRural = Pop_Rural / Area_ha, # population density of the rural population
  PrimaryEmployDens = Primary / Area_ha, # population density of primary sector employment (2010 pop census variable)
  TotalLaborDens = TotalLabor / Area_ha, # population density of total agricultural labor (2007 agricultural census variable)
  AGPasture_ha = AG_ha + Pasture_ha, # Total land used for agriculture and animal husbandry
  PrimaryEmploy_perHa = Primary / AGPasture_ha, # Density of primary sector employment (2010 pop census variable) per hectare of agriculture+pasture land
  AG_Workers_perHa = AG_Workers / AGPasture_ha, # Density of agricultural workers (2010 pop census variable, only includes laborers) per hectare of agriculture+pasture land
  TotalLabor_perHa = TotalLabor / AGPasture_ha, # Density of total agricultural labor (2007 agricultural census variable) per hectare of agriculture+pasture land
  MechanizEquip_perHa = MechanizEquip / AGPasture_ha, # Density of mechanized agricultural equipment per hectare of agriculture+pasture land
  DraftAnimals_perHa = DraftAnimals_Total / AGPasture_ha, # Density of draught animals per hectare of agriculture+pasture land
  Pct_AG_ha = AG_ha / AGPasture_ha, # Percentage of total agriculture+pasture land that is agricultural
  Pct_Pasture_ha = Pasture_ha / AGPasture_ha, # Percentage of total agriculture+pasture land that is pasture
  Pct_AG_ha_Irrig = Reigo_ha / AG_ha,
  Pct_AG_ha_Temp = Temporal_ha / AG_ha,
  Fertilizer = Pct_FertilChem_ha + Pct_FertilManure_ha,
  Techniques = Pct_FertilChem_ha + Pct_FertilManure_ha + Pct_Herbicides_ha + Pct_Insecticides_ha + Pct_ControlledBurn_ha,
  #### Calculation of "Labor Units" ####
  # used to equivocate different forms of labor input (machine, animal, human)
  # using efficiencies calculated from 20th century statistics on cultivation labor 
  # time per unit area using different technology (i.e. machine, animal, human).
  # One "Labor Unit" (LU) == 1 person-year of manual labor based on person-day equivalents
  # for common tasks undertaken over the course of the agricultural season

  LU_MechanizEquip = MechanizEquip * 30, #20 one piece of mechanized equipment is equivalent to 20 people
  LU_DraftAnimals = DraftAnimals_Total * 2, # draught animals and humans have 1-to-1 LU relationship 
  LU_FamLabor = FamLabor_Tot * 1, # Each family farm operator contributes 1 labor unit
  LU_ContractFull = ContractLabor_More6Mo * 1, # Each full-time contract laborer contributes 1 labor unit
  LU_ContractPart = ContractLabor_Less6Mo * 1, #0.5 Each seasonal contract laborer contributes 0.5 labor units
  LU_Total = LU_MechanizEquip + LU_DraftAnimals + LU_FamLabor + LU_ContractFull + LU_ContractPart, # total LUs == sum of all LUs
  LU_Total_perHa = LU_Total / AGPasture_ha # Density of total LUs per hectare of agriculture+pasture land
  ) %>% mutate(
         Municipio = str_replace_all(Municipio, c(" De " = " de ",
                                                  " Del " = " del ",
                                                  " La " = " la ",
                                                  " Las " = " las ",
                                                  " Los " = " los ",
                                                  " El " = " el ",
                                                  "Ziltlaltepec" = "Zitlaltepec",
                                                  "Atltzayanca" = "Altzayanca")),
         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
                                                              " Del " = " del ",
                                                              " La " = " la ",
                                                              " Las " = " las ",
                                                              " Los " = " los ",
                                                              " El " = " el ",
                                                              "Ziltlaltepec" = "Zitlaltepec",
                                                              "Atltzayanca" = "Altzayanca")))


```



#### Merge with Municipio Polygons and Export

```{r, 'Merge with Municipio Polygons and Export', message=FALSE, warning=FALSE}

Census2000s_poly <- Municipios2000s %>% select(-Area_ha, -Area_m2) %>% 
  left_join(Census2000s, by = c("Estado_ID", "Municipio_ID", "EstadoMunicipio", "Municipio", "Estado"))

st_write(Census2000s_poly, paste0(wd$data_p, "Census2000s_poly.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)

# save the data as .csv
write.csv(Census2000s, paste0(wd$data_p,"CensusData2000s.csv"))

rm(AGCensus2007, PopCensus2010)

```



## 2000s Land Use Data

Accidentally missing in SIAP, need to recheck:
Acatzingo, Puebla
General Felipe Angeles, Puebla
Mixtla, Puebla
San Salvador Huixcolotla, Puebla
Santo Tomas Hueyotlipan, Puebla


```{r, 'Load/Organize Land Use Polygons', message=FALSE, warning=FALSE}

# read GIS polygon data gpkg. This data is the intersection of two different land use polygon datasets:
# 1) FASII 2015 agricultural land use polygons
# 2) INEGI 2013 agricultural Land Use Polygons
LU2000 <- st_read(paste0(wd$data_r, "AG_Model_2000s/FASII_INEGI_LandUse2000s.gpkg")) 

# Remove Spanish accent marks from the municipality and state names
LU2000$NOM_MUN <- stri_trans_general(str=LU2000$NOM_MUN,id="Latin-ASCII")
LU2000$NOMEDO <- stri_trans_general(str=LU2000$NOMEDO,id="Latin-ASCII")
 

LU2000b <- LU2000 %>% 
  # Create new variable to abbreviate classified INEGI land use types
  mutate(Tipages = case_when(
    TIPAGES == "AGRICULTURA DE RIEGO" ~ "R",
    TIPAGES == "AGRICULTURA DE TEMPORAL" ~ "T",
    TIPAGES == "AGRICULTURA DE HUMEDAD" ~ "H")) %>% rowwise() %>% 
  # Create new master variable agricultural type classification using both
  # FASII and INEGI and FASII land use data
  mutate(
      #Type = ifelse(Tipages == "R" | MOD_AGR == "R", "R", 
      #              ifelse(Tipages == "H", "H", "T"))
      Type = ifelse(Tipages == "R" | MOD_AGR == "R", "Riego", "Temporal"),
      Type = ifelse(is.na(Type), "Temporal", Type)) %>% ungroup() %>%
  # remove unneeded variables
  select(-Name, -fid_2, -layer, -path, -NOMEDO,  -fid_3) %>% 
  # rename variables
  rename(Estado_ID = CVE_ENT, ddr_ID = CVE_DDR, ddr = NOMDDR, Cader_ID = CVE_CADER, 
    Cader = NOMCADER, Municipio_ID = CVE_MUN, Municipio = NOM_MUN) %>% 
  # create variable for the written name of the state based on the state code in the polygon data
  mutate(Estado = case_when(
    Estado_ID == "15" ~ "Mexico",
    Estado_ID == "09" ~ "Distrito Federal",
    Estado_ID == "13" ~ "Hidalgo",
    Estado_ID == "17" ~ "Morelos",
    Estado_ID == "21" ~ "Puebla",
    Estado_ID == "29" ~ "Tlaxcala"))

# Join/merge (union) all land use polygons of the name agricultural type within each municipality
LU2000c <- LU2000b %>% group_by(Type, Estado, Estado_ID, Municipio, Municipio_ID) %>% 
  summarise(geom = sf::st_union(geom)) %>% ungroup()

# calculate the area of the merged polygons in square meters and hectares
LU2000c$Area_m2 <- st_area(LU2000c)
LU2000c$Area_ha <- as.numeric(LU2000c$Area_m2)/10000


LU2000d <- LU2000c %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>% 
  # remove a number of municipios that should not be in the CMex focal region dataset
  filter(!(EstadoMunicipio %in% c("Coatetelco, Morelos", "Almoloya de Alquisiras, Mexico", "Amanalco, Mexico", "Iztapalapa, Distrito Federal", "Texcaltitlan, Mexico","Polotitlan, Mexico", "Temascalcingo, Mexico","Villa de Allende, Mexico", "Acambay de Ruiz Castaneda, Mexico", "Aculco, Mexico"))) %>% 
  # 
 mutate(AGType = case_when(
    EstadoMunicipio == "Tzicatlacoyan, Puebla" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Santa Catarina Tlaltempan, Puebla" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "San Diego la Mesa Tochimiltzingo, Puebla" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Ocuilan, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Cocotitlan, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Villa Guerrero, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Tonanitla, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Cuautitlan, Mexico" & Type == "Temporal" ~ "Riego", #############################
    .default = Type)) %>% select(-Type)

#%>% group_by(AGType, Estado, Estado_ID, Municipio, Municipio_ID, EstadoMunicipio) %>% 
  #summarise(geom = sf::st_union(geom)) %>% ungroup()

# Join/merge (union) all land use polygons of the name agricultural type within each municipality
LU2000e <- LU2000d %>% group_by(AGType, Estado, Estado_ID, Municipio, Municipio_ID, EstadoMunicipio) %>% 
  summarise(geom = sf::st_union(geom)) %>% ungroup()

# calculate the area of the merged polygons in square meters and hectares
LU2000e$Area_m2 <- st_area(LU2000e)
LU2000e$Area_ha <- as.numeric(LU2000e$Area_m2)/10000

LU2000e <- LU2000e %>% mutate(
         Municipio = str_replace_all(Municipio, c(" De " = " de ",
                                                  " Del " = " del ",
                                                  " La " = " la ",
                                                  " Las " = " las ",
                                                  " Los " = " los ",
                                                  " El " = " el ",
                                                  "Ziltlaltepec" = "Zitlaltepec",
                                                  "Atltzayanca" = "Altzayanca")),
         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
                                                              " Del " = " del ",
                                                              " La " = " la ",
                                                              " Las " = " las ",
                                                              " Los " = " los ",
                                                              " El " = " el ",
                                                              "Ziltlaltepec" = "Zitlaltepec",
                                                              "Atltzayanca" = "Altzayanca")))

LU_Cases = st_drop_geometry(LU2000e)
#write.csv(st_drop_geometry(LU2000c), paste0(wd$data_r,"LU_Cases.csv"))

#st_write(LU2000e, dsn = paste0(wd$data_r, "AG_Model_2000s/test2.gpkg"),layer="test2", driver="GPKG")

st_write(LU2000e, paste0(wd$data_r, "LU2000e.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)

rm(LU2000b, LU2000, LU2000c, LU2000d)

```


Change Riego to Temporal = 
Tzicatlacoyan, Puebla
Santa Catarina Tlaltempan, Puebla
San Diego la Mesa Tochimiltzingo, Puebla
Ocuilan, Mexico
Cocotitlan, Mexico
Villa Guerrero, Mexico

Change Temporal to Riego=
Cuautitlan, Mexico


HUMEDAD??


## SIAP Data 2003-2021

~Remove ROWS from SIAP due to 1 year (not included in land use data)~
~Remove ROWS from SIAP due to size (not included in land use data)~
~Remove ROWS from SIAP due to NO LAND USE LOCATION (not included in land use data)~

* **SIAP** = raw data (Cierre_agricola_mun_2003_2021.csv)
* **SIAP_2** = cleaned data. Rows = year + cultigen + crop cycle (season) + municipality + agriculture type
* **SIAP_3** = SIAP_2 data filtered to only include maize from the spring-summer cycle within the CMex study region by year, state-municipality and agriculture type. Yields are converted from tons/ha to kg/ha, and a handful of summary variables are included
* **SIAP_4** = SIAP_3 data with numerous additional summary variables calculated, which variously aggregate the data by municipality, agriculture type, and both municipality + agriculture type, but the full SIAP_3 data by-year has been preserved
* **SIAP_5** = SIAP_4 data summarized such that there are only rows for municipality + agriculture type (i.e. max of 2 rows per municipality if it has both temporal and irrigation present) No annual data; only variables summarizing them by municipality, agriculture type, and both municipality + agriculture type)
* **SIAP_6** = SIAP_4 data summarized such that there is only 1 row per municipality. Agriculture type summary vars preserved as columns but no annual data as in SIAP_5; only variables summarizing the data by municipality, agriculture type, and both municipality + agriculture type

#### Clean Data

```{r, 'Load, Clean and Organize SIAP 2003-2021 Yield Data', message=FALSE, warning=FALSE}

# Read-in the SIAP 2003-2021 Yield Data
SIAP <- read.csv(paste0(wd$data_r,"Cierre_agricola_mun_2003_2021.csv"))


SIAP_2 = SIAP %>% 
  # restrict dataset to the Mexican states located in the CMex focal region
  filter(Estado == "Ciudad de Mexico / DF" | 
         Estado == "Ciudad de Mexico" |
         Estado == "Mexico" |
         Estado == "Puebla" |
         Estado == "Morelos" |
         Estado == "Hidalgo" |
         Estado == "Tlaxcala") %>% 
  # Change some string names in the data to be congruent with the other agricultural data
  mutate_all(~ str_replace_all(., c("Ciudad de Mexico / DF" = "Distrito Federal", 
                                    "Ciudad de Mexico" = "Distrito Federal",
                                    "QUECHOLAC" = "Quecholac",
                                    "alvaro Obregon" = "Alvaro Obregon", 
                                    "General Felipe angeles" = "General Felipe Angeles",
                                    " De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%
  # Change incorrectly-designated character variables to numeric
  mutate(Planted = as.numeric(Planted), Harvested = as.numeric(Harvested),
          Lost = as.numeric(Lost), Product = as.numeric(Product),
          Yield = as.numeric(Yield), Price = as.numeric(Price),
          Value = as.numeric(Value)) %>% 
  mutate(
    # reported yield in the data == Product (tons) / hectares harvested
    Yield_orig = Yield,
    # we want to change the reported yield to == Product (tons) / hectares planted
    # to account for yield loss over the course of the growing season
    Yield = Product / Planted,
    # calculate the overall/average yield loss in tons per hectare
    YieldLoss = (Product / Harvested) - Yield,
    # calculate the percentage yield loss
    PctYieldLoss = (1 - (Yield / (Product / Harvested)))*100) %>% rowwise() %>% mutate(
      YieldLoss = ifelse(YieldLoss < 0, 0, YieldLoss),
      PctYieldLoss = ifelse(PctYieldLoss < 0, 0, PctYieldLoss)) %>% ungroup()

#SIAP_ID = SIAP_2 %>% select(-Year, -(Cycle_ID:Value)) %>% distinct(EstadoMunicipio, .keep_all = T, .remove_duplicates = TRUE)

# Export SIAP 2003-2021 Yield Data for manual editing
#write.csv(SIAP_ID, paste0(wd$data_r,"SIAP_ID.csv"))

# read-in manually-edited SIAP 2003-2021 ID Data
SIAP_ID <- read.csv(paste0(wd$data_r,"SIAP_ID_EDITS.csv")) %>% 
  # Change some string names in the data to be congruent with the other agricultural data
  mutate_all(~ str_replace_all(., c("Ciudad de Mexico / DF" = "Distrito Federal", 
                                    "Ciudad de Mexico" = "Distrito Federal",
                                    "QUECHOLAC" = "Quecholac",
                                    "alvaro Obregon" = "Alvaro Obregon", 
                                    "General Felipe angeles" = "General Felipe Angeles",
                                    " De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca")))

# left-join edited SIAP_ID dataframe with SIAP_2 yield data
SIAP_3 = SIAP_2 %>% left_join(SIAP_ID, by = c('Estado_ID', 'Estado', 'ddr_ID', 'ddr', 'Cader_ID', 'Cader', 'Municipio_ID', 'Municipio', 'EstadoMunicipio')) %>% 
  # filter the data to only include states and municipalities in the CMex focal region
  filter(INCLUDE == TRUE) %>%
  # only consider Spring-Summer crop cycle yields (exclude Autumn-Winter yields)
  filter(Cycle %in% c("Primavera-Verano", "Perennes")) %>%
  mutate(CultigenGroup = case_when(
    Cultigen == "Maiz grano" ~ "Maize",
    Cultigen == "Avena forrajera seca" ~ "Fodder",
    Cultigen == "Pastos y praderas seco" ~ "Fodder",
    Cultigen == "Alfalfa verde" ~ "Fodder",
    Cultigen == "Pastos y praderas" ~ "Fodder",
    Cultigen == "Cebada forrajera en verde" ~ "Fodder",
    Cultigen == "Pastos y praderas achicalado" ~ "Fodder",
    .default = "OtherCrops")) %>%
  group_by(EstadoMunicipio, Year, AGType) %>%
    mutate(Area_AGType = sum(Planted, na.rm=T),
           Area_AGType_Maize = sum(Planted[CultigenGroup == "Maize"], na.rm=T),
           Area_AGType_Maize = ifelse(is.na(Area_AGType_Maize), 0, Area_AGType_Maize),
           Area_AGType_Fodder = sum(Planted[CultigenGroup == "Fodder"], na.rm=T),
           Area_AGType_Fodder = ifelse(is.na(Area_AGType_Fodder), 0, Area_AGType_Fodder),
           Area_AGType_OtherCrops = sum(Planted[CultigenGroup == "OtherCrops"], na.rm=T),
           Area_AGType_OtherCrops = ifelse(is.na(Area_AGType_OtherCrops), 0, Area_AGType_OtherCrops)) %>% ungroup() %>%
  group_by(EstadoMunicipio, Year) %>%
    mutate(Area_Total = sum(Planted, na.rm=T),
           Area_Total_Maize = sum(Planted[CultigenGroup == "Maize"], na.rm=T),
           Area_Total_Maize = ifelse(is.na(Area_Total_Maize), 0, Area_Total_Maize),
           Area_Total_Fodder = sum(Planted[CultigenGroup == "Fodder"], na.rm=T),
           Area_Total_Fodder = ifelse(is.na(Area_Total_Fodder), 0, Area_Total_Fodder),
           Area_Total_OtherCrops = sum(Planted[CultigenGroup == "OtherCrops"], na.rm=T),
           Area_Total_OtherCrops = ifelse(is.na(Area_Total_OtherCrops), 0, Area_Total_OtherCrops)) %>% ungroup() %>%
    mutate(PctArea_Maize_Crops_AGType = Area_AGType_Maize / (Area_AGType_Maize + Area_AGType_OtherCrops),
           PctArea_Maize_AGType = Area_AGType_Maize / (Area_AGType_Maize + Area_AGType_OtherCrops + Area_AGType_Fodder),
           PctArea_Maize_Crops_Total = Area_Total_Maize / (Area_Total_Maize + Area_Total_OtherCrops),
           PctArea_Maize_Total = Area_Total_Maize / (Area_Total_Maize + Area_Total_OtherCrops + Area_Total_Fodder)) %>%
    # filter the data to only include Maize from the spring-summer cycle
    filter(Cultigen == "Maiz grano", Cycle == "Primavera-Verano") %>%
    # convert units -- tons to kg -- for yield, yield loss and product
    mutate(Yield = Yield * 1000, Yield_orig = Yield_orig * 1000, Product = Product* 1000, YieldLoss = YieldLoss*1000) %>%
    group_by(EstadoMunicipio, Year) %>%
    # calculate overall municipal average maize yields for all agricultural types (temporal and riego)
    # by first grouping by state-municipality and year, and then dividing the sum of the product by the sum of the hectares planted
    mutate(TotYield = (sum(Product, na.rm=T) / sum(Planted, na.rm=T)) + runif(1, min = 0.0001, max = 0.01),
           TotYield_orig = sum(Product, na.rm=T) / sum(Harvested, na.rm=T),
           TotYieldLoss = TotYield_orig - TotYield,
           TotPctYieldLoss = (1-(TotYield/TotYield_orig))*100) %>% ungroup()
  
#write.csv(SIAP_3, paste0(wd$data_r,"SIAP_CMex_Maize.csv"))

```



#### Remove Cases


```{r, 'Remove Cases', message=FALSE, warning=FALSE}

SIAP_3 = SIAP_3 %>% 
  # remove a number of municipios that should not be in the CMex focal region dataset
  filter(!(EstadoMunicipio %in% c("Coatetelco, Morelos", "Almoloya de Alquisiras, Mexico", "Amanalco, Mexico", "Iztapalapa, Distrito Federal", "Texcaltitlan, Mexico","Polotitlan, Mexico", "Temascalcingo, Mexico","Villa de Allende, Mexico", "Acambay de Ruiz Castaneda, Mexico", "Aculco, Mexico")))

#SIAP_5 = SIAP_5 %>% mutate_all(~ str_replace_all(., c("San Antonio La Isla" = "San Antonio la Isla", 
#                                     "Mineral de La Reforma" = "Mineral de la Reforma",
#                                     "San Martin de Las Piramides" = "San Martin de las Piramides",
#                                     "Ixtapan de La Sal" = "Ixtapan de la Sal", 
#                                     "San Nicolas de Los Ranchos" = "San Nicolas de los Ranchos",
#                                     "San Salvador El Verde" = "San Salvador el Verde", 
#                                     "San Diego La Mesa Tochimiltzingo" = "San Diego la Mesa Tochimiltzingo",
#                                     "Huehuetlan El Grande" = "Huehuetlan el Grande",
#                                     "Tetla de La Solidaridad" = "Tetla de la Solidaridad")))


#SIAP_5 <- SIAP_5 %>% mutate(across(where(is.character) & !one_of(c("Estado_ID", "Estado", "ddr_ID", "ddr", "Cader_ID", "Cader", "Municipio_ID", "Municipio", "EstadoMunicipio", "AGType")), as.numeric)) %>% mutate(
#         Municipio = str_replace_all(Municipio, c(" De " = " de ",
#                                                  " Del " = " del ",
#                                                  " La " = " la ",
#                                                  " Las " = " las ",
#                                                  " Los " = " los ",
#                                                  " El " = " el ",
#                                                  "Ziltlaltepec" = "Zitlaltepec",
#                                                  "Atltzayanca" = "Altzayanca")),
#         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
#                                                              " Del " = " del ",
#                                                              " La " = " la ",
#                                                              " Las " = " las ",
#                                                              " Los " = " los ",
 #                                                             " El " = " el ",
##                                                              "Ziltlaltepec" = "Zitlaltepec",
 #                                                             "Atltzayanca" = "Altzayanca")))


```



#### SIAP_4: Annual Data

```{r, 'SIAP_4: Annual Data', message=FALSE, warning=FALSE}

SIAP_4 = SIAP_3 %>% 
  # group the data by state-municipality and agriculture type
  group_by(EstadoMunicipio, AGType) %>% 
  # calculate variables for the maize yield (and yield loss) time-series: mean, standard deviation 
  # and coefficient of variation by state-municipality and agriculture type
  mutate(AvgYield = mean(Yield, na.rm=T), 
         sdYield = sd(Yield, na.rm=T), 
         cvYield = sdYield/AvgYield*100,
         AvgYieldLoss = mean(YieldLoss, na.rm=T), 
         sdYieldLoss = sd(YieldLoss, na.rm=T), 
         cvYieldLoss = sdYieldLoss/AvgYieldLoss*100,
         AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), 
         sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), 
         cvPctYieldLoss = sdPctYieldLoss/AvgPctYieldLoss*100) %>% 
  # calculate variable for the number of time series cases by state-municipality and agriculture type
  add_tally() %>% 
  # ungroup the data
  ungroup() %>% 
  # calculate the maize yield Z-score by state-municipality and agriculture type
  # using the state-municipality / agriculture type mean and st.dev
  mutate(zYield = (Yield - AvgYield)/sdYield) %>% 
  # group by state-municipality
  group_by(EstadoMunicipio) %>% 
  # calculate variables for the Yield and Yield Loss  mean, standard deviation and 
  # coefficient of variation for each agriculture type by state-municipality
  mutate(AvgYield_Total = mean(unique(TotYield), na.rm=T), #sum(Product, na.rm=T) / sum(Planted, na.rm=T)
         sdYield_Total = sd(unique(TotYield), na.rm=T), 
         cvYield_Total = sdYield_Total/AvgYield_Total*100,
         AvgYield_Irrig = mean(Yield[AGType == "Riego"] , na.rm=T),
         sdYield_Irrig = sd(Yield[AGType == "Riego"] , na.rm=T),
         cvYield_Irrig = sdYield_Irrig/AvgYield_Irrig*100,
         AvgYield_Temp = mean(Yield[AGType == "Temporal"], na.rm=T),
         sdYield_Temp = sd(Yield[AGType == "Temporal"], na.rm=T),
         cvYield_Temp = sdYield_Temp/AvgYield_Temp*100,
         AvgYieldLoss_Total = mean(unique(TotYieldLoss), na.rm=T), 
         sdYieldLoss_Total = sd(unique(TotYieldLoss), na.rm=T), 
         cvYieldLoss_Total = sdYieldLoss_Total/AvgYieldLoss_Total*100,
         AvgYieldLoss_Irrig = mean(YieldLoss[AGType == "Riego"] , na.rm=T),
         sdYieldLoss_Irrig = sd(YieldLoss[AGType == "Riego"] , na.rm=T),
         cvYieldLoss_Irrig = sdYieldLoss_Irrig/AvgYieldLoss_Irrig*100,
         AvgYieldLoss_Temp = mean(YieldLoss[AGType == "Temporal"], na.rm=T),
         sdYieldLoss_Temp = sd(YieldLoss[AGType == "Temporal"], na.rm=T),
         cvYieldLoss_Temp = sdYieldLoss_Temp/AvgYieldLoss_Temp*100,
         AvgPctYieldLoss_Total = mean(unique(TotPctYieldLoss), na.rm=T), 
         sdPctYieldLoss_Total = sd(unique(TotPctYieldLoss), na.rm=T), 
         cvPctYieldLoss_Total = sdPctYieldLoss_Total/AvgPctYieldLoss_Total*100,
         AvgPctYieldLoss_Irrig = mean(PctYieldLoss[AGType == "Riego"] , na.rm=T),
         sdPctYieldLoss_Irrig = sd(PctYieldLoss[AGType == "Riego"] , na.rm=T),
         cvPctYieldLoss_Irrig = sdPctYieldLoss_Irrig/AvgPctYieldLoss_Irrig*100,
         AvgPctYieldLoss_Temp = mean(PctYieldLoss[AGType == "Temporal"], na.rm=T),
         sdPctYieldLoss_Temp = sd(PctYieldLoss[AGType == "Temporal"], na.rm=T),
         cvPctYieldLoss_Temp = sdPctYieldLoss_Temp/AvgPctYieldLoss_Temp*100) %>% 
  # calculate variable for the overall number of time series cases by state-municipality
  add_tally(name = "n_Total") %>% 
  mutate(AvgArea_Irrig = mean(Area_AGType[AGType == "Riego"], na.rm=T),
         sdArea_Irrig = sd(Area_AGType[AGType == "Riego"], na.rm=T),
         cvArea_Irrig = sdArea_Irrig/AvgArea_Irrig*100,
         AvgArea_Irrig_Maize = mean(Area_AGType_Maize[AGType == "Riego"], na.rm=T),
         sdArea_Irrig_Maize = sd(Area_AGType_Maize[AGType == "Riego"], na.rm=T),
         cvArea_Irrig_Maize = sdArea_Irrig_Maize/AvgArea_Irrig_Maize*100,
         AvgArea_Irrig_Fodder = mean(Area_AGType_Fodder[AGType == "Riego"], na.rm=T),
         AvgArea_Irrig_OtherCrops = mean(Area_AGType_OtherCrops[AGType == "Riego"], na.rm=T),
         AvgPctArea_Maize_Crops_Irrig = mean(PctArea_Maize_Crops_AGType[AGType == "Riego"], na.rm=T),
         sdPctArea_Maize_Crops_Irrig = sd(PctArea_Maize_Crops_AGType[AGType == "Riego"], na.rm=T),
         cvPctArea_Maize_Crops_Irrig = sdPctArea_Maize_Crops_Irrig/AvgPctArea_Maize_Crops_Irrig*100,
         AvgPctArea_Maize_Irrig = mean(PctArea_Maize_AGType[AGType == "Riego"], na.rm=T),
         sdPctArea_Maize_Irrig = sd(PctArea_Maize_AGType[AGType == "Riego"], na.rm=T),
         cvPctArea_Maize_Irrig = sdPctArea_Maize_Irrig/AvgPctArea_Maize_Irrig*100,
         AvgArea_Temp = mean(Area_AGType[AGType == "Temporal"], na.rm=T),
         sdArea_Temp = sd(Area_AGType[AGType == "Temporal"], na.rm=T),
         cvArea_Temp = sdArea_Temp/AvgArea_Temp*100,
         AvgArea_Temp_Maize = mean(Area_AGType_Maize[AGType == "Temporal"], na.rm=T),
         sdArea_Temp_Maize = sd(Area_AGType_Maize[AGType == "Temporal"], na.rm=T),
         cvArea_Temp_Maize = sdArea_Temp_Maize/AvgArea_Temp_Maize*100,
         AvgArea_Temp_Fodder = mean(Area_AGType_Fodder[AGType == "Temporal"], na.rm=T),
         AvgArea_Temp_OtherCrops = mean(Area_AGType_OtherCrops[AGType == "Temporal"], na.rm=T),
         AvgPctArea_Maize_Crops_Temp = mean(PctArea_Maize_Crops_AGType[AGType == "Temporal"], na.rm=T),
         sdPctArea_Maize_Crops_Temp = sd(PctArea_Maize_Crops_AGType[AGType == "Temporal"], na.rm=T),
         cvPctArea_Maize_Crops_Temp = sdPctArea_Maize_Crops_Temp/AvgPctArea_Maize_Crops_Temp*100,
         AvgPctArea_Maize_Temp = mean(PctArea_Maize_AGType[AGType == "Temporal"], na.rm=T),
         sdPctArea_Maize_Temp = sd(PctArea_Maize_AGType[AGType == "Temporal"], na.rm=T),
         cvPctArea_Maize_Temp = sdPctArea_Maize_Temp/AvgPctArea_Maize_Temp*100,
         
         AvgArea_Total = mean(Area_AGType, na.rm=T), # It is correct that the _Total = f(_AGType) 
         sdArea_Total = sd(Area_AGType, na.rm=T), # because _AGType has a single value for each row (year + EstadoMunicipio + AGType)
         cvArea_Total = sdArea_Total/AvgArea_Total*100, # while _Total is the average of them per year per EstadoMunicipio
         AvgArea_Total_Maize = mean(Area_AGType_Maize, na.rm=T),
         sdArea_Total_Maize = sd(Area_AGType_Maize, na.rm=T),
         cvArea_Total_Maize = sdArea_Total_Maize/AvgArea_Total_Maize*100,
         AvgArea_Total_Fodder = mean(Area_AGType_Fodder, na.rm=T),
         AvgArea_Total_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
         AvgPctArea_Maize_Crops_Total = mean(PctArea_Maize_Crops_AGType, na.rm=T),
         sdPctArea_Maize_Crops_Total = sd(PctArea_Maize_Crops_AGType, na.rm=T),
         cvPctArea_Maize_Crops_Total = sdPctArea_Maize_Crops_Total/AvgPctArea_Maize_Crops_Total*100,
         AvgPctArea_Maize_Total = mean(PctArea_Maize_AGType, na.rm=T),
         sdPctArea_Maize_Total = sd(PctArea_Maize_AGType, na.rm=T),
         cvPctArea_Maize_Total = sdPctArea_Maize_Total/AvgPctArea_Maize_Total*100) %>%
  # ungroup the data
  ungroup() %>% 
  # calculate additional variables of interest
  mutate(
    # calculate the maize yield and yield loss Z-score by state-municipality for all agriculture types
    zYield_Total = (Yield - AvgYield_Total)/sdYield_Total,
    zYieldLoss_Total = (YieldLoss - AvgYieldLoss_Total)/sdYieldLoss_Total,
    # TTr = "Temporal-to-Total Ratio" == the ratio of avg temporal variable values to the avg total value
    # ITr = "Irrigation-to-Total Ratio" == the ratio of avg irrigation variable values to the avg total value
    ITr_AvgYield = AvgYield_Irrig/AvgYield_Total,
    ITr_AvgYieldLoss = AvgYieldLoss_Irrig/AvgYieldLoss_Total,
    TTr_AvgYield = AvgYield_Temp/AvgYield_Total,
    TTr_AvgYieldLoss = AvgYieldLoss_Irrig/AvgYieldLoss_Total,
    ITr_cvYield = cvYield_Irrig/cvYield_Total,
    ITr_cvYieldLoss = cvYieldLoss_Irrig/cvYieldLoss_Total,
    TTr_cvYield = cvYield_Irrig/cvYield_Total,
    TTr_cvYieldLoss = cvYieldLoss_Irrig/cvYieldLoss_Total)



```


#### SIAP_5: Agricultural Type Data

```{r, 'SIAP_5: AG Type Data', message=FALSE, warning=FALSE}

SIAP_5 = SIAP_4 %>% 
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sd(Yield, na.rm=T)/mean(Yield, na.rm=T)*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sd(YieldLoss, na.rm=T)/mean(YieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), # mean/average maize % Yield Loss
            sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), # standard deviation of maize % Yield Loss
            minPctYieldLoss = min(PctYieldLoss, na.rm=T), # minimum maize % Yield Loss
            maxPctYieldLoss = max(PctYieldLoss, na.rm=T), # maximum maize % Yield Loss
            medPctYieldLoss = median(PctYieldLoss, na.rm=T), # median maize % Yield Loss
            cvPctYieldLoss = sd(PctYieldLoss, na.rm=T)/mean(PctYieldLoss, na.rm=T)*100,# coefficient of variation of maize % Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares planted in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares planted in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            n = mean(n, na.rm=T), # number of time series cases by state-municipality and agriculture type
            n_Total = mean(n_Total, na.rm=T), # overall number of time series cases by state-municipality
            
            AvgYield_Total = mean(AvgYield_Total, na.rm=T), # mean maize yield for all agriculture types
            sdYield_Total = mean(sdYield_Total, na.rm=T), # standard deviation of maize yield for all agriculture types
            cvYield_Total = mean(cvYield_Total, na.rm=T), # coefficient of variation of maize yield for all agriculture types
            AvgYield_Irrig = mean(AvgYield_Irrig, na.rm=T), # mean maize yield for irrigated agriculture
            sdYield_Irrig = mean(sdYield_Irrig, na.rm=T), # standard deviation of maize yield for irrigated agriculture
            cvYield_Irrig = mean(cvYield_Irrig, na.rm=T), # coefficient of variation of maize yield for irrigated agriculture
            AvgYield_Temp = mean(AvgYield_Temp, na.rm=T), # mean maize yield for temporal agriculture
            sdYield_Temp = mean(sdYield_Temp, na.rm=T), # standard deviation of maize yield for temporal agriculture
            cvYield_Temp = mean(cvYield_Temp, na.rm=T), # coefficient of variation of maize yield for temporal agriculture
            ITr_AvgYield = mean(ITr_AvgYield, na.rm=T), # irrigation-to-total ratio for mean maize yields
            ITr_cvYield = mean(ITr_cvYield, na.rm=T), # irrigation-to-total ratio for coefficient of variation of maize yields
            TTr_AvgYield = mean(TTr_AvgYield, na.rm=T), # temporal-to-total ratio for mean maize yields
            TTr_cvYield = mean(TTr_cvYield, na.rm=T), # temporal-to-total ratio for coefficient of variation of maize yields
            
            AvgYieldLoss_Total = mean(AvgYieldLoss_Total, na.rm=T), # mean maize yield loss for all agriculture types
            sdYieldLoss_Total = mean(sdYieldLoss_Total, na.rm=T), # standard deviation of maize yield loss for all agriculture types
            cvYieldLoss_Total = mean(cvYieldLoss_Total, na.rm=T), # coefficient of variation of maize yield loss for all agriculture types
            AvgYieldLoss_Irrig = mean(AvgYieldLoss_Irrig, na.rm=T), # mean maize yield loss for irrigated agriculture
            sdYieldLoss_Irrig = mean(sdYieldLoss_Irrig, na.rm=T), # standard deviation of maize yield loss for irrigated agriculture
            cvYieldLoss_Irrig = mean(cvYieldLoss_Irrig, na.rm=T), # coefficient of variation of maize yield loss for irrigated agriculture
            AvgYieldLoss_Temp = mean(AvgYieldLoss_Temp, na.rm=T), # mean maize yield loss for temporal agriculture
            sdYieldLoss_Temp = mean(sdYieldLoss_Temp, na.rm=T), # standard deviation of maize yield loss for temporal agriculture
            cvYieldLoss_Temp = mean(cvYieldLoss_Temp, na.rm=T), # coefficient of variation of maize yield loss for temporal agriculture
            AvgPctYieldLoss_Total = mean(AvgPctYieldLoss_Total, na.rm=T), # mean % maize yield loss for all agriculture types
            sdPctYieldLoss_Total = mean(sdPctYieldLoss_Total, na.rm=T), # standard deviation of % maize yield loss for all agriculture types
            cvPctYieldLoss_Total = mean(cvPctYieldLoss_Total, na.rm=T), # coefficient of variation of % maize yield loss for all agriculture types
            AvgPctYieldLoss_Irrig = mean(AvgPctYieldLoss_Irrig, na.rm=T), # mean % maize yield loss for irrigated agriculture
            sdPctYieldLoss_Irrig = mean(sdPctYieldLoss_Irrig, na.rm=T), # standard deviation of % maize yield loss for irrigated agriculture
            cvPctYieldLoss_Irrig = mean(cvPctYieldLoss_Irrig, na.rm=T), # coefficient of variation of % maize yield loss for irrigated agriculture
            AvgPctYieldLoss_Temp = mean(AvgPctYieldLoss_Temp, na.rm=T), # mean % maize yield loss for temporal agriculture
            sdPctYieldLoss_Temp = mean(sdPctYieldLoss_Temp, na.rm=T), # standard deviation of % maize yield loss for temporal agriculture
            cvPctYieldLoss_Temp = mean(cvPctYieldLoss_Temp, na.rm=T), # coefficient of variation of % maize yield loss for temporal agriculture
            ITr_AvgYieldLoss = mean(ITr_AvgYieldLoss, na.rm=T), # irrigation-to-total ratio for mean maize yield loss
            ITr_cvYieldLoss = mean(ITr_cvYieldLoss, na.rm=T),# irrigation-to-total ratio for coefficient of variation of maize yield loss
            TTr_AvgYieldLoss = mean(TTr_AvgYieldLoss, na.rm=T), # temporal-to-total ratio for mean maize yield loss
            TTr_cvYieldLoss = mean(TTr_cvYieldLoss, na.rm=T),# temporal-to-total ratio for coefficient of variation of maize yield loss
            
         AvgArea_Irrig = mean(Area_AGType[AGType == "Riego"], na.rm=T),
         sdArea_Irrig = sd(Area_AGType[AGType == "Riego"], na.rm=T),
         cvArea_Irrig = sdArea_Irrig/AvgArea_Irrig*100,
         AvgArea_Irrig_Maize = mean(Area_AGType_Maize[AGType == "Riego"], na.rm=T),
         sdArea_Irrig_Maize = sd(Area_AGType_Maize[AGType == "Riego"], na.rm=T),
         cvArea_Irrig_Maize = sdArea_Irrig_Maize/AvgArea_Irrig_Maize*100,
         AvgArea_Irrig_Fodder = mean(Area_AGType_Fodder[AGType == "Riego"], na.rm=T),
         AvgArea_Irrig_OtherCrops = mean(Area_AGType_OtherCrops[AGType == "Riego"], na.rm=T),
         AvgPctArea_Maize_Crops_Irrig = mean(PctArea_Maize_Crops_AGType[AGType == "Riego"], na.rm=T),
         sdPctArea_Maize_Crops_Irrig = sd(PctArea_Maize_Crops_AGType[AGType == "Riego"], na.rm=T),
         cvPctArea_Maize_Crops_Irrig = sdPctArea_Maize_Crops_Irrig/AvgPctArea_Maize_Crops_Irrig*100,
         AvgPctArea_Maize_Irrig = mean(PctArea_Maize_AGType[AGType == "Riego"], na.rm=T),
         sdPctArea_Maize_Irrig = sd(PctArea_Maize_AGType[AGType == "Riego"], na.rm=T),
         cvPctArea_Maize_Irrig = sdPctArea_Maize_Irrig/AvgPctArea_Maize_Irrig*100,
         AvgArea_Temp = mean(Area_AGType[AGType == "Temporal"], na.rm=T),
         sdArea_Temp = sd(Area_AGType[AGType == "Temporal"], na.rm=T),
         cvArea_Temp = sdArea_Temp/AvgArea_Temp*100,
         AvgArea_Temp_Maize = mean(Area_AGType_Maize[AGType == "Temporal"], na.rm=T),
         sdArea_Temp_Maize = sd(Area_AGType_Maize[AGType == "Temporal"], na.rm=T),
         cvArea_Temp_Maize = sdArea_Temp_Maize/AvgArea_Temp_Maize*100,
         AvgArea_Temp_Fodder = mean(Area_AGType_Fodder[AGType == "Temporal"], na.rm=T),
         AvgArea_Temp_OtherCrops = mean(Area_AGType_OtherCrops[AGType == "Temporal"], na.rm=T),
         AvgPctArea_Maize_Crops_Temp = mean(PctArea_Maize_Crops_AGType[AGType == "Temporal"], na.rm=T),
         sdPctArea_Maize_Crops_Temp = sd(PctArea_Maize_Crops_AGType[AGType == "Temporal"], na.rm=T),
         cvPctArea_Maize_Crops_Temp = sdPctArea_Maize_Crops_Temp/AvgPctArea_Maize_Crops_Temp*100,
         AvgPctArea_Maize_Temp = mean(PctArea_Maize_AGType[AGType == "Temporal"], na.rm=T),
         sdPctArea_Maize_Temp = sd(PctArea_Maize_AGType[AGType == "Temporal"], na.rm=T),
         cvPctArea_Maize_Temp = sdPctArea_Maize_Temp/AvgPctArea_Maize_Temp*100,
         
         AvgArea_Total = mean(Area_AGType, na.rm=T), # It is correct that the _Total = f(_AGType) 
         sdArea_Total = sd(Area_AGType, na.rm=T), # because _AGType has a single value for each row (year + EstadoMunicipio + AGType)
         cvArea_Total = sdArea_Total/AvgArea_Total*100, # while _Total is the average of them per year per EstadoMunicipio
         AvgArea_Total_Maize = mean(Area_AGType_Maize, na.rm=T),
         sdArea_Total_Maize = sd(Area_AGType_Maize, na.rm=T),
         cvArea_Total_Maize = sdArea_Total_Maize/AvgArea_Total_Maize*100,
         AvgArea_Total_Fodder = mean(Area_AGType_Fodder, na.rm=T),
         AvgArea_Total_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
         AvgPctArea_Maize_Crops_Total = mean(PctArea_Maize_Crops_AGType, na.rm=T),
         sdPctArea_Maize_Crops_Total = sd(PctArea_Maize_Crops_AGType, na.rm=T),
         cvPctArea_Maize_Crops_Total = sdPctArea_Maize_Crops_Total/AvgPctArea_Maize_Crops_Total*100,
         AvgPctArea_Maize_Total = mean(PctArea_Maize_AGType, na.rm=T),
         sdPctArea_Maize_Total = sd(PctArea_Maize_AGType, na.rm=T),
         cvPctArea_Maize_Total = sdPctArea_Maize_Total/AvgPctArea_Maize_Total*100) %>%
            # ungroup the data
  ungroup() %>% rowwise() %>%
  # Remove NaN values from affected variables
  mutate(cvYieldLoss = ifelse(is.nan(cvYieldLoss), 0, cvYieldLoss),
         cvLost = ifelse(is.nan(cvLost), 0, cvLost)) %>% 
  ungroup()


```



#### SIAP_6: Municipal Data

```{r, 'SIAP_6: Municipal Data', message=FALSE, warning=FALSE}

x = SIAP_4 %>% 
  #group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sd(Yield, na.rm=T)/mean(Yield, na.rm=T)*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sd(YieldLoss, na.rm=T)/mean(YieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minPctYieldLoss = min(PctYieldLoss, na.rm=T), # minimum maize Yield Loss
            maxPctYieldLoss = max(PctYieldLoss, na.rm=T), # maximum maize Yield Loss
            medPctYieldLoss = median(PctYieldLoss, na.rm=T), # median maize Yield Loss
            cvPctYieldLoss = sd(PctYieldLoss, na.rm=T)/mean(PctYieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            sdPlanted = sd(Planted, na.rm=T), # standard deviation of hectares planted in maize
            cvPlanted = sdPlanted/AvgPlanted*100, # coefficient of variation of hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares harvested in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares harvested in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            sdProduct = sd(Product, na.rm=T), # standard deviation of total kg of maize produced
            cvProduct = sdProduct/AvgProduct*100, # coefficient of variation of total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            sdValue = sd(Value, na.rm=T), # standard deviation of total value in $MX of maize produced
            cvValue = sdValue/AvgValue*100, # coefficient of variation of total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            sdPrice = sd(Price, na.rm=T), # standard deviation of price per kg in $MX for maize
            cvPrice = sdPrice/AvgPrice*100, # coefficient of variation of price per kg in $MX for maize
            n = mean(n, na.rm=T),# number of time series cases by state-municipality and agriculture type
            AvgArea = mean(Area_AGType, na.rm=T), # It is correct that the _Total = f(_AGType) 
            sdArea = sd(Area_AGType, na.rm=T), # because _AGType has a single value for each row (year + EstadoMunicipio + AGType)
            cvArea = sdArea/AvgArea*100, # while _Total is the average of them per year per EstadoMunicipio
            AvgArea_Maize = mean(Area_AGType_Maize, na.rm=T),
            sdArea_Maize = sd(Area_AGType_Maize, na.rm=T),
            cvArea_Maize = sdArea_Maize/AvgArea_Maize*100,
            AvgArea_Fodder = mean(Area_AGType_Fodder, na.rm=T),
            AvgArea_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
            AvgPctArea_Maize_Crops = mean(PctArea_Maize_Crops_AGType, na.rm=T),
            sdPctArea_Maize_Crops = sd(PctArea_Maize_Crops_AGType, na.rm=T),
            cvPctArea_Maize_Crops = sdPctArea_Maize_Crops/AvgPctArea_Maize_Crops*100,
            AvgPctArea_Maize = mean(PctArea_Maize_AGType, na.rm=T),
            sdPctArea_Maize = sd(PctArea_Maize_AGType, na.rm=T),
            cvPctArea_Maize = sdPctArea_Maize/AvgPctArea_Maize*100)

SIAP_6 = SIAP_4 %>% 
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AGType = "Total",
            AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sd(Yield, na.rm=T)/mean(Yield, na.rm=T)*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sd(YieldLoss, na.rm=T)/mean(YieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minPctYieldLoss = min(PctYieldLoss, na.rm=T), # minimum maize Yield Loss
            maxPctYieldLoss = max(PctYieldLoss, na.rm=T), # maximum maize Yield Loss
            medPctYieldLoss = median(PctYieldLoss, na.rm=T), # median maize Yield Loss
            cvPctYieldLoss = sd(PctYieldLoss, na.rm=T)/mean(PctYieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            sdPlanted = sd(Planted, na.rm=T), # standard deviation of hectares planted in maize
            cvPlanted = sdPlanted/AvgPlanted*100, # coefficient of variation of hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares harvested in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares harvested in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            sdProduct = sd(Product, na.rm=T), # standard deviation of total kg of maize produced
            cvProduct = sdProduct/AvgProduct*100, # coefficient of variation of total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            sdValue = sd(Value, na.rm=T), # standard deviation of total value in $MX of maize produced
            cvValue = sdValue/AvgValue*100, # coefficient of variation of total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            sdPrice = sd(Price, na.rm=T), # standard deviation of price per kg in $MX for maize
            cvPrice = sdPrice/AvgPrice*100, # coefficient of variation of price per kg in $MX for maize
            n = n(),# number of time series cases by state-municipality and agriculture type
            AvgArea = mean(Area_AGType, na.rm=T), # It is correct that the _Total = f(_AGType) 
            sdArea = sd(Area_AGType, na.rm=T), # because _AGType has a single value for each row (year + EstadoMunicipio + AGType)
            cvArea = sdArea/AvgArea*100, # while _Total is the average of them per year per EstadoMunicipio
            AvgArea_Maize = mean(Area_AGType_Maize, na.rm=T),
            sdArea_Maize = sd(Area_AGType_Maize, na.rm=T),
            cvArea_Maize = sdArea_Maize/AvgArea_Maize*100,
            AvgArea_Fodder = mean(Area_AGType_Fodder, na.rm=T),
            AvgArea_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
            AvgPctArea_Maize_Crops = mean(PctArea_Maize_Crops_AGType, na.rm=T),
            sdPctArea_Maize_Crops = sd(PctArea_Maize_Crops_AGType, na.rm=T),
            cvPctArea_Maize_Crops = sdPctArea_Maize_Crops/AvgPctArea_Maize_Crops*100,
            AvgPctArea_Maize = mean(PctArea_Maize_AGType, na.rm=T),
            sdPctArea_Maize = sd(PctArea_Maize_AGType, na.rm=T),
            cvPctArea_Maize = sdPctArea_Maize/AvgPctArea_Maize*100) %>% 
  ungroup() %>% 
  bind_rows(x) %>% 
  pivot_longer(-c(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType), names_to = "Variable", values_to = "Value") %>% 
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp",
    AGType == "Total" ~ "Total")) %>% 
  pivot_wider(names_from = c(Variable, AGType), names_glue = "{Variable}_{AGType}", values_from = Value, values_fill = NA) %>% 
  #rowwise() %>% 
  mutate(
    # Calculate the ratios of irrigated and temporal variables to their state-municipality averages
    ITr_AvgYield = ifelse((AvgYield_Irrig/AvgYield_Total) == 1, NA, AvgYield_Irrig/AvgYield_Total),
    ITr_sdYield = ifelse((sdYield_Irrig/sdYield_Total) == 1, NA, sdYield_Irrig/sdYield_Total),
    ITr_minYield = ifelse((minYield_Irrig/minYield_Total) == 1, NA, minYield_Irrig/minYield_Total),
    ITr_maxYield = ifelse((maxYield_Irrig/maxYield_Total) == 1, NA, maxYield_Irrig/maxYield_Total),
    ITr_medYield = ifelse((medYield_Irrig/medYield_Total) == 1, NA, medYield_Irrig/medYield_Total),
    ITr_cvYield = ifelse((cvYield_Irrig/cvYield_Total) == 1, NA, cvYield_Irrig/cvYield_Total),
    ITr_AvgYieldLoss = ifelse((AvgYieldLoss_Irrig/AvgYieldLoss_Total) == 1, NA, AvgYieldLoss_Irrig/AvgYieldLoss_Total),
    ITr_sdYieldLoss = ifelse((sdYieldLoss_Irrig/sdYieldLoss_Total) == 1, NA, sdYieldLoss_Irrig/sdYieldLoss_Total),
    ITr_minYieldLoss = ifelse((minYieldLoss_Irrig/minYieldLoss_Total) == 1, NA, minYieldLoss_Irrig/minYieldLoss_Total),
    ITr_maxYieldLoss = ifelse((maxYieldLoss_Irrig/maxYieldLoss_Total) == 1, NA, maxYieldLoss_Irrig/maxYieldLoss_Total),
    ITr_medYieldLoss = ifelse((medYieldLoss_Irrig/medYieldLoss_Total) == 1, NA, medYieldLoss_Irrig/medYieldLoss_Total),
    ITr_cvYieldLoss = ifelse((cvYieldLoss_Irrig/cvYieldLoss_Total) == 1, NA, cvYieldLoss_Irrig/cvYieldLoss_Total),
    ITr_AvgPlanted = ifelse((AvgPlanted_Irrig/AvgPlanted_Total) == 1, NA, AvgPlanted_Irrig/AvgPlanted_Total),
    ITr_AvgPctYieldLoss = ifelse((AvgPctYieldLoss_Irrig/AvgPctYieldLoss_Total) == 1, NA, AvgPctYieldLoss_Irrig/AvgPctYieldLoss_Total),
    ITr_sdPctYieldLoss = ifelse((sdPctYieldLoss_Irrig/sdPctYieldLoss_Total) == 1, NA, sdPctYieldLoss_Irrig/sdPctYieldLoss_Total),
    ITr_minPctYieldLoss = ifelse((minPctYieldLoss_Irrig/minPctYieldLoss_Total) == 1, NA, minPctYieldLoss_Irrig/minPctYieldLoss_Total),
    ITr_maxPctYieldLoss = ifelse((maxPctYieldLoss_Irrig/maxPctYieldLoss_Total) == 1, NA, maxPctYieldLoss_Irrig/maxPctYieldLoss_Total),
    ITr_medPctYieldLoss = ifelse((medPctYieldLoss_Irrig/medPctYieldLoss_Total) == 1, NA, medPctYieldLoss_Irrig/medPctYieldLoss_Total),
    ITr_cvPctYieldLoss = ifelse((cvPctYieldLoss_Irrig/cvPctYieldLoss_Total) == 1, NA, cvPctYieldLoss_Irrig/cvPctYieldLoss_Total),
    ITr_AvgPlanted = ifelse((AvgPlanted_Irrig/AvgPlanted_Total) == 1, NA, AvgPlanted_Irrig/AvgPlanted_Total),
    ITr_sdPlanted = ifelse((sdPlanted_Irrig/sdPlanted_Total) == 1, NA, sdPlanted_Irrig/sdPlanted_Total),
    ITr_cvPlanted = ifelse((cvPlanted_Irrig/cvPlanted_Total) == 1, NA, cvPlanted_Irrig/cvPlanted_Total),
    ITr_AvgHarvested = ifelse((AvgHarvested_Irrig/AvgHarvested_Total) == 1, NA, AvgHarvested_Irrig/AvgHarvested_Total),
    ITr_sdHarvested = ifelse((sdHarvested_Irrig/sdHarvested_Total) == 1, NA, sdHarvested_Irrig/sdHarvested_Total),
    ITr_cvHarvested = ifelse((cvHarvested_Irrig/cvHarvested_Total) == 1, NA, cvHarvested_Irrig/cvHarvested_Total),
    ITr_AvgLost = ifelse((AvgLost_Irrig/AvgLost_Total) == 1, NA, AvgLost_Irrig/AvgLost_Total),
    ITr_sdLost = ifelse((sdLost_Irrig/sdLost_Total) == 1, NA, sdLost_Irrig/sdLost_Total),
    ITr_cvLost = ifelse((cvLost_Irrig/cvLost_Total) == 1, NA, cvLost_Irrig/cvLost_Total),
    ITr_AvgProduct = ifelse((AvgProduct_Irrig/AvgProduct_Total) == 1, NA, AvgProduct_Irrig/AvgProduct_Total),
    ITr_sdProduct = ifelse((sdProduct_Irrig/sdProduct_Total) == 1, NA, sdProduct_Irrig/sdProduct_Total),
    ITr_cvProduct = ifelse((cvProduct_Irrig/cvProduct_Total) == 1, NA, cvProduct_Irrig/cvProduct_Total),
    # Calculate the ratio of temporal variables to the state-municipality average
    TTr_AvgYield = ifelse((AvgYield_Temp/AvgYield_Total) == 1, NA, AvgYield_Temp/AvgYield_Total),
    TTr_sdYield = ifelse((sdYield_Temp/sdYield_Total) == 1, NA, sdYield_Temp/sdYield_Total),
    TTr_minYield = ifelse((minYield_Temp/minYield_Total) == 1, NA, minYield_Temp/minYield_Total),
    TTr_maxYield = ifelse((maxYield_Temp/maxYield_Total) == 1, NA, maxYield_Temp/maxYield_Total),
    TTr_medYield = ifelse((medYield_Temp/medYield_Total) == 1, NA, medYield_Temp/medYield_Total),
    TTr_cvYield = ifelse((cvYield_Temp/cvYield_Total) == 1, NA, cvYield_Temp/cvYield_Total),
    TTr_AvgYieldLoss = ifelse((AvgYieldLoss_Temp/AvgYieldLoss_Total) == 1, NA, AvgYieldLoss_Temp/AvgYieldLoss_Total),
    TTr_sdYieldLoss = ifelse((sdYieldLoss_Temp/sdYieldLoss_Total) == 1, NA, sdYieldLoss_Temp/sdYieldLoss_Total),
    TTr_minYieldLoss = ifelse((minYieldLoss_Temp/minYieldLoss_Total) == 1, NA, minYieldLoss_Temp/minYieldLoss_Total),
    TTr_maxYieldLoss = ifelse((maxYieldLoss_Temp/maxYieldLoss_Total) == 1, NA, maxYieldLoss_Temp/maxYieldLoss_Total),
    TTr_medYieldLoss = ifelse((medYieldLoss_Temp/medYieldLoss_Total) == 1, NA, medYieldLoss_Temp/medYieldLoss_Total),
    TTr_cvYieldLoss = ifelse((cvYieldLoss_Temp/cvYieldLoss_Total) == 1, NA, cvYieldLoss_Temp/cvYieldLoss_Total),
    TTr_AvgPctYieldLoss = ifelse((AvgPctYieldLoss_Temp/AvgPctYieldLoss_Total) == 1, NA, AvgPctYieldLoss_Temp/AvgPctYieldLoss_Total),
    TTr_sdPctYieldLoss = ifelse((sdPctYieldLoss_Temp/sdPctYieldLoss_Total) == 1, NA, sdPctYieldLoss_Temp/sdPctYieldLoss_Total),
    TTr_minPctYieldLoss = ifelse((minPctYieldLoss_Temp/minPctYieldLoss_Total) == 1, NA, minPctYieldLoss_Temp/minPctYieldLoss_Total),
    TTr_maxPctYieldLoss = ifelse((maxPctYieldLoss_Temp/maxPctYieldLoss_Total) == 1, NA, maxPctYieldLoss_Temp/maxPctYieldLoss_Total),
    TTr_medPctYieldLoss = ifelse((medPctYieldLoss_Temp/medPctYieldLoss_Total) == 1, NA, medPctYieldLoss_Temp/medPctYieldLoss_Total),
    TTr_cvPctYieldLoss = ifelse((cvPctYieldLoss_Temp/cvPctYieldLoss_Total) == 1, NA, cvPctYieldLoss_Temp/cvPctYieldLoss_Total),
    TTr_AvgPlanted = ifelse((AvgPlanted_Temp/AvgPlanted_Total) == 1, NA, AvgPlanted_Temp/AvgPlanted_Total),
    TTr_sdPlanted = ifelse((sdPlanted_Temp/sdPlanted_Total) == 1, NA, sdPlanted_Temp/sdPlanted_Total),
    TTr_cvPlanted = ifelse((cvPlanted_Temp/cvPlanted_Total) == 1, NA, cvPlanted_Temp/cvPlanted_Total),
    TTr_AvgHarvested = ifelse((AvgHarvested_Temp/AvgHarvested_Total) == 1, NA, AvgHarvested_Temp/AvgHarvested_Total),
    TTr_sdHarvested = ifelse((sdHarvested_Temp/sdHarvested_Total) == 1, NA, sdHarvested_Temp/sdHarvested_Total),
    TTr_cvHarvested = ifelse((cvHarvested_Temp/cvHarvested_Total) == 1, NA, cvHarvested_Temp/cvHarvested_Total),
    TTr_AvgLost = ifelse((AvgLost_Temp/AvgLost_Total) == 1, NA, AvgLost_Temp/AvgLost_Total),
    TTr_sdLost = ifelse((sdLost_Temp/sdLost_Total) == 1, NA, sdLost_Temp/sdLost_Total),
    TTr_cvLost = ifelse((cvLost_Temp/cvLost_Total) == 1, NA, cvLost_Temp/cvLost_Total),
    TTr_AvgProduct = ifelse((AvgProduct_Temp/AvgProduct_Total) == 1, NA, AvgProduct_Temp/AvgProduct_Total),
    TTr_sdProduct = ifelse((sdProduct_Temp/sdProduct_Total) == 1, NA, sdProduct_Temp/sdProduct_Total),
    TTr_cvProduct = ifelse((cvProduct_Temp/cvProduct_Total) == 1, NA, cvProduct_Temp/cvProduct_Total)
    ) %>% ungroup()

rm(x)

```




#### Save SIAP Data as .csv

```{r, label='Save SIAP Data as .csv', message=FALSE,warning=FALSE}
# save the data as .csv
write.csv(SIAP_2, paste0(wd$data_r,"SIAP_2.csv"))

write.csv(SIAP_3, paste0(wd$data_r,"SIAP_3.csv"))

write.csv(SIAP_4, paste0(wd$data_r,"SIAP_4.csv"))

write.csv(SIAP_5, paste0(wd$data_r,"SIAP_5.csv"))

write.csv(SIAP_6, paste0(wd$data_r,"SIAP_6.csv"))

rm(SIAP_2, SIAP_ID, SIAP)
```


## Merge Data

#### Remove SIAP Cases

Tecamac, Mexico(???)

**No Land Use polygons:**
* Tonanitla, Mexico -- Temporal
* Villa de Tezontepec, Hidalgo -- Riego

**No SIAP data:**
* Milpa Alta, Distrito Federal -- Riego
* Tlahuac, Distrito Federal -- Riego
* Xochimilco, Distrito Federal -- Riego
* Axapusco, Mexico -- Riego
* Ixtapaluca, Mexico -- Riego
* Ocuilan, Mexico -- Riego
* Valle de Chalco Solidaridad, Mexico -- Riego
* Villa Guerrero, Mexico -- Riego
* San Diego la Mesa Tochimiltzingo, Puebla -- Riego
* Santa Catarina Tlaltempan, Puebla -- Riego
* Tzicatlacoyan, Puebla -- Riego
* Cuautitlan, Mexico -- Temporal

```{r, label='Remove SIAP Cases', message=FALSE,warning=FALSE}
SIAP_5_remove_cases = SIAP_5 %>% 
# remove irrigation maize yield cases for some municipalities that lack irrigation agriculture in the land use data
  filter(!(EstadoMunicipio %in% c("Chigmecatitlan, Puebla", 
                                  "Huitzilac, Morelos", 
                                  "San Jose Teacalco, Tlaxcala", 
                                  "Tlalnepantla, Morelos", 
                                  "Totolapan, Morelos", 
                                  "Acajete, Puebla", 
                                  "Almoloya, Hidalgo", 
                                  "Apan, Hidalgo", 
                                  "Atlatlahucan, Morelos", 
                                  "Emiliano Zapata, Hidalgo", 
                                  "Mazatecochco de Jose Maria Morelos, Tlaxcala", 
                                  "San Francisco Tetlanohcan, Tlaxcala", 
                                  "San Pablo del Monte, Tlaxcala", 
                                  "Tolcayuca, Hidalgo", 
                                  "Tonanitla, Mexico", 
                                  "Amaxac de Guerrero, Tlaxcala", 
                                  "Jaltenco, Mexico") & AGType %in% "Riego"))
```


#### Merge SIAP with Land Use Polygons

```{r, label='Merge SIAP with Land Use Polygons', message=FALSE,warning=FALSE}
#LU_Cases = LU_Cases %>% select(EstadoMunicipio, AGType)
#SIAP_Cases = SIAP_5 %>% select(EstadoMunicipio, AGType)
#LU_Cases = st_drop_geometry(LU_Cases)
#SIAP_Cases <- SIAP_Cases[, c("EstadoMunicipio", "AGType")]

#LU_Cases$LU_Cases = TRUE
#SIAP_Cases$SIAP_Cases = TRUE

#X = SIAP_Cases %>% full_join(LU_Cases, by = c("EstadoMunicipio", "AGType"))

#X = stringdist_left_join(SIAP_Cases, LU_Cases, 
#           by = c("EstadoMunicipio", "AGType"))



SIAP_LU_poly = LU2000e %>% left_join(SIAP_5_remove_cases, by = c("EstadoMunicipio", "AGType"))

SIAP_LU_poly_Cases = st_drop_geometry(SIAP_LU_poly)

#SIAP_LU_poly = stringdist_left_join(LU2000e, SIAP_5, 
#           by = c("EstadoMunicipio", "AGType"))

###SIAP_LU_poly_b = stringdist_left_join(SIAP_5, LU2000d, 
###           by = c("EstadoMunicipio", "AGType"))

SIAP_LU_poly <- SIAP_LU_poly %>% select(-ddr_ID, -ddr, -Cader_ID, -Cader, -Municipio_ID.y, -Municipio.y, -Estado_ID.y, -Estado.y, -Area_m2) %>% rename( Municipio = Municipio.x, Estado = Estado.x, Estado_ID = Estado_ID.x, Municipio_ID = Municipio_ID.x, AGType_Area_ha = Area_ha)

SIAP_LU_poly_Cases <- SIAP_LU_poly_Cases %>% select(-ddr_ID, -ddr, -Cader_ID, -Cader, -Municipio_ID.y, -Municipio.y, -Estado_ID.y, -Estado.y, -Area_m2) %>% rename( Municipio = Municipio.x, Estado = Estado.x, Estado_ID = Estado_ID.x, Municipio_ID = Municipio_ID.x, AGType_Area_ha = Area_ha)

#write.csv(SIAP_LU_poly_Cases, paste0(wd$data_r,"SIAP_LU_poly_Cases.csv"))

#setdiff(SIAP_LU_poly_a$EstadoMunicipio.x, SIAP_LU_poly_b$EstadoMunicipio.y)
#setdiff(SIAP_LU_poly_b$EstadoMunicipio.y, SIAP_LU_poly_a$EstadoMunicipio.x)
#setdiff(SIAP_LU_poly_a$EstadoMunicipio.x, SIAP_LU_poly_b$EstadoMunicipio.x)
#setdiff(SIAP_LU_poly_b$EstadoMunicipio.x, SIAP_LU_poly_a$EstadoMunicipio.x)
#setdiff(SIAP_LU_poly_b$EstadoMunicipio.y, SIAP_LU_poly_a$EstadoMunicipio.y)
#setdiff(SIAP_Cases, LU_Cases)
```



### Merge 2000s Census Data with SIAP-Land-Use Polygons

```{r, label='Merge 2000s Census Data with SIAP-Land-Use Polygons', message=FALSE,warning=FALSE}

Data2000s_poly = SIAP_LU_poly %>% left_join(Census2000s, 
           by = c("EstadoMunicipio", "Municipio", "Estado", "Estado_ID", "Municipio_ID"))

#setdiff(Data2000s_poly$EstadoMunicipio, SIAP_LU_poly$EstadoMunicipio)
#setdiff(SIAP_LU_poly$EstadoMunicipio, Data2000s_poly$EstadoMunicipio)

#save(Data2000s_poly, file = paste0(wd$data_r, "Data2000s_poly.rData"))


st_write(Data2000s_poly, paste0(wd$data_p, "Data2000s_poly.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)

Data2000s_cases = st_drop_geometry(Data2000s_poly)
write.csv(Data2000s_cases, paste0(wd$data_p,"Data2000s_poly.csv"))
rm(LU_Cases, SIAP_Cases, LU2000e, SIAP_LU_poly, SIAP_LU_poly, SIAP_LU_poly_Cases)

```

 
 
 
 
 
## Remove Cases

```{r}

CASES_REMOVE = TRUE

SAVE_DATA = FALSE
#"Soyaniquilpan de Juarez, Mexico", 
cases_remove <- c("Mixquiahuala de Juarez, Hidalgo", "Tezontepec de Aldama, Hidalgo", "Tepetitlan, Hidalgo", "Tula de Allende, Hidalgo", "Tepeji del Rio de Ocampo, Hidalgo", "Tlaxcoapan, Hidalgo", "Tlahuelilpan, Hidalgo", "Atitalaquia, Hidalgo", "Atotonilco de Tula, Hidalgo", "Francisco I. Madero, Hidalgo", "Tetepango, Hidalgo", "Ajacuba, Hidalgo", "Tetepango, Hidalgo")


if (CASES_REMOVE == TRUE) {
  
  SIAP_3 = SIAP_3 %>% filter(!(EstadoMunicipio %in% cases_remove))
  SIAP_4 = SIAP_4 %>% filter(!(EstadoMunicipio %in% cases_remove))
  SIAP_5 = SIAP_5 %>% filter(!(EstadoMunicipio %in% cases_remove))
  SIAP_6 = SIAP_6 %>% filter(!(EstadoMunicipio %in% cases_remove))
  Data2000s_poly = Data2000s_poly %>% filter(!(EstadoMunicipio %in% cases_remove))
  Data2000s_cases = Data2000s_cases %>% filter(!(EstadoMunicipio %in% cases_remove))
  LU2000e = LU2000e %>% filter(!(EstadoMunicipio %in% cases_remove))
  Census2000s_poly = Census2000s_poly %>% filter(!(EstadoMunicipio %in% cases_remove))
  Census2000s = Census2000s %>% filter(!(EstadoMunicipio %in% cases_remove))
  Municipios2000s_Cases = Municipios2000s_Cases %>% filter(!(EstadoMunicipio %in% cases_remove))
  Municipios2000s = Municipios2000s %>% filter(!(EstadoMunicipio %in% cases_remove))
  
  if (SAVE_DATA == TRUE) {
    
    st_write(Data2000s_poly, paste0(wd$data_p, "Data2000s_poly.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)
    write.csv(Data2000s_cases, paste0(wd$data_p,"Data2000s_poly.csv"))
    write.csv(SIAP_3, paste0(wd$data_r,"SIAP_3.csv"))
    write.csv(SIAP_4, paste0(wd$data_r,"SIAP_4.csv"))
    write.csv(SIAP_5, paste0(wd$data_r,"SIAP_5.csv"))
    write.csv(SIAP_6, paste0(wd$data_r,"SIAP_6.csv"))
    write.csv(Census2000s, paste0(wd$data_r,"CensusData2000s.csv"))
    st_write(LU2000e, paste0(wd$data_r, "LU2000e.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)
    Municipios2000s_Cases = st_drop_geometry(Municipios2000s)
    st_write(Municipios2000s, paste0(wd$data_p, "Municipios2000s_Data.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)
    st_write(Census2000s_poly, paste0(wd$data_r, "Census2000s_poly.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)
    
  }
  
  
}



```



CreateTableOne(
  vars,
  strata,
  data,
  factorVars,
  includeNA = FALSE,
  test = TRUE,
  testApprox = chisq.test,
  argsApprox = list(correct = TRUE),
  testExact = fisher.test,
  argsExact = list(workspace = 2 * 10^5),
  testNormal = oneway.test,
  argsNormal = list(var.equal = TRUE),
  testNonNormal = kruskal.test,
  argsNonNormal = list(NULL),
  smd = TRUE,
  addOverall = FALSE
)


```{r}











```

 
 
 
 
 


# Comparative Analysis of CMex Yields Over Time 

## Import and Organize Comparative Data

```{r, label='Import Comparative Data', message=FALSE,warning=FALSE}

CY <- read.csv(paste0(wd$data_r,"ComparativeYields.csv"))

Colonial <- read.csv(paste0(wd$data_r,"Colonial_MaizeYields.csv"))

AGCensus1960 <- read.csv(paste0(wd$data_r,"AGCensus1960_MaizeYields.csv"))

AGCensus1970 <- read.csv(paste0(wd$data_r,"AGCensus1970_MaizeYields.csv"))

AGCensus1991 <- read.csv(paste0(wd$data_r,"AGCensus1991_MaizeYields.csv"))

AGCensus2007 <- read.csv(paste0(wd$data_r,"AGCensus2007_MaizeYields.csv"))

#SandersAztec <- read.csv(paste0(wd$data_r,"SandersModelAztecBOM.csv"))
SandersAztec <- read.csv(paste0(wd$data_r,"SandersModelAztecBOM2.csv"))

SandersC20 <- read.csv(paste0(wd$data_r,"SandersC20EthnogBOM.csv"))

if (CASES_REMOVE == TRUE) {
  
  cases_remove_CAP <- toupper(cases_remove)
  
  AGCensus1960 = AGCensus1960 %>% filter(!(NOM %in% cases_remove_CAP))
  AGCensus1991 = AGCensus1991 %>% filter(!(NOM %in% cases_remove_CAP))
  AGCensus2007 = AGCensus2007 %>% filter(!(Municipio %in% cases_remove))
  
}


```


```{r, label='Organize Comparative Data', message=FALSE,warning=FALSE}

EarlyColonial = Colonial %>% filter(Period == "C16 Sample") %>% filter(TimeSeries == F) 
#nnn = nrow(EarlyColonial)
#EarlyColonial <- EarlyColonial %>% rowwise() %>% mutate(Weight = ifelse(TimeSeries == F,1,0.25)) %>% ungroup() %>% mutate(Weight = Weight/nnn)
EarlyColonial_dens = density(EarlyColonial$Yield, from=0)#, weights=EarlyColonial$Weight
EarlyColonial_dens2 <- data.frame(EarlyColonial_dens$x, EarlyColonial_dens$y, EarlyColonial_dens$bw, EarlyColonial_dens$n, "Early\nColonial\n(16th Century)\n\n", "Sample of historically documented local-level yields", "EarlyColonial")
names(EarlyColonial_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

LateColonial = Colonial %>% filter(Period == "C18 Sample") %>% filter(TimeSeries == F) 
#nnn = nrow(LateColonial)
#LateColonial <- LateColonial %>% rowwise() %>% mutate(Weight = ifelse(TimeSeries == F,1,0.25)) %>% ungroup() %>% mutate(Weight = Weight/nnn)
LateColonial_dens = density(LateColonial$Yield, from=0)#, weights=LateColonial$Weight
LateColonial_dens2 <- data.frame(LateColonial_dens$x, LateColonial_dens$y, LateColonial_dens$bw, LateColonial_dens$n, "Late\nColonial\n(18th Century)\n\n", "Sample of historically documented local-level yields", "LateColonial")
names(LateColonial_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

AGCensus1960_A = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Ejido" | Size == "Small" | Size == "Large") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))
#s = sum(AGCensus1960_A$Maize1960_ha, na.rm = T)
#AGCensus1960_T_dens = density(AGCensus1960_T$Maize1960_kgha, weights = AGCensus1960_T$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_A_dens = density(AGCensus1960_A$Maize1960_kgha, na.rm = T, from=0)
AGCensus1960_A_dens2 <- data.frame(AGCensus1960_A_dens$x, AGCensus1960_A_dens$y, AGCensus1960_A_dens$bw, AGCensus1960_A_dens$n, "1960\nAgricultural\nCensus\n\n", "Municipal averages by type of land tenure\n(ejidos, large (>5 ha) and small (<5 ha) holdings)", "AGCensus1960_A"
)
names(AGCensus1960_A_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

AGCensus1960_BOM_A = AGCensus1960_A %>% filter(Region == "BOM")
AGCensus1960_BOM_A_dens = density(AGCensus1960_BOM_A$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_T = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Total") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))

#s = sum(AGCensus1960_T$Maize1960_ha, na.rm = T)
#AGCensus1960_T_dens = density(AGCensus1960_T$Maize1960_kgha, weights = AGCensus1960_T$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_T_dens = density(AGCensus1960_T$Maize1960_kgha, na.rm = T, from=0)
AGCensus1960_T_dens2 <- data.frame(AGCensus1960_T_dens$x, AGCensus1960_T_dens$y, AGCensus1960_T_dens$bw, AGCensus1960_T_dens$n, "1960\nAgricultural\nCensus\n\n", "Overall municipal averages", "AGCensus1960_T")
names(AGCensus1960_T_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

AGCensus1960_BOM_T = AGCensus1960_T %>% filter(Region == "BOM")
AGCensus1960_BOM_T_dens = density(AGCensus1960_BOM_T$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_S = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Small") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))
s = sum(AGCensus1960_S$Maize1960_ha, na.rm = T)
#AGCensus1960_S_dens = density(AGCensus1960_S$Maize1960_kgha, weights = AGCensus1960_S$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_S_dens = density(AGCensus1960_S$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_BOM_S = AGCensus1960_S %>% filter(Region == "BOM")
AGCensus1960_BOM_S_dens = density(AGCensus1960_BOM_S$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_L = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Large") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))
s = sum(AGCensus1960_L$Maize1960_ha, na.rm = T)
#AGCensus1960_L_dens = density(AGCensus1960_L$Maize1960_kgha, weights = AGCensus1960_L$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_L_dens = density(AGCensus1960_L$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_BOM_L = AGCensus1960_L %>% filter(Region == "BOM")
AGCensus1960_BOM_L_dens = density(AGCensus1960_BOM_L$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_E = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Ejido") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))
s = sum(AGCensus1960_E$Maize1960_ha, na.rm = T)
#AGCensus1960_E_dens = density(AGCensus1960_E$Maize1960_kgha, weights = AGCensus1960_E$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_E_dens = density(AGCensus1960_E$Maize1960_kgha, na.rm = T, from=0)

AGCensus1960_BOM_E = AGCensus1960_E %>% filter(Region == "BOM")
AGCensus1960_BOM_E_dens = density(AGCensus1960_BOM_E$Maize1960_kgha, na.rm = T, from=0)

AGCensus1970_A = AGCensus1970 %>% #filter(Size == "Total") %>% 
  filter(Size == "Ejido" | Size == "Small" | Size == "Large") %>% 
  
  filter(!is.na(Harvest_ha_S))
#s = sum(AGCensus1970_A$Harvest_ha_S, na.rm = T)
#AGCensus1970_T_dens = density(AGCensus1970_T$Yield_S, weights = AGCensus1970_T$Harvest_ha_S / s, from = 0, na.rm = T)
AGCensus1970_A_dens = density(AGCensus1970_A$Yield_S, na.rm = T, from=0)
AGCensus1970_A_dens2 <- data.frame(AGCensus1970_A_dens$x, AGCensus1970_A_dens$y, AGCensus1970_A_dens$bw, AGCensus1970_A_dens$n, "1970\nAgricultural\nCensus\n\n", "Municipal averages by type of land tenure\n(ejidos, large (>5 ha) and small (<5 ha) holdings)", "AGCensus1970_A"
)
names(AGCensus1970_A_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

AGCensus1970_BOM_A = AGCensus1970_A %>% filter(Region == "BOM")
AGCensus1970_BOM_A_dens = density(AGCensus1970_BOM_A$Yield_S, na.rm = T, from=0)

AGCensus1970_T = AGCensus1970 %>% #filter(Size == "Total") %>% 
  filter(Size == "Total") %>% 
  
  filter(!is.na(Harvest_ha_S))

#s = sum(AGCensus1970_T$Harvest_ha_S, na.rm = T)
#AGCensus1970_T_dens = density(AGCensus1970_T$Yield_S, weights = AGCensus1970_T$Harvest_ha_S / s, from = 0, na.rm = T)
AGCensus1970_T_dens = density(AGCensus1970_T$Yield_S, na.rm = T, from=0)
AGCensus1970_T_dens2 <- data.frame(AGCensus1970_T_dens$x, AGCensus1970_T_dens$y, AGCensus1970_T_dens$bw, AGCensus1970_T_dens$n, "1970\nAgricultural\nCensus\n\n", "Overall municipal averages", "AGCensus1970_T")
names(AGCensus1970_T_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

AGCensus1970_BOM_T = AGCensus1970_T %>% filter(Region == "BOM")
AGCensus1970_BOM_T_dens = density(AGCensus1970_BOM_T$Yield_S, na.rm = T, from=0)

AGCensus1970_S = AGCensus1970 %>% #filter(Size == "Total") %>% 
  filter(Size == "Small") %>% 
  
  filter(!is.na(Harvest_ha_S))
s = sum(AGCensus1970_S$Harvest_ha_S, na.rm = T)
#AGCensus1970_S_dens = density(AGCensus1970_S$Yield_S, weights = AGCensus1970_S$Harvest_ha_S / s, from = 0, na.rm = T)
AGCensus1970_S_dens = density(AGCensus1970_S$Yield_S, na.rm = T, from=0)

AGCensus1970_BOM_S = AGCensus1970_S %>% filter(Region == "BOM")
AGCensus1970_BOM_S_dens = density(AGCensus1970_BOM_S$Yield_S, na.rm = T, from=0)

AGCensus1970_L = AGCensus1970 %>% #filter(Size == "Total") %>% 
  filter(Size == "Large") %>% 
  
  filter(!is.na(Harvest_ha_S))
s = sum(AGCensus1970_L$Harvest_ha_S, na.rm = T)
#AGCensus1970_L_dens = density(AGCensus1970_L$Yield_S, weights = AGCensus1970_L$Harvest_ha_S / s, from = 0, na.rm = T)
AGCensus1970_L_dens = density(AGCensus1970_L$Yield_S, na.rm = T, from=0)

AGCensus1970_BOM_L = AGCensus1970_L %>% filter(Region == "BOM")
AGCensus1970_BOM_L_dens = density(AGCensus1970_BOM_L$Yield_S, na.rm = T, from=0)

AGCensus1970_E = AGCensus1970 %>% #filter(Size == "Total") %>% 
  filter(Size == "Ejido") %>% 
  
  filter(!is.na(Harvest_ha_S))
s = sum(AGCensus1970_E$Harvest_ha_S, na.rm = T)
#AGCensus1970_E_dens = density(AGCensus1970_E$Yield_S, weights = AGCensus1970_E$Harvest_ha_S / s, from = 0, na.rm = T)
AGCensus1970_E_dens = density(AGCensus1970_E$Yield_S, na.rm = T, from=0)

AGCensus1970_BOM_E = AGCensus1970_E %>% filter(Region == "BOM")
AGCensus1970_BOM_E_dens = density(AGCensus1970_BOM_E$Yield_S, na.rm = T, from=0)

AGCensus1991_T = AGCensus1991 %>% filter(!is.na(Yield)) 
AGCensus1991_dens = density(AGCensus1991_T$Yield, na.rm = T, from=0)
AGCensus1991_dens2 <- data.frame(AGCensus1991_dens$x, AGCensus1991_dens$y, AGCensus1991_dens$bw, AGCensus1991_dens$n, "1991\nAgricultural\nCensus\n\n", "Overall municipal averages", "AGCensus1991_T")
names(AGCensus1991_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

AGCensus2007_T = AGCensus2007 %>% filter(!is.na(Yield)) 
s = sum(AGCensus2007_T$Harvested_ha, na.rm = T)
#AGCensus2007_dens = density(AGCensus2007_T$Yield, weights = AGCensus2007_T$Harvested_ha / s, from = 0, na.rm = T)
AGCensus2007_dens = density(AGCensus2007_T$Yield, na.rm = T, from=0)
AGCensus2007_dens2 <- data.frame(AGCensus2007_dens$x, AGCensus2007_dens$y, AGCensus2007_dens$bw, AGCensus2007_dens$n, "2007\nAgricultural\nCensus\n\n", "Overall municipal averages", "AGCensus2007_T")
names(AGCensus2007_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SandersAztec_dens = density(SandersAztec$Yield, from=0)
SandersAztec_dens2 <- data.frame(SandersAztec_dens$x, SandersAztec_dens$y, SandersAztec_dens$bw, SandersAztec_dens$n, "Sanders\nAztec\nModel**\n\n", "Carrying capacity model derived from\nmid-20th century data", "SandersAztec")
names(SandersAztec_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SandersC20_dens = density(SandersC20$YieldAvg, from=0)
SandersC20_dens2 <- data.frame(SandersC20_dens$x, SandersC20_dens$y, SandersC20_dens$bw, SandersC20_dens$n, "Sanders\nmid-20th\nCentury**\n\n", "Sample of ethnographically recorded local-level yields", "SandersC20")
names(SandersC20_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")
#"Sanders mid-20th Century\nSample (BOM Only)"

SIAP_4_2003 = SIAP_4 %>% filter(Year == 2003) 
SIAP_4_2003_dens = density(SIAP_4_2003$Yield, from=0)
SIAP_4_2003_dens2 <- data.frame(SIAP_4_2003_dens$x, SIAP_4_2003_dens$y, SIAP_4_2003_dens$bw, SIAP_4_2003_dens$n, "SIAP 2003\n", "Municipal averages by cultivation type\n(irrigation and temporal)", "SIAP_4_2003")
names(SIAP_4_2003_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SIAP_4_2003a = SIAP_4 %>% filter(Year == 2003) %>% group_by(EstadoMunicipio) %>% summarize(Yield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
SIAP_4_2003a_dens = density(SIAP_4_2003a$Yield)
SIAP_4_2003a_dens2 <- data.frame(SIAP_4_2003a_dens$x, SIAP_4_2003a_dens$y, SIAP_4_2003a_dens$bw, SIAP_4_2003a_dens$n, "SIAP 2003\n", "Overall municipal averages", "SIAP_4_2003a")
names(SIAP_4_2003a_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SIAP_4_2020 = SIAP_4 %>% filter(Year == 2020) 
SIAP_4_2020_dens = density(SIAP_4_2020$Yield, from=0)
SIAP_4_2020_dens2 <- data.frame(SIAP_4_2020_dens$x, SIAP_4_2020_dens$y, SIAP_4_2020_dens$bw, SIAP_4_2020_dens$n, "SIAP 2020\n", "Municipal averages by cultivation type\n(irrigation and temporal)", "SIAP_4_2020")
names(SIAP_4_2020_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SIAP_4_2020a = SIAP_4 %>% filter(Year == 2020) %>% group_by(EstadoMunicipio) %>% summarize(Yield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
SIAP_4_2020a_dens = density(SIAP_4_2020a$Yield, from=0)
SIAP_4_2020a_dens2 <- data.frame(SIAP_4_2020a_dens$x, SIAP_4_2020a_dens$y, SIAP_4_2020a_dens$bw, SIAP_4_2020a_dens$n, "SIAP 2020\n", "Overall municipal averages", "SIAP_4_2020a")
names(SIAP_4_2020a_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SIAP_4_Avg = SIAP_4 %>% group_by(EstadoMunicipio, AGType) %>% summarise(AvgYield = mean(Yield, na.rm=T))
SIAP_4_Avg_dens = density(SIAP_4_Avg$AvgYield, na.rm=T, from=0)
SIAP_4_Avg_dens2 <- data.frame(SIAP_4_Avg_dens$x, SIAP_4_Avg_dens$y, SIAP_4_Avg_dens$bw, SIAP_4_Avg_dens$n, "SIAP\n2003-2021\nAverage\n\n", "Municipal averages by cultivation type\n(irrigation and temporal)", "SIAP_4_Avg")
names(SIAP_4_Avg_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

SIAP_4_Avg_T = SIAP_4 %>% group_by(EstadoMunicipio) %>% summarise(AvgYield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
SIAP_4_Avg_T_dens = density(SIAP_4_Avg_T$AvgYield, na.rm=T, from=0)
SIAP_4_Avg_T_dens2 <- data.frame(SIAP_4_Avg_T_dens$x, SIAP_4_Avg_T_dens$y, SIAP_4_Avg_T_dens$bw, SIAP_4_Avg_T_dens$n, "SIAP\n2003-2021\nAverage\n\n", "Overall municipal averages", "SIAP_4_Avg_T")
names(SIAP_4_Avg_T_dens2) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Data", "Series")

Dens.df = rbind(EarlyColonial_dens2, LateColonial_dens2, SandersAztec_dens2, AGCensus1960_T_dens2, AGCensus1960_A_dens2, AGCensus1970_T_dens2, AGCensus1970_A_dens2, SandersC20_dens2, AGCensus1991_dens2, SIAP_4_2003_dens2, SIAP_4_2003a_dens2, AGCensus2007_dens2, SIAP_4_2020_dens2, SIAP_4_2020a_dens2, SIAP_4_Avg_dens2, SIAP_4_Avg_T_dens2)


CY_prob_dens_list <- list(EarlyColonial_dens, LateColonial_dens, SandersAztec_dens, AGCensus1960_T_dens, AGCensus1960_A_dens, AGCensus1960_L_dens, AGCensus1960_S_dens, AGCensus1960_E_dens, AGCensus1960_BOM_A_dens, AGCensus1960_BOM_T_dens, AGCensus1960_BOM_L_dens, AGCensus1960_BOM_S_dens, AGCensus1960_BOM_E_dens,                   AGCensus1970_T_dens, AGCensus1970_A_dens, AGCensus1970_L_dens, AGCensus1970_S_dens, AGCensus1970_E_dens, AGCensus1970_BOM_A_dens, AGCensus1970_BOM_T_dens, AGCensus1970_BOM_L_dens, AGCensus1970_BOM_S_dens,AGCensus1970_BOM_E_dens,  SandersC20_dens, AGCensus1991_dens, SIAP_4_2003_dens, SIAP_4_2003a_dens, AGCensus2007_dens, SIAP_4_2020_dens, SIAP_4_2020a_dens, SIAP_4_Avg_dens, SIAP_4_Avg_T_dens)
names(CY_prob_dens_list) <- c("EarlyColonial_dens", "LateColonial_dens", "SandersAztec_dens", "AGCensus1960_T_dens", "AGCensus1960_A_dens", "AGCensus1960_L_dens", "AGCensus1960_S_dens", "AGCensus1960_E_dens", "AGCensus1960_BOM_A_dens", "AGCensus1960_BOM_T_dens", "AGCensus1960_BOM_L_dens", "AGCensus1960_BOM_S_dens", "AGCensus1960_BOM_E_dens",  "AGCensus1970_T_dens", "AGCensus1970_A_dens", "AGCensus1970_L_dens","AGCensus1970_S_dens", "AGCensus1970_E_dens", "AGCensus1970_BOM_A_dens", "AGCensus1970_BOM_T_dens", "AGCensus1970_BOM_L_dens", "AGCensus1970_BOM_S_dens", "AGCensus1970_BOM_E_dens",  "SandersC20_dens", "AGCensus1991_dens", "SIAP_4_2003_dens", "SIAP_4_2003a_dens", "AGCensus2007_dens", "SIAP_4_2020_dens", "SIAP_4_2020a_dens", "SIAP_4_Avg_dens", "SIAP_4_Avg_T_dens")

CY_df_list <- list(EarlyColonial, LateColonial, AGCensus1960_A, AGCensus1960_T, AGCensus1960_S, AGCensus1960_L, AGCensus1960_E, AGCensus1960_BOM_A, AGCensus1960_BOM_T, AGCensus1960_BOM_L, AGCensus1960_BOM_S, AGCensus1960_BOM_E, AGCensus1970_A, AGCensus1970_T, AGCensus1970_S, AGCensus1970_L, AGCensus1970_E, AGCensus1970_BOM_A, AGCensus1970_BOM_T, AGCensus1970_BOM_L, AGCensus1970_BOM_S, AGCensus1970_BOM_E, AGCensus1991_T, AGCensus2007_T, SIAP_4_2003, SIAP_4_2003a, SIAP_4_2020, SIAP_4_2020a, SIAP_4_Avg, SIAP_4_Avg_T)
names(CY_df_list) <- c("EarlyColonial", "LateColonial", "AGCensus1960_A", "AGCensus1960_T", "AGCensus1960_S", "AGCensus1960_L", "AGCensus1960_E", "AGCensus1960_BOM_A", "AGCensus1960_BOM_T", "AGCensus1960_BOM_L", "AGCensus1960_BOM_S", "AGCensus1960_BOM_E", "AGCensus1970_A", "AGCensus1970_T", "AGCensus1970_S", "AGCensus1970_L", "AGCensus1970_E", "AGCensus1970_BOM_A", "AGCensus1970_BOM_T", "AGCensus1970_BOM_L", "AGCensus1970_BOM_S", "AGCensus1970_BOM_E",  "AGCensus1991_T", "AGCensus2007_T", "SIAP_4_2003", "SIAP_4_2003a", "SIAP_4_2020", "SIAP_4_2020a", "SIAP_4_Avg", "SIAP_4_Avg_T")

CY_data_list <- list(Colonial, AGCensus1960, AGCensus1970, AGCensus1991, AGCensus2007, SandersAztec, SandersC20)
names(CY_data_list) <- c("Colonial", "AGCensus1960", "AGCensus1970", "AGCensus1991", "AGCensus2007", "SandersAztec", "SandersC20")

rm(EarlyColonial_dens2, LateColonial_dens2, SandersAztec_dens2, AGCensus1960_T_dens2, AGCensus1960_A_dens2, AGCensus1970_T_dens2, AGCensus1970_A_dens2, SandersC20_dens2, AGCensus1991_dens2, SIAP_4_2003_dens2, SIAP_4_2003a_dens2, AGCensus2007_dens2, SIAP_4_2020_dens2, SIAP_4_2020a_dens2, SIAP_4_Avg_dens2, SIAP_4_Avg_T_dens2, s, nnn, EarlyColonial_dens, LateColonial_dens, SandersAztec_dens,    AGCensus1960_T_dens, AGCensus1960_A_dens, AGCensus1960_L_dens, AGCensus1960_S_dens, AGCensus1960_E_dens, AGCensus1960_BOM_A_dens, AGCensus1960_BOM_T_dens, AGCensus1960_BOM_L_dens, AGCensus1960_BOM_S_dens, AGCensus1960_BOM_E_dens,  AGCensus1970_T_dens, AGCensus1970_A_dens, AGCensus1970_L_dens, AGCensus1970_S_dens, AGCensus1970_E_dens, AGCensus1970_BOM_A_dens, AGCensus1970_BOM_T_dens, AGCensus1970_BOM_L_dens, AGCensus1970_BOM_S_dens, AGCensus1970_BOM_E_dens, SandersC20_dens, AGCensus1991_dens, SIAP_4_2003_dens, SIAP_4_2003a_dens, AGCensus2007_dens, SIAP_4_2020_dens, SIAP_4_2020a_dens, SIAP_4_Avg_dens, SIAP_4_Avg_T_dens,EarlyColonial, LateColonial, AGCensus1960_A, AGCensus1960_T, AGCensus1960_S, AGCensus1960_L, AGCensus1960_E, AGCensus1960_BOM_A, AGCensus1960_BOM_T, AGCensus1960_BOM_L, AGCensus1960_BOM_S, AGCensus1960_BOM_E, 
      AGCensus1970_A, AGCensus1970_T, AGCensus1970_S, AGCensus1970_L, AGCensus1970_E, AGCensus1970_BOM_A, AGCensus1970_BOM_T, AGCensus1970_BOM_L, AGCensus1970_BOM_S, AGCensus1970_BOM_E, AGCensus1991_T, AGCensus2007_T, SIAP_4_2003, SIAP_4_2003a, SIAP_4_2020, SIAP_4_2020a, SIAP_4_Avg, SIAP_4_Avg_T, Colonial, AGCensus1960, AGCensus1970, AGCensus1991, AGCensus2007, SandersAztec, SandersC20)
```

  

  
  
## Ridgeline Density Plot

  SIAP_4_Avg_T_dens2$Height = 1200
SIAP_4_Avg_dens2$Height = 1200
SIAP_4_2020a_dens2$Height = 2000
SIAP_4_2020_dens2$Height = 2000
AGCensus2007_dens2$Height = 2000
SIAP_4_2003a_dens2$Height = 1500
SIAP_4_2003_dens2$Height = 1500
SandersC20_dens2$Height = 1300
SandersAztec_dens2$Height = 550
AGCensus2007_dens2$Height = 1200
AGCensus1991_dens2$Height = 900
AGCensus1960_A_dens2$Height = 350
AGCensus1960_T_dens2$Height = 350
LateColonial_dens2$Height = 1200
EarlyColonial_dens2$Height = 2500
Dens.df$Label <- factor(Dens.df$Label, levels = c("Early\nColonial\n(16th Century)\n\n", "Late\nColonial\n(18th Century)\n\n", "Sanders\nAztec\nModel**\n\n", "1960\nAgricultural\nCensus\n\n", "Sanders\nmid-20th\nCentury**\n\n", "1991\nAgricultural\nCensus\n\n", "SIAP 2003\n", "2007\nAgricultural\nCensus\n\n", "SIAP 2020\n", "SIAP\n2003-2021\nAverage\n\n"))

Dens.df$Data <- factor(Dens.df$Data, levels = c("Overall municipal averages", "Municipal averages by cultivation type\n(irrigation and temporal)", "Municipal averages by type of land tenure\n(ejidos, large (>5 ha) and small (<5 ha) holdings)", "Sample of historically documented local-level yields", "Sample of ethnographically recorded local-level yields", "Carrying capacity model derived from\nmid-20th century data"))

```{r, label='Ridgeline Density Plot', message=FALSE,warning=FALSE}

if (!require("desiderata")) {remotes::install_github("DesiQuintans/desiderata")}

Dens.df = Dens.df %>% mutate(
    Height = case_when(
      Series == "SIAP_4_Avg_T" ~ 1200,
      Series == "SIAP_4_Avg" ~ 1200,
      Series == "SIAP_4_2020a" ~ 2000,
      Series == "SIAP_4_2020" ~ 2000,
      Series == "AGCensus2007_T" ~ 1200,
      Series == "SIAP_4_2003a" ~ 1500,
      Series == "SIAP_4_2003" ~ 1500,
      Series == "SandersC20" ~ 1300,
      Series == "SandersAztec" ~ 550,
      Series == "AGCensus1991_T" ~ 900,
      Series == "AGCensus1970_A" ~ 275,
      Series == "AGCensus1970_T" ~ 275,
      Series == "AGCensus1960_A" ~ 350,
      Series == "AGCensus1960_T" ~ 350,
      Series == "LateColonial" ~ 1200,
      Series == "EarlyColonial" ~ 2500),
    Label = factor(Label, levels = c(
      "Early\nColonial\n(16th Century)\n\n", 
      "Late\nColonial\n(18th Century)\n\n", 
      "Sanders\nAztec\nModel**\n\n", 
      "1960\nAgricultural\nCensus\n\n", 
      "Sanders\nmid-20th\nCentury**\n\n", 
      "1970\nAgricultural\nCensus\n\n", 
      "1991\nAgricultural\nCensus\n\n", 
      "SIAP 2003\n", 
      "2007\nAgricultural\nCensus\n\n", 
      "SIAP 2020\n", 
      "SIAP\n2003-2021\nAverage\n\n")),
    Data = factor(Data, levels = c(
      "Overall municipal averages", 
      "Municipal averages by cultivation type\n(irrigation and temporal)", 
      "Municipal averages by type of land tenure\n(ejidos, large (>5 ha) and small (<5 ha) holdings)", 
      "Sample of historically documented local-level yields", 
      "Sample of ethnographically recorded local-level yields", 
      "Carrying capacity model derived from\nmid-20th century data")))

ggp1 <- ggplot() + 
  geom_ridgeline(data=Dens.df, aes(x=Yield, y=Label, height=Density*Height, fill=Data, color=Data), alpha=0.2,size=0.5)+
  scale_fill_discrete(name = "Type of Data", drop = FALSE) +
  scale_colour_discrete(name = "Type of Data", drop = FALSE)+
  guides(fill = guide_legend(byrow = TRUE), color = guide_legend(byrow = TRUE)) +
  labs(x ="Maize Yield (kg / ha)", y = "Probability Density")+#title="Bayesian Construction of Regional-Scale Popularity Curves", subtitle = "Ceramic Complexes in the S. Basin of Mexico", 
    #guides(fill = guide_legend(nrow = 3))+
  theme_bw()+
  #scale_y_discrete(expand = c(.05, .05)) +
  scale_x_continuous(limits= c(0,11000), breaks=seq(0,11000,1000)) +#,breaks = MyBreaks,labels = MyLabs
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
        axis.text.y = element_text(color="black", face="bold", size=10), 
        axis.title.x = element_text(color="black", size=16, face="bold"),
        axis.title.y = element_text(color="black", size=16, face="bold"),
        legend.justification=c(0,1), legend.position=c(0.55,0.55), 
        legend.title=element_text(color="black", face="bold", size = 14),#element_blank(),
        legend.spacing.y = unit(0.2,"cm"),
        legend.key = element_rect(colour = "transparent", fill = "transparent"),
        legend.text = element_text(colour="black", size = 10),
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')) 
         # plot.title = element_text(hjust = 0.5, face="bold"), plot.subtitle = element_text(hjust = 0.5, face="bold"))+theme(plot.background = element_rect(fill = "white", colour = NA))
ggp1 = ggp1 + rotate_y_text(angle = 0, align = 0.5, valign = 0.5)
ggp1 <- add_sub(ggp1, "**These two data series pertain to the Basin of Mexico (BOM) only, while all others pertain to the broader Central Mexico study region.", x = 1, hjust = 1, size = 11)
#save figure
ggsave("RidgelineComparativeYields.png", plot = ggp1, device = "png", path = wd$figs, scale = 1, width = 10, height = 7,   units = "in",  dpi = 1500)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"RidgelineComparativeYields.png"), FALSE)


#rm(ggp1, Dens.df)

```

### Gamma Tests


```{r, label='Comparative Yields Gamma Tests', message=FALSE,warning=FALSE}


gamma_test(CY_df_list[["AGCensus1960_T"]]$Maize1960_kgha)
gamma_test(CY_df_list[["AGCensus1960_A"]]$Maize1960_kgha)
gamma_test(CY_df_list[["AGCensus1970_T"]]$Yield_S)
gamma_test(CY_df_list[["AGCensus1970_A"]]$Yield_S)
gamma_test(CY_df_list[["LateColonial"]]$Yield)
gamma_test(CY_df_list[["EarlyColonial"]]$Yield)
gamma_test(CY_df_list[["AGCensus1991_T"]]$Yield)
gamma_test(CY_df_list[["AGCensus2007_T"]]$Yield)
gamma_test(CY_data_list[["SandersAztec"]]$Yield)
gamma_test(CY_data_list[["SandersC20"]]$YieldAvg)
gamma_test(CY_df_list[["SIAP_4_2003"]]$Yield[CY_df_list[["SIAP_4_2003"]]$Yield > 0])
gamma_test(CY_df_list[["SIAP_4_2003a"]]$Yield[CY_df_list[["SIAP_4_2003a"]]$Yield > 0])
gamma_test(CY_df_list[["SIAP_4_2020"]]$Yield[CY_df_list[["SIAP_4_2020"]]$Yield > 0])
gamma_test(CY_df_list[["SIAP_4_2020a"]]$Yield[CY_df_list[["SIAP_4_2020a"]]$Yield > 0])
gamma_test(CY_df_list[["SIAP_4_Avg"]]$AvgYield)
gamma_test(CY_df_list[["SIAP_4_Avg_T"]]$AvgYield)

#gamma_fit(x)
```





### Kruskal-Wallis & Dunn Test


```{r}

x1 = data.frame(CY_df_list[["LateColonial"]]$Yield, "Early Colonial")
names(x1) = c("Yield", "Series")
x2 = data.frame(CY_df_list[["LateColonial"]]$Yield, "Late Colonial")
names(x2) = c("Yield", "Series")
x3 = data.frame(CY_data_list[["SandersAztec"]]$Yield, "Sanders Aztec Model")
names(x3) = c("Yield", "Series")
x4 = data.frame(CY_df_list[["AGCensus1960_T"]]$Maize1960_kgha, "AG Census 1960 - Average")
names(x4) = c("Yield", "Series")
x5 = data.frame(CY_df_list[["AGCensus1960_A"]]$Maize1960_kgha, "AG Census 1960 - All Cases")
names(x5) = c("Yield", "Series")
x6 = data.frame(CY_data_list[["SandersC20"]]$YieldAvg, "Sanders Ethnographic Sample")
names(x6) = c("Yield", "Series")
x6B = data.frame(CY_df_list[["AGCensus1970_T"]]$Yield_S, "AG Census 1970 - Average")
names(x6B) = c("Yield", "Series")
x6C = data.frame(CY_df_list[["AGCensus1970_A"]]$Yield_S, "AG Census 1970 - All Cases")
names(x6C) = c("Yield", "Series")
x7 = data.frame(CY_df_list[["AGCensus1991_T"]]$Yield, "AG Census 1991 - Average")
names(x7) = c("Yield", "Series")
x8 = data.frame(CY_df_list[["SIAP_4_2003"]]$Yield, "SIAP 2003 - Average")
names(x8) = c("Yield", "Series")
x9 = data.frame(CY_df_list[["SIAP_4_2003a"]]$Yield, "SIAP 2003 - Average")
names(x9) = c("Yield", "Series")
x10 = data.frame(CY_df_list[["AGCensus2007_T"]]$Yield, "AG Census 2007 - All Cases")
names(x10) = c("Yield", "Series")
x11 = data.frame(CY_df_list[["SIAP_4_2020a"]]$Yield, "SIAP 2021 - Average")
names(x11) = c("Yield", "Series")
x12 = data.frame(CY_df_list[["SIAP_4_2020"]]$Yield, "SIAP 2021 - All Cases")
names(x12) = c("Yield", "Series")
x13 = data.frame(CY_df_list[["SIAP_4_Avg_T"]]$AvgYield, "SIAP 2003-2021 - Average")
names(x13) = c("Yield", "Series")
x14 = data.frame(CY_df_list[["SIAP_4_Avg"]]$AvgYield, "SIAP 2003-2021 - All Cases")
names(x14) = c("Yield", "Series")

dat = rbind(x1, x2, x3, x4, x5, x6, x6B, x6C, x7, x8, x9, x10, x11, x12, x13, x14)
dat = dat[complete.cases(dat), ]

kruskal.test(Yield ~ Series,
  data = dat
)

dunnTest(Yield ~ Series,
  data = dat,
  method = "holm"
)

ggbetweenstats(
  data = dat,
  x = Series,
  y = Yield,
  type = "nonparametric", # ANOVA or Kruskal-Wallis
  pairwise.display = "significant", # "significant" "non-significant" "all"
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  #plot.type = "box",
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 1500, segment.linetype = 0,     min.segment.length = 0),
  pairwise.comparisons = F,
  centrality.plotting = T,
  bf.message = FALSE
)

knitr::kable(z,  booktabs = TRUE)



  pack_rows(index = c("Sanders' Ethnographic Sample" = 1, "BOM 1960 Agricultural Census" = 5)) %>% 
  add_header_above(c(" " = 1, "Distance / Divergence Metrics" = 4, "Kolmogorov–Smirnov Test" = 2)) %>% 
  add_header_above(c("Difference / Similarity to Sanders' Aztec BOM Carrying Capacity Model" = 7))

rm(x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14)
```









## Sanders Data and 1960 Census


Here we compare Sanders' carrying capacity model to the 1960 AG Census and Sanders' mid-20th century ethnographic yield data

#### Ridgeline Plot

As seen in the plot below,

```{r, label='Sanders Aztec Model Ridgeline Plot', message=FALSE,warning=FALSE}

az = Dens.df %>% filter(Series == "SandersAztec") %>% select(-Data,-Height) %>% mutate(Label = "Sanders\nAztec\nModel\n")
sand = Dens.df %>% filter(Series == "SandersC20") %>% select(-Data,-Height) %>% mutate(Label = "Sanders\nEthnographic\nSample\n")
l <- data.frame(CY_prob_dens_list[["AGCensus1960_BOM_L_dens"]]$x, CY_prob_dens_list[["AGCensus1960_BOM_L_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_L_dens"]]$bw, CY_prob_dens_list[["AGCensus1960_BOM_L_dens"]]$n, "BOM 1960\nAgricultural\nCensus\nLarge (>5 ha)\n", "L")
names(l) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Series")
s <- data.frame(CY_prob_dens_list[["AGCensus1960_BOM_S_dens"]]$x, CY_prob_dens_list[["AGCensus1960_BOM_S_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_S_dens"]]$bw, CY_prob_dens_list[["AGCensus1960_BOM_S_dens"]]$n, "BOM 1960\nAgricultural\nCensus\nSmall (<5 ha)\n", "S")
names(s) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Series")
e <- data.frame(CY_prob_dens_list[["AGCensus1960_BOM_E_dens"]]$x, CY_prob_dens_list[["AGCensus1960_BOM_E_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_E_dens"]]$bw, CY_prob_dens_list[["AGCensus1960_BOM_E_dens"]]$n, "BOM 1960\nAgricultural\nCensus\nEjidos\n", "E")
names(e) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Series")
t <- data.frame(CY_prob_dens_list[["AGCensus1960_BOM_T_dens"]]$x, CY_prob_dens_list[["AGCensus1960_BOM_T_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_T_dens"]]$bw, CY_prob_dens_list[["AGCensus1960_BOM_T_dens"]]$n, "BOM 1960\nAgricultural\nCensus\nAverage\n", "T")
names(t) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Series")
a <- data.frame(CY_prob_dens_list[["AGCensus1960_BOM_A_dens"]]$x, CY_prob_dens_list[["AGCensus1960_BOM_A_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_A_dens"]]$bw, CY_prob_dens_list[["AGCensus1960_BOM_A_dens"]]$n, "BOM 1960\nAgricultural\nCensus\nAll Cases\n", "A")
names(a) <- c("Yield", "Density", "Bandwidth", "n", "Label", "Series")
SandersAztecDens = rbind(az,t,s,l,e,a,sand)



SandersAztecDens = SandersAztecDens %>% mutate(
    Height = case_when(
      Series == "SandersAztec" ~ 650,
      Series == "SandersC20" ~ 1000,
      Series == "T" ~ 330,
      Series == "A" ~ 400,
      Series == "L" ~ 350,
      Series == "S" ~ 330,
      Series == "E" ~ 350),
    Label = factor(Label, levels = c(
      "Sanders\nAztec\nModel\n", 
      "BOM 1960\nAgricultural\nCensus\nAverage\n", 
      "BOM 1960\nAgricultural\nCensus\nLarge (>5 ha)\n",
      "BOM 1960\nAgricultural\nCensus\nSmall (<5 ha)\n",
      "BOM 1960\nAgricultural\nCensus\nEjidos\n",
      "BOM 1960\nAgricultural\nCensus\nAll Cases\n",
      "Sanders\nEthnographic\nSample\n")))

ggp1 <- ggplot() + 
  geom_ridgeline(data=SandersAztecDens, aes(x=Yield, y=Label, height=Density*Height, 
                                            fill=Label,
                                            ), color = "black", alpha=0.2,size=0.5)+
  scale_fill_brewer(palette="Set3", guide="none")+
  #scale_colour_discrete(guide="none", drop = FALSE)+
  #guides(fill = "none", color = "none") +
  #guides(fill = guide_legend(byrow = TRUE), color = guide_legend(byrow = TRUE)) +
  labs(x ="Maize Yield (kg / ha)", y = "Probability Density")+#title="Bayesian Construction of Regional-Scale Popularity Curves", subtitle = "Ceramic Complexes in the S. Basin of Mexico", 
    #guides(fill = guide_legend(nrow = 3))+
  theme_bw()+
  #scale_y_discrete(expand = c(.05, .05)) +
  scale_x_continuous(limits= c(0,5500), breaks=seq(0,5500,500)) +#,breaks = MyBreaks,labels = MyLabs
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
        axis.text.y = element_text(color="black", face="bold", size=10), 
        axis.title.x = element_text(color="black", size=16, face="bold"),
        axis.title.y = element_text(color="black", size=16, face="bold"))
        #legend.justification=c(0,1), legend.position="none",#c(0.55,0.55), 
        #legend.title=element_text(color="black", face="bold", size = 14),#element_blank(),
        #legend.spacing.y = unit(0.2,"cm"),
        #legend.key = element_rect(colour = "transparent", fill = "transparent"),
        #legend.text = element_text(colour="black", size = 10),
        #legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')) 
         # plot.title = element_text(hjust = 0.5, face="bold"), plot.subtitle = element_text(hjust = 0.5, face="bold"))+theme(plot.background = element_rect(fill = "white", colour = NA))
ggp1 = ggp1 + rotate_y_text(angle = 0, align = 0.5, valign = 0.5)
#ggp1 <- add_sub(ggp1, "**These two data series pertain to the Basin of Mexico (BOM) only, while all others pertain to the broader Central Mexico study region.", x = 1, hjust = 1, size = 11)
#save figure
ggsave("RidgelineSanders1960.png", plot = ggp1, device = "png", path = wd$figs, scale = 1, width = 10, height = 7,   units = "in",  dpi = 1500)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"RidgelineSanders1960.png"), FALSE)


#rm(ggp1, Dens.df)
rm(az,t,s,l,e,a,sand,SandersAztecDens,ggp1)


```



#### Statistical Distance / Divergence

Statistical comparison of their probability density functions (PDFs) -- i.e. the shape of their univariate distributions, as computed via kernel density estimation on the original data series

```{r, label='Statistical Distance / Divergence', message=FALSE,warning=FALSE}

#if (!require("philentropy")) {install.packages("philentropy")}
#require("philentropy")

KS1 = ks.test(CY_data_list[["SandersC20"]]$YieldAvg, CY_data_list[["SandersAztec"]]$Yield)
KS2 = ks.test(CY_df_list[["AGCensus1960_BOM_T"]]$Maize1960_kgha, CY_data_list[["SandersAztec"]]$Yield)
KS3 = ks.test(CY_df_list[["AGCensus1960_BOM_L"]]$Maize1960_kgha, CY_data_list[["SandersAztec"]]$Yield)
KS4 = ks.test(CY_df_list[["AGCensus1960_BOM_S"]]$Maize1960_kgha, CY_data_list[["SandersAztec"]]$Yield)
KS5 = ks.test(CY_df_list[["AGCensus1960_BOM_E"]]$Maize1960_kgha, CY_data_list[["SandersAztec"]]$Yield)
KS6 = ks.test(CY_df_list[["AGCensus1960_BOM_A"]]$Maize1960_kgha, CY_data_list[["SandersAztec"]]$Yield)

kss = c(KS1$statistic, KS2$statistic, KS3$statistic, KS4$statistic, KS5$statistic, KS6$statistic)
ksp = c(KS1$p.value, KS2$p.value, KS3$p.value, KS4$p.value, KS5$p.value, KS6$p.value)
y = CY_prob_dens_list[["SandersAztec_dens"]]$y
x = rbind(CY_prob_dens_list[["SandersC20_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_T_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_L_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_S_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_E_dens"]]$y, CY_prob_dens_list[["AGCensus1960_BOM_A_dens"]]$y)

euclid = dist_one_many(y, x, method = "euclidean", testNA = FALSE)
kl = dist_one_many(y, x, method = "kullback-leibler", testNA = FALSE)
js = dist_one_many(y, x, method = "jensen-shannon", testNA = FALSE)
h = dist_one_many(y, x, method = "hellinger", testNA = FALSE)
dat = as.data.frame(t(rbind(euclid,kl,js,h, kss, ksp)))
#"Sanders' Ethnographic Sample"

n <- c(" ", "Municipal Average", "Large (>5 ha)", "Small (<5 ha)", "Ejidos", "All Cases")
#m = c("Sanders' Ethnographic Sample", "BOM 1960 Agricultural Census", "BOM 1960 Agricultural Census", "BOM 1960 Agricultural Census", "BOM 1960 Agricultural Census", "BOM 1960 Agricultural Census")
dat = cbind(n,dat)
rownames(dat) = NULL
colnames(dat) <- c("  ", "Euclidean", "Kullback-Leibler", "Jensen-Shannon", "Hellinger", "D statistic", "probability")
knitr::kable(dat, col.names = gsub("[.]", " ", names(dat)), digits = 4, booktabs = TRUE, align = c('lccccc')) %>%
  pack_rows(index = c("Sanders' Ethnographic Sample" = 1, "BOM 1960 Agricultural Census" = 5)) %>% 
  add_header_above(c(" " = 1, "Distance / Divergence Metrics" = 4, "Kolmogorov–Smirnov Test" = 2)) %>% 
  add_header_above(c("Difference / Similarity to Sanders' Aztec BOM Carrying Capacity Model" = 7))

rm(x,y,kl,js,h,dat,n, kss, ksp, KS1, KS2, KS3, KS4, KS5, KS6)



```

#### K-S Test 95% C.I. Plots

```{r}


ecdf.ks.CI(CY_data_list[["SandersC20"]]$YieldAvg, family="sans", main= "SandersC20", cex.main=2, font.main=2, font.lab=2, xlab="Maize Yield (kg / ha)", ylab="ECDF(Maize Yield)")
lines(ecdf(CY_data_list[["SandersAztec"]]$Yield), do.points = T, verticals=F, lwd=2, col="blue")

ecdf.ks.CI(CY_df_list[["AGCensus1960_BOM_T"]]$Maize1960_kgha, family="sans", main= "AGCensus1960_BOM_T", cex.main=2, font.main=2, font.lab=2, xlab="Maize Yield (kg / ha)", ylab="ECDF(Maize Yield)")
lines(ecdf(CY_data_list[["SandersAztec"]]$Yield), do.points = T, verticals=F, lwd=2, col="blue")

ecdf.ks.CI(CY_df_list[["AGCensus1960_BOM_S"]]$Maize1960_kgha, family="sans", main= "AGCensus1960_BOM_S", cex.main=2, font.main=2, font.lab=2, xlab="Maize Yield (kg / ha)", ylab="ECDF(Maize Yield)")
lines(ecdf(CY_data_list[["SandersAztec"]]$Yield), do.points = T, verticals=F, lwd=2, col="blue")

ecdf.ks.CI(CY_df_list[["AGCensus1960_BOM_L"]]$Maize1960_kgha, family="sans", main= "AGCensus1960_BOM_L", cex.main=2, font.main=2, font.lab=2, xlab="Maize Yield (kg / ha)", ylab="ECDF(Maize Yield)")
lines(ecdf(CY_data_list[["SandersAztec"]]$Yield), do.points = T, verticals=F, lwd=2, col="blue")

ecdf.ks.CI(CY_df_list[["AGCensus1960_BOM_E"]]$Maize1960_kgha, family="sans", main= "AGCensus1960_BOM_E", cex.main=2, font.main=2, font.lab=2, xlab="Maize Yield (kg / ha)", ylab="ECDF(Maize Yield)")
lines(ecdf(CY_data_list[["SandersAztec"]]$Yield), do.points = T, verticals=F, lwd=2, col="blue")

ecdf.ks.CI(CY_df_list[["AGCensus1960_BOM_A"]]$Maize1960_kgha, family="sans", main= "AGCensus1960_BOM_A", cex.main=2, font.main=2, font.lab=2, xlab="Maize Yield (kg / ha)", ylab="ECDF(Maize Yield)")
lines(ecdf(CY_data_list[["SandersAztec"]]$Yield), do.points = T, verticals=F, lwd=2, col="blue")

#ks.test(CY_df_list[["AGCensus1960_BOM_T"]]$Maize1960_kgha, "pnorm",fitdistr(CY_df_list[["AGCensus1960_BOM_T"]]$Maize1960_kgha, "normal")$estimate[1], fitdistr(CY_df_list[["AGCensus1960_BOM_T"]]$Maize1960_kgha, "normal")$estimate[2])

```


#### Kruskal-Wallis & Dunn Test

```{r}

x1 = data.frame(CY_data_list[["SandersC20"]]$YieldAvg, "Sanders Ethnographic Sample")
names(x1) = c("Yield", "Series")
x2 = data.frame(CY_data_list[["SandersAztec"]]$Yield, "Sanders Aztec Model")
names(x2) = c("Yield", "Series")
x3 = data.frame(CY_df_list[["AGCensus1960_BOM_T"]]$Maize1960_kgha, "AG Census 1960 - Average")
names(x3) = c("Yield", "Series")
x4 = data.frame(CY_df_list[["AGCensus1960_BOM_E"]]$Maize1960_kgha, "AG Census 1960 - Ejidos")
names(x4) = c("Yield", "Series")
x5 = data.frame(CY_df_list[["AGCensus1960_BOM_S"]]$Maize1960_kgha, "AG Census 1960 - Small")
names(x5) = c("Yield", "Series")
x6 = data.frame(CY_df_list[["AGCensus1960_BOM_L"]]$Maize1960_kgha, "AG Census 1960 - Large")
names(x6) = c("Yield", "Series")
x7 = data.frame(CY_df_list[["AGCensus1960_BOM_A"]]$Maize1960_kgha, "AG Census 1960 - All Cases")
names(x7) = c("Yield", "Series")

dat = rbind(x1, x2, x3, x4, x5, x6, x7)
dat = dat[complete.cases(dat), ]

kruskal.test(Yield ~ Series,
  data = dat
)

dunnTest(Yield ~ Series,
  data = dat,
  method = "holm"
)

ggbetweenstats(
  data = dat,
  x = Series,
  y = Yield,
  type = "nonparametric", # ANOVA or Kruskal-Wallis
  pairwise.display = "non-significant", # "significant" "non-significant"
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  #plot.type = "box",
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 1500, segment.linetype = 0,     min.segment.length = 0),
  pairwise.comparisons = TRUE,
  centrality.plotting = T,
  bf.message = FALSE
)


rm(x1, x2, x3, x4, x5, x6, x7)
```


```{r}
#dat2 = dat %>% filter(!(Series %in% c("Sanders Ethnographic Sample")))

dat2 = dat %>% filter((Series %in% c("Sanders Ethnographic Sample", "Sanders Aztec Model", "AG Census 1960 - All Cases")))

kruskal.test(Yield ~ Series,
  data = dat2
)

dunnTest(Yield ~ Series,
  data = dat2,
  method = "holm"
)

ggbetweenstats(
  data = dat2,
  x = Series,
  y = Yield,
  type = "nonparametric", # ANOVA or Kruskal-Wallis
  pairwise.display = "all", # "significant" "non-significant"
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  #plot.type = "box",
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 1500, segment.linetype = 0,     min.segment.length = 0),
  pairwise.comparisons = TRUE,
  centrality.plotting = T,
  bf.message = FALSE
)

```





## Analysis of Variance

https://statsandr.com/blog/anova-in-r/
https://statsandr.com/blog/kruskal-wallis-test-nonparametric-version-anova/

x2
```{r, label='MANOVA Violin Plots', message=FALSE,warning=FALSE}
kruskal.test(flipper_length_mm ~ species,
  data = dat
)



dunnTest(flipper_length_mm ~ species,
  data = dat,
  method = "holm"
)


ggbetweenstats(
  data = dat,
  x = species,
  y = flipper_length_mm,
  type = "nonparametric", # ANOVA or Kruskal-Wallis
  plot.type = "box",
  pairwise.comparisons = TRUE,
  pairwise.display = "significant",
  centrality.plotting = FALSE,
  bf.message = FALSE
)




CY <- read.csv(paste0(wd$data_r,"ComparativeYields.csv"))
CY$Series <- factor(CY$Series, levels = c("AG Census 1960", "Sanders Aztec BOM Model", "AG Census 1991", "Sanders mid-20th Century BOM", "SIAP 2003-2021 Average"))
x = ggbetweenstats(
  data = dplyr::filter(CY, Size == "Total"),
  x = Series, ## grouping/independent variable
  y = Yield, ## dependent variables
  type = "robust", ## type of statistics
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  ## turn off messages
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 3000, segment.linetype = 0,
    min.segment.length = 0)
) + ## modifying the plot further
  ggplot2::scale_y_continuous(
    limits = c(0, 7000),
    breaks = seq(from = 0, to = 7000, by = 500)
  ) 
x

CY2 <- read.csv(paste0(wd$data_r,"ComparativeYields.csv"))

CY2 = CY2 %>% filter(Series == "Sanders mid-20th Century BOM" | Series == "AG Census 1960" | Series == "Sanders Aztec BOM Model") %>% rowwise() %>% mutate(Size = ifelse(Series == "Sanders mid-20th Century BOM" | Series == "Sanders Aztec BOM Model", '', Size)) %>% ungroup() %>% unite(SizeSeries, Series, Size, sep = "\n") %>% mutate_all(~ str_replace_all(., c(" BOM" = ""))) %>% mutate(Yield = as.numeric(Yield))
CY2$Series <- factor(CY2$SizeSeries, levels = c("Sanders mid-20th Century\n", "Sanders Aztec Model\n", "AG Census 1960\nSmall", "AG Census 1960\nLarge", "AG Census 1960\nEjido", "AG Census 1960\nTotal"))
x2 = ggbetweenstats(
  data = dplyr::filter(CY2, !is.na(Yield)),
  x = Series, ## grouping/independent variable
  y = Yield, ## dependent variables
  type = "robust", ## type of statistics
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  ## turn off messages
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 6000, segment.linetype = 0,
    min.segment.length = 0)
) + ## modifying the plot further
  ggplot2::scale_y_continuous(
    limits = c(0, 7000),
    breaks = seq(from = 0, to = 5000, by = 500)
  ) 












```


## SIAP Histograms 

### Yield

#### Average Yield Histograms

```{r, label='SIAP Yield Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_4,aes(x = Yield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 300, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Maize Yield (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,12000), breaks=seq(0,12000,2000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_4 %>% group_by(EstadoMunicipio, Year) %>% summarize(Yield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
df$Series <- "Municipal Average"
df2 = SIAP_4 %>% select(EstadoMunicipio, Year, Yield) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = Yield)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 300, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  geom_density(aes(group = Series, color = Series, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="Maize Yield (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,12000), breaks=seq(0,12000,2000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType_AvgYield.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

YieldIrrig = SIAP_4 %>% filter(AGType == "Riego") %>% pull(Yield) %>% na.omit
YieldTemp = SIAP_4 %>% filter(AGType == "Temporal") %>% pull(Yield) %>% na.omit
YieldTotal = df %>% filter(Series == "Municipal Average") %>% pull(Yield) %>% na.omit
YieldAll = df %>% filter(Series == "Both Irrigation and Temporal") %>% pull(Yield) %>% na.omit

gamma_test(YieldIrrig[YieldIrrig > 0])
gamma_test(YieldTemp[YieldTemp > 0])
gamma_test(YieldTotal[YieldTotal > 0])
gamma_test(YieldAll[YieldAll > 0])

rm(ggp2, h1, h2, df, df2, YieldIrrig, YieldTemp, YieldTotal, YieldAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType_AvgYield.png"), FALSE)
```


#### St.Dev. Yield Histograms

```{r, label='SIAP SD Yield Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_5,aes(x = sdYield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 100, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=135 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="St.Dev. Maize Yield (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,5000), breaks=seq(0,5000,500)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_6 %>% select(EstadoMunicipio, sdYield_Total) %>% rename(sdYield = sdYield_Total) %>% mutate(Series = "Municipal Average")
df2 = SIAP_5 %>% select(EstadoMunicipio, sdYield) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = sdYield)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 100, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  geom_density(aes(group = Series, color = Series, y=135 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="St.Dev. Maize Yield (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,5000), breaks=seq(0,5000,500)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType_sdYield.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

sdIrrig = SIAP_5 %>% filter(AGType == "Riego") %>% pull(sdYield)
sdTemp = SIAP_5 %>% filter(AGType == "Temporal") %>% pull(sdYield)
sdTotal = df %>% filter(Series == "Municipal Average") %>% pull(sdYield)
sdAll = df %>% filter(Series == "Both Irrigation and Temporal") %>% pull(sdYield)

gamma_test(sdIrrig)
gamma_test(sdTemp)
gamma_test(sdTotal)
gamma_test(sdAll)

rm(ggp2, h1, h2, df, df2, sdIrrig, sdTemp, sdTotal, sdAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType_sdYield.png"), FALSE)
```



#### C.V. Yield Histograms

```{r, label='SIAP CV Yield Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_5,aes(x = cvYield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 5, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=6.75 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="C.V. Maize Yield", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,160), breaks=seq(0,160,10)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_6 %>% select(EstadoMunicipio, cvYield_Total) %>% rename(cvYield = cvYield_Total) %>% mutate(Series = "Municipal Average")
df2 = SIAP_5 %>% select(EstadoMunicipio, cvYield) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = cvYield)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 5, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  geom_density(aes(group = Series, color = Series, y=6.75 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="C.V. Maize Yield", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,160), breaks=seq(0,160,10)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType_cvYield.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

cvIrrig = SIAP_5 %>% filter(AGType == "Riego") %>% pull(cvYield)
cvTemp = SIAP_5 %>% filter(AGType == "Temporal") %>% pull(cvYield)
cvTotal = df %>% filter(Series == "Municipal Average") %>% pull(cvYield)
cvAll = df %>% filter(Series == "Both Irrigation and Temporal") %>% pull(cvYield)

gamma_test(cvIrrig)
gamma_test(cvTemp)
gamma_test(cvTotal)
gamma_test(cvAll)

rm(ggp2, h1, h2, df, df2, cvIrrig, cvTemp, cvTotal, cvAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType_cvYield.png"), FALSE)
```





### Yield Loss

#### Average Yield Loss Histograms


```{r, label='SIAP Yield Loss Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_4,aes(x = YieldLoss)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 250, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  #geom_density(aes(group = AGType, color = AGType, y= ..count..), adjust = 2, size=1, alpha=0.5)+
  #scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Maize Yield Loss (kg / ha)", y = "Count")+
    theme_bw()+
    #scale_y_continuous(trans='log10')+
    scale_x_continuous(limits= c(-125,5000), breaks=seq(0,5000,500)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_4 %>% group_by(EstadoMunicipio, Year) %>% summarize(YieldLoss = mean(YieldLoss, na.rm=T))
df$Series <- "Municipal Average"
df2 = SIAP_4 %>% select(EstadoMunicipio, Year, YieldLoss) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = YieldLoss)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 250, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  #geom_density(aes(group = Series, color = Series, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  #scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="Maize Yield Loss (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(-125,5000), breaks=seq(0,5000,500)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType_YieldLoss.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

YieldLossIrrig = SIAP_4 %>% filter(AGType == "Riego") %>% pull(YieldLoss) %>% na.omit
YieldLossTemp = SIAP_4 %>% filter(AGType == "Temporal") %>% pull(YieldLoss) %>% na.omit
YieldLossTotal = df %>% filter(Series == "Municipal Average") %>% pull(YieldLoss) %>% na.omit
YieldLossAll = df %>% filter(Series == "Both Irrigation and Temporal") %>% pull(YieldLoss) %>% na.omit

gamma_test(YieldLossIrrig[YieldLossIrrig > 0])
gamma_test(YieldLossTemp[YieldLossTemp > 0])
gamma_test(YieldLossTotal[YieldLossTotal > 0])
gamma_test(YieldLossAll[YieldLossAll > 0])

rm(ggp2, h1, h2, df, df2, YieldLossIrrig, YieldLossTemp, YieldLossTotal, YieldLossAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType_YieldLoss.png"), FALSE)
```


#### St.Dev. Yield Loss Histograms

```{r, label='SIAP SD Yield Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_5,aes(x = sdYieldLoss)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 50, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=60 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="St.Dev. Maize Yield Loss (kg / ha)", y = "Count")+
    theme_bw()+
    #scale_x_continuous(limits= c(0,5000), breaks=seq(0,5000,500)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_6 %>% select(EstadoMunicipio, sdYieldLoss_Total) %>% rename(sdYieldLoss = sdYieldLoss_Total) %>% mutate(Series = "Municipal Average")
df2 = SIAP_5 %>% select(EstadoMunicipio, sdYieldLoss) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = sdYieldLoss)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 50, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  geom_density(aes(group = Series, color = Series, y=60 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="St.Dev. Maize Yield Loss (kg / ha)", y = "Count")+
    theme_bw()+
    #scale_x_continuous(limits= c(0,5000), breaks=seq(0,5000,500)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType_sdYieldLoss.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

sdIrrig = SIAP_5 %>% filter(AGType == "Riego") %>% pull(sdYieldLoss) %>% na.omit
sdTemp = SIAP_5 %>% filter(AGType == "Temporal") %>% pull(sdYieldLoss) %>% na.omit
sdTotal = df %>% filter(Series == "Municipal Average") %>% pull(sdYieldLoss) %>% na.omit
sdAll = df %>% filter(Series == "Both Irrigation and Temporal") %>% pull(sdYieldLoss) %>% na.omit

gamma_test(sdIrrig[sdIrrig > 0])
gamma_test(sdTemp[sdTemp > 0])
gamma_test(sdTotal[sdTotal > 0])
gamma_test(sdAll[sdAll > 0])

rm(ggp2, h1, h2, df, df2, sdIrrig, sdTemp, sdTotal, sdAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType_sdYieldLoss.png"), FALSE)
```


#### C.V. Yield Loss Histograms


Disadvantages
When the mean value is close to zero, the CV becomes very sensitive to small changes in the mean

```{r, label='SIAP CV Yield Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_5,aes(x = cvYieldLoss)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 25, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=29 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="C.V. Maize Yield Loss", y = "Count")+
    theme_bw()+
    #scale_x_continuous(limits= c(0,160), breaks=seq(0,160,10)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_6 %>% select(EstadoMunicipio, cvYieldLoss_Total) %>% rename(cvYieldLoss = cvYieldLoss_Total) %>% mutate(Series = "Municipal Average")
df2 = SIAP_5 %>% select(EstadoMunicipio, cvYieldLoss) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = cvYieldLoss)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 25, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  geom_density(aes(group = Series, color = Series, y=29 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="C.V. Maize Yield Loss", y = "Count")+
    theme_bw()+
    #scale_x_continuous(limits= c(0,160), breaks=seq(0,160,10)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.75,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType_cvYieldLoss.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

cvIrrig = SIAP_5 %>% filter(AGType == "Riego") %>% pull(cvYieldLoss) %>% na.omit
cvTemp = SIAP_5 %>% filter(AGType == "Temporal") %>% pull(cvYieldLoss) %>% na.omit
cvTotal = df %>% filter(Series == "Municipal Average") %>% pull(cvYieldLoss) %>% na.omit
cvAll = df %>% filter(Series == "Both Irrigation and Temporal") %>% pull(cvYieldLoss) %>% na.omit

gamma_test(cvIrrig[cvIrrig > 0])
gamma_test(cvTemp[cvTemp > 0])
gamma_test(cvTotal[cvTotal > 0])
gamma_test(cvAll[cvAll > 0])

rm(ggp2, h1, h2, df, df2, cvIrrig, cvTemp, cvTotal, cvAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType_cvYieldLoss.png"), FALSE)
```




### Yield Fluctuation

```{r, label='Yield Fluctuation Data', message=FALSE,warning=FALSE}

z = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  group_by(Municipio, Estado, EstadoMunicipio, Year) %>% 
  summarize(AGType = "Total",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T)) %>% 
  ungroup() %>% 
  group_by(EstadoMunicipio) %>%
  mutate(avg = mean(Yield, na.rm=T),
         sd = sd(Yield, na.rm=T)) %>% ungroup() %>% 
  mutate(Zfluct_Yield = (Yield - avg) / sd) %>%
  ungroup() %>% 
  select(-Yield,-avg,-sd)
  
SIAP_ZFluct_long = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Yield) %>%
  group_by(EstadoMunicipio, AGType) %>%
  mutate(Zfluct_Yield = (Yield - mean(Yield, na.rm=T)) / sd(Yield, na.rm=T)) %>%
  ungroup() %>% 
  select(-Yield) %>% 
  bind_rows(z)

```


#### Yield Fluctuation Histograms


```{r, label='SIAP Yield Loss Histograms', message=FALSE,warning=FALSE}
x = SIAP_ZFluct_long %>% filter(!(AGType %in% c("Total")))

h1 = ggplot(x,aes(x = Zfluct_Yield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 0.2, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  #geom_density(aes(group = AGType, color = AGType, y= ..count..), adjust = 2, size=1, alpha=0.5)+
  #scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Annual Maize Yield Z-Score for Municipio", y = "Count")+
    theme_bw()+
    scale_y_continuous(breaks=seq(0,400,100))+
    scale_x_continuous(limits= c(-4.5,4.5), breaks=seq(-4,4,1)) +
    theme(axis.text.x = element_text(vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=12, face="bold"),
          axis.title.y = element_text(color="black", size=12, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.025,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

y = x %>% mutate(AGType = "All") %>% bind_rows(z)

h2 = ggplot(y,aes(x = Zfluct_Yield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 0.2, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Total", "All"), labels = c("Total", "All"))+
  #geom_density(aes(group = Series, color = Series, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  #scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Total", "All"))+
  labs(x ="Annual Maize Yield Z-Score for Municipio", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(-4.5,4.5), breaks=seq(-4,4,1)) +
    theme(axis.text.x = element_text(vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=12, face="bold"),
          axis.title.y = element_text(color="black", size=12, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.7,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_Zfluct_Yield.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

Zfluct_YieldIrrig = x %>% filter(AGType == "Riego") %>% pull(Zfluct_Yield) %>% na.omit
Zfluct_YieldTemp = x %>% filter(AGType == "Temporal") %>% pull(Zfluct_Yield) %>% na.omit
Zfluct_YieldTotal = y %>% filter(AGType == "Total") %>% pull(Zfluct_Yield) %>% na.omit
Zfluct_YieldAll = y %>% filter(AGType == "All") %>% pull(Zfluct_Yield) %>% na.omit

shapiro.test(Zfluct_YieldIrrig[Zfluct_YieldIrrig > 0])
shapiro.test(Zfluct_YieldTemp[Zfluct_YieldTemp > 0])
shapiro.test(Zfluct_YieldTotal[Zfluct_YieldTotal > 0])
shapiro.test(Zfluct_YieldAll[Zfluct_YieldAll > 0])

rm(ggp2, x,y,z, h1, h2, Zfluct_YieldIrrig, Zfluct_YieldTemp, Zfluct_YieldTotal, Zfluct_YieldAll)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_Zfluct_Yield.png"), FALSE)
```



## Maize Yield Maps

### Prepare Map Data
•	Merge 1960, 1991, 2007 and SIAP data with municipios polygons

NOT IN 1960 = IN 1960
"Santa Cruz Quilehtla, Tlaxcala" = "Acuamanala de Miguel Hidalgo, Tlaxcala", 
"Valle de Chalco Solidaridad, Mexico" = "Chalco, Mexico", 
"La Magdalena Tlaltelulco, Tlaxcala" = "Chiautempan, Tlaxcala", x1
"San Francisco Tetlanohcan, Tlaxcala" = "Chiautempan, Tlaxcala", 
"Cuautitlan Izcalli, Mexico" = "Cuautitlan, Mexico",
"Santa Ana Nopalucan, Tlaxcala" = "Ixtacuixtla de Mariano Matamoros, Tlaxcala", 
"Tonanitla, Mexico" = "Jaltenco, Mexico", 
"Cuauhtemoc, Distrito Federal" = "Miguel Hidalgo, Distrito Federal", x2
"Venustiano Carranza, Distrito Federal" = "Miguel Hidalgo, Distrito Federal",
"Benito Juarez, Distrito Federal" = "Miguel Hidalgo, Distrito Federal",
"Santa Apolonia Teacalco, Tlaxcala" = "Nativitas, Tlaxcala", 
"San Jose del Rincon, Mexico" = "San Felipe del Progreso, Mexico", 
"Benito Juarez, Tlaxcala" = "Sanctorum de Lazaro Cardenas, Tlaxcala", 
"San Juan Huactzinco, Tlaxcala" = "Tepeyanco, Tlaxcala", 
"Santa Catarina Ayometla, Tlaxcala" = "Tepeyanco, Tlaxcala", 
"Emiliano Zapata, Tlaxcala" = "Terrenate, Tlaxcala",  x1
"Lazaro Cardenas, Tlaxcala" = "Terrenate, Tlaxcala", 
"San Damian Texoloc, Tlaxcala" = "Tetlatlahuca, Tlaxcala", x1
"San Jeronimo Zacualpan, Tlaxcala" = "Tetlatlahuca, Tlaxcala", 
"Tlahuelilpan, Hidalgo" = "Tezontepec de Aldama, Hidalgo", 
"San Jose Teacalco, Tlaxcala" = "Tzompantepec, Tlaxcala",
"San Lucas Tecopilco, Tlaxcala" = "Xaltocan, Tlaxcala", 
"San Lorenzo Axocomanitla, Tlaxcala" = "Zacatelco, Tlaxcala", 
"Santa Isabel Xiloxoxtla, Tlaxcala" = "Zacatelco, Tlaxcala", 
"Temoac, Morelos" = "Zacualpan, Morelos", 



```{r, label='Prepare Map Data', message=FALSE,warning=FALSE}

### 1960 Agricultural Census Yields ###

AGC1960 = CY_data_list[["AGCensus1960"]] %>% filter(INCLUDE == TRUE) %>% 
  select(Location, State, INCLUDE, Size, Maize1960_kg, Maize1960_ha) %>%
  rename(Municipio = Location, Estado = State) %>%
  mutate(Municipio = str_to_title(Municipio)) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec de Trinidad Sanchez Santos" = "Zitlaltepec de Trinidad Sanchez Santos",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%  
  group_by(Municipio, Estado, EstadoMunicipio, Size) %>%
  filter(!(EstadoMunicipio %in% c("San Martin Totoltepec, Puebla"))) %>% 
  summarize(Yield = sum(as.numeric(Maize1960_kg), na.rm=T) / sum(as.numeric(Maize1960_ha), na.rm=T))  %>%
  pivot_wider(names_from = Size, values_from = Yield, values_fill = NA) %>% 
  mutate(across(everything(), ~ifelse(is.nan(.), NA, .))) %>% 
  rename(Y_1960_E = Ejido, Y_1960_S = Small, Y_1960_L = Large, Y_1960_Total = Total) %>%
  rowwise() %>% mutate(Y_1960_Max = max(Y_1960_E, Y_1960_S, Y_1960_L, Y_1960_Total, na.rm=T)) %>% ungroup()


# 1960 split municipios

rEM = c("Santa Cruz Quilehtla, Tlaxcala", "Valle de Chalco Solidaridad, Mexico", "La Magdalena Tlaltelulco, Tlaxcala", "San Francisco Tetlanohcan, Tlaxcala", "Cuautitlan Izcalli, Mexico", "Santa Ana Nopalucan, Tlaxcala", "Tonanitla, Mexico", "Cuauhtemoc, Distrito Federal", "Venustiano Carranza, Distrito Federal", "Benito Juarez, Distrito Federal", "Santa Apolonia Teacalco, Tlaxcala", "San Jose del Rincon, Mexico", "Benito Juarez, Tlaxcala", "San Juan Huactzinco, Tlaxcala", "Santa Catarina Ayometla, Tlaxcala", "Emiliano Zapata, Tlaxcala", "Lazaro Cardenas, Tlaxcala", "San Damian Texoloc, Tlaxcala", "San Jeronimo Zacualpan, Tlaxcala", "Tlahuelilpan, Hidalgo", "San Jose Teacalco, Tlaxcala", "San Lucas Tecopilco, Tlaxcala", "San Lorenzo Axocomanitla, Tlaxcala", "Santa Isabel Xiloxoxtla, Tlaxcala", "Temoac, Morelos")
rM = sub(",.*", "", rEM)

split_cases = AGC1960 %>% filter(EstadoMunicipio %in% c("Miguel Hidalgo, Distrito Federal", "Cuautitlan, Mexico", "Chalco, Mexico", "Jaltenco, Mexico", "San Felipe del Progreso, Mexico", "Zacualpan, Morelos", "Tezontepec de Aldama, Hidalgo", "Sanctorum de Lazaro Cardenas, Tlaxcala", "Ixtacuixtla de Mariano Matamoros, Tlaxcala", "Nativitas, Tlaxcala", "Tetlatlahuca, Tlaxcala", "Zacatelco, Tlaxcala", "Tepeyanco, Tlaxcala", "Acuamanala de Miguel Hidalgo, Tlaxcala", "Chiautempan, Tlaxcala", "Tzompantepec, Tlaxcala", "Xaltocan, Tlaxcala", "Terrenate, Tlaxcala")) %>% 
  mutate(count = 1,
         count = ifelse(EstadoMunicipio == "Miguel Hidalgo, Distrito Federal", 3, count),
         count = ifelse(EstadoMunicipio %in% c("Tepeyanco, Tlaxcala", "Zacatelco, Tlaxcala","Tetlatlahuca, Tlaxcala", "Chiautempan, Tlaxcala", "Terrenate, Tlaxcala"), 2, count))  %>% 
  slice(rep(row_number(), count)) 
split_cases$Municipio = rM
split_cases$EstadoMunicipio = rEM
split_cases = split_cases %>% select(-count)
AGC1960 = AGC1960 %>% bind_rows(split_cases)

write.csv(AGC1960, paste0(wd$data_p,"AGC1960.csv"))

### 1960 Agricultural Census Yields ###

AGC1970 = CY_data_list[["AGCensus1970"]] %>%
  select(Municipio, Estado, Size, Yield_S, Harvest_ha_S) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec de Trinidad Sanchez Santos" = "Zitlaltepec de Trinidad Sanchez Santos",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%
  filter(!(EstadoMunicipio %in% c("Santa Catarina Tlaltempan, Puebla"))) %>% 
  group_by(Municipio, Estado, EstadoMunicipio, Size) %>%
  summarize(Yield = as.numeric(Yield_S))  %>%
  pivot_wider(names_from = Size, values_from = Yield, values_fill = NA) %>%
  mutate(across(everything(), ~ifelse(is.nan(.), NA, .))) %>% 
  rename(Y_1970_E = Ejido, Y_1970_S = Small, Y_1970_L = Large, Y_1970_Total = Total) %>%
  rowwise() %>% mutate(Y_1970_Max = max(Y_1970_E, Y_1970_S, Y_1970_L, Y_1970_Total, na.rm=T)) %>% ungroup()

# 1970 split municipios

rEM = c("Santa Cruz Quilehtla, Tlaxcala", "Valle de Chalco Solidaridad, Mexico", "La Magdalena Tlaltelulco, Tlaxcala", "San Francisco Tetlanohcan, Tlaxcala", "Cuautitlan Izcalli, Mexico", "Santa Ana Nopalucan, Tlaxcala", "Tonanitla, Mexico", "Santa Apolonia Teacalco, Tlaxcala", "San Jose del Rincon, Mexico", "Benito Juarez, Tlaxcala", "San Juan Huactzinco, Tlaxcala", "Santa Catarina Ayometla, Tlaxcala", "Emiliano Zapata, Tlaxcala", "Lazaro Cardenas, Tlaxcala", "San Damian Texoloc, Tlaxcala", "San Jeronimo Zacualpan, Tlaxcala", "Tlahuelilpan, Hidalgo", "San Jose Teacalco, Tlaxcala", "San Lucas Tecopilco, Tlaxcala", "San Lorenzo Axocomanitla, Tlaxcala", "Santa Isabel Xiloxoxtla, Tlaxcala")#"Cuauhtemoc, Distrito Federal", "Venustiano Carranza, Distrito Federal", "Benito Juarez, Distrito Federal",, "Temoac, Morelos"
rM = sub(",.*", "", rEM)

split_cases = AGC1970 %>% filter(EstadoMunicipio %in% c("Cuautitlan, Mexico", "Chalco, Mexico", "Jaltenco, Mexico", "San Felipe del Progreso, Mexico",  "Tezontepec de Aldama, Hidalgo", "Sanctorum de Lazaro Cardenas, Tlaxcala", "Ixtacuixtla de Mariano Matamoros, Tlaxcala", "Nativitas, Tlaxcala", "Tetlatlahuca, Tlaxcala", "Zacatelco, Tlaxcala", "Tepeyanco, Tlaxcala", "Acuamanala de Miguel Hidalgo, Tlaxcala", "Chiautempan, Tlaxcala", "Tzompantepec, Tlaxcala", "Xaltocan, Tlaxcala", "Terrenate, Tlaxcala")) %>% #"Miguel Hidalgo, Distrito Federal", "Zacualpan, Morelos",
  mutate(count = 1,
         #count = ifelse(EstadoMunicipio == "Miguel Hidalgo, Distrito Federal", 3, count),
         count = ifelse(EstadoMunicipio %in% c("Tepeyanco, Tlaxcala", "Zacatelco, Tlaxcala","Tetlatlahuca, Tlaxcala", "Chiautempan, Tlaxcala", "Terrenate, Tlaxcala"), 2, count))  %>% 
  slice(rep(row_number(), count)) 
split_cases$Municipio = rM
split_cases$EstadoMunicipio = rEM
split_cases = split_cases %>% select(-count)
AGC1970 = AGC1970 %>% bind_rows(split_cases)

write.csv(AGC1970, paste0(wd$data_p,"AGC1970.csv"))

### 1991 Agricultural Census Yields ###

AGC1991 = CY_data_list[["AGCensus1991"]] %>% 
  select(Name, State, Yield) %>%
  rename(Municipio = Name, Estado = State, Y_1991_Total = Yield) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec de Trinidad Sanchez Santos",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  mutate(Y_1991_Total = as.numeric(Y_1991_Total))#%>%
  #mutate(AGType = "Total")

# 1991 split municipios

rEM = c("Valle de Chalco Solidaridad, Mexico", "Tonanitla, Mexico", "San Jose del Rincon, Mexico", "La Magdalena Tlaltelulco, Tlaxcala", "San Francisco Tetlanohcan, Tlaxcala", "Santa Ana Nopalucan, Tlaxcala", "Benito Juarez, Tlaxcala", "Santa Cruz Quilehtla, Tlaxcala", "Santa Apolonia Teacalco, Tlaxcala", "San Juan Huactzinco, Tlaxcala", "Santa Catarina Ayometla, Tlaxcala", "Emiliano Zapata, Tlaxcala", "Lazaro Cardenas, Tlaxcala", "San Damian Texoloc, Tlaxcala", "San Jeronimo Zacualpan, Tlaxcala", "San Jose Teacalco, Tlaxcala", "San Lucas Tecopilco, Tlaxcala", "San Lorenzo Axocomanitla, Tlaxcala", "Santa Isabel Xiloxoxtla, Tlaxcala")
rM = sub(",.*", "", rEM)

split_cases = AGC1991 %>% filter(EstadoMunicipio %in% c("Chalco, Mexico", "Jaltenco, Mexico", "San Felipe del Progreso, Mexico", "Sanctorum de Lazaro Cardenas, Tlaxcala", "Ixtacuixtla de Mariano Matamoros, Tlaxcala", "Nativitas, Tlaxcala", "Tetlatlahuca, Tlaxcala", "Zacatelco, Tlaxcala", "Tepeyanco, Tlaxcala", "Acuamanala de Miguel Hidalgo, Tlaxcala", "Chiautempan, Tlaxcala", "Tzompantepec, Tlaxcala", "Xaltocan, Tlaxcala", "Terrenate, Tlaxcala")) %>% 
  mutate(count = 1,
         count = ifelse(EstadoMunicipio == "Miguel Hidalgo, Distrito Federal", 3, count),
         count = ifelse(EstadoMunicipio %in% c("Tepeyanco, Tlaxcala", "Zacatelco, Tlaxcala","Tetlatlahuca, Tlaxcala", "Chiautempan, Tlaxcala", "Terrenate, Tlaxcala"), 2, count))  %>% 
  slice(rep(row_number(), count)) 
split_cases$Municipio = rM
split_cases$EstadoMunicipio = rEM
split_cases = split_cases %>% select(-count)
AGC1991 = AGC1991 %>% bind_rows(split_cases)

write.csv(AGC1991, paste0(wd$data_p,"AGC1991.csv"))


### 2007 Agricultural Census Yields ###

AGC2007 = CY_data_list[["AGCensus2007"]] %>% 
  select(Name, State, Yield) %>%
  rename(Municipio = Name, Estado = State, Y_AGC2007_Total = Yield) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  mutate(Y_AGC2007_Total = as.numeric(Y_AGC2007_Total))# %>%
  #mutate(AGType = "Total")

write.csv(AGC2007, paste0(wd$data_p,"AGC2007.csv"))

if (CASES_REMOVE == TRUE) {
  
  AGC1960 = AGC1960 %>% filter(!(EstadoMunicipio %in% cases_remove))
  AGC1991 = AGC1991 %>% filter(!(EstadoMunicipio %in% cases_remove))
  AGC2007 = AGC2007 %>% filter(!(EstadoMunicipio %in% cases_remove))
  
}



### SIAP 2003-2021 ANNUAL Yields ###

x = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  group_by(Municipio, Estado, EstadoMunicipio, Year) %>% 
  summarize(AGType = "Total",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T))

SIAP_annual = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Yield) %>%
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp")) %>% 
  bind_rows(x) %>% 
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "Y_{Year}_{AGType}",
    values_from = Yield)

### SIAP 2003-2021 Average Yields by Agriculture Type + overall ###
### plus Yield Variability and Other Variables                  ###

SIAP_averages = SIAP_6 %>% select(-Estado_ID, -ddr, -ddr_ID, -Cader, -Cader_ID, -Municipio_ID)

#SIAP_5 <- SIAP_5 %>% mutate(across(where(is.character) & !one_of(c("Estado_ID", "Estado", "ddr_ID", "ddr", "Cader_ID", "Cader", "Municipio_ID", "Municipio", "EstadoMunicipio", "AGType")), as.numeric)) 






SIAP_ZFluct = SIAP_ZFluct_long %>% 
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp",
    AGType == "Total" ~ "Total")) %>% 
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "YZf_{Year}_{AGType}",
    values_from = Zfluct_Yield)


### Merge Full SIAP 2003-2021 Data ###

SIAP_yields = SIAP_annual %>% left_join(SIAP_averages, by = c("Municipio", "Estado", "EstadoMunicipio")) 

rm(SIAP_annual, SIAP_averages, x, split_cases, rEM, rM)


#my_mean <- function(x) mean(x, na.rm = T)

### Merge Full Data ###

MunicipioYields <- Municipios2000s %>% 
  left_join(AGC1960, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC1970, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC1991, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC2007, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(SIAP_yields, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  select(-Area_m2)#-AGType.x, -AGType.y, 
  

scale2 <- function(x) (x - mean(x, na.rm = T)) / sd(x, na.rm = T)

MunicipioYields_Z <- MunicipioYields %>% 
  mutate(across(where(is.numeric), scale2)) %>%
  left_join(SIAP_ZFluct, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  mutate(CoT_1960_SIAP_dif = AvgYield_Total - Y_1960_Total,
         CoT_1960_SIAP_rat = AvgYield_Total / Y_1960_Total)


MunicipioYields <- MunicipioYields %>% 
  left_join(SIAP_ZFluct, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  mutate(CoT_1960_SIAP_dif = AvgYield_Total - Y_1960_Total,
         CoT_1960_SIAP_rat = AvgYield_Total / Y_1960_Total)

st_write(MunicipioYields, paste0(wd$data_p, "MunicipioYields.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)
st_write(MunicipioYields_Z, paste0(wd$data_p, "MunicipioYields_Z.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)

#geo <- st_geometry(MunicipioYields_Z)
#nb <- st_contiguity(geo)
MunicipioYields_Z <- MunicipioYields_Z %>% 
  mutate(nb = sfdep::st_contiguity(geom),
         wt = sfdep::st_weights(nb, allow_zero = TRUE))

nb <- MunicipioYields_Z$nb
wt <- MunicipioYields_Z$wt


```


x <- MunicipioYields_Z$AvgYield_Total
moran <- global_moran_test(x, nb, wt, alternative = "two.sided", na.action=na.omit)
paste0("Two-Sided Moran's I Test")
paste0("St.Dev = ", signif(moran$statistic, 3), ",  p = ", signif(moran$p.value,2))
paste0("Moran's I = ", signif(as.numeric(moran$estimate[1]), 3), ", Expectation = ", signif(as.numeric(moran$estimate[2]),1))
moran.test(x, nb, na.action=na.omit, zero.policy=T)

Total Variables



PctArea_AvgPlanted = AvgPlanted / Area_ha 
PctArea_AvgHarvested = AvgHarvested / Area_ha
PctArea_AvgProduct = AvgProduct / Area_ha
PctArea_AvgValue = AvgValue / Area_ha

### Maps 
Maps of average maize yields by municipality
•	Same spatial patterning??

```{r, label='Basemaps', message=FALSE,warning=FALSE}
Hillshade <- read_stars(paste0(wd$data_r, "HillshadeCMex.tif"))
Estados <- st_read(paste0(wd$data_r, "StatesPoly.gpkg"))
Estados2 = Estados %>% mutate(my_nudge_x = case_when(
    NOM_ENT == "Mexico" ~ 4000,
    NOM_ENT == "DF" ~ 0,
    NOM_ENT == "Hidalgo" ~ -7000,
    NOM_ENT == "Morelos" ~ 0,
    NOM_ENT == "Puebla" ~ -50000,
    NOM_ENT == "Tlaxcala" ~ 0,
    NOM_ENT == "" ~ 0),
    my_nudge_y = case_when(
    NOM_ENT == "Mexico" ~ 1500,
    NOM_ENT == "DF" ~ 0,
    NOM_ENT == "Hidalgo" ~ 0,
    NOM_ENT == "Morelos" ~ 0,
    NOM_ENT == "Puebla" ~ -65000,
    NOM_ENT == "Tlaxcala" ~ 0,
    NOM_ENT == "" ~ 0))



myPalette <- colorRampPalette(c("red4", "red4", "red4", "red4", "red", "orange", "yellow", "greenyellow", "green", "green4", "green4","green4", "green4"))
#myPalette <- c("red4", "red4", "red", "orange", "yellow", "greenyellow", "green", "green4", "green4")
myBreaks = c(-6, -4, -2, -1,  0, 1, 2, 4, 6)
myLimits = c(-6, 6)
myLegendTitle = "Z-Score\nMaize\nYield" #"Maize\nYield\n(kg/ha)"

```


#### Average Yields Over Time Maps

```{r, label='Average Yields Over Time Maps', message=FALSE, warning=FALSE}

map_list = list()

var = c("Y_1960_Total", "Y_1960_E", "Y_1960_L", "Y_1960_S", "Y_1960_Max","Y_1970_Total", "Y_1970_E", "Y_1970_L", "Y_1970_S", "Y_1970_Max", "Y_1991_Total", "Y_AGC2007_Total", "AvgYield_Total", "AvgYield_Irrig", "AvgYield_Temp")
tit = c("Central Mexico Study Region - 1960 Agricultural Census", "Central Mexico Study Region - 1960 Agricultural Census", "Central Mexico Study Region - 1960 Agricultural Census", "Central Mexico Study Region - 1960 Agricultural Census", "Central Mexico Study Region - 1960 Agricultural Census", "Central Mexico Study Region - 1970 Agricultural Census", "Central Mexico Study Region - 1970 Agricultural Census", "Central Mexico Study Region - 1970 Agricultural Census", "Central Mexico Study Region - 1970 Agricultural Census", "Central Mexico Study Region - 1970 Agricultural Census", "Central Mexico Study Region - 1991 Agricultural Census", "Central Mexico Study Region - 2007 Agricultural Census", "Central Mexico Study Region - SIAP 2003-2021", "Central Mexico Study Region - SIAP 2003-2021", "Central Mexico Study Region - SIAP 2003-2021")
subtit = c("Z-Score Average Overall Maize Yield", "Z-Score Average Ejido Maize Yield", "Z-Score Average Large Farm Maize Yield", "Z-Score Average Small Farm Maize Yield", "Z-Score Max Average Maize Yield","Z-Score Average Overall Maize Yield", "Z-Score Average Ejido Maize Yield", "Z-Score Average Large Farm Maize Yield", "Z-Score Average Small Farm Maize Yield", "Z-Score Max Average Maize Yield", "Z-Score Average Overall Maize Yield", "Z-Score Average Overall Maize Yield", "Z-Score Average Overall Maize Yield", "Z-Score Average Irrigation Maize Yield", "Z-Score Average Temporal Maize Yield")
name=c("Y_1960_Total", "Y_1960_E", "Y_1960_L", "Y_1960_S", "Y_1960_Max", "Y_1970_Total", "Y_1970_E", "Y_1970_L", "Y_1970_S", "Y_1970_Max","Y_1991_Total", "Y_AGC2007_Total", "SIAP_AvgYield_Total", "SIAP_AvgYield_Irrig", "SIAP_AvgYield_Temp")


for (i in 1:length(var)) {
  v = paste0(var[i])
  t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s, global_moran = T,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 
  
names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name, ".png"))

knitr::include_graphics(paths, FALSE)


```


#### SIAP Total Yield Time Series

new folder for maps

sf1_fill
sf1_fill_legend_title
mytitle
mysubtitle

```{r, label='SIAP Total Yield Time Series', message=FALSE, warning=FALSE}

map_list = list()

var = c("Y_2003_Total", "Y_2004_Total", "Y_2005_Total", "Y_2006_Total", "Y_2007_Total", "Y_2008_Total", "Y_2009_Total", "Y_2010_Total", "Y_2011_Total", "Y_2012_Total", "Y_2013_Total", "Y_2014_Total", "Y_2015_Total", "Y_2016_Total", "Y_2017_Total", "Y_2018_Total", "Y_2019_Total", "Y_2020_Total", "Y_2021_Total")
tit = "Central Mexico Study Region - SIAP 2003-2021"
yrs = 2003:2021
subtit = paste0("Z-Score ", yrs, " Average Overall Maize Yield")
name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

#knitr::include_graphics(paths, FALSE)

```


#### SIAP Temporal Yield Time Series


```{r, label='SIAP Temporal Yield Time Series', message=FALSE, warning=FALSE}

map_list = list()

var = c("Y_2003_Temp", "Y_2004_Temp", "Y_2005_Temp", "Y_2006_Temp", "Y_2007_Temp", "Y_2008_Temp", "Y_2009_Temp", "Y_2010_Temp", "Y_2011_Temp", "Y_2012_Temp", "Y_2013_Temp", "Y_2014_Temp", "Y_2015_Temp", "Y_2016_Temp", "Y_2017_Temp", "Y_2018_Temp", "Y_2019_Temp", "Y_2020_Temp", "Y_2021_Temp")
tit = "Central Mexico Study Region - SIAP 2003-2021"
yrs = 2003:2021
subtit = paste0("Z-Score ", yrs, " Average Temporal Maize Yield")
name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

#knitr::include_graphics(paths, FALSE)

```




#### SIAP Irrigation Yield Time Series



```{r, label='SIAP Irrigation Yield Time Series', message=FALSE, warning=FALSE}

map_list = list()

var = c("Y_2003_Irrig", "Y_2004_Irrig", "Y_2005_Irrig", "Y_2006_Irrig", "Y_2007_Irrig", "Y_2008_Irrig", "Y_2009_Irrig", "Y_2010_Irrig", "Y_2011_Irrig", "Y_2012_Irrig", "Y_2013_Irrig", "Y_2014_Irrig", "Y_2015_Irrig", "Y_2016_Irrig", "Y_2017_Irrig", "Y_2018_Irrig", "Y_2019_Irrig", "Y_2020_Irrig", "Y_2021_Irrig")
tit = "Central Mexico Study Region - SIAP 2003-2021"
yrs = 2003:2021
subtit = paste0("Z-Score ", yrs, " Average Irrigation Maize Yield")
name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

#knitr::include_graphics(paths, FALSE)

```



#### SIAP Yield Variability



```{r, label='SIAP Yield Variability', message=FALSE, warning=FALSE}

map_list = list()

var = c("sdYield_Total", "minYield_Total", "maxYield_Total", "medYield_Total", "cvYield_Total", "sdYield_Temp", "minYield_Temp", "maxYield_Temp", "medYield_Temp", "cvYield_Temp", "sdYield_Irrig", "minYield_Irrig", "maxYield_Irrig", "medYield_Irrig", "cvYield_Irrig")
tit = "Central Mexico Study Region - SIAP 2003-2021"
#yrs = 2003:2021
subtit = c("Z-Score St.Dev. Total Maize Yield", "Z-Score Minimum Total Maize Yield", "Z-Score Maximum Total Maize Yield", "Z-Score Median Total Maize Yield", "Z-Score C.V. Total Maize Yield", "Z-Score St.Dev. Temporal Maize Yield", "Z-Score Minimum Temporal Maize Yield", "Z-Score Maximum Temporal Maize Yield", "Z-Score Median Temporal Maize Yield", "Z-Score C.V. Temporal Maize Yield", "Z-Score St.Dev. Irrigation Maize Yield", "Z-Score Minimum Irrigation Maize Yield", "Z-Score Maximum Irrigation Maize Yield", "Z-Score Median Irrigation Maize Yield", "Z-Score C.V. Irrigation Maize Yield")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```




#### SIAP Yield Loss



```{r, label='SIAP Yield Loss', message=FALSE, warning=FALSE}

map_list = list()

var = c("AvgYieldLoss_Total", "sdYieldLoss_Total", "minYieldLoss_Total", "maxYieldLoss_Total", "medYieldLoss_Total", "cvYieldLoss_Total", "AvgYieldLoss_Temp", "sdYieldLoss_Temp", "minYieldLoss_Temp", "maxYieldLoss_Temp", "medYieldLoss_Temp", "cvYieldLoss_Temp", "AvgYieldLoss_Irrig", "sdYieldLoss_Irrig", "minYieldLoss_Irrig", "maxYieldLoss_Irrig", "medYieldLoss_Irrig", "cvYieldLoss_Irrig")
tit = "Central Mexico Study Region - SIAP 2003-2021"
#yrs = 2003:2021
subtit = c("Z-Score Average Total Maize Yield Loss", "Z-Score St.Dev. Total Maize Yield Loss", "Z-Score Minimum Total Maize Yield Loss", "Z-Score Maximum Total Maize Yield Loss", "Z-Score Median Total Maize Yield Loss", "Z-Score C.V. Total Maize Yield Loss", "Z-Score Average Temporal Maize Yield Loss", "Z-Score St.Dev. Temporal Maize Yield Loss", "Z-Score Minimum Temporal Maize Yield Loss", "Z-Score Maximum Temporal Maize Yield Loss", "Z-Score Median Temporal Maize Yield Loss", "Z-Score C.V. Temporal Maize Yield Loss", "Z-Score Average Irrigation Maize Yield Loss", "Z-Score St.Dev. Irrigation Maize Yield Loss", "Z-Score Minimum Irrigation Maize Yield Loss", "Z-Score Maximum Irrigation Maize Yield Loss", "Z-Score Median Irrigation Maize Yield Loss", "Z-Score C.V. Irrigation Maize Yield Loss")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```



#### SIAP Percent Yield Loss



```{r, label='SIAP Percent Yield Loss', message=FALSE, warning=FALSE}

map_list = list()

var = c("AvgPctYieldLoss_Total", "sdPctYieldLoss_Total", "minPctYieldLoss_Total", "maxPctYieldLoss_Total", "medPctYieldLoss_Total", "cvPctYieldLoss_Total", "AvgPctYieldLoss_Temp", "sdPctYieldLoss_Temp", "minPctYieldLoss_Temp", "maxPctYieldLoss_Temp", "medPctYieldLoss_Temp", "cvPctYieldLoss_Temp", "AvgPctYieldLoss_Irrig", "sdPctYieldLoss_Irrig", "minPctYieldLoss_Irrig", "maxPctYieldLoss_Irrig", "medPctYieldLoss_Irrig", "cvPctYieldLoss_Irrig")
tit = "Central Mexico Study Region - SIAP 2003-2021"
#yrs = 2003:2021
subtit = c("Z-Score Average Total Maize % Yield Loss", "Z-Score St.Dev. Total Maize % Yield Loss", "Z-Score Minimum Total Maize % Yield Loss", "Z-Score Maximum Total Maize % Yield Loss", "Z-Score Median Total Maize % Yield Loss", "Z-Score C.V. Total Maize % Yield Loss", "Z-Score Average Temporal Maize % Yield Loss", "Z-Score St.Dev. Temporal Maize % Yield Loss", "Z-Score Minimum Temporal Maize % Yield Loss", "Z-Score Maximum Temporal Maize % Yield Loss", "Z-Score Median Temporal Maize % Yield Loss", "Z-Score C.V. Temporal Maize % Yield Loss", "Z-Score Average Irrigation Maize % Yield Loss", "Z-Score St.Dev. Irrigation Maize % Yield Loss", "Z-Score Minimum Irrigation Maize % Yield Loss", "Z-Score Maximum Irrigation Maize % Yield Loss", "Z-Score Median Irrigation Maize % Yield Loss", "Z-Score C.V. Irrigation Maize % Yield Loss")


name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```


#### SIAP Irrigation-Total Ratio


```{r, label='SIAP Irrigation-Total Ratio', message=FALSE, warning=FALSE}

map_list = list()

var = c("ITr_AvgYield", "ITr_sdYield", "ITr_minYield", "ITr_maxYield", "ITr_medYield", "ITr_cvYield", "ITr_AvgYieldLoss", "ITr_sdYieldLoss", "ITr_minYieldLoss", "ITr_maxYieldLoss", "ITr_medYieldLoss", "ITr_cvYieldLoss", "ITr_AvgPctYieldLoss", "ITr_sdPctYieldLoss", "ITr_minPctYieldLoss", "ITr_maxPctYieldLoss", "ITr_medPctYieldLoss", "ITr_cvPctYieldLoss")
tit = "Central Mexico Study Region - SIAP 2003-2021"
#yrs = 2003:2021
subtit = c("Z-Score Irrig-Total Ratio for Average Maize Yield", "Z-Score Irrig-Total Ratio for St.Dev. Maize Yield", "Z-Score Irrig-Total Ratio for Minimum Maize Yield", "Z-Score Irrig-Total Ratio for Maximum Maize Yield", "Z-Score Irrig-Total Ratio for Median Maize Yield", "Z-Score Irrig-Total Ratio for C.V. Maize Yield", "Z-Score Irrig-Total Ratio for Average Maize Yield Loss", "Z-Score Irrig-Total Ratio for St.Dev. Maize Yield Loss", "Z-Score Irrig-Total Ratio for Minimum Maize Yield Loss", "Z-Score Irrig-Total Ratio for Maximum Maize Yield Loss", "Z-Score Irrig-Total Ratio for Median Maize Yield Loss", "Z-Score Irrig-Total Ratio for C.V. Maize Yield Loss", "Z-Score Irrig-Total Ratio for Average Maize % Yield Loss", "Z-Score Irrig-Total Ratio for St.Dev. Maize % Yield Loss", "Z-Score Irrig-Total Ratio for Minimum Maize % Yield Loss", "Z-Score Irrig-Total Ratio for Maximum Maize % Yield Loss", "Z-Score Irrig-Total Ratio for Median Maize % Yield Loss", "Z-Score Irrig-Total Ratio for C.V. Maize % Yield Loss")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

#knitr::include_graphics(paths, FALSE)

```


#### ****SIAP Temporal-Total Ratio



```{r, label='SIAP Temporal-Total Ratio', message=FALSE, warning=FALSE}

map_list = list()

var = c("TTr_AvgYield", "TTr_sdYield", "TTr_minYield", "TTr_maxYield", "TTr_medYield", "TTr_cvYield", "TTr_AvgYieldLoss", "TTr_sdYieldLoss", "TTr_minYieldLoss", "TTr_maxYieldLoss", "TTr_medYieldLoss", "TTr_cvYieldLoss", "TTr_AvgPctYieldLoss", "TTr_sdPctYieldLoss", "TTr_minPctYieldLoss", "TTr_maxPctYieldLoss", "TTr_medPctYieldLoss", "TTr_cvPctYieldLoss")
tit = "Central Mexico Study Region - SIAP 2003-2021"
#yrs = 2003:2021
subtit = c("Z-Score Temporal-Total Ratio for Average Maize Yield", "Z-Score Temporal-Total Ratio for St.Dev. Maize Yield", "Z-Score Temporal-Total Ratio for Minimum Maize Yield", "Z-Score Temporal-Total Ratio for Maximum Maize Yield", "Z-Score Temporal-Total Ratio for Median Maize Yield", "Z-Score Temporal-Total Ratio for C.V. Maize Yield", "Z-Score Temporal-Total Ratio for Average Maize Yield Loss", "Z-Score Temporal-Total Ratio for St.Dev. Maize Yield Loss", "Z-Score Temporal-Total Ratio for Minimum Maize Yield Loss", "Z-Score Temporal-Total Ratio for Maximum Maize Yield Loss", "Z-Score Temporal-Total Ratio for Median Maize Yield Loss", "Z-Score Temporal-Total Ratio for C.V. Maize Yield Loss","Z-Score Temporal-Total Ratio for Average Maize % Yield Loss", "Z-Score Temporal-Total Ratio for St.Dev. Maize % Yield Loss", "Z-Score Temporal-Total Ratio for Minimum Maize % Yield Loss", "Z-Score Temporal-Total Ratio for Maximum Maize % Yield Loss", "Z-Score Temporal-Total Ratio for Median Maize % Yield Loss", "Z-Score Temporal-Total Ratio for C.V. Maize % Yield Loss")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```


#### SIAP Maize Price


```{r, label='SIAP Maize Price', message=FALSE, warning=FALSE}

map_list = list()

var = c("AvgPrice_Total", "sdPrice_Total", "cvPrice_Total")
tit = "Central Mexico Study Region - SIAP 2003-2021"
#yrs = 2003:2021
subtit = c("Z-Score Average Maize Price", "Z-Score St.Dev. Maize Price", "Z-Score C.V. Maize Price")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = t, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

#knitr::include_graphics(paths, FALSE)

```


#### SIAP Annual Z-Score Average Yield Fluctuation


```{r, label='SIAP Annual Z-Score Avy Total Yield Fluctuation', message=FALSE, warning=FALSE}

map_list = list()

var = c("YZf_2003_Total", "YZf_2004_Total", "YZf_2005_Total", "YZf_2006_Total", "YZf_2007_Total", "YZf_2008_Total", "YZf_2009_Total", "YZf_2010_Total", "YZf_2011_Total", "YZf_2012_Total", "YZf_2013_Total", "YZf_2014_Total",  "YZf_2015_Total",  "YZf_2016_Total",  "YZf_2017_Total",  "YZf_2018_Total", "YZf_2019_Total",  "YZf_2020_Total",  "YZf_2021_Total")
tit = "Central Mexico Study Region - SIAP 2003-2021"
yrs = 2003:2021
#subtit = paste0("Annual Municipal Z-Score ", yrs, " Average Total Maize Yield")
#subtit = c("Annual Municipal Z-Score Average Yield", "Z-Score St.Dev. Maize Price", "Z-Score C.V. Maize Price")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0("Annual Municipal Z-Score ", yrs[i], " Average Overall Maize Yield")
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = tit, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

#knitr::include_graphics(paths, FALSE)

```



#### SIAP Annual Z-Score Temporal Yield Fluctuation


```{r, label='SIAP Annual Z-Score Avy Temporal Yield Fluctuation', message=FALSE, warning=FALSE}

map_list = list()

var = c("YZf_2003_Temp", "YZf_2004_Temp", "YZf_2005_Temp", "YZf_2006_Temp", "YZf_2007_Temp", "YZf_2008_Temp", "YZf_2009_Temp",
"YZf_2010_Temp", "YZf_2011_Temp", "YZf_2012_Temp", "YZf_2013_Temp", "YZf_2014_Temp",  "YZf_2015_Temp",  "YZf_2016_Temp",  "YZf_2017_Temp",  "YZf_2018_Temp", "YZf_2019_Temp",  "YZf_2020_Temp",  "YZf_2021_Temp")
tit = "Central Mexico Study Region - SIAP 2003-2021"
yrs = 2003:2021
#subtit = paste0("Annual Municipal Z-Score ", yrs, " Average Total Maize Yield")
#subtit = c("Annual Municipal Z-Score Average Yield", "Z-Score St.Dev. Maize Price", "Z-Score C.V. Maize Price")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0("Annual Municipal Z-Score ", yrs[i], " Average Temporal Maize Yield")
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = tit, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```






#### SIAP Annual Z-Score Irrigation Yield Fluctuation


```{r, label='SIAP Annual Z-Score Avy Irrigation Yield Fluctuation', message=FALSE, warning=FALSE}

map_list = list()

var = c("YZf_2003_Irrig", "YZf_2004_Irrig", "YZf_2005_Irrig", "YZf_2006_Irrig", "YZf_2007_Irrig", "YZf_2008_Irrig", "YZf_2009_Irrig", "YZf_2010_Irrig", "YZf_2011_Irrig", "YZf_2012_Irrig", "YZf_2013_Irrig", "YZf_2014_Irrig",  "YZf_2015_Irrig",  "YZf_2016_Irrig",  "YZf_2017_Irrig", "YZf_2018_Irrig", "YZf_2019_Irrig",  "YZf_2020_Irrig",  "YZf_2021_Irrig")
tit = "Central Mexico Study Region - SIAP 2003-2021"
yrs = 2003:2021
#subtit = paste0("Annual Municipal Z-Score ", yrs, " Average Total Maize Yield")
#subtit = c("Annual Municipal Z-Score Average Yield", "Z-Score St.Dev. Maize Price", "Z-Score C.V. Maize Price")

name = paste0("SIAP_",var)


for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0("Annual Municipal Z-Score ", yrs[i], " Average Irrigation Maize Yield")
  val = MunicipioYields_Z[[var[i]]]
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = MunicipioYields_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette, sf1_fill_palette_n = 11,
                             sf1_fill_legend_title = myLegendTitle, sf1_fill_legend_limits = myLimits,
                             sf1_fill_legend_breaks = myBreaks, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = tit, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
} 

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```






### 2000s Agricultural Census Maps


```{r, label='Prepare Agricultural Census Data', message=FALSE, warning=FALSE}

scale2 <- function(x) (x - mean(x, na.rm = T)) / sd(x, na.rm = T)

Census2000s_poly_Z <- Census2000s_poly %>% 
  select(Municipio, Estado, EstadoMunicipio, Pop_Total, UrbRatio, Pop_Pct_Rural, Pct_Primary, Pct_AG_Workers, PrimaryEmploy_perHa, AG_Workers_perHa, PopDens, PopDensRural, PrimaryEmployDens, Pct_Fallow_ha, Pct_Rest_ha, Pct_Rented_ha, Pct_FertilChem_ha, Pct_FertilManure_ha, Pct_ImprovSeed_ha, Pct_Herbicides_ha, Pct_Insecticides_ha, Pct_ControlledBurn_ha, Pct_Tract_Mechaniz_pu, Pct_Tract_Animal_pu, Pct_Tract_Manual_pu, TotalLaborDens, MechanizEquip_perHa, DraftAnimals_perHa, Pct_AG_ha, Pct_Pasture_ha, LU_Total_perHa, geom) %>%
  filter(!(EstadoMunicipio %in% c("Azcapotzalco, Distrito Federal", "Nezahualcoyotl, Mexico"))) %>% 
  mutate(across(where(is.character) & !one_of(c("Estado", "Municipio", "EstadoMunicipio")), as.numeric)) %>%
  mutate(across(where(is.numeric), scale2))

myPalette2 <- colorRampPalette(c("navyblue", "blue", "green", "yellow",  "orange", "red", "red4"))
#myPalette2 <- colorRampPalette(c("white", "grey80", "grey80", "grey80", "grey70", "grey60", "grey50", "grey40", "grey30", "grey20", "grey20","grey20", "black"))
#myPalette <- c("red4", "red4", "red", "orange", "yellow", "greenyellow", "green", "green4", "green4")
#myBreaks2 = NULL#c(-6, -4, -2, -1,  0, 1, 2, 4, 6)
#myLimits2 = NA#c(-6, 6)
myLegendTitle2 = "Z-Score\nVariable" #"Maize\nYield\n(kg/ha)"

```


#### Pop Census 2010




```{r, label='Pop Census 2010 Maps', message=FALSE, warning=FALSE}

   

map_list = list()

var = c("Pop_Total", "UrbRatio", "Pop_Pct_Rural", "Pct_Primary", "Pct_AG_Workers", "PrimaryEmploy_perHa", "AG_Workers_perHa", "PopDens", "PopDensRural", "PrimaryEmployDens")
tit = "Central Mexico Study Region - 2010 Population Census"
#yrs = 2003:2021
subtit = c("Z-Score Total Population", "Z-Score Urban Ratio", "Z-Score Percent Population Rural", "Z-Score Percent Primary Sector Employment", "Z-Score Percent Agricultural Workers of Total Employment", "Z-Score Primary Sector Workers per hectare Farmland", "Z-Score Agricultural Workers per hectare Farmland", "Z-Score Population Density", "Z-Score Rural Population Density", "Z-Score Primary Sector Workers per hectare Total Area")

name = paste0("PopCensus2010_",var)
mins = min(Census2000s_poly_Z[[v]], na.rm=T)

for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  myLimits2 = c(min(Census2000s_poly_Z[[v]], na.rm=T), max(Census2000s_poly_Z[[v]], na.rm=T))
  myBreaks2 = seq(myLimits2[1],  myLimits2[2], length.out = 7)
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = Census2000s_poly_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette2, sf1_fill_palette_n = 7,
                             sf1_fill_legend_title = myLegendTitle2, sf1_fill_legend_limits = myLimits2,
                             sf1_fill_legend_breaks = myBreaks2, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = tit, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
}

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```


#### AG Census 2007



```{r, label='AG Census 2007 Maps', message=FALSE, warning=FALSE}

   

map_list = list()

var = c("Pct_Fallow_ha", "Pct_Rest_ha", "Pct_Rented_ha", "Pct_FertilChem_ha", "Pct_FertilManure_ha", "Pct_ImprovSeed_ha", "Pct_Herbicides_ha", "Pct_Insecticides_ha", "Pct_ControlledBurn_ha", "Pct_Tract_Mechaniz_pu", "Pct_Tract_Animal_pu", "Pct_Tract_Manual_pu", "TotalLaborDens", "MechanizEquip_perHa", "DraftAnimals_perHa", "Pct_AG_ha", "Pct_Pasture_ha", "LU_Total_perHa", "Fertilizer", "Techniques")
tit = "Central Mexico Study Region - 2007 Agricultural Census"
#yrs = 2003:2021
subtit = c("Z-Score Percent Farmland Under Fallow Rotation", "Z-Score Percent Farmland Left Uncultivated", "Z-Score Percent Farmland Rented", "Z-Score Percent Farmland Chemically Fertilized", "Z-Score Percent Farmland Manure Fertilized", "Z-Score Percent Farmland Improved Seed", "Z-Score Percent Farmland Herbicides", "Z-Score Percent Farmland Insecticides", "Z-Score Percent Farmland Controlled Burn", "Z-Score Percent Production Units Mechanized Traction","Z-Score Percent Production Units Animal Traction", "Z-Score Percent Production Units Manual Traction", "Z-Score Density of Total AG Laborers per ha Farmland", "Z-Score Mechanized Equipment per ha Farmland", "Z-Score Draught Animals per ha Farmland", "Z-Score Percent Land under Cultivation", "Z-Score Percent Land under Pasture", "Z-Score Total Labor Units per ha Farmland")

name = paste0("AGCensus2007_",var)
mins = min(Census2000s_poly_Z[[v]], na.rm=T)

for (i in 1:length(var)) {
  v = paste0(var[i])
  #t = paste0(tit[i])
  s = paste0(subtit[i])
  val = MunicipioYields_Z[[var[i]]]
  myLimits2 = c(min(Census2000s_poly_Z[[v]], na.rm=T), max(Census2000s_poly_Z[[v]], na.rm=T))
  myBreaks2 = seq(myLimits2[1],  myLimits2[2], length.out = 7)
  map_list[[i]] <- CMex_AG_Map(stars_hillshade = Hillshade, sf1 = Census2000s_poly_Z, sf1_aes_string = T, sf1_geom = "geom",
                             sf1_fill = v, sf1_fill_palette = myPalette2, sf1_fill_palette_n = 7,
                             sf1_fill_legend_title = myLegendTitle2, sf1_fill_legend_limits = myLimits2,
                             sf1_fill_legend_breaks = myBreaks2, sf2 = Estados, sf2_geom = geom,
                             sf2_label_column = NOM_ENT, sf2_label_nudge_x = Estados2$my_nudge_x, 
                             sf2_label_nudge_y = Estados2$my_nudge_y, mytitle = tit, mysubtitle = s,
                             moran_nb = nb, moran_wt = wt, moran_val = val, moran_box = c(572000, 626450, 2195909, 2252689))
}

names(map_list) <- name

for (i in 1:length(name)) {
  n = paste0(name,".png")[i]
  ggsave(n, plot = map_list[[i]], device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257, units = "in",  dpi = 1500)
}

paths <- paste0(wd$figs,paste0("Maps/", name,".png"))

knitr::include_graphics(paths, FALSE)

```




## Spatial Patterning of Average Yield Over Time


The concept of bivariate spatial correlation is complex and often misinterpreted. It is typically considered to be the correlation between one variable and the spatial lag of another variable, as originally implemented in the precursor of GeoDa (e.g., as described in Anselin, Syabri, and Smirnov 2002). However, this does not take into account the inherent correlation between the two variables. More precisely, the bivariate spatial correlation is between xi and ∑jwijyj, but does not take into account the correlation between xi  and yi, i.e., between the two variables at the same location.



In its initial conceptualization, as mentioned above, a bivariate Moran scatter plot extends the idea of a Moran scatter plot with a variable on the x-axis and its spatial lag on a y-axis to a bivariate context. The fundamental difference is that in the bivariate case the spatial lag pertains to a different variable. In essence, this notion of bivariate spatial correlation measures the degree to which the value for a given variable at a location is correlated with its neighbors for a different variable.


I have two regression models, one is a spatial error regression and the other is standard OLS. My purpose is ONLY to evaluate the correlation between two variables. The OLS model has a low R^2 (0.15) while the spatial error model has a much higher Nagelkerke pseudo-R-squared (0.65). I think that this means that there is a considerable spatial correlation between the two variables when the spatial error term is considered. This should mean that higher than expected residual values suggest a missing explanatory variable that is spatially correlated. However, model validation via the Hausman specification test and likelihood-ratio test had very low p-values (p-value < 2.2e-16), rejecting the null hypothesis that the spatial error model coefficients are valid. But, again, I am only interested in correlation here -- rather than the regression coefficients and their predictive accuracy/validity. These cross-validation tests do not invalidate the high correlation achieved by the spatial error model, do they?
ChatGPT
The results of the Hausman specification test and likelihood-ratio test, with very low p-values rejecting the null hypothesis, indicate that there are significant differences between the coefficients of the spatial error model and the OLS model. These tests suggest that the spatial error model may not be the appropriate model for your data, and the coefficients obtained from this model may not be valid.

While the spatial error model may provide a higher Nagelkerke pseudo-R-squared and suggest spatial correlation between the variables, it is important to consider the validity and reliability of the model. The low p-values in the tests indicate that the spatial error model is not preferred over the OLS model in terms of the coefficients' validity.

It is worth noting that the spatial error model assumes that the spatial correlation captured by the spatial error term is the only source of spatial dependence in the data. If there are other unobserved spatial factors or omitted variables that are driving the spatial correlation, the spatial error model may not be appropriate or reliable.

Therefore, it is important to interpret the results cautiously and consider other factors such as the model assumptions, goodness-of-fit measures, and diagnostic tests when evaluating the correlation between the variables. Additionally, it may be beneficial to explore other spatial regression models or methods to further investigate and validate the spatial correlation in your data.

I am merely trying to test whether there is a spatial correlation using the spatial error term. This should mean that higher than expected residual values suggest a missing explanatory variable that is spatially correlated. Just as the pearson coefficient is a valid measure of correlation without a regression model, this also means that the spatial error model's Nagelkerke pseudo-R-squared *exists* independent of the validity of the model, correct?

 the Nagelkerke pseudo-R-squared, which measures the proportion of variance explained by the spatial error model, exists independent of the validity of the model. It provides a measure of the overall fit of the model in terms of explaining the variation in the dependent variable.

The Nagelkerke pseudo-R-squared, similar to other R-squared measures, indicates the proportion of the total variation in the dependent variable that is explained by the independent variables, including the spatial error term. In the context of spatial regression models, the spatial error term captures the unexplained spatial dependence or spatial autocorrelation in the data.

Therefore, a higher Nagelkerke pseudo-R-squared value suggests a better fit of the spatial error model in explaining the variation in the dependent variable, accounting for both the observed independent variables and the unobserved spatial dependence.

However, it is important to note that while the Nagelkerke pseudo-R-squared provides a measure of overall fit, it does not necessarily indicate the presence or absence of spatial correlation between specific variables. To explicitly test for spatial correlation between the variables of interest, you may consider other measures such as spatial autocorrelation statistics (e.g., Moran's I) or spatial regression diagnostics (e.g., spatial lag or error models).

Additionally, it is recommended to interpret the results in the broader context of model assumptions, goodness-of-fit measures, and diagnostic tests to ensure the reliability and validity of the spatial regression model.





```{r}

sf_list <- list()
bvMI_list <- list()
cor_list <- list()
ols_list <- list()
MI_list <- list()
error_lm_list <- list()
# List of variables
var = c("Y_1960_Total", "Y_1960_S", "Y_1991_Total", "Y_AGC2007_Total", "AvgYield_Total", "AvgYield_Irrig", "AvgYield_Temp")

# Use combn() to get all combinations of pairs
combinations <- combn(var, 2, simplify = FALSE)

df <- data.frame(rep("",length(combinations)),rep("",length(combinations)),rep(0,length(combinations)),rep(0,length(combinations)),rep(0,length(combinations)))
names(df) <- c("Series1", "Series2", "n", "Pearson", "bvMI")

  #val = 
  
  
# Loop to iterate over combinations
for (i in seq_along(combinations)) {
  
  vars2 = c(combinations[[i]][1], combinations[[i]][2])
  
  zzz = MunicipioYields_Z %>% select(all_of(vars2))  %>% 
    filter(!is.na(!!sym(vars2[1]))) %>%
    filter(!is.na(!!sym(vars2[2]))) %>%
    mutate(nb = sfdep::st_contiguity(geom),
           wt = sfdep::st_weights(nb, allow_zero = T)) %>%
    filter(!purrr::map_lgl(nb, function(x) length(x) == 1 && x == 0))%>%
    mutate(nb = sfdep::st_contiguity(geom),
           wt = sfdep::st_weights(nb, allow_zero = T))
  nn <- nrow(zzz)
  nb <- zzz$nb
  wt <- zzz$wt
  
  
  reg_formula <- paste(vars2[1], "~", vars2[2])
  reg_formula <- as.formula(reg_formula)
  ols <- lm(reg_formula, data = zzz)
  olsSum = summary(ols)
  ols$terms
  zzz$residuals <- ols$residuals
  residGMI = global_moran_test(zzz$residuals, nb, wt, alternative = "two.sided", na.action=na.omit, zero.policy=T)
  
  zzz %>% spdep::poly2nb(queen=TRUE) %>% spdep::nb2listw(style="W") -> zzzNbList
  
  LMtests = lm.LMtests(ols, zzzNbList, test="all")
  
  #SLX.model <- spatialreg::lmSLX(reg_formula, data=zzz, zzzNbList)
  #SLX.model_sum = summary(SLX.model)
  #SLX.model_sum_impacts = summary(spatialreg::impacts(SLX.model, zzzNbList), zstats = TRUE)[["pzmat"]]
  
  #sp.lag.model <- spatialreg::lagsarlm(reg_formula, data=zzz, zzzNbList)
  #sp.lag.model_sum = summary(sp.lag.model, Nagelkerke = TRUE) #Nagelkerke pseudo-R-squared
  #sp.lag.model_sum_impacts = summary(spatialreg::impacts(sp.lag.model, listw = zzzNbList, R=100), zstats = TRUE)[["pzmat"]]

  sp.err.model <- spatialreg::errorsarlm(reg_formula, data = zzz, listw = zzzNbList)
  sp.err.model_sum = summary(sp.err.model, Nagelkerke = TRUE) #Nagelkerke pseudo-R-squared
  
  #To test the validity of the error model we can run a Spatial Hausman Test to see if the results of the analysis verify our use of the model. Developed by Pace and LeSage, they state that: "For a given set of variables, a divergence between the coefficient estimates from a spatial error model and OLS suggest that neither is yielding regression parameter estimates matching the underlying parameters. This calls into questions use of either OLS or a standard error model for that set of variables." --Pace, R.K. and LeSage, J.P. (2008) A spatial Hausman test. Economics Letters 101(3), pgs. 282-284
  
  #spatialreg::Hausman.test(sp.err.model)
  
  #Based on the p-value of 0.4992 we would not reject the HO that the estimation method should yield coefficients appropriate for a spatial error model. If the p-value had been significant, we would have concluded that the use of OLS or a standard error model may not be appropriate for this set of variables.
  #Spatial Durbin Error Model
  #sd.err <- spatialreg::errorsarlm(reg_formula, data = zzz, listw = zzzNbList, etype = "emixed")
  #summary(sd.err, Nagelkerke = TRUE)
  #summary(spatialreg::impacts(sd.err, listw = zzzNbList, R = 100), zstats = TRUE)[["pzmat"]]
  #Based on the impacts analysis, we can see not many of the impacts are significant, so we might consider limiting the model to either the spatial error, SLX, or OLS models. Since we have already run the analysis and determined the most appropriate model of those three, we should see similar results in our likelihood ration test. This will help us test the HO that we should restrict the model to a more simple model. The first step is to determine if we should restrict the model from a Spatial Durbin Error model to a spatial error mode.
  #likelihood ratio test:
  #LR.Sarlm(sd.err,sp.err.model)
  #LR.Sarlm(sp.err.model,ols)
  #Our results are saying that, with a high p-value of 0.1573, we should not reject the null hypothesis. Meaning that we should restrict the model to a spatial error model. To provide further evidence of that, the p-value for the comparison of the Spatial Durbin Error model and the SLX model is 0.0123 and 0.0435 for the OLS model, which means we should not restrict this to a SLX or OLS model.
  
  #Spatial Durbin Model
  sdm <- spatialreg::lagsarlm(reg_formula, data = zzz, listw = zzzNbList, type = "mixed")
  
  sf_list[[i]] <- zzz
  
  bvMI_list[[i]] <- global_moran_bv(zzz[[vars2[1]]], 
                                    zzz[[vars2[2]]], 
                                    nb, wt, nsim = 99, scale = TRUE)
  cor_list[[i]] <- cor(zzz[[vars2[1]]], zzz[[vars2[2]]], method = 'pearson')
  
  ols_list[[i]] <- ols
  
  MI_list[[i]] <- residGMI
  
  error_lm_list[[i]] <- sp.err.model
  
  df$Series1[i] = vars2[1]
  df$Series2[i] = vars2[2]
  df$n[i] = nn
  
  df$Pearson[i] = cor_list[[i]]
  
  df$bvMI[i] = bvMI_list[[i]]$t0
  
  df$ols_R2[i] = summary(ols)$r.squared
  df$ols_pr[i] = as.numeric(pf(olsSum$fstatistic[1],olsSum$fstatistic[2],olsSum$fstatistic[3],lower.tail=F))
  df$ols_se[i] = summary(ols)$sigma
  
  df$resid_MI_sd[i] = residGMI$statistic
  df$resid_MI_pr[i] = residGMI$p.value
  df$resid_MI_est[i] = as.numeric(residGMI$estimate[1])
  df$resid_MI_exp[i] = as.numeric(residGMI$estimate[2])
  
  df$LMerr_pr[i] = LMtests[["LMerr"]][["p.value"]][[1]]
  df$LMlag_pr[i] = LMtests[["LMerr"]][["p.value"]][[1]]
  df$RLMerr_pr[i] = LMtests[["RLMerr"]][["p.value"]][[1]]
  df$RLMlag_pr[i] = LMtests[["RLMerr"]][["p.value"]][[1]]
  #df$SARMA_pr = LMtests[["RLMerr"]][["p.value"]][[1]]
  
  df$sp_err_NK_psR2[i] = sp.err.model_sum$NK #Nagelkerke pseudo-R-squared
  df$sp_err_Wald[i] = sp.err.model_sum$Wald1$statistic #The Wald statistic, also known as the Wald test or Wald chi-square test, is a statistical test used to assess the significance of individual coefficients or groups of coefficients in a statistical model. It is commonly used in the context of generalized linear models (GLMs) and other regression models. The Wald statistic is based on the asymptotic theory of maximum likelihood estimation. It compares the estimated coefficient(s) to its/their standard error(s) and assesses whether the coefficient(s) significantly deviate from zero.
  df$sp_err_Wald_pr[i] = sp.err.model_sum$Wald1$p.value #A small p-value (usually below a specified significance level, such as 0.05) indicates evidence against the null hypothesis, suggesting that the coefficient(s) is/are significantly different from zero.
  df$sp_err_AIC[i] = sp.err.model$AIC_lm.model #Akaike Information Criterion. It is a measure used for model selection and comparison. The AIC value quantifies the trade-off between the goodness of fit of the model and the complexity of the model.  It penalizes models with more parameters, favoring simpler models that explain the data well with fewer parameters.
  #df$ = sp.err.model$rest.se
  df$sp_err_s2[i] = sp.err.model_sum$s2 #ML residual variance (sigma squared) represents the estimated variance of the error term in the model. The ML residual variance is estimated using maximum likelihood estimation, which aims to find the parameter values that maximize the likelihood of observing the data given the model. The ML estimation process estimates the residual variance by optimizing the fit of the model to the observed data. The ML residual variance is an important measure in model assessment, as it provides an indication of how well the model captures the variability in the data. A lower residual variance suggests a better fit of the model to the data, indicating that the model explains a larger proportion of the variability.
  #df$ = sp.err.model_sum$SSE
  
  #df$ols_coef_a = as.numeric(ols$coefficients[2])
  #df$ols_coef_a_se = summary(ols)$coefficients[3]
  #df$ols_coef_a_pr = summary(ols)$coefficients[7]
  #df$ols_coef_b = as.numeric(ols$coefficients[1])
 # df$ols_coef_b_se = summary(ols)$coefficients[4]
  #df$ols_coef_b_pr = summary(ols)$coefficients[8]
  
}


```






```{r}
if (!require("psych")) {install.packages("psych")}
YZ = st_drop_geometry(MunicipioYields_Z)
YZ = YZ %>% select(Y_1960_Total, Y_1960_E, Y_1960_L, Y_1960_S, Y_1991_Total, Y_AGC2007_Total, AvgYield_Total, AvgYield_Irrig, AvgYield_Temp, Y_2004_Total)


pairs.panels(YZ, smooth = F, scale = F, density=TRUE,ellipses=F,
     digits = 2,method="pearson", pch = 19, lm=T,cor=TRUE,jiggle=FALSE,factor=2, 
     hist.col="#00AFBB",show.points=TRUE,rug=TRUE, breaks = "Sturges",cex.cor=3,wt=NULL,
     smoother=FALSE,stars=T,ci=T,alpha=.05)

pairs(x, 
      smooth = TRUE, 
      scale = FALSE, 
      density=TRUE,
      ellipses=TRUE,
     digits = 2,
     method="pearson", 
     pch = 20, 
     lm=FALSE,
     cor=TRUE,jiggle=FALSE,factor=2, 
     hist.col="cyan",show.points=TRUE,rug=TRUE, breaks = "Sturges",cex.cor=1,wt=NULL,
     smoother=FALSE,stars=FALSE,ci=FALSE,alpha=.05, ...)
```


library(zoo)
library(lmtest)
library(sandwich)
library(ggplot2)
library(devtools)
library(broom)
library(plyr)
library(MASS)
library(NSM3)


MunicipioYields_Z %>% select(Y_1960_Total, Y_1960_E, Y_1960_L, Y_1960_S, Y_1991_Total, Y_AGC2007_Total, AvgYield_Total, AvgYield_Irrig, AvgYield_Temp)

```{r, label='Change Over Time Regression by Municipality', message=FALSE,warning=FALSE}



plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$Y_AGC2007_Total)
plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$AvgYield_Total)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$Y_AGC2007_Total)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$AvgYield_Total)
plot(MunicipioYields_Z$Y_AGC2007_Total, MunicipioYields_Z$AvgYield_Total)

plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$Y_2007_Total.x)
plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$AvgYield_Total)

plot(MunicipioYields_Z$Y_1960_L, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_L, MunicipioYields_Z$Y_AGC2007_Total)
plot(MunicipioYields_Z$Y_1960_L, MunicipioYields_Z$AvgYield_Total)

plot(MunicipioYields_Z$Y_1960_E, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_E, MunicipioYields_Z$Y_AGC2007_Total)
plot(MunicipioYields_Z$Y_1960_E, MunicipioYields_Z$AvgYield_Total)

plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$AvgYield_Irrig)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$AvgYield_Irrig)
plot(MunicipioYields_Z$Y_AGC2007_Total, MunicipioYields_Z$AvgYield_Irrig)

plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$AvgYield_Temp)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$AvgYield_Temp)
plot(MunicipioYields_Z$Y_AGC2007_Total, MunicipioYields_Z$AvgYield_Temp)
```


Spatial regression models are statistical models that incorporate spatial dependencies or spatial effects in the analysis of relationships between variables. These models account for the fact that observations in close proximity may be more similar or related to each other compared to observations that are farther apart. Here are explanations of different types of spatial regression models:

Spatial Autoregressive (SAR) Model: The SAR model assumes that the value of a dependent variable in a specific location is influenced by the values of the dependent variable in neighboring locations. It incorporates a spatial lag term, which is the weighted average of the dependent variable values in neighboring locations, to capture the spatial dependence. The weights represent the spatial relationship between locations, typically based on distance or contiguity.

Spatial Error (SE) Model: The SE model assumes that the errors or residuals of a traditional regression model are spatially correlated. It accounts for the spatial autocorrelation in the residuals by including a spatially structured error term in the model. This error term captures the unexplained spatial variation that is not accounted for by the independent variables.

Spatial Durbin Model: The Spatial Durbin model combines elements of the SAR and SE models. It includes both a spatial lag term and a spatially structured error term. The model allows for examining the direct spatial spillover effects of both the dependent variable and the independent variables on the dependent variable.

Geographically Weighted Regression (GWR): GWR is a local regression technique that estimates regression coefficients at each location based on the neighboring observations. It allows for spatially varying relationships between the dependent variable and independent variables. GWR takes into account the spatial heterogeneity in the relationships and provides insights into how the relationships change across space.

These spatial regression models provide a framework to explore and analyze spatially dependent data, where the spatial relationships among observations are taken into account. They help to account for spatial autocorrelation, spatial heterogeneity, and spatial spillover effects, allowing for a more accurate analysis of the relationships between variables in a spatial context. The choice of model depends on the specific research question, data characteristics, and underlying assumptions about the spatial patterns in the data.


The choice of spatial regression model depends on the characteristics of your data and the research question you want to answer. Here are some considerations for when to use different spatial regression models:

SAR Model: The SAR model is appropriate when you expect that the value of a dependent variable in a specific location is influenced by the values of the dependent variable in neighboring locations. This model is suitable when there is a spatial process of diffusion, spillover, or spatial interaction that you want to capture in your analysis. SAR models are commonly used when there is a clear spatial autocorrelation pattern in the data.

SE Model: The SE model is suitable when you believe that the residuals or errors of a traditional regression model exhibit spatial autocorrelation. This model is appropriate when you want to account for spatially correlated error terms that may arise due to unobserved spatially varying factors or omitted variables. SE models are useful when you expect that the errors have a spatial structure that is not captured by the independent variables.

Spatial Durbin Model: The Spatial Durbin model is appropriate when you want to examine both the direct and indirect spatial effects of the dependent variable and the independent variables. It allows for investigating how changes in the values of the dependent and independent variables in neighboring locations impact the value of the dependent variable at a specific location. The Spatial Durbin model is suitable when you expect both spatial spillover effects and spatially structured error terms in your analysis.

GWR: Geographically Weighted Regression is useful when you suspect that the relationships between the dependent variable and independent variables vary across space. It allows for estimating spatially varying regression coefficients and provides insights into how the relationships change across different locations. GWR is appropriate when you expect spatial heterogeneity or non-stationarity in the relationships and want to capture local variations in the data.

It is important to note that the appropriate choice of spatial regression model also depends on the availability and quality of spatial data, the scale of analysis, and the underlying assumptions of the models. It is often valuable to explore and compare the results from different spatial regression models to gain a more comprehensive understanding of the relationships between variables in a spatial context.


We can further test this by doing (geographically weighted?) regression of yields over time by municipio
•	Regression table, possibly graphs


```{r}













```













## Historical vs. Modern Regression by Municipality

We can also do a limited cross validation using historical data regressed against modern data


```{r, label='Historical vs. Modern Regression by Municipality', message=FALSE,warning=FALSE}
dat <- read.csv(paste0(wd$data_r,"Hist_vs_Modern_Yields.csv"))

dat_C16 = dat %>% filter(Sample == "C16")

dat_C18 = dat %>% filter(Sample == "C18") %>% filter(!(Municipio %in% c("Apan")))


fitA = lm(Colonial ~ SIAP, dat_C16)
fitAs = summary(fitA)

fitB = lm(Colonial ~ X1960, dat_C18)
fitBs = summary(fitB)

fitC = lm(Colonial ~ SIAP, dat)
fitCs = summary(fitC)

plt_A <- ggplot(dat_C16, aes(x=SIAP, y=Colonial)) +
  geom_point(size=2.5, color="black", shape=16) + 
  geom_smooth(fullrange=F, method =lm, se=TRUE, colour="red", size=1) +
  scale_x_continuous(breaks=seq(1000,4000,1000)) +
  scale_y_continuous(breaks=seq(0,5000,1000)) +
  coord_cartesian(xlim=c(750,4250), ylim=c(0,6500)) +
  annotate("label", x = 1700, y = 5700, label = "atop(bold(italic(Y) == 1.23 * ~italic(X) - 92.8),bold(italic(R^2) == 0.65 ~~~~~~ italic(n) == 7 ))", parse = TRUE, color ="black", size=4)+
  xlab("SIAP 2003-2021 Yield (kg / ha)") +
  ylab("Early Colonial Yield (kg / ha)") +
  theme_bw() +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"))

plt_B <- ggplot(dat_C18, aes(x=X1960, y=Colonial)) +
  geom_point(size=2.5, color="black", shape=16) + 
  geom_smooth(fullrange=F, method =lm, se=TRUE, colour="red", size=1) +
  scale_x_continuous(breaks=seq(600,1200,200)) +
  scale_y_continuous(breaks=seq(0,1750,250)) +
  coord_cartesian(xlim=c(550,1250), ylim=c(0,2100)) +
  annotate("label", x = 750, y = 1850, label = "atop(bold(italic(Y) == 1.72 * ~italic(X) - 621.6),bold(italic(R^2) == 0.49 ~~~~~~ italic(n) == 14 ))", parse = TRUE, color ="black", size=4)+
  xlab("1960 Census Yield (kg / ha)") +
  ylab("Late Colonial Yield (kg / ha)") +
  theme_bw() +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"))

plt_C <- ggplot(dat, aes(x=SIAP, y=Colonial)) +
  geom_point(size=2.5, color="black", shape=16) + 
  geom_smooth(fullrange=F, method =lm, se=TRUE, colour="red", size=1) +
  scale_x_continuous(breaks=seq(1000,4000,1000)) +
  scale_y_continuous(breaks=seq(0,5000,1000)) +
  coord_cartesian(xlim=c(750,4250), ylim=c(0,6000)) +
  annotate("label", x = 1760, y = 5300, label = "atop(bold(italic(Y) == 1.07 * ~italic(X) - 747.5),bold(italic(R^2) == 0.35 ~~~~~~ italic(n) == 22 ))", parse = TRUE, color ="black", size=4)+
  xlab("SIAP 2003-2021 Yield (kg / ha)") +
  ylab("Colonial Yield (kg / ha)") +
  theme_bw() +
  theme(axis.text = element_text(size = 12, color="black"),
        axis.title.y = element_text(size = 12, face = "bold"),
        axis.title.x = element_text(size = 12, face = "bold"))

pltABC <- plot_grid(plt_A, plt_B, plt_C, ncol = 3, nrow = 1, labels = "AUTO", label_size = 30, hjust=-1)

ggsave("Hist_vs_Modern_Yields.png", plot = pltABC, device = "png", path = wd$figs, scale = 1, width = 9.5, height = 3.25,   units = "in",  dpi = 1500, bg = "white")

knitr::include_graphics(paste0(wd$figs,"Hist_vs_Modern_Yields.png"), FALSE)
```



# Rescale Yield Data
nom = "Mixquiahuala de Juarez, Hidalgo"
x = SIAP_4 %>% filter(EstadoMunicipio == nom)
x$Yield



```{r, label='xxx', message=FALSE,warning=FALSE}

"Mixquiahuala de Juarez, Hidalgo", 
"Tezontepec de Aldama, Hidalgo", 
"Tepetitlan, Hidalgo", 
"Tula de Allende, Hidalgo", 
"Tepeji del Rio de Ocampo, Hidalgo", 
"Tlaxcoapan, Hidalgo", 
"Soyaniquilpan de Juarez, Mexico", 
"Tlahuelilpan, Hidalgo", 
"Atitalaquia, Hidalgo", 
"Atotonilco de Tula, Hidalgo", 
"Francisco I. Madero, Hidalgo", 
```




## CHINAMPAS SBOM

```{r, label='xxx', message=FALSE,warning=FALSE}

```





# Drafts

Entropy(x$Yield[complete.cases(x$Yield)])
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(sdYield_Total)
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(sdYield_Total)
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(cvYield_Total)
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(cvYield_Total)
hist(x$Yield)
hist(x$PctYieldLoss)

```{r, label='xxx', message=FALSE,warning=FALSE}
nom = "Mixquiahuala de Juarez, Hidalgo"
x = SIAP_4 %>% filter(EstadoMunicipio == nom)
x$YieldLoss
x$PctYieldLoss
Entropy(x$YieldLoss[complete.cases(x$YieldLoss)])
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(sdYieldLoss_Total)
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(sdPctYieldLoss_Total)
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(cvYieldLoss_Total)
SIAP_6 %>% filter(EstadoMunicipio == nom) %>% pull(cvPctYieldLoss_Total)
hist(x$YieldLoss)
hist(x$PctYieldLoss)

```
Tlaltizapan de Zapata, Morelos
Xochitepec, Morelos
Tepoztlan, Morelos
Cuernavaca, Morelos
Yautepec, Morelos
Ayala, Morelos

Ozumba, Mexico
Chalco, Mexico
Coatepec Harinas, Mexico
Tonatico, Mexico
Coatepec Harinas, Mexico
Ixtapan de la Sal, Mexico

Tepeojuma, Puebla
Huaquechula, Puebla
Tlapanala, Puebla
Tepexco, Puebla
Tepemaxalco, Puebla
San Diego la Mesa Tochimiltzingo, Puebla
Teopantlan, Puebla


!!!!!!!!!!!!!!!!!!!!
NE, Estado de Mexico
Nopaltepec, Mexico
Axapusco, Mexico
Temascalapa, Mexico
San Martin de las Piramides, Mexico
Tepetlaoxtoc, Mexico

SE Hidalgo
Apan, Hidalgo
Emiliano Zapata, Hidalgo
Singuilucan, Hidalgo
Epazoyucan, Hidalgo
Mineral del Monte, Hidalgo


S. Hidalgo
Mixquiahuala de Juarez, Hidalgo
Tezontepec de Aldama, Hidalgo
Tepetitlan, Hidalgo
Tula de Allende, Hidalgo
Tepeji del Rio de Ocampo, Hidalgo


Tecamachalco Region, Puebla
Yehualtepec, Puebla
Xochitlan Todos Santos, Puebla
Molcaxac, Puebla
Tecamachalco, Puebla
Quecholac, Puebla



```{r}
ColonialTS = Colonial %>% filter(TimeSeries == T)  %>% group_by(Name) %>% 
  mutate(Yield_rs = linear_rescale(Yield),
         Yield_z = (Yield - mean(Yield))/sd(Yield),
         ks = ks.test(Yield, "pnorm",fitdistr(Yield,"normal")$estimate[1],fitdistr(Yield,"normal")$estimate[2])$p.value,
         shapiro = shapiro.test(Yield)$p.value ) %>% ungroup()

ChiconautlaC16TS = ColonialTS %>% filter(Name == "Chiconautla") 
CoatepecC16TS = ColonialTS %>% filter(Name == "Coatepec") 
ZapotlanC16TS = ColonialTS %>% filter(Name == "Zapotlan") 
TizayucaC16TS = ColonialTS %>% filter(Name == "Tizayuca") 
TepepolcoC16TS = ColonialTS %>% filter(Name == "Tepepolco") 
SanMartinNotarioC16TS = ColonialTS %>% filter(Name == "Haz. San Martin Notario") 
SanJoseAcolmanC16TS = ColonialTS %>% filter(Name == "Haz. San Jose Acolman") 
SanDiegoPinalC16TS = ColonialTS %>% filter(Name == "Haz. San Diego Pinal") 
hist(ChiconautlaC16TS$Yield, breaks =8)
hist(CoatepecC16TS$Yield, breaks =8)
hist(ZapotlanC16TS$Yield, breaks =8)
hist(TizayucaC16TS$Yield, breaks =8)
hist(TepepolcoC16TS$Yield, breaks =8)
hist(SanMartinNotarioC16TS$Yield, breaks =8)
hist(SanJoseAcolmanC16TS$Yield, breaks =8)
hist(SanDiegoPinalC16TS$Yield, breaks =8)
hist(ColonialTS$Yield_rs)
hist(ColonialTS$Yield_z)
hist(ColonialTS$Yield)

x=ks.test(ChiconautlaC16TS$Yield, "pnorm",fitdistr(ChiconautlaC16TS$Yield,"normal")$estimate[1],fitdistr(ChiconautlaC16TS$Yield,"normal")$estimate[2])

ecdf.ks.CI(ChiconautlaC16TS$Yield, family="sans", main= "Chiconautla C16 TS", cex.main=2, font.main=2, font.lab=2, xlab="Yield", ylab="ECDF(Yield)")
fit<-fitdistr(ChiconautlaC16TS$Yield,"normal")$estimate
Norm1 <- rnorm(10000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")

ecdf.ks.CI(CoatepecC16TS$Yield, family="sans", main= "Coatepec C16 TS", cex.main=2, font.main=2, font.lab=2, xlab="Yield", ylab="ECDF(Yield)")
fit<-fitdistr(CoatepecC16TS$Yield,"normal")$estimate
Norm1 <- rnorm(10000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")

ecdf.ks.CI(SanDiegoPinalC16TS$Yield, family="sans", main= "SanDiegoPinal C18 TS", cex.main=2, font.main=2, font.lab=2, xlab="Yield", ylab="ECDF(Yield)")
fit<-fitdistr(SanDiegoPinalC16TS$Yield,"normal")$estimate
Norm1 <- rnorm(10000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
```











```{r}
a = SIAP_4 %>% filter(AGType == "Temporal") %>% filter(!is.na(zYield))
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
#shapiro.test(a$zYield)

a = SIAP_4 %>% filter(AGType == "Riego") %>% filter(!is.na(zYield))
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Riego", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)

a = SIAP_4 %>% filter(!is.na(zYield))
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Both", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
#shapiro.test(a$zYield)

a = SIAP_4 %>% filter(EstadoMunicipio == "Tlalpan, Distrito Federal" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Tlalpan Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)


a = SIAP_4 %>% filter(EstadoMunicipio == "Xochimilco, Distrito Federal" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Xochimilco Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)


a = SIAP_4 %>% filter(EstadoMunicipio == "Epazoyucan, Hidalgo" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Epazoyucan Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)


a = SIAP_4 %>% filter(EstadoMunicipio == "Tecamac, Mexico" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Tecamac Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)

```













```{r}
hist(SIAP_5$AvgYield)
gamma_test(SIAP_5$AvgYield)
a= SIAP_5 %>% filter(AGType == "Temporal")
gamma_test(a$AvgYield)
hist(a$AvgYield)
a= SIAP_5 %>% filter(AGType == "Riego")
gamma_test(a$AvgYield)
hist(a$AvgYield)

hist(SIAP_5$cvYield)
gamma_test(SIAP_5$cvYield)
a= SIAP_5 %>% filter(AGType == "Temporal")
gamma_test(a$cvYield)
hist(a$cvYield)
a= SIAP_5 %>% filter(AGType == "Riego")
gamma_test(a$cvYield)
hist(a$cvYield)

hist(SIAP_5$sdYield)
gamma_test(SIAP_5$sdYield)
a= SIAP_5 %>% filter(AGType == "Temporal")
gamma_test(a$sdYield)
hist(a$sdYield)
a= SIAP_5 %>% filter(AGType == "Riego")
gamma_test(a$sdYield)
hist(a$sdYield)
```










```{r, 'Rescale SIAP 2003-2021 Yield Data', message=FALSE, warning=FALSE}

hist(unique(SIAP_3$TotYield), breaks = seq(0, 12500, by = 250), xlim = c(0,12500))
hist(log(unique(SIAP_3$TotYield)), breaks = 50)
hist(SIAP_3$Yield, breaks = seq(0, 13000, by = 250), xlim = c(0,13000))
hist(log(SIAP_3$Yield), breaks = 50)





```
Tepepolco
Haz. SanMartinNotario
Haz. SanJoseAcolman
Haz. SanDiegoPinal



p <- data %>%
  mutate(text = fct_reorder(text, value)) %>%
  ggplot( aes(x=value, color=text, fill=text)) +
    geom_histogram(alpha=0.6, binwidth = 5) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("Assigned Probability (%)") +
    facet_wrap(~text)

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 