---
title: "Aztec Agricultural Productivity Model"
subtitle: "Part 2: Agriculture Data"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```

This R markdown document prepares the data used in the Aztec agricultural productivity random forest model, which is undertaken in Part 2 (the subsequent R markdown script). This involves the following:

  1. Load, reorganize and integrate the modern agricultural analogue dataset, which includes:
      + Contemporary municipio polygons from INEGI
      + 2010 municipal population census statistics
      + 2007 municipal agricultural census statistics
      + FASII and INEGI geospatial land use polygons from the 2000s and 2010s
      + SIAP 2003-2021 crop yield data
      + 
 
CRS = WGS84 UTM Zone 14N (EPSG: 32614)


# Setup 

All of the data and scripts are downloadable from the [Aztec Agriculture github repository](https://https://github.com/rcesaret/AztecAgriculture), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/Huexotzinco/HuexTlaxAnal2022/HuexTlax2022Analysis/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", "dismo", 
              "purrr", "spatialEco", "whitebox", "classInt","ggnewscale", "lbmech", 
              "data.table", "tidyterra","gridExtra", "cowplot", "scam", "rmarkdown", 
              "spatialreg","spdep", "ggridges", "ggnewscale", "scales", "ggstatsplot",
              "stringi", "fuzzyjoin", "mgcv", "randomForest", "ranger", "kableExtra", 
              "goft", "MASS", "NSM3", "ggsn")


# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R", "linear_rescale.R")#"splitByAttributes.R", 
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```



# 2000s Agricultural Data

## Municipios

```{r, 'Load Municipios Polygons', message=FALSE, warning=FALSE}
# Read-in municipio polygons for the focal region
Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))

# Remove Spanish accent marks from the municipality names
Municipios2000s$NOM_MUN <- stri_trans_general(str=Municipios2000s$NOM_MUN,id="Latin-ASCII")


Municipios2000s <- Municipios2000s %>% 
  # create variable for the written name of the state based on the state code in the polygon data
  mutate(State = case_when(
    CVE_ENT == "15" ~ "Mexico",
    CVE_ENT == "09" ~ "Distrito Federal",
    CVE_ENT == "13" ~ "Hidalgo",
    CVE_ENT == "17" ~ "Morelos",
    CVE_ENT == "21" ~ "Puebla",
    CVE_ENT == "29" ~ "Tlaxcala")) %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, NOM_MUN, State, sep = ", ", remove = F) %>%  
  # remove a number of municipalities that are not included in the focal region
  # (these polygons are tiny residual edges not removed by GIS pre-processing)
  filter(!(EstadoMunicipio %in% c("Almoloya de Alquisiras, Mexico", "Amanalco, Mexico", "Texcaltitlan, Mexico","Polotitlan, Mexico", "Temascalcingo, Mexico","Villa de Allende, Mexico", "Acambay de Ruiz Castaneda, Mexico", "Aculco, Mexico"))) %>% 
  # rename variables
  rename(Estado = State, Estado_ID = CVE_ENT, Municipio_ID = CVE_MUN, Municipio = NOM_MUN) %>% 
  # remove prior ID column
  select(-OID_1)

# calculate variable for the area of each municipality in square meters
Municipios2000s$Area_m2 <- st_area(Municipios2000s)
# calculate variable for the area of each municipality in hectares
Municipios2000s$Area_ha <- as.numeric(Municipios2000s$Area_m2)/10000
# create copy of municipality dataframe without the polygons
Municipios2000s_Cases = st_drop_geometry(Municipios2000s)
# save municipality polygon data
st_write(Municipios2000s, paste0(wd$data_p, "Municipios2000s_Data.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)

```




## 2000s Census Data


### 2010 Population Census

```{r, 'Load/Organize 2010 Population Census', message=FALSE, warning=FALSE}

# read .csv file of 2010 population census data
PopCensus2010 <- read.csv(paste0(wd$data_r,"AG_Model_2000s/PopCensus2010.csv"))

PopCensus2010 <- PopCensus2010 %>% 
  # remove a number of unwanted variables
  select(-MUN, -ORD, -MUN_NUM, -INCLUDE) %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F)

# left join the 2010 population census data with the municipality dataframe
PopCensus2010 <- Municipios2000s_Cases %>% left_join(PopCensus2010, by=c('EstadoMunicipio', 'Municipio', 'Estado'))
# export csv of the 2010 population census data
write.csv(PopCensus2010, paste0(wd$data_r,"AG_Model_2000s/testcensus.csv"))

```




### 2007 Agricultural Census

```{r, 'Load/Organize 2007 Agricultural Census', message=FALSE, warning=FALSE}

# read .csv file of 2007 agricultural census data
AGCensus2007 <- read.csv(paste0(wd$data_r,"AG_Model_2000s/AGCensus2007.csv"))

AGCensus2007 <- AGCensus2007 %>% 
  # remove a number of unwanted variables
  select(-Region, -ORD, -Num, -INCLUDE) %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F)

```





### Integrate 2000s Cenusus Data

```{r, 'Integrate 2000s Cenusus Data', message=FALSE, warning=FALSE}

# create a combined 2000s census dataframe from the 2010 population census dataframe
# and the 2007 agricultural census dataframe
Census2000s <- PopCensus2010 %>% 
  # select desired 2010 population census variables to join with 2007 agricultural census data
  select(Estado_ID, Municipio_ID, EstadoMunicipio, Municipio, Estado, Area_ha, 
         Pop_Total, Pop_Rural, Pop_Urban, UrbRatio, Pop_Pct_Rural, Pop_Employed, 
         Primary, Pct_Primary, AG_Workers, Pct_AG_Workers) %>% 
  # left join the 2010 population census data with the 2007 agricultural census dataframe
  left_join(AGCensus2007, by=c('EstadoMunicipio', 'Municipio', 'Estado'))


```


### Calculate Derived Census Variables

```{r, 'Calculate Derived 2000s Census Variables', message=FALSE, warning=FALSE}

# Calculate a number of derived variables from the combined 2000s census dataframe
Census2000s <- Census2000s %>% mutate(
  PopDens = Pop_Total / Area_ha, # population density
  PopDensRural = Pop_Rural / Area_ha, # population density of the rural population
  PrimaryEmployDens = Primary / Area_ha, # population density of primary sector employment (2010 pop census variable)
  TotalLaborDens = TotalLabor / Area_ha, # population density of total agricultural labor (2007 agricultural census variable)
  AGPasture_ha = AG_ha + Pasture_ha, # Total land used for agriculture and animal husbandry
  PrimaryEmploy_perHa = Primary / AGPasture_ha, # Density of primary sector employment (2010 pop census variable) per hectare of agriculture+pasture land
  AG_Workers_perHa = AG_Workers / AGPasture_ha, # Density of agricultural workers (2010 pop census variable, only includes laborers) per hectare of agriculture+pasture land
  TotalLabor_perHa = TotalLabor / AGPasture_ha, # Density of total agricultural labor (2007 agricultural census variable) per hectare of agriculture+pasture land
  MechanizEquip_perHa = MechanizEquip / AGPasture_ha, # Density of mechanized agricultural equipment per hectare of agriculture+pasture land
  DraftAnimals_perHa = DraftAnimals_Total / AGPasture_ha, # Density of draught animals per hectare of agriculture+pasture land
  Pct_AG_ha = AG_ha / AGPasture_ha, # Percentage of total agriculture+pasture land that is agricultural
  Pct_Pasture_ha = Pasture_ha / AGPasture_ha, # Percentage of total agriculture+pasture land that is pasture
  
  #### Calculation of "Labor Units" ####
  # used to equivocate different forms of labor input (machine, animal, human)
  # using efficiencies calculated from 20th century statistics on cultivation labor 
  # time per unit area using different technology (i.e. machine, animal, human).
  # One "Labor Unit" (LU) == 1 person-year of manual labor based on person-day equivalents
  # for common tasks undertaken over the course of the agricultural season

  LU_MechanizEquip = MechanizEquip * 20, # one piece of mechanized equipment is equivalent to 20 people
  LU_DraftAnimals = DraftAnimals_Total * 1, # draught animals and humans have 1-to-1 LU relationship 
  LU_FamLabor = FamLabor_Tot * 1, # Each family farm operator contributes 1 labor unit
  LU_ContractFull = ContractLabor_More6Mo * 1, # Each full-time contract laborer contributes 1 labor unit
  LU_ContractPart = ContractLabor_Less6Mo * 0.5, # Each seasonal contract laborer contributes 0.5 labor units
  LU_Total = LU_MechanizEquip + LU_DraftAnimals + LU_FamLabor + LU_ContractFull + LU_ContractPart, # total LUs == sum of all LUs
  LU_Total_perHa = LU_Total / AGPasture_ha # Density of total LUs per hectare of agriculture+pasture land
  )

```




## 2000s Land Use Data

Accidentally missing in SIAP, need to recheck:
Acatzingo, Puebla
General Felipe Angeles, Puebla
Mixtla, Puebla
San Salvador Huixcolotla, Puebla
Santo Tomas Hueyotlipan, Puebla


```{r, 'Load/Organize Land Use Polygons', message=FALSE, warning=FALSE}

# read GIS polygon data gpkg. This data is the intersection of two different land use polygon datasets:
# 1) FASII 2015 agricultural land use polygons
# 2) INEGI 2013 agricultural Land Use Polygons
LU2000 <- st_read(paste0(wd$data_r, "AG_Model_2000s/FASII_INEGI_LandUse2000s.gpkg")) 

# Remove Spanish accent marks from the municipality and state names
LU2000$NOM_MUN <- stri_trans_general(str=LU2000$NOM_MUN,id="Latin-ASCII")
LU2000$NOMEDO <- stri_trans_general(str=LU2000$NOMEDO,id="Latin-ASCII")
 

LU2000b <- LU2000 %>% 
  # Create new variable to abbreviate classified INEGI land use types
  mutate(Tipages = case_when(
    TIPAGES == "AGRICULTURA DE RIEGO" ~ "R",
    TIPAGES == "AGRICULTURA DE TEMPORAL" ~ "T",
    TIPAGES == "AGRICULTURA DE HUMEDAD" ~ "H")) %>% rowwise() %>% 
  # Create new master variable agricultural type classification using both
  # FASII and INEGI and FASII land use data
  mutate(
      #Type = ifelse(Tipages == "R" | MOD_AGR == "R", "R", 
      #              ifelse(Tipages == "H", "H", "T"))
      Type = ifelse(Tipages == "R" | MOD_AGR == "R", "Riego", "Temporal"),
      Type = ifelse(is.na(Type), "Temporal", Type)) %>% ungroup() %>%
  # remove unneeded variables
  select(-Name, -fid_2, -layer, -path, -NOMEDO,  -fid_3) %>% 
  # rename variables
  rename(Estado_ID = CVE_ENT, ddr_ID = CVE_DDR, ddr = NOMDDR, Cader_ID = CVE_CADER, 
    Cader = NOMCADER, Municipio_ID = CVE_MUN, Municipio = NOM_MUN) %>% 
  # create variable for the written name of the state based on the state code in the polygon data
  mutate(Estado = case_when(
    Estado_ID == "15" ~ "Mexico",
    Estado_ID == "09" ~ "Distrito Federal",
    Estado_ID == "13" ~ "Hidalgo",
    Estado_ID == "17" ~ "Morelos",
    Estado_ID == "21" ~ "Puebla",
    Estado_ID == "29" ~ "Tlaxcala"))

# Join/merge (union) all land use polygons of the name agricultural type within each municipality
LU2000c <- LU2000b %>% group_by(Type, Estado, Estado_ID, Municipio, Municipio_ID) %>% 
  summarise(geom = sf::st_union(geom)) %>% ungroup()

# calculate the area of the merged polygons in square meters and hectares
LU2000c$Area_m2 <- st_area(LU2000c)
LU2000c$Area_ha <- as.numeric(LU2000c$Area_m2)/10000


LU2000d <- LU2000c %>% 
  # create a variable that joins state and municipality written names ("[municipality], [state]")
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>% 
  # remove a number of municipios that should not be in the CMex focal region dataset
  filter(!(EstadoMunicipio %in% c("Coatetelco, Morelos", "Almoloya de Alquisiras, Mexico", "Amanalco, Mexico", "Iztapalapa, Distrito Federal", "Texcaltitlan, Mexico","Polotitlan, Mexico", "Temascalcingo, Mexico","Villa de Allende, Mexico", "Acambay de Ruiz Castaneda, Mexico", "Aculco, Mexico"))) %>% 
  # 
 mutate(AGType = case_when(
    EstadoMunicipio == "Tzicatlacoyan, Puebla" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Santa Catarina Tlaltempan, Puebla" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "San Diego la Mesa Tochimiltzingo, Puebla" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Ocuilan, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Cocotitlan, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Villa Guerrero, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Tonanitla, Mexico" & Type == "Riego" ~ "Temporal", #############################
    EstadoMunicipio == "Cuautitlan, Mexico" & Type == "Temporal" ~ "Riego", #############################
    .default = Type)) %>% select(-Type)

#%>% group_by(AGType, Estado, Estado_ID, Municipio, Municipio_ID, EstadoMunicipio) %>% 
  #summarise(geom = sf::st_union(geom)) %>% ungroup()

# Join/merge (union) all land use polygons of the name agricultural type within each municipality
LU2000e <- LU2000d %>% group_by(AGType, Estado, Estado_ID, Municipio, Municipio_ID, EstadoMunicipio) %>% 
  summarise(geom = sf::st_union(geom)) %>% ungroup()

# calculate the area of the merged polygons in square meters and hectares
LU2000e$Area_m2 <- st_area(LU2000e)
LU2000e$Area_ha <- as.numeric(LU2000e$Area_m2)/10000

LU_Cases = st_drop_geometry(LU2000e)
#write.csv(st_drop_geometry(LU2000c), paste0(wd$data_r,"LU_Cases.csv"))

#st_write(LU2000e, dsn = paste0(wd$data_r, "AG_Model_2000s/test2.gpkg"),layer="test2", driver="GPKG")

```


Change Riego to Temporal = 
Tzicatlacoyan, Puebla
Santa Catarina Tlaltempan, Puebla
San Diego la Mesa Tochimiltzingo, Puebla
Ocuilan, Mexico
Cocotitlan, Mexico
Villa Guerrero, Mexico

Change Temporal to Riego=
Cuautitlan, Mexico


HUMEDAD??


## SIAP Data 2003-2021

~Remove ROWS from SIAP due to 1 year (not included in land use data)~
~Remove ROWS from SIAP due to size (not included in land use data)~
~Remove ROWS from SIAP due to NO LAND USE LOCATION (not included in land use data)~



```{r, 'Load/Organize SIAP 2003-2021 Yield Data', message=FALSE, warning=FALSE}

# Read-in the SIAP 2003-2021 Yield Data
SIAP <- read.csv(paste0(wd$data_r,"Cierre_agricola_mun_2003_2021.csv"))


SIAP_2 = SIAP %>% 
  # restrict dataset to the Mexican states located in the CMex focal region
  filter(Estado == "Ciudad de Mexico / DF" | 
         Estado == "Ciudad de Mexico" |
         Estado == "Mexico" |
         Estado == "Puebla" |
         Estado == "Morelos" |
         Estado == "Hidalgo" |
         Estado == "Tlaxcala") %>% 
  # Change some string names in the data to be congruent with the other agricultural data
  mutate_all(~ str_replace_all(., c("Ciudad de Mexico / DF" = "Distrito Federal", 
                                    "Ciudad de Mexico" = "Distrito Federal",
                                    "QUECHOLAC" = "Quecholac",
                                    "alvaro Obregon" = "Alvaro Obregon", 
                                    "General Felipe angeles" = "General Felipe Angeles"))) %>%
  # Change incorrectly-designated character variables to numeric
  mutate(Planted = as.numeric(Planted), Harvested = as.numeric(Harvested),
          Lost = as.numeric(Lost), Product = as.numeric(Product),
          Yield = as.numeric(Yield), Price = as.numeric(Price),
          Value = as.numeric(Value)) %>% 
  mutate(
    # reported yield in the data == Product (tons) / hectares harvested
    Yield_orig = Yield,
    # we want to change the reported yield to == Product (tons) / hectares planted
    # to account for yield loss over the course of the growing season
    Yield = Product / Planted,
    # calculate the overall/average yield loss in tons per hectare
    YieldLoss = Yield_orig - Yield) %>% rowwise() %>% mutate(
      YieldLoss = ifelse(YieldLoss < 0, 0, YieldLoss)) %>% ungroup()

#SIAP_ID = SIAP_2 %>% select(-Year, -(Cycle_ID:Value)) %>% distinct(EstadoMunicipio, .keep_all = T, .remove_duplicates = TRUE)

# Export SIAP 2003-2021 Yield Data for manual editing
#write.csv(SIAP_ID, paste0(wd$data_r,"SIAP_ID.csv"))

# read-in manually-edited SIAP 2003-2021 ID Data
SIAP_ID <- read.csv(paste0(wd$data_r,"SIAP_ID_EDITS.csv")) %>% 
  # Change some string names in the data to be congruent with the other agricultural data
  mutate_all(~ str_replace_all(., c("Ciudad de Mexico / DF" = "Distrito Federal", 
                                    "Ciudad de Mexico" = "Distrito Federal",
                                    "QUECHOLAC" = "Quecholac",
                                    "alvaro Obregon" = "Alvaro Obregon", 
                                    "General Felipe angeles" = "General Felipe Angeles")))

# left-join edited SIAP_ID dataframe with SIAP_2 yield data
SIAP_3 = SIAP_2 %>% left_join(SIAP_ID, by = c('Estado_ID', 'Estado', 'ddr_ID', 'ddr', 'Cader_ID', 'Cader', 'Municipio_ID', 'Municipio', 'EstadoMunicipio')) %>% 
  # filter the data to only include Maize states and municipalities in the CMex focal region
  filter(Cultigen == "Maiz grano", INCLUDE == TRUE) %>%
  # convert units -- tons to kg -- for yield, yield loss and product
  mutate(Yield = Yield * 1000, Yield_orig = Yield_orig * 1000, Product = Product* 1000, YieldLoss = YieldLoss*1000) %>% 
  # only consider Spring-Summer crop cycle yields (exclude Autumn-Winter yields)
  filter(Cycle == "Primavera-Verano") %>%
  # calculate overall municipal average maize yields for all agricultural types (temporal and riego)
  # by first grouping by state-municipality and year, and then dividing the sum of the product by the sum of the hectares planted
  group_by(EstadoMunicipio, Year) %>%
  mutate(TotYield = (sum(Product, na.rm=T) / sum(Planted, na.rm=T)) + runif(1, min = 0.0001, max = 0.01),
         TotYield_orig = sum(Product, na.rm=T) / sum(Harvested, na.rm=T),
         TotYieldLoss = TotYield_orig - TotYield) %>% ungroup()
  
#write.csv(SIAP_3, paste0(wd$data_r,"SIAP_CMex_Maize.csv"))

```





```{r, 'Reformat SIAP 2003-2021 Yield Data', message=FALSE, warning=FALSE}



SIAP_4 = SIAP_3 %>% 
  # group the data by state-municipality and agriculture type
  group_by(EstadoMunicipio, AGType) %>% 
  # calculate variables for the maize yield (and yield loss) time-series: mean, standard deviation 
  # and coefficient of variation by state-municipality and agriculture type
  mutate(AvgYield = mean(Yield, na.rm=T), 
         sdYield = sd(Yield, na.rm=T), 
         cvYield = sdYield/AvgYield*100,
         AvgYieldLoss = mean(YieldLoss, na.rm=T), 
         sdYieldLoss = sd(YieldLoss, na.rm=T), 
         cvYieldLoss = sdYieldLoss/AvgYield*100) %>% 
  # calculate variable for the number of time series cases by state-municipality and agriculture type
  add_tally() %>% 
  # ungroup the data
  ungroup() %>% 
  # calculate the maize yield Z-score by state-municipality and agriculture type
  # using the state-municipality / agriculture type mean and st.dev
  mutate(zYield = (Yield - AvgYield)/sdYield) %>% 
  # group by state-municipality
  group_by(EstadoMunicipio) %>% 
  # calculate variables for the Yield and Yield Loss  mean, standard deviation and 
  # coefficient of variation for each agriculture type by state-municipality
  mutate(AvgYield_Total = mean(unique(TotYield), na.rm=T), #sum(Product, na.rm=T) / sum(Planted, na.rm=T)
         sdYield_Total = sd(unique(TotYield), na.rm=T), 
         cvYield_Total = sdYield_Total/AvgYield_Total*100,
         AvgYield_Irrig = mean(Yield[AGType == "Riego"] , na.rm=T),
         sdYield_Irrig = sd(Yield[AGType == "Riego"] , na.rm=T),
         cvYield_Irrig = sdYield_Irrig/AvgYield_Irrig*100,
         AvgYield_Temp = mean(Yield[AGType == "Temporal"], na.rm=T),
         sdYield_Temp = sd(Yield[AGType == "Temporal"], na.rm=T),
         cvYield_Temp = sdYield_Temp/AvgYield_Temp*100,
         AvgYieldLoss_Total = mean(unique(TotYieldLoss), na.rm=T), 
         sdYieldLoss_Total = sd(unique(TotYieldLoss), na.rm=T), 
         cvYieldLoss_Total = sdYieldLoss_Total/AvgYieldLoss_Total*100,
         AvgYieldLoss_Irrig = mean(YieldLoss[AGType == "Riego"] , na.rm=T),
         sdYieldLoss_Irrig = sd(YieldLoss[AGType == "Riego"] , na.rm=T),
         cvYieldLoss_Irrig = sdYieldLoss_Irrig/AvgYieldLoss_Irrig*100,
         AvgYieldLoss_Temp = mean(YieldLoss[AGType == "Temporal"], na.rm=T),
         sdYieldLoss_Temp = sd(YieldLoss[AGType == "Temporal"], na.rm=T),
         cvYieldLoss_Temp = sdYieldLoss_Temp/AvgYieldLoss_Temp*100) %>% 
  # calculate variable for the overall number of time series cases by state-municipality
  add_tally(name = "n_Total") %>% 
  # ungroup the data
  ungroup() %>% 
  # calculate additional variables of interest
  mutate(
    # calculate the maize yield and yield loss Z-score by state-municipality for all agriculture types
    zYield_Total = (Yield - AvgYield_Total)/sdYield_Total,
    zYieldLoss_Total = (YieldLoss - AvgYieldLoss_Total)/sdYieldLoss_Total,
    # Calculate the ratio of mean irrigated maize yield to mean temporal maize yield for each state-municipality
    IT_ratio_AvgYield = AvgYield_Irrig/AvgYield_Temp,
    IT_ratio_AvgYieldLoss = AvgYieldLoss_Irrig/AvgYieldLoss_Temp,
    # Calculate the ratio of the irrigated maize yield coefficient of variation to 
    # the temporal maize yield and yield loss coefficient of variation for each state-municipality
    IT_ratio_cvYield = cvYield_Irrig/cvYield_Temp,
    IT_ratio_cvYieldLoss = cvYieldLoss_Irrig/cvYieldLoss_Temp)


SIAP_5 = SIAP_4 %>% 
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sdYield/AvgYield*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sdYieldLoss/AvgYieldLoss*100, # coefficient of variation of maize Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares planted in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares planted in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            n = mean(n, na.rm=T), # number of time series cases by state-municipality and agriculture type
            n_Total = mean(n_Total, na.rm=T), # overall number of time series cases by state-municipality
            
            AvgYield_Total = mean(AvgYield_Total, na.rm=T), # mean maize yield for all agriculture types
            sdYield_Total = mean(sdYield_Total, na.rm=T), # standard deviation of maize yield for all agriculture types
            cvYield_Total = mean(cvYield_Total, na.rm=T), # coefficient of variation of maize yield for all agriculture types
            AvgYield_Irrig = mean(AvgYield_Irrig, na.rm=T), # mean maize yield for irrigated agriculture
            sdYield_Irrig = mean(sdYield_Irrig, na.rm=T), # standard deviation of maize yield for irrigated agriculture
            cvYield_Irrig = mean(cvYield_Irrig, na.rm=T), # coefficient of variation of maize yield for irrigated agriculture
            AvgYield_Temp = mean(AvgYield_Temp, na.rm=T), # mean maize yield for temporal agriculture
            sdYield_Temp = mean(sdYield_Temp, na.rm=T), # standard deviation of maize yield for temporal agriculture
            cvYield_Temp = mean(cvYield_Temp, na.rm=T), # coefficient of variation of maize yield for temporal agriculture
            IT_ratio_AvgYield = mean(IT_ratio_AvgYield, na.rm=T), # irrigation-temporal ratio for mean maize yields
            IT_ratio_cvYield = mean(IT_ratio_cvYield, na.rm=T), # irrigation-temporal ratio for coefficient of variation of maize yields
            
            AvgYieldLoss_Total = mean(AvgYieldLoss_Total, na.rm=T), # mean maize yield loss for all agriculture types
            sdYieldLoss_Total = mean(sdYieldLoss_Total, na.rm=T), # standard deviation of maize yield loss for all agriculture types
            cvYieldLoss_Total = mean(cvYieldLoss_Total, na.rm=T), # coefficient of variation of maize yield loss for all agriculture types
            AvgYieldLoss_Irrig = mean(AvgYieldLoss_Irrig, na.rm=T), # mean maize yield loss for irrigated agriculture
            sdYieldLoss_Irrig = mean(sdYieldLoss_Irrig, na.rm=T), # standard deviation of maize yield loss for irrigated agriculture
            cvYieldLoss_Irrig = mean(cvYieldLoss_Irrig, na.rm=T), # coefficient of variation of maize yield loss for irrigated agriculture
            AvgYieldLoss_Temp = mean(AvgYieldLoss_Temp, na.rm=T), # mean maize yield loss for temporal agriculture
            sdYieldLoss_Temp = mean(sdYieldLoss_Temp, na.rm=T), # standard deviation of maize yield loss for temporal agriculture
            cvYieldLoss_Temp = mean(cvYieldLoss_Temp, na.rm=T), # coefficient of variation of maize yield loss for temporal agriculture
            IT_ratio_AvgYieldLoss = mean(IT_ratio_AvgYieldLoss, na.rm=T), # irrigation-temporal ratio for mean maize yield loss
            IT_ratio_cvYieldLoss = mean(IT_ratio_cvYieldLoss, na.rm=T) # irrigation-temporal ratio for coefficient of variation of maize yield loss
            
            # ungroup the data
            ) %>% ungroup() %>% 
  # remove a number of municipios that should not be in the CMex focal region dataset
  filter(!(EstadoMunicipio %in% c("Coatetelco, Morelos", "Almoloya de Alquisiras, Mexico", "Amanalco, Mexico", "Iztapalapa, Distrito Federal", "Texcaltitlan, Mexico","Polotitlan, Mexico", "Temascalcingo, Mexico","Villa de Allende, Mexico", "Acambay de Ruiz Castaneda, Mexico", "Aculco, Mexico"))) %>% 
  # remove irrigation maize yield cases for some municipalities that lack irrigation agriculture in the land use data
  filter(!(EstadoMunicipio %in% c("Chigmecatitlan, Puebla", "Huitzilac, Morelos", "San Jose Teacalco, Tlaxcala", "Tlalnepantla, Morelos", "Totolapan, Morelos", "Acajete, Puebla", "Almoloya, Hidalgo", "Apan, Hidalgo", "Atlatlahucan, Morelos", "Emiliano Zapata, Hidalgo", "Mazatecochco de Jose Maria Morelos, Tlaxcala", "San Francisco Tetlanohcan, Tlaxcala", "San Pablo del Monte, Tlaxcala", "Tolcayuca, Hidalgo", "Tonanitla, Mexico", "Amaxac de Guerrero, Tlaxcala", "Jaltenco, Mexico") & AGType %in% "Riego"))

#SIAP_5[is.nan(SIAP_5)] <- NA

SIAP_5 <- SIAP_5 %>% rowwise() %>%
  mutate(cvYieldLoss = ifelse(is.nan(cvYieldLoss), 0, cvYieldLoss),
         cvLost = ifelse(is.nan(cvLost), 0, cvLost)) %>% ungroup()

#write.csv(SIAP_4, paste0(wd$data_r,"SIAP_CMex_Maize.csv"))

#write.csv(SIAP_5, paste0(wd$data_r,"SIAP_5.csv"))


```


AvgYield_Irrig	
         sdYield_Irrig	
         cvYield_Irrig	
         AvgYield_Temp	
         sdYield_Temp	
         cvYield_Temp	
         IT_ratio_AvgYield	
         IT_ratio_cvYield

         AvgYieldLoss_Irrig	
         sdYieldLoss_Irrig	
         cvYieldLoss_Irrig	
         AvgYieldLoss_Temp	
         sdYieldLoss_Temp	
         cvYieldLoss_Temp	
         IT_ratio_AvgYieldLoss	
         IT_ratio_cvYieldLoss


Tecamac, Mexico

No Land Use:


Tonanitla, Mexico
Temporal
Villa de Tezontepec, Hidalgo
Riego




No SIAP:

Milpa Alta, Distrito Federal
Riego
Tlahuac, Distrito Federal
Riego
Xochimilco, Distrito Federal
Riego

Axapusco, Mexico
Riego
Ixtapaluca, Mexico
Riego
Ocuilan, Mexico
Riego
Valle de Chalco Solidaridad, Mexico
Riego
Villa Guerrero, Mexico
Riego
San Diego la Mesa Tochimiltzingo, Puebla
Riego
Santa Catari Tlaltempan, Puebla
Riego
Tzicatlacoyan, Puebla
Riego
Cuautitlan, Mexico
Temporal


### CHINAMPAS SBOM

```{r, label='xxx', message=FALSE,warning=FALSE}

```


### Merge SIAP with Land Use Polygons

```{r, label='Merge SIAP with Land Use Polygons', message=FALSE,warning=FALSE}
#LU_Cases = LU_Cases %>% select(EstadoMunicipio, AGType)
#SIAP_Cases = SIAP_5 %>% select(EstadoMunicipio, AGType)
#LU_Cases = st_drop_geometry(LU_Cases)
#SIAP_Cases <- SIAP_Cases[, c("EstadoMunicipio", "AGType")]

#LU_Cases$LU_Cases = TRUE
#SIAP_Cases$SIAP_Cases = TRUE

#X = SIAP_Cases %>% full_join(LU_Cases, by = c("EstadoMunicipio", "AGType"))

#X = stringdist_left_join(SIAP_Cases, LU_Cases, 
#           by = c("EstadoMunicipio", "AGType"))



SIAP_5 = SIAP_5 %>% mutate_all(~ str_replace_all(., c("San Antonio La Isla" = "San Antonio la Isla", 
                                     "Mineral de La Reforma" = "Mineral de la Reforma",
                                     "San Martin de Las Piramides" = "San Martin de las Piramides",
                                     "Ixtapan de La Sal" = "Ixtapan de la Sal", 
                                     "San Nicolas de Los Ranchos" = "San Nicolas de los Ranchos",
                                     "San Salvador El Verde" = "San Salvador el Verde", 
                                     "San Diego La Mesa Tochimiltzingo" = "San Diego la Mesa Tochimiltzingo",
                                     "Huehuetlan El Grande" = "Huehuetlan el Grande",
                                     "Tetla de La Solidaridad" = "Tetla de la Solidaridad")))


SIAP_LU_poly = LU2000e %>% left_join(SIAP_5, by = c("EstadoMunicipio", "AGType"))

SIAP_LU_poly_Cases = st_drop_geometry(SIAP_LU_poly)

#SIAP_LU_poly = stringdist_left_join(LU2000e, SIAP_5, 
#           by = c("EstadoMunicipio", "AGType"))

###SIAP_LU_poly_b = stringdist_left_join(SIAP_5, LU2000d, 
###           by = c("EstadoMunicipio", "AGType"))

SIAP_LU_poly <- SIAP_LU_poly %>% select(-ddr_ID, -ddr, -Cader_ID, -Cader, -Municipio_ID.y, -Municipio.y, -Estado_ID.y, -Estado.y, -Area_m2) %>% rename( Municipio = Municipio.x, Estado = Estado.x, Estado_ID = Estado_ID.x, Municipio_ID = Municipio_ID.x, AGType_Area_ha = Area_ha)

SIAP_LU_poly_Cases <- SIAP_LU_poly_Cases %>% select(-ddr_ID, -ddr, -Cader_ID, -Cader, -Municipio_ID.y, -Municipio.y, -Estado_ID.y, -Estado.y, -Area_m2) %>% rename( Municipio = Municipio.x, Estado = Estado.x, Estado_ID = Estado_ID.x, Municipio_ID = Municipio_ID.x, AGType_Area_ha = Area_ha)

#write.csv(SIAP_LU_poly_Cases, paste0(wd$data_r,"SIAP_LU_poly_Cases.csv"))

#setdiff(SIAP_LU_poly_a$EstadoMunicipio.x, SIAP_LU_poly_b$EstadoMunicipio.y)
#setdiff(SIAP_LU_poly_b$EstadoMunicipio.y, SIAP_LU_poly_a$EstadoMunicipio.x)
#setdiff(SIAP_LU_poly_a$EstadoMunicipio.x, SIAP_LU_poly_b$EstadoMunicipio.x)
#setdiff(SIAP_LU_poly_b$EstadoMunicipio.x, SIAP_LU_poly_a$EstadoMunicipio.x)
#setdiff(SIAP_LU_poly_b$EstadoMunicipio.y, SIAP_LU_poly_a$EstadoMunicipio.y)
#setdiff(SIAP_Cases, LU_Cases)
```

plot(Data2000s_poly["AGType"])



### Merge 2000s Census Data with SIAP-Land-Use Polygons

```{r, label='Merge 2000s Census Data with SIAP-Land-Use Polygons', message=FALSE,warning=FALSE}

Data2000s_poly = SIAP_LU_poly %>% left_join(Census2000s, 
           by = c("EstadoMunicipio", "Municipio", "Estado", "Estado_ID", "Municipio_ID"))

#%>% select( -Municipio_ID.x, -Municipio.x, -Estado_ID.x, -Estado.x, -EstadoMunicipio.x) %>% rename(EstadoMunicipio = EstadoMunicipio.y, Municipio = Municipio.y, Estado = Estado.y, Estado_ID = Estado_ID.y, Municipio_ID = Municipio_ID.y)

rm(LU_Cases, SIAP_Cases, SIAP_2, SIAP_ID, SIAP, LU2000b, LU2000, LU2000c, LU2000d, Census2000s, SIAP_LU_poly
)

#setdiff(Data2000s_poly$EstadoMunicipio, SIAP_LU_poly$EstadoMunicipio)
#setdiff(SIAP_LU_poly$EstadoMunicipio, Data2000s_poly$EstadoMunicipio)

#save(Data2000s_poly, file = paste0(wd$data_r, "Data2000s_poly.rData"))


st_write(Data2000s_poly, paste0(wd$data_p, "Data2000s_poly.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)

Data2000s_cases = st_drop_geometry(Data2000s_poly)
write.csv(Data2000s_cases, paste0(wd$data_p,"Data2000s_poly.csv"))

#load(paste0(wd$data_r, "Data2000s_poly.rData"))
```

 
 
 
 
 
 
 
 
 
 
 
 


# Comparative Analysis of CMex Yields Over Time 

## Import Comparative Data

```{r, label='Import Comparative Data', message=FALSE,warning=FALSE}

CY <- read.csv(paste0(wd$data_r,"ComparativeYields.csv"))

Colonial <- read.csv(paste0(wd$data_r,"Colonial_MaizeYields.csv"))

AGCensus1960 <- read.csv(paste0(wd$data_r,"AGCensus1960_MaizeYields.csv"))

AGCensus1991 <- read.csv(paste0(wd$data_r,"AGCensus1991_MaizeYields.csv"))

AGCensus2007 <- read.csv(paste0(wd$data_r,"AGCensus2007_MaizeYields.csv"))

SandersAztec <- read.csv(paste0(wd$data_r,"SandersModelAztecBOM.csv"))

SandersC20 <- read.csv(paste0(wd$data_r,"SandersC20EthnogBOM.csv"))

```

## Ridgeline Density Plot

```{r, label='Ridgeline Density Plot', message=FALSE,warning=FALSE}

EarlyColonial = Colonial %>% filter(Period == "C16 Sample") %>% filter(TimeSeries == F) 
#nnn = nrow(EarlyColonial)
#EarlyColonial <- EarlyColonial %>% rowwise() %>% mutate(Weight = ifelse(TimeSeries == F,1,0.25)) %>% ungroup() %>% mutate(Weight = Weight/nnn)
EarlyColonial_dens = density(EarlyColonial$Yield, from=0, weights=EarlyColonial$Weight)
EarlyColonial_dens <- data.frame(EarlyColonial_dens$x, EarlyColonial_dens$y, EarlyColonial_dens$bw, EarlyColonial_dens$n, "16th Century Sample", "Local-level sample of recorded yields")
names(EarlyColonial_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

LateColonial = Colonial %>% filter(Period == "C18 Sample") %>% filter(TimeSeries == F) 
#nnn = nrow(LateColonial)
#LateColonial <- LateColonial %>% rowwise() %>% mutate(Weight = ifelse(TimeSeries == F,1,0.25)) %>% ungroup() %>% mutate(Weight = Weight/nnn)
LateColonial_dens = density(LateColonial$Yield, from=0, weights=LateColonial$Weight)
LateColonial_dens <- data.frame(LateColonial_dens$x, LateColonial_dens$y, LateColonial_dens$bw, LateColonial_dens$n, "18th Century Sample", "Local-level sample of recorded yields")
names(LateColonial_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

AGCensus1960_A = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Ejido" | Size == "Small" | Size == "Large") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))
s = sum(AGCensus1960_A$Maize1960_ha, na.rm = T)
#AGCensus1960_T_dens = density(AGCensus1960_T$Maize1960_kgha, weights = AGCensus1960_T$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_A_dens = density(AGCensus1960_A$Maize1960_kgha, na.rm = T, from=0)
AGCensus1960_A_dens <- data.frame(AGCensus1960_A_dens$x, AGCensus1960_A_dens$y, AGCensus1960_A_dens$bw, AGCensus1960_A_dens$n, "1960 Agricultural Census", "Municipal averages by type of land tenure\n(ejidos, large (>5 ha) and small (<5 ha) holdings)"
)
names(AGCensus1960_A_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

AGCensus1960_T = AGCensus1960 %>% #filter(Size == "Total") %>% 
  filter(Size == "Total") %>% 
  filter(INCLUDE == TRUE) %>% 
  filter(!is.na(Maize1960_ha))
s = sum(AGCensus1960_T$Maize1960_ha, na.rm = T)
#AGCensus1960_T_dens = density(AGCensus1960_T$Maize1960_kgha, weights = AGCensus1960_T$Maize1960_ha / s, from = 0, na.rm = T)
AGCensus1960_T_dens = density(AGCensus1960_T$Maize1960_kgha, na.rm = T, from=0)
AGCensus1960_T_dens <- data.frame(AGCensus1960_T_dens$x, AGCensus1960_T_dens$y, AGCensus1960_T_dens$bw, AGCensus1960_T_dens$n, "1960 Agricultural Census", "Overall municipal averages")
names(AGCensus1960_T_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

AGCensus1991_T = AGCensus1991 %>% filter(!is.na(Yield)) 
AGCensus1991_dens = density(AGCensus1991_T$Yield, na.rm = T, from=0)
AGCensus1991_dens <- data.frame(AGCensus1991_dens$x, AGCensus1991_dens$y, AGCensus1991_dens$bw, AGCensus1991_dens$n, "1991 Agricultural Census", "Overall municipal averages")
names(AGCensus1991_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

AGCensus2007_T = AGCensus2007 %>% filter(!is.na(Yield)) 
s = sum(AGCensus2007_T$Harvested_ha, na.rm = T)
#AGCensus2007_dens = density(AGCensus2007_T$Yield, weights = AGCensus2007_T$Harvested_ha / s, from = 0, na.rm = T)
AGCensus2007_dens = density(AGCensus2007_T$Yield, na.rm = T, from=0)
AGCensus2007_dens <- data.frame(AGCensus2007_dens$x, AGCensus2007_dens$y, AGCensus2007_dens$bw, AGCensus2007_dens$n, "2007 Agricultural Census", "Overall municipal averages")
names(AGCensus2007_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SandersAztec_dens = density(SandersAztec$Yield, from=0)
SandersAztec_dens <- data.frame(SandersAztec_dens$x, SandersAztec_dens$y, SandersAztec_dens$bw, SandersAztec_dens$n, "Sanders Aztec Model\n (BOM Only)", "Model derived from mid-20th century data")
names(SandersAztec_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SandersC20_dens = density(SandersC20$YieldAvg, from=0)
SandersC20_dens <- data.frame(SandersC20_dens$x, SandersC20_dens$y, SandersC20_dens$bw, SandersC20_dens$n, "Sanders mid-20th Century\nSample (BOM Only)", "Local-level sample of recorded yields")
names(SandersC20_dens) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")


SIAP_4_2003 = SIAP_4 %>% filter(Year == 2003) 
SIAP_4_2003 = density(SIAP_4_2003$Yield, from=0)
SIAP_4_2003 <- data.frame(SIAP_4_2003$x, SIAP_4_2003$y, SIAP_4_2003$bw, SIAP_4_2003$n, "SIAP 2003", "Municipal Averages by cultivation type\n(irrigation and temporal)")
names(SIAP_4_2003) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SIAP_4_2003a = SIAP_4 %>% filter(Year == 2003) %>% group_by(EstadoMunicipio) %>% summarize(Yield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
SIAP_4_2003a = density(SIAP_4_2003a$Yield)
SIAP_4_2003a <- data.frame(SIAP_4_2003a$x, SIAP_4_2003a$y, SIAP_4_2003a$bw, SIAP_4_2003a$n, "SIAP 2003", "Overall municipal averages")
names(SIAP_4_2003a) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SIAP_4_2020 = SIAP_4 %>% filter(Year == 2020) 
SIAP_4_2020 = density(SIAP_4_2020$Yield, from=0)
SIAP_4_2020 <- data.frame(SIAP_4_2020$x, SIAP_4_2020$y, SIAP_4_2020$bw, SIAP_4_2020$n, "SIAP 2020", "Municipal Averages by cultivation type\n(irrigation and temporal)")
names(SIAP_4_2020) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SIAP_4_2020a = SIAP_4 %>% filter(Year == 2020) %>% group_by(EstadoMunicipio) %>% summarize(Yield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
SIAP_4_2020a = density(SIAP_4_2020a$Yield, from=0)
SIAP_4_2020a <- data.frame(SIAP_4_2020a$x, SIAP_4_2020a$y, SIAP_4_2020a$bw, SIAP_4_2020a$n, "SIAP 2020", "Overall municipal averages")
names(SIAP_4_2020a) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SIAP_4_Avg = SIAP_4 %>% group_by(EstadoMunicipio, AGType) %>% summarise(AvgYield = mean(Yield, na.rm=T))
SIAP_4_Avg = density(SIAP_4_Avg$AvgYield, na.rm=T, from=0)
SIAP_4_Avg <- data.frame(SIAP_4_Avg$x, SIAP_4_Avg$y, SIAP_4_Avg$bw, SIAP_4_Avg$n, "SIAP 2003-2021 Average", "Municipal Averages by cultivation type\n(irrigation and temporal)")
names(SIAP_4_Avg) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SIAP_4_Avg_T = SIAP_4 %>% group_by(EstadoMunicipio) %>% summarise(AvgYield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
SIAP_4_Avg_T = density(SIAP_4_Avg_T$AvgYield, na.rm=T, from=0)
SIAP_4_Avg_T <- data.frame(SIAP_4_Avg_T$x, SIAP_4_Avg_T$y, SIAP_4_Avg_T$bw, SIAP_4_Avg_T$n, "SIAP 2003-2021 Average", "Overall municipal averages")
names(SIAP_4_Avg_T) <- c("Yield", "Density", "Bandwidth", "n", "Series", "Data")

SIAP_4_Avg_T$Height = 1200
SIAP_4_Avg$Height = 1200
SIAP_4_2020a$Height = 2000
SIAP_4_2020$Height = 2000
AGCensus2007_dens$Height = 2000
SIAP_4_2003a$Height = 1500
SIAP_4_2003$Height = 1500
SandersC20_dens$Height = 1300
SandersAztec_dens$Height = 550
AGCensus2007_dens$Height = 1200
AGCensus1991_dens$Height = 900
AGCensus1960_A_dens$Height = 350
AGCensus1960_T_dens$Height = 350
LateColonial_dens$Height = 1200
EarlyColonial_dens$Height = 2500

Dens.df = rbind(EarlyColonial_dens,LateColonial_dens, SandersAztec_dens, AGCensus1960_T_dens, AGCensus1960_A_dens, SandersC20_dens, AGCensus1991_dens, SIAP_4_2003, SIAP_4_2003a, AGCensus2007_dens, SIAP_4_2020, SIAP_4_2020a, SIAP_4_Avg, SIAP_4_Avg_T)

rm(EarlyColonial_dens,LateColonial_dens, SandersAztec_dens, AGCensus1960_T_dens, SandersC20_dens, AGCensus1991_dens, SIAP_4_2003, AGCensus2007_dens, SIAP_4_2020, SIAP_4_Avg, s, nnn)

Dens.df$Series <- factor(Dens.df$Series, levels = c("16th Century Sample", "18th Century Sample", "Sanders Aztec Model\n (BOM Only)", "1960 Agricultural Census", "Sanders mid-20th Century\nSample (BOM Only)", "1991 Agricultural Census", "SIAP 2003", "2007 Agricultural Census", "SIAP 2020", "SIAP 2003-2021 Average"))

#"Overall municipal averages","Municipal Averages by cultivation type\n(irrigation and temporal)","Municipal averages by type of land tenure\n(ejidos, large (>5 ha) and small (<5 ha) holdings)","Local-level sample of recorded yields","Model derived from mid-20th century data"
ggp1 <- ggplot() + 
  geom_ridgeline(data=Dens.df, aes(x=Yield, y=Series, height=Density*Height, fill=Data, color=Data), alpha=0.2,size=0.5)+
  scale_fill_discrete(name = "Data Specifications") +#, labels = c("Theoretical Beta (Prior)", "Empirical Aoristic (Conditional)", "Final Bayesian Prior (Posterior)") 
  scale_colour_discrete(name = "Data Specifications", drop = FALSE)+#, labels = c("Theoretical Beta (Prior)", "Empirical Aoristic (Conditional)", "Final Bayesian Prior (Posterior)")
  guides(fill = guide_legend(byrow = TRUE), color = guide_legend(byrow = TRUE)) +
  #geom_vline(data=MP, aes(xintercept = years), linetype = "dashed", alpha=0.6)+
    labs(x ="Maize Yield (kg / ha)", y = "Probability Density")+#title="Bayesian Construction of Regional-Scale Popularity Curves", subtitle = "Ceramic Complexes in the S. Basin of Mexico", 
    #guides(fill = guide_legend(nrow = 3))+
    theme_bw()+
  #scale_y_discrete(expand = c(.05, .05)) +
    scale_x_continuous(limits= c(0,11000), breaks=seq(0,11000,1000)) +#,breaks = MyBreaks,labels = MyLabs
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", face="bold"), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.55,0.55), 
          legend.title=element_text(color="black", face="bold", size = 14),#element_blank(),
          legend.spacing.y = unit(0.2,"cm"),
          legend.key = element_rect(colour = "transparent", fill = "transparent"),
          legend.text = element_text(colour="black", size = 10))
          #legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid'), 
         # plot.title = element_text(hjust = 0.5, face="bold"), plot.subtitle = element_text(hjust = 0.5, face="bold"))+theme(plot.background = element_rect(fill = "white", colour = NA))


#save figure
ggsave("RidgelineComparativeYields.png", plot = ggp1, device = "png", path = wd$figs, scale = 1, width = 10, height = 7,   units = "in",  dpi = 1500)

rm(ggp1)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"RidgelineComparativeYields.png"), FALSE)

```


## ***Histograms 

```{r, label='Histograms', message=FALSE,warning=FALSE}

```


## ***Gamma Tests

```{r, label='Gamma Tests', message=FALSE,warning=FALSE}
gamma_test(AGCensus1960_T$Maize1960_kgha)
gamma_test(LateColonial$Yield)
gamma_test(EarlyColonial$Yield)
gamma_test(AGCensus1991_T$Yield)
gamma_test(AGCensus2007_T$Yield)
gamma_test(SandersAztec$Yield)
gamma_test(SandersC20$YieldAvg)
gamma_test(SIAP_4_2003$Yield[SIAP_4_2003$Yield > 0])
gamma_test(SIAP_4_2020a$Yield[SIAP_4_2020a$Yield > 0])
gamma_test(SIAP_4_Avg1$AvgYield)

gamma_fit(x)
```


## ***MANOVA Violin Plots

```{r, label='MANOVA Violin Plots', message=FALSE,warning=FALSE}
CY <- read.csv(paste0(wd$data_r,"ComparativeYields.csv"))
CY$Series <- factor(CY$Series, levels = c("AG Census 1960", "Sanders Aztec BOM Model", "AG Census 1991", "Sanders mid-20th Century BOM", "SIAP 2003-2021 Average"))
x = ggbetweenstats(
  data = dplyr::filter(CY, Size == "Total"),
  x = Series, ## grouping/independent variable
  y = Yield, ## dependent variables
  type = "robust", ## type of statistics
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  ## turn off messages
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 3000, segment.linetype = 0,
    min.segment.length = 0)
) + ## modifying the plot further
  ggplot2::scale_y_continuous(
    limits = c(0, 7000),
    breaks = seq(from = 0, to = 7000, by = 500)
  ) 
x

CY2 <- read.csv(paste0(wd$data_r,"ComparativeYields.csv"))

CY2 = CY2 %>% filter(Series == "Sanders mid-20th Century BOM" | Series == "AG Census 1960" | Series == "Sanders Aztec BOM Model") %>% rowwise() %>% mutate(Size = ifelse(Series == "Sanders mid-20th Century BOM" | Series == "Sanders Aztec BOM Model", '', Size)) %>% ungroup() %>% unite(SizeSeries, Series, Size, sep = "\n") %>% mutate_all(~ str_replace_all(., c(" BOM" = ""))) %>% mutate(Yield = as.numeric(Yield))
CY2$Series <- factor(CY2$SizeSeries, levels = c("Sanders mid-20th Century\n", "Sanders Aztec Model\n", "AG Census 1960\nSmall", "AG Census 1960\nLarge", "AG Census 1960\nEjido", "AG Census 1960\nTotal"))
x2 = ggbetweenstats(
  data = dplyr::filter(CY2, !is.na(Yield)),
  x = Series, ## grouping/independent variable
  y = Yield, ## dependent variables
  type = "robust", ## type of statistics
  xlab = "", ## label for the x-axis
  ylab = "Maize Yield (kg/ha)", ## label for the y-axis
  ## turn off messages
  ggtheme = ggplot2::theme_gray(), ## a different theme
  package = "yarrr", ## package from which color palette is to be taken
  palette = "info2", ## choosing a different color palette
  title = "",
  caption = "",
  centrality.label.args = list(size = 4, nudge_x = 0,nudge_y = 6000, segment.linetype = 0,
    min.segment.length = 0)
) + ## modifying the plot further
  ggplot2::scale_y_continuous(
    limits = c(0, 7000),
    breaks = seq(from = 0, to = 5000, by = 500)
  ) 

x2
```



```{r, label='Ridgeline Density Plot', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_4,aes(x = Yield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 300, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Maize Yield (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,12000), breaks=seq(0,12000,2000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

df = SIAP_4 %>% group_by(EstadoMunicipio, Year) %>% summarize(Yield = sum(Product, na.rm=T) / sum(Planted, na.rm=T))
df$Series <- "Municipal Average"
df2 = SIAP_4 %>% select(EstadoMunicipio, Year, Yield) %>% mutate(Series = "Both Irrigation and Temporal")
df = rbind(df,df2)

h2 = ggplot(df,aes(x = Yield)) +
  geom_histogram(aes(group = Series, fill = Series),alpha = 0.5, position = "identity", binwidth = 300, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("grey75", "greenyellow"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Average", "Both"))+
  geom_density(aes(group = Series, color = Series, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("black", "green"), breaks = c("Municipal Average", "Both Irrigation and Temporal"), labels = c("Average", "Both"))+
  labs(x ="Maize Yield (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,12000), breaks=seq(0,12000,2000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

ggp2 = plot_grid(h1, h2, labels = c('A', 'B'), label_size = 24)


#save figure
ggsave("Hists_SIAP_AGType.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 4.5,   units = "in",  dpi = 1500)

rm(ggp2, h1, h2, df, df2)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_SIAP_AGType.png"), FALSE)
```


## Maize Yield Maps

### Merge Data and Join with Municipio Polygons
	Merge 1960, 1991, 2007 and SIAP data with municipios polygons

```{r, label='Merge Data and Join with Municipio Polygons', message=FALSE,warning=FALSE}
AGC1960 = AGCensus1960 %>% filter(INCLUDE == TRUE) %>% 
  select(Location, State, INCLUDE, Size, Maize1960_kg, Maize1960_ha) %>%
  rename(Municipio = Location, Estado = State) %>%
  mutate(Municipio = str_to_title(Municipio)) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%  
  group_by(Municipio, Estado, EstadoMunicipio, Size) %>%
  summarize(Yield = sum(as.numeric(Maize1960_kg), na.rm=T) / sum(as.numeric(Maize1960_ha), na.rm=T))  %>%
  pivot_wider(names_from = Size, values_from = Yield, values_fill = NA) %>% 
  mutate(across(everything(), ~ifelse(is.nan(.), NA, .))) %>% 
  rename(Y_1960_E = Ejido, Y_1960_S = Small, Y_1960_L = Large, Y_1960_Total = Total)

AGC1991 = AGCensus1991 %>% 
  select(Name, State, Yield) %>%
  rename(Municipio = Name, Estado = State, Y_1991_Total = Yield) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  mutate(AGType = "Total")

AGC2007 = AGCensus2007 %>% 
  select(Name, State, Yield) %>%
  rename(Municipio = Name, Estado = State, Y_2007_Total = Yield) %>%
  unite(col = EstadoMunicipio, Municipio, Estado, sep = ", ", remove = F) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca"))) %>%
  mutate(AGType = "Total")

x = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  group_by(Municipio, Estado, EstadoMunicipio, Year) %>% 
  summarize(AGType = "Total",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T))

SIAP_annual = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Yield) %>%
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp"))

SIAP_annual = rbind(SIAP_annual,x)

SIAP_annual = SIAP_annual %>%
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "Y_{Year}_{AGType}",
    values_from = Yield)

SIAP_AvgType = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp")) %>%
  group_by(Municipio, Estado, EstadoMunicipio, AGType) %>% 
  summarize(Year = "Average",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T)) %>%
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "Y_{Year}_{AGType}",
    values_from = Yield)

SIAP_AvgTotal = SIAP_4 %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Total",
    AGType == "Temporal" ~ "Total")) %>%
  group_by(Municipio, Estado, EstadoMunicipio, AGType) %>% 
  summarize(Year = "Average",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T))%>%
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "Y_{Year}_{AGType}",
    values_from = Yield)

SIAP_yields = SIAP_annual %>% left_join(SIAP_AvgType, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(SIAP_AvgTotal, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  mutate_all(~ str_replace_all(., c(" De " = " de ", 
                                    " Del " = " del ", 
                                    " La " = " la ", 
                                    " Las " = " las ", 
                                    " Los " = " los ",
                                    " El " = " el ",
                                    "Ziltlaltepec" = "Zitlaltepec",
                                    "Atltzayanca" = "Altzayanca")))

rm(SIAP_annual, SIAP_AvgType, SIAP_AvgTotal, x)

scale2 <- function(x, na.rm = FALSE) (x - mean(x, na.rm = T)) / sd(x, na.rm = T)

MunicipioYields <- Municipios2000s %>% mutate(
         Municipio = str_replace_all(Municipio, c(" De " = " de ",
                                                  " Del " = " del ",
                                                  " La " = " la ",
                                                  " Las " = " las ",
                                                  " Los " = " los ",
                                                  " El " = " el ",
                                                  "Ziltlaltepec" = "Zitlaltepec",
                                                  "Atltzayanca" = "Altzayanca")),
         EstadoMunicipio = str_replace_all(EstadoMunicipio, c(" De " = " de ",
                                                              " Del " = " del ",
                                                              " La " = " la ",
                                                              " Las " = " las ",
                                                              " Los " = " los ",
                                                              " El " = " el ",
                                                              "Ziltlaltepec" = "Zitlaltepec",
                                                              "Atltzayanca" = "Altzayanca"))) %>%
  left_join(AGC1960, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC1991, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC2007, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(SIAP_yields, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  select(-AGType.x, -AGType.y, -Area_m2, -Area_ha) %>%
  mutate(across(where(is.character) & !one_of(c("Estado_ID", "Municipio_ID", "EstadoMunicipio", "Municipio", "Estado")), as.numeric))

MunicipioYields_Z <- MunicipioYields %>% 
  mutate(across(where(is.numeric), scale2))

```


### Maps of Average Yield Over Time
Maps of average maize yields by municipality
	Same spatial patterning??

```{r, label='Basemaps', message=FALSE,warning=FALSE}
Hillshade <- read_stars(paste0(wd$data_r, "HillshadeCMex.tif"))
Estados <- st_read(paste0(wd$data_r, "StatesPoly.gpkg"))
Estados2 = Estados %>% mutate(my_nudge_x=ifelse(NOM_ENT=='Puebla',-50000,0),
                             my_nudge_y=ifelse(NOM_ENT=='Puebla',-65000,0))

Base <- ggplot() + 
  geom_stars(data = Hillshade)+
  scale_fill_gradient(low = "black", high = "white", guide="none")+
  coord_sf()+
  theme_void()
#colorRampPalette(rev(brewer.pal(11, "Spectral")))
myPalette <- colorRampPalette(c("red4", "red4", "red4", "red4", "red", "orange", "yellow", "greenyellow", "green", "green4", "green4","green4", "green4"))
#myPalette <- c("red4", "red4", "red", "orange", "yellow", "greenyellow", "green", "green4", "green4")
sc <- scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(7), limits=c(-5, 5),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6))

```


#### 1960 AG Census Maps


```{r, label='1960 AG Census Maps', message=FALSE,warning=FALSE}

Map1960_T <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_1960_Total), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "1960 Ag. Census - Z-Score Average Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

Map1960_E <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_1960_E), color = "black", size=1, alpha = 0.55) +
scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "1960 Ag. Census - Z-Score Average Ejido Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

Map1960_S <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_1960_S), color = "black", size=1, alpha = 0.55) +
scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "1960 Ag. Census - Z-Score Small Farm Average Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

Map1960_L <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_1960_L), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "1960 Ag. Census - Z-Score Large Farm Average Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

ggsave("Map1960_T.png", plot = Map1960_T, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
ggsave("Map1960_E.png", plot = Map1960_E, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
ggsave("Map1960_S.png", plot = Map1960_S, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
ggsave("Map1960_L.png", plot = Map1960_L, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
knitr::include_graphics(paste0(wd$figs,"Map1960_T.png"), FALSE)
knitr::include_graphics(paste0(wd$figs,"Map1960_E.png"), FALSE)
knitr::include_graphics(paste0(wd$figs,"Map1960_S.png"), FALSE)
knitr::include_graphics(paste0(wd$figs,"Map1960_L.png"), FALSE)
#rm(Map1960_T,Map1960_E,Map1960_S,Map1960_L)

```


#### Maps of Average Municipal Yields Over Time


```{r, label='Maps of Average Yields Over Time', message=FALSE,warning=FALSE}

Map1991_T <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_1991_Total), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "1991 Ag. Census - Z-Score Average Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

Map2007_T <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_2007_Total.x), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "2007 Ag. Census - Z-Score Average Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

MapSIAP_Avg_Total <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_Average_Total), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "SIAP 2003-2021 - Z-Score Overall Average Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),



ggsave("Map1991_T.png", plot = Map1991_T, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
ggsave("Map2007_T.png", plot = Map2007_T, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
ggsave("MapSIAP_Avg_Total.png", plot = MapSIAP_Avg_Total, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
knitr::include_graphics(paste0(wd$figs,"Map1960_T.png"), FALSE)
knitr::include_graphics(paste0(wd$figs,"Map1991_T.png"), FALSE)
knitr::include_graphics(paste0(wd$figs,"Map2007_T.png"), FALSE)
knitr::include_graphics(paste0(wd$figs,"MapSIAP_Avg_Total.png"), FALSE)
#rm(Map1960_T,Map1960_E,Map1960_S,Map1960_L)

```


#### Maps of Average SIAP Yields by AG Type


```{r, label='Maps of Average SIAP Yields by AG Type', message=FALSE,warning=FALSE}

MapSIAP_Avg_Temp <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_Average_Temp), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "SIAP 2003-2021 - Z-Score Average Temporal Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),

MapSIAP_Avg_Irrig <- Base + ggnewscale::new_scale_fill()+
  geom_sf(data = MunicipioYields_Z, aes(geometry = geom, fill = Y_Average_Irrig), color = "black", size=1, alpha = 0.55) +
  scale_fill_gradientn(name = "Maize\nYield\n(kg/ha)", colors = myPalette(11), limits=c(-6, 6),breaks=c(-6, -4, -2, -1,  0, 1, 2, 4, 6)) +
  geom_sf(data = Estados, aes(geometry = geom), fill = "transparent", color = "white", linewidth=1.5, inherit.aes = F) +
  geom_sf_text(data = Estados, aes(label = NOM_ENT), size = 9, color = "white", face="bold",
               nudge_x=Estados2$my_nudge_x,nudge_y=Estados2$my_nudge_y)+
  labs(title= "SIAP 2003-2021 - Z-Score Average Irrigation Maize Yield")+#, subtitle = "Period 9, CL (c.AD 100-550)"
  coord_sf()+ north(data = Estados, symbol = 12, scale = 0.15, location = "topleft")+
  geom_rect(aes(xmin = 357134, xmax = 464000, ymin = 2042755, ymax = 2053000), color = "white", fill = "white")  +
  scalebar(data = Estados, dist = 50, dist_unit = "km", transform = F, model = "WGS84", st.color = "black", height = 0.03, st.dist = 0.03, st.size = 5, st.bottom = T, location = "bottomleft")+#, anchor = c(360291,2051443)
  theme(legend.justification=c(0,1), legend.position=c(0.85,0.95), 
        legend.title=element_text(color="black", face="bold", size = 14),
        legend.text = element_text(colour="black", size = 8, face="bold"),
        legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"),
        legend.box.background = element_rect(colour = "black"),
        legend.margin=ggplot2::margin(t= 2, r= 2, b= 5, l= 2),
        plot.title = element_text(hjust = 0.5, face="bold", size=16),
        plot.background = element_rect(fill = "white", colour = NA))#plot.subtitle = element_text(hjust = 0.5, face="bold", size=14),



ggsave("MapSIAP_Avg_Temp.png", plot = MapSIAP_Avg_Temp, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
ggsave("MapSIAP_Avg_Irrig.png", plot = MapSIAP_Avg_Irrig, device = "png", path = wd$figs, scale = 1, width = 6.85, height = 5.257,   units = "in",  dpi = 1500)
  knitr::include_graphics(paste0(wd$figs,"Map1960_T.png"), FALSE)
  knitr::include_graphics(paste0(wd$figs,"Map1991_T.png"), FALSE)
  knitr::include_graphics(paste0(wd$figs,"Map2007_T.png"), FALSE)
  knitr::include_graphics(paste0(wd$figs,"MapSIAP_Avg_Temp.png"), FALSE)
  knitr::include_graphics(paste0(wd$figs,"MapSIAP_Avg_Irrig.png"), FALSE)
  knitr::include_graphics(paste0(wd$figs,"MapSIAP_Avg_Total.png"), FALSE)
#rm(Map1960_T,Map1960_E,Map1960_S,Map1960_L)

```

Difference between irrigation and temporal yield SPATIAL distributions?
	Maps
o	Avg yields for irrig and temporal
o	IT ratio

#### Maps of Average SIAP Yields by AG Type and Year

```{r, label='Maps of Average SIAP Yields by AG Type and Year', message=FALSE,warning=FALSE}

```



## Change Over Time Regression

```{r, label='Change Over Time Regression by Municipality', message=FALSE,warning=FALSE}

plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$Y_2007_Total.x)
plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$Y_Average_Total)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$Y_2007_Total.x)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$Y_Average_Total)
plot(MunicipioYields_Z$Y_2007_Total.x, MunicipioYields_Z$Y_Average_Total)

plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$Y_2007_Total.x)
plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$Y_Average_Total)

plot(MunicipioYields_Z$Y_1960_L, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_L, MunicipioYields_Z$Y_2007_Total.x)
plot(MunicipioYields_Z$Y_1960_L, MunicipioYields_Z$Y_Average_Total)

plot(MunicipioYields_Z$Y_1960_E, MunicipioYields_Z$Y_1991_Total)
plot(MunicipioYields_Z$Y_1960_E, MunicipioYields_Z$Y_2007_Total.x)
plot(MunicipioYields_Z$Y_1960_E, MunicipioYields_Z$Y_Average_Total)

plot(MunicipioYields_Z$Y_1960_Total, MunicipioYields_Z$Y_Average_Irrig)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$Y_Average_Irrig)
plot(MunicipioYields_Z$Y_2007_Total.x, MunicipioYields_Z$Y_Average_Irrig)

plot(MunicipioYields_Z$Y_1960_S, MunicipioYields_Z$Y_Average_Temp)
plot(MunicipioYields_Z$Y_1991_Total, MunicipioYields_Z$Y_Average_Temp)
plot(MunicipioYields_Z$Y_2007_Total.x, MunicipioYields_Z$Y_Average_Temp)
```

We can further test this by doing (geographically weighted?) regression of yields over time by municipio
	Regression table, possibly graphs

## Historical vs. Modern Regression by Municipality
We can also do a limited cross validation using historical data regressed against modern data
	Excel spreadsheet  graphs and regression table
o	C16  SIAP
o	C18  1960
o	All colonial  SIAP 

```{r, label='Historical vs. Modern Regression by Municipality', message=FALSE,warning=FALSE}

```







# Drafts



```{r}
ColonialTS = Colonial %>% filter(TimeSeries == T)  %>% group_by(Name) %>% 
  mutate(Yield_rs = linear_rescale(Yield),
         Yield_z = (Yield - mean(Yield))/sd(Yield),
         ks = ks.test(Yield, "pnorm",fitdistr(Yield,"normal")$estimate[1],fitdistr(Yield,"normal")$estimate[2])$p.value,
         shapiro = shapiro.test(Yield)$p.value ) %>% ungroup()

ChiconautlaC16TS = ColonialTS %>% filter(Name == "Chiconautla") 
CoatepecC16TS = ColonialTS %>% filter(Name == "Coatepec") 
ZapotlanC16TS = ColonialTS %>% filter(Name == "Zapotlan") 
TizayucaC16TS = ColonialTS %>% filter(Name == "Tizayuca") 
TepepolcoC16TS = ColonialTS %>% filter(Name == "Tepepolco") 
SanMartinNotarioC16TS = ColonialTS %>% filter(Name == "Haz. San Martin Notario") 
SanJoseAcolmanC16TS = ColonialTS %>% filter(Name == "Haz. San Jose Acolman") 
SanDiegoPinalC16TS = ColonialTS %>% filter(Name == "Haz. San Diego Pinal") 
hist(ChiconautlaC16TS$Yield, breaks =8)
hist(CoatepecC16TS$Yield, breaks =8)
hist(ZapotlanC16TS$Yield, breaks =8)
hist(TizayucaC16TS$Yield, breaks =8)
hist(TepepolcoC16TS$Yield, breaks =8)
hist(SanMartinNotarioC16TS$Yield, breaks =8)
hist(SanJoseAcolmanC16TS$Yield, breaks =8)
hist(SanDiegoPinalC16TS$Yield, breaks =8)
hist(ColonialTS$Yield_rs)
hist(ColonialTS$Yield_z)
hist(ColonialTS$Yield)

x=ks.test(ChiconautlaC16TS$Yield, "pnorm",fitdistr(ChiconautlaC16TS$Yield,"normal")$estimate[1],fitdistr(ChiconautlaC16TS$Yield,"normal")$estimate[2])

ecdf.ks.CI(ChiconautlaC16TS$Yield, family="sans", main= "Chiconautla C16 TS", cex.main=2, font.main=2, font.lab=2, xlab="Yield", ylab="ECDF(Yield)")
fit<-fitdistr(ChiconautlaC16TS$Yield,"normal")$estimate
Norm1 <- rnorm(10000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")

ecdf.ks.CI(CoatepecC16TS$Yield, family="sans", main= "Coatepec C16 TS", cex.main=2, font.main=2, font.lab=2, xlab="Yield", ylab="ECDF(Yield)")
fit<-fitdistr(CoatepecC16TS$Yield,"normal")$estimate
Norm1 <- rnorm(10000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")

ecdf.ks.CI(SanDiegoPinalC16TS$Yield, family="sans", main= "SanDiegoPinal C18 TS", cex.main=2, font.main=2, font.lab=2, xlab="Yield", ylab="ECDF(Yield)")
fit<-fitdistr(SanDiegoPinalC16TS$Yield,"normal")$estimate
Norm1 <- rnorm(10000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
```



```{r}
a = SIAP_4 %>% filter(AGType == "Temporal") %>% filter(!is.na(zYield))
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
#shapiro.test(a$zYield)

a = SIAP_4 %>% filter(AGType == "Riego") %>% filter(!is.na(zYield))
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Riego", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)

a = SIAP_4 %>% filter(!is.na(zYield))
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Both", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
#shapiro.test(a$zYield)

a = SIAP_4 %>% filter(EstadoMunicipio == "Tlalpan, Distrito Federal" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Tlalpan Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)


a = SIAP_4 %>% filter(EstadoMunicipio == "Xochimilco, Distrito Federal" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Xochimilco Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)


a = SIAP_4 %>% filter(EstadoMunicipio == "Epazoyucan, Hidalgo" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Epazoyucan Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)


a = SIAP_4 %>% filter(EstadoMunicipio == "Tecamac, Mexico" & AGType == "Temporal")
hist(a$zYield)
ks.test(a$zYield, "pnorm",fitdistr(a$zYield,"normal")$estimate[1],fitdistr(a$zYield,"normal")$estimate[2])
ecdf.ks.CI(a$zYield, family="sans", main= "Tecamac Temporal", cex.main=2, font.main=2, font.lab=2, xlab="zYield", ylab="ECDF(zYield)")
fit<-fitdistr(a$zYield,"normal")$estimate
Norm1 <- rnorm(100000, fit[1],fit[2])
lines(ecdf(Norm1), do.points = FALSE, verticals=T, lwd=2, col="blue")
shapiro.test(a$zYield)

```


```{r}
hist(SIAP_5$AvgYield)
gamma_test(SIAP_5$AvgYield)
a= SIAP_5 %>% filter(AGType == "Temporal")
gamma_test(a$AvgYield)
hist(a$AvgYield)
a= SIAP_5 %>% filter(AGType == "Riego")
gamma_test(a$AvgYield)
hist(a$AvgYield)

hist(SIAP_5$cvYield)
gamma_test(SIAP_5$cvYield)
a= SIAP_5 %>% filter(AGType == "Temporal")
gamma_test(a$cvYield)
hist(a$cvYield)
a= SIAP_5 %>% filter(AGType == "Riego")
gamma_test(a$cvYield)
hist(a$cvYield)

hist(SIAP_5$sdYield)
gamma_test(SIAP_5$sdYield)
a= SIAP_5 %>% filter(AGType == "Temporal")
gamma_test(a$sdYield)
hist(a$sdYield)
a= SIAP_5 %>% filter(AGType == "Riego")
gamma_test(a$sdYield)
hist(a$sdYield)
```

```{r, 'Rescale SIAP 2003-2021 Yield Data', message=FALSE, warning=FALSE}

hist(unique(SIAP_3$TotYield), breaks = seq(0, 12500, by = 250), xlim = c(0,12500))
hist(log(unique(SIAP_3$TotYield)), breaks = 50)
hist(SIAP_3$Yield, breaks = seq(0, 13000, by = 250), xlim = c(0,13000))
hist(log(SIAP_3$Yield), breaks = 50)





```
Tepepolco
Haz. SanMartinNotario
Haz. SanJoseAcolman
Haz. SanDiegoPinal



p <- data %>%
  mutate(text = fct_reorder(text, value)) %>%
  ggplot( aes(x=value, color=text, fill=text)) +
    geom_histogram(alpha=0.6, binwidth = 5) +
    scale_fill_viridis(discrete=TRUE) +
    scale_color_viridis(discrete=TRUE) +
    theme_ipsum() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("Assigned Probability (%)") +
    facet_wrap(~text)

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 