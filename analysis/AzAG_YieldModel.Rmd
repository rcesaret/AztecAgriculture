---
title: "Aztec Agricultural Productivity Model"
subtitle: "Yield Model"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```



```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```


  
# Setup 


```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions



```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", 
              "dismo", "purrr", "spatialEco", "whitebox", "classInt",
              "ggnewscale", "lbmech", "data.table", "tidyterra","gridExtra", 
              "cowplot", "scam", "rmarkdown", "spatialreg","spdep", "ggridges", 
              "ggnewscale", "scales", "ggstatsplot", "stringi", "fuzzyjoin", 
              "mgcv", "randomForest", "ranger", "exactextractr", "kableExtra",
              "goft", "MASS", "NSM3", "ggsn", "rlang", "FSA", "philentropy", 
              "sfdep","spdep", "Boruta", "mlbench", "caret", "DataExplorer", 
              "tableone", "mlr3", "mlr3verse", "mlr3learners", "mlr3measures", 
              "mlr3tuning", "mlr3mbo", "mlr3misc", "mlr3viz", "mlr3tuningspaces", 
              "mlr3pipelines", "mlr3hyperband", "mlr3fselect", "mlr3filters", 
              "mlr3cluster", "FSelectorRcpp", "mlr3extralearners", "mlr3spatial", 
              "mlr3spatiotempcv", "praznik", "care", "genalg")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R", "linear_rescale.R", "CMex_AG_Map.R")
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```

"Milpa Alta, Distrito Federal", "Tlahuac, Distrito Federal", "Xochimilco, Distrito Federal", "Axapusco, Mexico", "Ixtapaluca, Mexico", "Valle de Chalco Solidaridad, Mexico", "Chicoloapan, Mexico", "Chimalhuacan, Mexico", "Malinalco, Mexico"








# Modelling Aztec Maize Yields



Unfortunate

## Rescale Yields

10*Yield^0.65
```{r}

RescaleYields <- function(x, method, a, b){
  
  if (method == "power"){
    y <- a*x^b
  }
  
  if (method == "sigmoid"){
    y <- a/(1+exp(-x*b))-(a/2)
  }
  
  return(y)
}

METHOD = "power"
A_PAR = 10
B_PAR = 0.65


```

## BOM Chinampas
Some of the most important cases for our Aztec yield model are the chinampas of the southern Basin of Mexico. Unfortunately, these areas no longer cultivate 
write.csv(SIAP_2, paste0(wd$data_r,"SIAP_2_BOM_IrrigNoMaizeCases.csv"))
```{r}

# Read-in the SIAP 2003-2021 Yield Data
SIAP_2 <- read.csv(paste0(wd$data_p,"SIAP_2.csv"))

Chalco <- SIAP_2 %>% filter(EstadoMunicipio == "Chalco, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano") %>% 
  mutate(Yield=Yield*1000, ZYield = (Yield - mean(Yield)) / sd(Yield))


MilpaAlta <- SIAP_2 %>% filter(EstadoMunicipio == "Milpa Alta, Distrito Federal" & AGType == "Riego" & Cycle == "Perennes") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Cycle = "Primavera-Verano", Price = NA, Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = Planted +20, Harvested = Harvested + 20) 
MilpaAlta$Yield = (Chalco$ZYield + runif(1, min = -0.5, max = 0.5))*(150 +runif(1, min = 0, max = 50))+3800
MilpaAlta$Product = MilpaAlta$Yield*MilpaAlta$Harvested


Xochimilco <- SIAP_2 %>% filter(EstadoMunicipio == "Xochimilco, Distrito Federal" & AGType == "Riego" & Cultigen == "Lechuga") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Price = NA, Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = Planted +100, Harvested = Harvested + 100) 
Xochimilco$Yield = (Chalco$ZYield + runif(1, min = -0.5, max = 0.5))*(150 +runif(1, min = 0, max = 50))+4050
Xochimilco$Product = Xochimilco$Yield*Xochimilco$Harvested


Tlahuac <- SIAP_2 %>% filter(EstadoMunicipio == "Tlahuac, Distrito Federal" & AGType == "Riego" & Cultigen == "Brocoli" & Cycle == "Primavera-Verano") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Price = NA, Value = NA, Yield_orig = NA, Yield_SIAP = NA) 
Tlahuac$Yield = (Chalco$ZYield + runif(1, min = -0.5, max = 0.5))*(150 +runif(1, min = 0, max = 50))+4000
Tlahuac$Product = Tlahuac$Yield*Tlahuac$Harvested


ValleChalco <- SIAP_2 %>% filter(EstadoMunicipio == "Valle de Chalco Solidaridad, Mexico" & AGType == "Riego" & Cycle == "Primavera-Verano" & Cultigen == "Lechuga") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Price = NA, Value = NA, Yield_orig = NA, Yield_SIAP = NA) 
ValleChalco$Yield = (Chalco$ZYield[(length(Chalco$ZYield)-nrow(ValleChalco)+1):length(Chalco$ZYield)] + runif(1, min = -0.5, max = 0.5))*(150 +runif(1, min = 0, max = 50))+3900
ValleChalco$Product = ValleChalco$Yield*ValleChalco$Harvested
runif(1, min = 0.01, max = 0.5)



Ixtapaluca <- SIAP_2 %>% filter(EstadoMunicipio == "Ixtapaluca, Mexico" & AGType == "Riego" & Cultigen == "Maiz forrajero en verde") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = Planted +50, Harvested = Harvested + 50) 
Ixtapaluca$Yield = (Chalco$ZYield[2:19] + runif(1, min = -0.5, max = 0.5))*(200 +runif(1, min = -10, max = 20))+2300
Ixtapaluca$Product = Ixtapaluca$Yield*Ixtapaluca$Harvested



Nextlalpan <- SIAP_2 %>% filter(EstadoMunicipio == "Nextlalpan, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = Planted +20, Harvested = Harvested + 20) 
Nextlalpan$Yield = (Chalco$ZYield + runif(1, min = -0.5, max = 0.5))*(200 +runif(1, min = -10, max = 20))+3800
Nextlalpan$Product = Nextlalpan$Yield*Nextlalpan$Harvested

Tonanitla <- SIAP_2 %>% filter(EstadoMunicipio == "Tonanitla, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = Planted +20, Harvested = Harvested + 20) 
Tonanitla$Yield = (Chalco$ZYield[4:19] + runif(1, min = -0.5, max = 0.5))*(200 +runif(1, min = -10, max = 20))+3800
Tonanitla$Product = Tonanitla$Yield*Tonanitla$Harvested

Tecamac <- SIAP_2 %>% filter(EstadoMunicipio == "Tecamac, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano") %>% mutate(Cultigen = "Maiz grano", Cultigen_ID = 7490000, AGType = "Riego", Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = Planted +20, Harvested = Harvested + 20) 
Tecamac$Yield = (Chalco$ZYield + runif(1, min = -0.75, max = 0.75))*(300 +runif(1, min = -10, max = 20))+3500
Tecamac$Product = Tecamac$Yield*Tecamac$Harvested



##############################################################


Otumba <- SIAP_2 %>% filter(EstadoMunicipio == "Otumba, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano") %>% 
  mutate(Yield=Yield*1000, ZYield = (Yield - mean(Yield)) / sd(Yield))

Axapusco <- SIAP_2 %>% filter(EstadoMunicipio == "Otumba, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano") %>% 
  mutate(EstadoMunicipio = "Axapusco, Mexico", Municipio_ID = 16, Municipio = "Axapusco", Price = NA, Value = NA, Yield_orig = NA, Yield_SIAP = NA, Planted = 50)
Axapusco$Yield = (Otumba$ZYield + runif(1, min = -0.5, max = 0.5))*(285 +runif(1, min = -10, max = 20))+2200
Axapusco$Planted = Axapusco$Planted + runif(1, min = -3, max = 5)
Axapusco$Harvested = Axapusco$Harvested
Axapusco$Product = Axapusco$Yield*Axapusco$Harvested


ADDEDCASES <- rbind(MilpaAlta, Xochimilco, Tlahuac, ValleChalco, Ixtapaluca, Axapusco, Nextlalpan, Tonanitla, Tecamac)

rm(Chalco, MilpaAlta, Xochimilco, Tlahuac, ValleChalco, Ixtapaluca, Axapusco, Nextlalpan, Otumba, Tonanitla, Tecamac)






```



## Create Data


```{r}


# Read-in the SIAP 2003-2021 Yield Data
SIAP_2 <- read.csv(paste0(wd$data_p,"SIAP_2.csv"))



SIAP_2b = SIAP_2 %>% mutate(
    # convert units -- tons to kg -- for yield, yield loss and product
    Yield = Yield * 1000, Product = Product * 1000,
    # reported yield in the data == Product (tons) / hectares harvested
    Yield_orig = Yield,
    # we want to change the reported yield to == Product (tons) / hectares planted
    # to account for yield loss over the course of the growing season
    Yield = Product / Planted, 
    # Save old SIAP yields as a variable
    Yield_SIAP = Yield,
    Yield = RescaleYields(Yield, method = METHOD, a = A_PAR, b = B_PAR))

# delete the modified rows
SIAP_2b = SIAP_2b %>% 
  filter(!(EstadoMunicipio == "Milpa Alta, Distrito Federal" & AGType == "Riego" & Cycle == "Perrenes")) %>%
  filter(!(EstadoMunicipio == "Xochimilco, Distrito Federal" & AGType == "Riego" & Cultigen == "Lechuga")) %>%
  filter(!(EstadoMunicipio == "Tlahuac, Distrito Federal" & AGType == "Riego" & Cultigen == "Brocoli" & Cycle == "Primavera-Verano")) %>%
  filter(!(EstadoMunicipio == "Valle de Chalco Solidaridad, Mexico" & AGType == "Riego" & Cycle == "Primavera-Verano" & Cultigen == "Lechuga")) %>%
  filter(!(EstadoMunicipio == "Ixtapaluca, Mexico" & AGType == "Riego" & Cultigen == "Maiz forrajero en verde")) %>%
  filter(!(EstadoMunicipio == "Nextlalpan, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano")) %>%
  filter(!(EstadoMunicipio == "Tonanitla, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano")) %>%
  filter(!(EstadoMunicipio == "Tecamac, Mexico" & AGType == "Riego" & Cultigen == "Maiz grano"))


# Add the new rows
SIAP_2b = rbind(SIAP_2b, ADDEDCASES) 

SIAP_2b = SIAP_2b %>% 
  select(-X) %>%
    # only consider Spring-Summer crop cycle yields (exclude Autumn-Winter yields)
  filter(Cycle %in% c("Primavera-Verano", "Perennes")) %>%
  mutate(CultigenGroup = case_when(
    Cultigen == "Maiz grano" ~ "Maize",
    Cultigen == "Avena forrajera seca" ~ "Fodder",
    Cultigen == "Pastos y praderas seco" ~ "Fodder",
    Cultigen == "Alfalfa verde" ~ "Fodder",
    Cultigen == "Pastos y praderas" ~ "Fodder",
    Cultigen == "Cebada forrajera en verde" ~ "Fodder",
    Cultigen == "Pastos y praderas achicalado" ~ "Fodder",
    .default = "OtherCrops")) %>%
  group_by(EstadoMunicipio, Year, AGType) %>%
    mutate(Area_AGType = sum(Planted, na.rm=T),
           Area_AGType_Maize = sum(Planted[CultigenGroup == "Maize"], na.rm=T),
           Area_AGType_Maize = ifelse(is.na(Area_AGType_Maize), 0, Area_AGType_Maize),
           Area_AGType_Fodder = sum(Planted[CultigenGroup == "Fodder"], na.rm=T),
           Area_AGType_Fodder = ifelse(is.na(Area_AGType_Fodder), 0, Area_AGType_Fodder),
           Area_AGType_OtherCrops = sum(Planted[CultigenGroup == "OtherCrops"], na.rm=T),
           Area_AGType_OtherCrops = ifelse(is.na(Area_AGType_OtherCrops), 0, Area_AGType_OtherCrops)) %>% ungroup() %>%
  group_by(EstadoMunicipio, Year) %>%
  mutate(Area_Total = sum(Planted, na.rm=T) + runif(1, min = 0.0000001, max = 0.0001),
           Area_Total_Maize = sum(Planted[CultigenGroup == "Maize"], na.rm=T) + runif(1, min = 0.0000001, max = 0.0001),
           Area_Total_Maize = ifelse(is.na(Area_Total_Maize) | Area_Total_Maize <=  0.0001, 0, Area_Total_Maize),
           Area_Total_Fodder = sum(Planted[CultigenGroup == "Fodder"], na.rm=T) + runif(1, min = 0.0000001, max = 0.0001),
           Area_Total_Fodder = ifelse(is.na(Area_Total_Fodder) | Area_Total_Fodder <=  0.0001, 0, Area_Total_Fodder),
           Area_Total_OtherCrops = sum(Planted[CultigenGroup == "OtherCrops"], na.rm=T) + runif(1, min = 0.0000001, max = 0.0001),
           Area_Total_OtherCrops = ifelse(is.na(Area_Total_OtherCrops) | Area_Total_OtherCrops <=  0.0001, 0, Area_Total_OtherCrops)) %>% ungroup() %>%
    mutate(PctArea_Maize_Crops_AGType = Area_AGType_Maize / (Area_AGType_Maize + Area_AGType_OtherCrops),
           PctArea_Maize_AGType = Area_AGType_Maize / (Area_AGType_Maize + Area_AGType_OtherCrops + Area_AGType_Fodder),
           PctArea_Maize_Crops_Total = Area_Total_Maize / (Area_Total_Maize + Area_Total_OtherCrops),
           PctArea_Maize_Total = Area_Total_Maize / (Area_Total_Maize + Area_Total_OtherCrops + Area_Total_Fodder)) %>%
    # filter the data to only include Maize from the spring-summer cycle
    filter(Cultigen == "Maiz grano", Cycle == "Primavera-Verano") %>%
    
    group_by(EstadoMunicipio, Year)

SIAP_3_rs <- SIAP_2b %>% mutate(
  Product = Yield * Planted,
  Yield_orig = Product / Harvested,
  YieldLoss = (Product / Harvested) - Yield,
  PctYieldLoss = (1 - (Yield / (Product / Harvested)))*100) %>% rowwise() %>% 
  mutate(YieldLoss = ifelse(YieldLoss < 0, 0, YieldLoss),
      PctYieldLoss = ifelse(PctYieldLoss < 0, 0, PctYieldLoss)) %>% ungroup() %>% 
  group_by(EstadoMunicipio, Year) %>%
    mutate(TotYield = (sum(Product, na.rm=T) / sum(Planted, na.rm=T)) + runif(1, min = 0.0001, max = 0.01),
           TotYield_orig = sum(Product, na.rm=T) / sum(Harvested, na.rm=T),
           TotYieldLoss = TotYield_orig - TotYield,
           TotPctYieldLoss = (1-(TotYield/TotYield_orig))*100) %>% ungroup()

rm(SIAP_2, ADDEDCASES, METHOD, A_PAR, B_PAR)

SIAP_4_rs = SIAP_3_rs %>% 
  # group the data by state-municipality and agriculture type
  group_by(EstadoMunicipio, AGType) %>% 
  # calculate variables for the maize yield (and yield loss) time-series: mean, standard deviation 
  # and coefficient of variation by state-municipality and agriculture type
  mutate(AvgYield = mean(Yield, na.rm=T), 
         sdYield = sd(Yield, na.rm=T), 
         cvYield = sdYield/AvgYield*100,
         AvgYieldLoss = mean(YieldLoss, na.rm=T), 
         sdYieldLoss = sd(YieldLoss, na.rm=T), 
         cvYieldLoss = sdYieldLoss/AvgYieldLoss*100,
         AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), 
         sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), 
         cvPctYieldLoss = sdPctYieldLoss/AvgPctYieldLoss*100) %>% 
  # calculate variable for the number of time series cases by state-municipality and agriculture type
  add_tally() %>% 
  # ungroup the data
  ungroup() %>% 
  # calculate the maize yield Z-score by state-municipality and agriculture type
  # using the state-municipality / agriculture type mean and st.dev
  mutate(zYield = (Yield - AvgYield)/sdYield) %>% 
  # group by state-municipality
  group_by(EstadoMunicipio) %>% 
  # calculate variables for the Yield and Yield Loss  mean, standard deviation and 
  # coefficient of variation for each agriculture type by state-municipality
  mutate(AvgYield_Total = mean(unique(TotYield), na.rm=T), #sum(Product, na.rm=T) / sum(Planted, na.rm=T)
         sdYield_Total = sd(unique(TotYield), na.rm=T), 
         cvYield_Total = sdYield_Total/AvgYield_Total*100,
         AvgYield_Irrig = mean(Yield[AGType == "Riego"] , na.rm=T),
         sdYield_Irrig = sd(Yield[AGType == "Riego"] , na.rm=T),
         cvYield_Irrig = sdYield_Irrig/AvgYield_Irrig*100,
         AvgYield_Temp = mean(Yield[AGType == "Temporal"], na.rm=T),
         sdYield_Temp = sd(Yield[AGType == "Temporal"], na.rm=T),
         cvYield_Temp = sdYield_Temp/AvgYield_Temp*100,
         AvgYieldLoss_Total = mean(unique(TotYieldLoss), na.rm=T), 
         sdYieldLoss_Total = sd(unique(TotYieldLoss), na.rm=T), 
         cvYieldLoss_Total = sdYieldLoss_Total/AvgYieldLoss_Total*100,
         AvgYieldLoss_Irrig = mean(YieldLoss[AGType == "Riego"] , na.rm=T),
         sdYieldLoss_Irrig = sd(YieldLoss[AGType == "Riego"] , na.rm=T),
         cvYieldLoss_Irrig = sdYieldLoss_Irrig/AvgYieldLoss_Irrig*100,
         AvgYieldLoss_Temp = mean(YieldLoss[AGType == "Temporal"], na.rm=T),
         sdYieldLoss_Temp = sd(YieldLoss[AGType == "Temporal"], na.rm=T),
         cvYieldLoss_Temp = sdYieldLoss_Temp/AvgYieldLoss_Temp*100,
         AvgPctYieldLoss_Total = mean(unique(TotPctYieldLoss), na.rm=T), 
         sdPctYieldLoss_Total = sd(unique(TotPctYieldLoss), na.rm=T), 
         cvPctYieldLoss_Total = sdPctYieldLoss_Total/AvgPctYieldLoss_Total*100,
         AvgPctYieldLoss_Irrig = mean(PctYieldLoss[AGType == "Riego"] , na.rm=T),
         sdPctYieldLoss_Irrig = sd(PctYieldLoss[AGType == "Riego"] , na.rm=T),
         cvPctYieldLoss_Irrig = sdPctYieldLoss_Irrig/AvgPctYieldLoss_Irrig*100,
         AvgPctYieldLoss_Temp = mean(PctYieldLoss[AGType == "Temporal"], na.rm=T),
         sdPctYieldLoss_Temp = sd(PctYieldLoss[AGType == "Temporal"], na.rm=T),
         cvPctYieldLoss_Temp = sdPctYieldLoss_Temp/AvgPctYieldLoss_Temp*100) %>% 
  # calculate variable for the overall number of time series cases by state-municipality
  add_tally(name = "n_Total") %>% ungroup() %>% 
  group_by(EstadoMunicipio, AGType) %>% 
  mutate(AvgArea = mean(Area_AGType, na.rm=T),
         sdArea = sd(Area_AGType, na.rm=T),
         cvArea = sdArea/AvgArea*100,
         AvgArea_Maize = mean(Area_AGType_Maize, na.rm=T),
         sdArea_Maize = sd(Area_AGType_Maize, na.rm=T),
         cvArea_Maize = sdArea_Maize/AvgArea_Maize*100,
         AvgArea_Fodder = mean(Area_AGType_Fodder, na.rm=T),
         AvgArea_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
         AvgPctArea_Maize_Crops = mean(PctArea_Maize_Crops_AGType, na.rm=T),
         sdPctArea_Maize_Crops = sd(PctArea_Maize_Crops_AGType, na.rm=T),
         cvPctArea_Maize_Crops = sdPctArea_Maize_Crops/AvgPctArea_Maize_Crops*100,
         AvgPctArea_Maize = mean(PctArea_Maize_AGType, na.rm=T),
         sdPctArea_Maize = sd(PctArea_Maize_AGType, na.rm=T),
         cvPctArea_Maize = sdPctArea_Maize/AvgPctArea_Maize*100) %>%
  ungroup() %>% group_by(EstadoMunicipio) %>% 
  mutate(AvgArea_Irrig = mean(Area_AGType[AGType == "Riego"], na.rm=T),
         AvgArea_Irrig_Maize = mean(Area_AGType_Maize[AGType == "Riego"], na.rm=T),
         AvgArea_Irrig_Fodder = mean(Area_AGType_Fodder[AGType == "Riego"], na.rm=T),
         AvgArea_Irrig_OtherCrops = mean(Area_AGType_OtherCrops[AGType == "Riego"], na.rm=T),
         AvgPctArea_Maize_Crops_Irrig = mean(PctArea_Maize_Crops_AGType[AGType == "Riego"], na.rm=T),
         AvgPctArea_Maize_Irrig = mean(PctArea_Maize_AGType[AGType == "Riego"], na.rm=T),
         AvgArea_Temp = mean(Area_AGType[AGType == "Temporal"], na.rm=T),
         AvgArea_Temp_Maize = mean(Area_AGType_Maize[AGType == "Temporal"], na.rm=T),
         AvgArea_Temp_Fodder = mean(Area_AGType_Fodder[AGType == "Temporal"], na.rm=T),
         AvgArea_Temp_OtherCrops = mean(Area_AGType_OtherCrops[AGType == "Temporal"], na.rm=T),
         AvgPctArea_Maize_Crops_Temp = mean(PctArea_Maize_Crops_AGType[AGType == "Temporal"], na.rm=T),
         AvgPctArea_Maize_Temp = mean(PctArea_Maize_AGType[AGType == "Temporal"], na.rm=T),
         
         AvgArea_Total = mean(unique(Area_Total), na.rm=T), 
         sdArea_Total = sd(unique(Area_Total), na.rm=T), 
         cvArea_Total = sdArea_Total/AvgArea_Total*100,
         AvgArea_Total_Maize = mean(unique(Area_Total_Maize), na.rm=T),
         sdArea_Total_Maize = sd(unique(Area_Total_Maize), na.rm=T),
         cvArea_Total_Maize = sdArea_Total_Maize/AvgArea_Total_Maize*100,
         AvgArea_Total_Fodder = mean(unique(Area_Total_Fodder), na.rm=T),
         AvgArea_Total_OtherCrops = mean(unique(Area_Total_OtherCrops), na.rm=T),
         AvgPctArea_Maize_Crops_Total = mean(unique(PctArea_Maize_Crops_Total), na.rm=T),
         sdPctArea_Maize_Crops_Total = sd(unique(PctArea_Maize_Crops_Total), na.rm=T),
         cvPctArea_Maize_Crops_Total = sdPctArea_Maize_Crops_Total/AvgPctArea_Maize_Crops_Total*100,
         AvgPctArea_Maize_Total = mean(unique(PctArea_Maize_Total), na.rm=T),
         sdPctArea_Maize_Total = sd(unique(PctArea_Maize_Total), na.rm=T),
         cvPctArea_Maize_Total = sdPctArea_Maize_Total/AvgPctArea_Maize_Total*100) %>%
  # ungroup the data
  ungroup() %>% 
  # calculate additional variables of interest
  mutate(
    # irrigated maize % of total maize cultivation
    AvgPctMaizeArea_Irrig = AvgArea_Irrig_Maize / AvgArea_Total_Maize,
    AvgPctMaizeArea_Irrig = ifelse(is.nan(AvgPctMaizeArea_Irrig), 0, AvgPctMaizeArea_Irrig),
    # temporal maize % of total maize cultivation 
    AvgPctMaizeArea_Temp = AvgArea_Temp_Maize / AvgArea_Total_Maize,
    AvgPctMaizeArea_Temp = ifelse(is.nan(AvgPctMaizeArea_Temp), 0, AvgPctMaizeArea_Temp),
    # irrigated % of total cultivation 
    AvgPctArea_Irrig = AvgArea_Irrig / AvgArea_Total,#BY MUNICIPIO (both AGTypes have same value!)
    AvgPctArea_Irrig = ifelse(is.nan(AvgPctArea_Irrig), 0, AvgPctArea_Irrig),
    # temporal % of total cultivation 
    AvgPctArea_Temp = AvgArea_Temp / AvgArea_Total,
    AvgPctArea_Temp = ifelse(is.nan(AvgPctArea_Temp), 0, AvgPctArea_Temp),
    # calculate the maize yield and yield loss Z-score by state-municipality for all agriculture types
    zYield_Total = (Yield - AvgYield_Total)/sdYield_Total,
    zYieldLoss_Total = (YieldLoss - AvgYieldLoss_Total)/sdYieldLoss_Total,
    # TTr = "Temporal-to-Total Ratio" == the ratio of avg temporal variable values to the avg total value
    # ITr = "Irrigation-to-Total Ratio" == the ratio of avg irrigation variable values to the avg total value
    ITr_AvgYield = AvgYield_Irrig/AvgYield_Total,
    ITr_AvgYieldLoss = AvgYieldLoss_Irrig/AvgYieldLoss_Total,
    TTr_AvgYield = AvgYield_Temp/AvgYield_Total,
    TTr_AvgYieldLoss = AvgYieldLoss_Irrig/AvgYieldLoss_Total,
    ITr_cvYield = cvYield_Irrig/cvYield_Total,
    ITr_cvYieldLoss = cvYieldLoss_Irrig/cvYieldLoss_Total,
    TTr_cvYield = cvYield_Irrig/cvYield_Total,
    TTr_cvYieldLoss = cvYieldLoss_Irrig/cvYieldLoss_Total)

SIAP_5_rs = SIAP_4_rs %>% 
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sd(Yield, na.rm=T)/mean(Yield, na.rm=T)*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sd(YieldLoss, na.rm=T)/mean(YieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), # mean/average maize % Yield Loss
            sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), # standard deviation of maize % Yield Loss
            minPctYieldLoss = min(PctYieldLoss, na.rm=T), # minimum maize % Yield Loss
            maxPctYieldLoss = max(PctYieldLoss, na.rm=T), # maximum maize % Yield Loss
            medPctYieldLoss = median(PctYieldLoss, na.rm=T), # median maize % Yield Loss
            cvPctYieldLoss = sd(PctYieldLoss, na.rm=T)/mean(PctYieldLoss, na.rm=T)*100,# coefficient of variation of maize % Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares planted in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares planted in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            n = mean(n, na.rm=T), # number of time series cases by state-municipality and agriculture type
            n_Total = mean(n_Total, na.rm=T), # overall number of time series cases by state-municipality
            
            AvgYield_Total = mean(AvgYield_Total, na.rm=T), # mean maize yield for all agriculture types
            sdYield_Total = mean(sdYield_Total, na.rm=T), # standard deviation of maize yield for all agriculture types
            cvYield_Total = mean(cvYield_Total, na.rm=T), # coefficient of variation of maize yield for all agriculture types
            AvgYield_Irrig = mean(AvgYield_Irrig, na.rm=T), # mean maize yield for irrigated agriculture
            sdYield_Irrig = mean(sdYield_Irrig, na.rm=T), # standard deviation of maize yield for irrigated agriculture
            cvYield_Irrig = mean(cvYield_Irrig, na.rm=T), # coefficient of variation of maize yield for irrigated agriculture
            AvgYield_Temp = mean(AvgYield_Temp, na.rm=T), # mean maize yield for temporal agriculture
            sdYield_Temp = mean(sdYield_Temp, na.rm=T), # standard deviation of maize yield for temporal agriculture
            cvYield_Temp = mean(cvYield_Temp, na.rm=T), # coefficient of variation of maize yield for temporal agriculture
            ITr_AvgYield = mean(ITr_AvgYield, na.rm=T), # irrigation-to-total ratio for mean maize yields
            ITr_cvYield = mean(ITr_cvYield, na.rm=T), # irrigation-to-total ratio for coefficient of variation of maize yields
            TTr_AvgYield = mean(TTr_AvgYield, na.rm=T), # temporal-to-total ratio for mean maize yields
            TTr_cvYield = mean(TTr_cvYield, na.rm=T), # temporal-to-total ratio for coefficient of variation of maize yields
            
            AvgYieldLoss_Total = mean(AvgYieldLoss_Total, na.rm=T), # mean maize yield loss for all agriculture types
            sdYieldLoss_Total = mean(sdYieldLoss_Total, na.rm=T), # standard deviation of maize yield loss for all agriculture types
            cvYieldLoss_Total = mean(cvYieldLoss_Total, na.rm=T), # coefficient of variation of maize yield loss for all agriculture types
            AvgYieldLoss_Irrig = mean(AvgYieldLoss_Irrig, na.rm=T), # mean maize yield loss for irrigated agriculture
            sdYieldLoss_Irrig = mean(sdYieldLoss_Irrig, na.rm=T), # standard deviation of maize yield loss for irrigated agriculture
            cvYieldLoss_Irrig = mean(cvYieldLoss_Irrig, na.rm=T), # coefficient of variation of maize yield loss for irrigated agriculture
            AvgYieldLoss_Temp = mean(AvgYieldLoss_Temp, na.rm=T), # mean maize yield loss for temporal agriculture
            sdYieldLoss_Temp = mean(sdYieldLoss_Temp, na.rm=T), # standard deviation of maize yield loss for temporal agriculture
            cvYieldLoss_Temp = mean(cvYieldLoss_Temp, na.rm=T), # coefficient of variation of maize yield loss for temporal agriculture
            AvgPctYieldLoss_Total = mean(AvgPctYieldLoss_Total, na.rm=T), # mean % maize yield loss for all agriculture types
            sdPctYieldLoss_Total = mean(sdPctYieldLoss_Total, na.rm=T), # standard deviation of % maize yield loss for all agriculture types
            cvPctYieldLoss_Total = mean(cvPctYieldLoss_Total, na.rm=T), # coefficient of variation of % maize yield loss for all agriculture types
            AvgPctYieldLoss_Irrig = mean(AvgPctYieldLoss_Irrig, na.rm=T), # mean % maize yield loss for irrigated agriculture
            sdPctYieldLoss_Irrig = mean(sdPctYieldLoss_Irrig, na.rm=T), # standard deviation of % maize yield loss for irrigated agriculture
            cvPctYieldLoss_Irrig = mean(cvPctYieldLoss_Irrig, na.rm=T), # coefficient of variation of % maize yield loss for irrigated agriculture
            AvgPctYieldLoss_Temp = mean(AvgPctYieldLoss_Temp, na.rm=T), # mean % maize yield loss for temporal agriculture
            sdPctYieldLoss_Temp = mean(sdPctYieldLoss_Temp, na.rm=T), # standard deviation of % maize yield loss for temporal agriculture
            cvPctYieldLoss_Temp = mean(cvPctYieldLoss_Temp, na.rm=T), # coefficient of variation of % maize yield loss for temporal agriculture
            ITr_AvgYieldLoss = mean(ITr_AvgYieldLoss, na.rm=T), # irrigation-to-total ratio for mean maize yield loss
            ITr_cvYieldLoss = mean(ITr_cvYieldLoss, na.rm=T),# irrigation-to-total ratio for coefficient of variation of maize yield loss
            TTr_AvgYieldLoss = mean(TTr_AvgYieldLoss, na.rm=T), # temporal-to-total ratio for mean maize yield loss
            TTr_cvYieldLoss = mean(TTr_cvYieldLoss, na.rm=T),# temporal-to-total ratio for coefficient of variation of maize yield loss
            
         AvgArea = mean(Area_AGType, na.rm=T),
         sdArea = sd(Area_AGType, na.rm=T),
         cvArea = sdArea/AvgArea*100,
         AvgArea_Maize = mean(Area_AGType_Maize, na.rm=T),
         sdArea_Maize = sd(Area_AGType_Maize, na.rm=T),
         cvArea_Maize = sdArea_Maize/AvgArea_Maize*100,
         AvgArea_Fodder = mean(Area_AGType_Fodder, na.rm=T),
         AvgArea_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
         AvgPctArea_Maize_Crops = mean(PctArea_Maize_Crops_AGType, na.rm=T),
         sdPctArea_Maize_Crops = sd(PctArea_Maize_Crops_AGType, na.rm=T),
         cvPctArea_Maize_Crops = sdPctArea_Maize_Crops/AvgPctArea_Maize_Crops*100,
         AvgPctArea_Maize = mean(PctArea_Maize_AGType, na.rm=T),
         sdPctArea_Maize = sd(PctArea_Maize_AGType, na.rm=T),
         cvPctArea_Maize = sdPctArea_Maize/AvgPctArea_Maize*100,
         
         AvgArea_Irrig = ifelse(is.na(mean(AvgArea_Irrig, na.rm=T)), 0, mean(AvgArea_Irrig, na.rm=T)),
         AvgArea_Irrig_Maize = ifelse(is.na(mean(AvgArea_Irrig_Maize, na.rm=T)), 0, mean(AvgArea_Irrig_Maize, na.rm=T)),
         AvgArea_Irrig_Fodder = ifelse(is.na(mean(AvgArea_Irrig_Fodder, na.rm=T)), 0, mean(AvgArea_Irrig_Fodder, na.rm=T)),
         AvgArea_Irrig_OtherCrops = ifelse(is.na(mean(AvgArea_Irrig_OtherCrops, na.rm=T)), 0, mean(AvgArea_Irrig_OtherCrops, na.rm=T)),
         AvgPctArea_Maize_Crops_Irrig = ifelse(is.na(mean(AvgPctArea_Maize_Crops_Irrig, na.rm=T)), 0, mean(AvgPctArea_Maize_Crops_Irrig, na.rm=T)),
         AvgPctArea_Maize_Irrig = ifelse(is.na(mean(AvgPctArea_Maize_Irrig, na.rm=T)), 0, mean(AvgPctArea_Maize_Irrig, na.rm=T)),
         AvgArea_Temp = ifelse(is.na(mean(AvgArea_Temp, na.rm=T)), 0, mean(AvgArea_Temp, na.rm=T)),
         AvgArea_Temp_Maize = ifelse(is.na(mean(AvgArea_Temp_Maize, na.rm=T)), 0, mean(AvgArea_Temp_Maize, na.rm=T)),
         AvgArea_Temp_Fodder = ifelse(is.na(mean(AvgArea_Temp_Fodder, na.rm=T)), 0, mean(AvgArea_Temp_Fodder, na.rm=T)),
         AvgArea_Temp_OtherCrops = ifelse(is.na(mean(AvgArea_Temp_OtherCrops, na.rm=T)), 0, mean(AvgArea_Temp_OtherCrops, na.rm=T)),
         AvgPctArea_Maize_Crops_Temp = ifelse(is.na(mean(AvgPctArea_Maize_Crops_Temp, na.rm=T)), 0, mean(AvgPctArea_Maize_Crops_Temp, na.rm=T)),
         AvgPctArea_Maize_Temp = ifelse(is.na(mean(AvgPctArea_Maize_Temp, na.rm=T)), 0, mean(AvgPctArea_Maize_Temp, na.rm=T)),
         
         AvgArea_Total = mean(AvgArea_Total, na.rm=T),
         sdArea_Total = mean(sdArea_Total, na.rm=T),
         cvArea_Total = mean(cvArea_Total, na.rm=T),
         AvgArea_Total_Maize = mean(AvgArea_Total_Maize, na.rm=T),
         sdArea_Total_Maize = mean(sdArea_Total_Maize, na.rm=T),
         cvArea_Total_Maize = mean(cvArea_Total_Maize, na.rm=T),
         AvgArea_Total_Fodder = mean(AvgArea_Total_Fodder, na.rm=T),
         AvgArea_Total_OtherCrops = mean(AvgArea_Total_OtherCrops, na.rm=T),
         AvgPctArea_Maize_Crops_Total = mean(AvgPctArea_Maize_Crops_Total, na.rm=T),
         sdPctArea_Maize_Crops_Total = mean(sdPctArea_Maize_Crops_Total, na.rm=T),
         cvPctArea_Maize_Crops_Total = mean(cvPctArea_Maize_Crops_Total, na.rm=T),
         AvgPctArea_Maize_Total = mean(AvgPctArea_Maize_Total, na.rm=T),
         sdPctArea_Maize_Total = mean(sdPctArea_Maize_Total, na.rm=T),
         cvPctArea_Maize_Total = mean(cvPctArea_Maize_Total, na.rm=T)) %>%
   # ungroup the data
   ungroup() %>% 
   mutate(
    # irrigated maize % of total maize cultivation
    AvgPctMaizeArea_Irrig = AvgArea_Irrig_Maize / AvgArea_Total_Maize,
    AvgPctMaizeArea_Irrig = ifelse(is.nan(AvgPctMaizeArea_Irrig), 0, AvgPctMaizeArea_Irrig),
    AvgPctMaizeArea_Irrig = ifelse(is.na(AvgPctMaizeArea_Irrig), 0, AvgPctMaizeArea_Irrig),
    AvgPctMaizeArea_Irrig = ifelse(AvgPctMaizeArea_Irrig > 1, 1, AvgPctMaizeArea_Irrig),
    # temporal maize % of total maize cultivation 
    AvgPctMaizeArea_Temp = AvgArea_Temp_Maize / AvgArea_Total_Maize,
    AvgPctMaizeArea_Temp = ifelse(is.nan(AvgPctMaizeArea_Temp), 0, AvgPctMaizeArea_Temp),
    AvgPctMaizeArea_Temp = ifelse(is.na(AvgPctMaizeArea_Temp), 0, AvgPctMaizeArea_Temp),
    AvgPctMaizeArea_Temp = ifelse(AvgPctMaizeArea_Temp > 1, 1, AvgPctMaizeArea_Temp),
    # irrigated % of total cultivation 
    AvgPctArea_Irrig = AvgArea_Irrig / AvgArea_Total,#BY MUNICIPIO (both AGTypes have same value!)
    AvgPctArea_Irrig = ifelse(is.nan(AvgPctArea_Irrig), 0, AvgPctArea_Irrig),
    AvgPctArea_Irrig = ifelse(is.na(AvgPctArea_Irrig), 0, AvgPctArea_Irrig),
    AvgPctArea_Irrig = ifelse(AvgPctArea_Irrig > 1, 1, AvgPctArea_Irrig),
    # temporal % of total cultivation 
    AvgPctArea_Temp = AvgArea_Temp / AvgArea_Total,
    AvgPctArea_Temp = ifelse(is.nan(AvgPctArea_Temp), 0, AvgPctArea_Temp),
    AvgPctArea_Temp = ifelse(is.na(AvgPctArea_Temp), 0, AvgPctArea_Temp),
    AvgPctArea_Temp = ifelse(AvgPctArea_Temp > 1, 1, AvgPctArea_Temp)) %>% 
  rowwise() %>%
  # Remove NaN values from affected variables
  mutate(cvYieldLoss = ifelse(is.nan(cvYieldLoss), 0, cvYieldLoss),
         cvLost = ifelse(is.nan(cvLost), 0, cvLost)) %>% 
  ungroup()

x = SIAP_4_rs %>% 
  #group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sd(Yield, na.rm=T)/mean(Yield, na.rm=T)*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sd(YieldLoss, na.rm=T)/mean(YieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minPctYieldLoss = min(PctYieldLoss, na.rm=T), # minimum maize Yield Loss
            maxPctYieldLoss = max(PctYieldLoss, na.rm=T), # maximum maize Yield Loss
            medPctYieldLoss = median(PctYieldLoss, na.rm=T), # median maize Yield Loss
            cvPctYieldLoss = sd(PctYieldLoss, na.rm=T)/mean(PctYieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            sdPlanted = sd(Planted, na.rm=T), # standard deviation of hectares planted in maize
            cvPlanted = sdPlanted/AvgPlanted*100, # coefficient of variation of hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares harvested in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares harvested in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            sdProduct = sd(Product, na.rm=T), # standard deviation of total kg of maize produced
            cvProduct = sdProduct/AvgProduct*100, # coefficient of variation of total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            sdValue = sd(Value, na.rm=T), # standard deviation of total value in $MX of maize produced
            cvValue = sdValue/AvgValue*100, # coefficient of variation of total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            sdPrice = sd(Price, na.rm=T), # standard deviation of price per kg in $MX for maize
            cvPrice = sdPrice/AvgPrice*100, # coefficient of variation of price per kg in $MX for maize
            n = mean(n, na.rm=T),# number of time series cases by state-municipality and agriculture type
            AvgArea = mean(Area_AGType, na.rm=T),
            sdArea = sd(Area_AGType, na.rm=T),
            cvArea = sdArea/AvgArea*100,
            AvgArea_Maize = mean(Area_AGType_Maize, na.rm=T),
            sdArea_Maize = sd(Area_AGType_Maize, na.rm=T),
            cvArea_Maize = sdArea_Maize/AvgArea_Maize*100,
            AvgArea_Fodder = mean(Area_AGType_Fodder, na.rm=T),
            AvgArea_OtherCrops = mean(Area_AGType_OtherCrops, na.rm=T),
            AvgPctArea_Maize_Crops = mean(PctArea_Maize_Crops_AGType, na.rm=T),
            sdPctArea_Maize_Crops = sd(PctArea_Maize_Crops_AGType, na.rm=T),
            cvPctArea_Maize_Crops = sdPctArea_Maize_Crops/AvgPctArea_Maize_Crops*100,
            AvgPctArea_Maize = mean(PctArea_Maize_AGType, na.rm=T),
            sdPctArea_Maize = sd(PctArea_Maize_AGType, na.rm=T),
            cvPctArea_Maize = sdPctArea_Maize/AvgPctArea_Maize*100)

SIAP_6_rs = SIAP_4_rs %>% 
  # group by all of the ID variables (effectively at the resolution of each agriculture type and state-municipality)
  group_by(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio) %>%
  # summarize the dataset by state-municipality and agriculture type
  summarize(AGType = "Total",
            AvgYield = mean(Yield, na.rm=T), # mean/average maize yield
            sdYield = sd(Yield, na.rm=T), # standard deviation of maize yield
            minYield = min(Yield, na.rm=T), # minimum maize yield
            maxYield = max(Yield, na.rm=T), # maximum maize yield
            medYield = median(Yield, na.rm=T), # median maize yield
            cvYield = sd(Yield, na.rm=T)/mean(Yield, na.rm=T)*100, # coefficient of variation of maize yield
            
            AvgYieldLoss = mean(YieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdYieldLoss = sd(YieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minYieldLoss = min(YieldLoss, na.rm=T), # minimum maize Yield Loss
            maxYieldLoss = max(YieldLoss, na.rm=T), # maximum maize Yield Loss
            medYieldLoss = median(YieldLoss, na.rm=T), # median maize Yield Loss
            cvYieldLoss = sd(YieldLoss, na.rm=T)/mean(YieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPctYieldLoss = mean(PctYieldLoss, na.rm=T), # mean/average maize Yield Loss
            sdPctYieldLoss = sd(PctYieldLoss, na.rm=T), # standard deviation of maize Yield Loss
            minPctYieldLoss = min(PctYieldLoss, na.rm=T), # minimum maize Yield Loss
            maxPctYieldLoss = max(PctYieldLoss, na.rm=T), # maximum maize Yield Loss
            medPctYieldLoss = median(PctYieldLoss, na.rm=T), # median maize Yield Loss
            cvPctYieldLoss = sd(PctYieldLoss, na.rm=T)/mean(PctYieldLoss, na.rm=T)*100,# coefficient of variation of maize Yield Loss
            
            AvgPlanted = mean(Planted, na.rm=T), # average hectares planted in maize
            sdPlanted = sd(Planted, na.rm=T), # standard deviation of hectares planted in maize
            cvPlanted = sdPlanted/AvgPlanted*100, # coefficient of variation of hectares planted in maize
            AvgHarvested = mean(Harvested, na.rm=T), # average hectares harvested in maize
            sdHarvested = sd(Harvested, na.rm=T), # standard deviation of hectares harvested in maize
            cvHarvested = sdHarvested/AvgHarvested*100, # coefficient of variation of hectares harvested in maize
            AvgLost = mean(Lost, na.rm=T), # average number of hectares of maize lost (i.e. planted but not harvested)
            sdLost = sd(Lost, na.rm=T), # standard deviation of hectares of maize lost (i.e. planted but not harvested)
            cvLost = sdLost/AvgLost*100, # coefficient of variation of hectares of maize lost (i.e. planted but not harvested)
            AvgProduct = mean(Product, na.rm=T), # average total kg of maize produced
            sdProduct = sd(Product, na.rm=T), # standard deviation of total kg of maize produced
            cvProduct = sdProduct/AvgProduct*100, # coefficient of variation of total kg of maize produced
            AvgValue = mean(Value, na.rm=T), # average total value in $MX of maize produced
            sdValue = sd(Value, na.rm=T), # standard deviation of total value in $MX of maize produced
            cvValue = sdValue/AvgValue*100, # coefficient of variation of total value in $MX of maize produced
            AvgPrice = mean(Price, na.rm=T), # average price per kg in $MX for maize
            sdPrice = sd(Price, na.rm=T), # standard deviation of price per kg in $MX for maize
            cvPrice = sdPrice/AvgPrice*100, # coefficient of variation of price per kg in $MX for maize
            n = n(),# number of time series cases by state-municipality and agriculture type
            AvgArea = mean(AvgArea_Total, na.rm=T),
            sdArea = mean(sdArea_Total, na.rm=T),
            cvArea = mean(cvArea_Total, na.rm=T),
            AvgArea_Maize = mean(AvgArea_Total_Maize, na.rm=T),
            sdArea_Maize = mean(sdArea_Total_Maize, na.rm=T),
            cvArea_Maize = mean(cvArea_Total_Maize, na.rm=T),
            AvgArea_Fodder = mean(AvgArea_Total_Fodder, na.rm=T),
            AvgArea_OtherCrops = mean(AvgArea_Total_OtherCrops, na.rm=T),
            AvgPctArea_Maize_Crops = mean(AvgPctArea_Maize_Crops_Total, na.rm=T),
            sdPctArea_Maize_Crops = mean(sdPctArea_Maize_Crops_Total, na.rm=T),
            cvPctArea_Maize_Crops = mean(cvPctArea_Maize_Crops_Total, na.rm=T),
            AvgPctArea_Maize = mean(AvgPctArea_Maize_Total, na.rm=T),
            sdPctArea_Maize = mean(sdPctArea_Maize_Total, na.rm=T),
            cvPctArea_Maize = mean(cvPctArea_Maize_Total, na.rm=T)) %>% 
  ungroup() %>% 
  bind_rows(x) %>% 
  pivot_longer(-c(Estado_ID, Estado, ddr_ID, ddr, Cader_ID, Cader, Municipio_ID, Municipio, EstadoMunicipio, AGType), names_to = "Variable", values_to = "Value") %>% 
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp",
    AGType == "Total" ~ "Total")) %>% 
  pivot_wider(names_from = c(Variable, AGType), names_glue = "{Variable}_{AGType}", values_from = Value, values_fill = NA) %>% 
  #rowwise() %>% 
  mutate(
    # Calculate the ratios of irrigated and temporal variables to their state-municipality averages
    ITr_AvgYield = ifelse((AvgYield_Irrig/AvgYield_Total) == 1, NA, AvgYield_Irrig/AvgYield_Total),
    ITr_sdYield = ifelse((sdYield_Irrig/sdYield_Total) == 1, NA, sdYield_Irrig/sdYield_Total),
    ITr_minYield = ifelse((minYield_Irrig/minYield_Total) == 1, NA, minYield_Irrig/minYield_Total),
    ITr_maxYield = ifelse((maxYield_Irrig/maxYield_Total) == 1, NA, maxYield_Irrig/maxYield_Total),
    ITr_medYield = ifelse((medYield_Irrig/medYield_Total) == 1, NA, medYield_Irrig/medYield_Total),
    ITr_cvYield = ifelse((cvYield_Irrig/cvYield_Total) == 1, NA, cvYield_Irrig/cvYield_Total),
    ITr_AvgYieldLoss = ifelse((AvgYieldLoss_Irrig/AvgYieldLoss_Total) == 1, NA, AvgYieldLoss_Irrig/AvgYieldLoss_Total),
    ITr_sdYieldLoss = ifelse((sdYieldLoss_Irrig/sdYieldLoss_Total) == 1, NA, sdYieldLoss_Irrig/sdYieldLoss_Total),
    ITr_minYieldLoss = ifelse((minYieldLoss_Irrig/minYieldLoss_Total) == 1, NA, minYieldLoss_Irrig/minYieldLoss_Total),
    ITr_maxYieldLoss = ifelse((maxYieldLoss_Irrig/maxYieldLoss_Total) == 1, NA, maxYieldLoss_Irrig/maxYieldLoss_Total),
    ITr_medYieldLoss = ifelse((medYieldLoss_Irrig/medYieldLoss_Total) == 1, NA, medYieldLoss_Irrig/medYieldLoss_Total),
    ITr_cvYieldLoss = ifelse((cvYieldLoss_Irrig/cvYieldLoss_Total) == 1, NA, cvYieldLoss_Irrig/cvYieldLoss_Total),
    ITr_AvgPlanted = ifelse((AvgPlanted_Irrig/AvgPlanted_Total) == 1, NA, AvgPlanted_Irrig/AvgPlanted_Total),
    ITr_AvgPctYieldLoss = ifelse((AvgPctYieldLoss_Irrig/AvgPctYieldLoss_Total) == 1, NA, AvgPctYieldLoss_Irrig/AvgPctYieldLoss_Total),
    ITr_sdPctYieldLoss = ifelse((sdPctYieldLoss_Irrig/sdPctYieldLoss_Total) == 1, NA, sdPctYieldLoss_Irrig/sdPctYieldLoss_Total),
    ITr_minPctYieldLoss = ifelse((minPctYieldLoss_Irrig/minPctYieldLoss_Total) == 1, NA, minPctYieldLoss_Irrig/minPctYieldLoss_Total),
    ITr_maxPctYieldLoss = ifelse((maxPctYieldLoss_Irrig/maxPctYieldLoss_Total) == 1, NA, maxPctYieldLoss_Irrig/maxPctYieldLoss_Total),
    ITr_medPctYieldLoss = ifelse((medPctYieldLoss_Irrig/medPctYieldLoss_Total) == 1, NA, medPctYieldLoss_Irrig/medPctYieldLoss_Total),
    ITr_cvPctYieldLoss = ifelse((cvPctYieldLoss_Irrig/cvPctYieldLoss_Total) == 1, NA, cvPctYieldLoss_Irrig/cvPctYieldLoss_Total),
    ITr_AvgPlanted = ifelse((AvgPlanted_Irrig/AvgPlanted_Total) == 1, NA, AvgPlanted_Irrig/AvgPlanted_Total),
    ITr_sdPlanted = ifelse((sdPlanted_Irrig/sdPlanted_Total) == 1, NA, sdPlanted_Irrig/sdPlanted_Total),
    ITr_cvPlanted = ifelse((cvPlanted_Irrig/cvPlanted_Total) == 1, NA, cvPlanted_Irrig/cvPlanted_Total),
    ITr_AvgHarvested = ifelse((AvgHarvested_Irrig/AvgHarvested_Total) == 1, NA, AvgHarvested_Irrig/AvgHarvested_Total),
    ITr_sdHarvested = ifelse((sdHarvested_Irrig/sdHarvested_Total) == 1, NA, sdHarvested_Irrig/sdHarvested_Total),
    ITr_cvHarvested = ifelse((cvHarvested_Irrig/cvHarvested_Total) == 1, NA, cvHarvested_Irrig/cvHarvested_Total),
    ITr_AvgLost = ifelse((AvgLost_Irrig/AvgLost_Total) == 1, NA, AvgLost_Irrig/AvgLost_Total),
    ITr_sdLost = ifelse((sdLost_Irrig/sdLost_Total) == 1, NA, sdLost_Irrig/sdLost_Total),
    ITr_cvLost = ifelse((cvLost_Irrig/cvLost_Total) == 1, NA, cvLost_Irrig/cvLost_Total),
    ITr_AvgProduct = ifelse((AvgProduct_Irrig/AvgProduct_Total) == 1, NA, AvgProduct_Irrig/AvgProduct_Total),
    ITr_sdProduct = ifelse((sdProduct_Irrig/sdProduct_Total) == 1, NA, sdProduct_Irrig/sdProduct_Total),
    ITr_cvProduct = ifelse((cvProduct_Irrig/cvProduct_Total) == 1, NA, cvProduct_Irrig/cvProduct_Total),
    # Calculate the ratio of temporal variables to the state-municipality average
    TTr_AvgYield = ifelse((AvgYield_Temp/AvgYield_Total) == 1, NA, AvgYield_Temp/AvgYield_Total),
    TTr_sdYield = ifelse((sdYield_Temp/sdYield_Total) == 1, NA, sdYield_Temp/sdYield_Total),
    TTr_minYield = ifelse((minYield_Temp/minYield_Total) == 1, NA, minYield_Temp/minYield_Total),
    TTr_maxYield = ifelse((maxYield_Temp/maxYield_Total) == 1, NA, maxYield_Temp/maxYield_Total),
    TTr_medYield = ifelse((medYield_Temp/medYield_Total) == 1, NA, medYield_Temp/medYield_Total),
    TTr_cvYield = ifelse((cvYield_Temp/cvYield_Total) == 1, NA, cvYield_Temp/cvYield_Total),
    TTr_AvgYieldLoss = ifelse((AvgYieldLoss_Temp/AvgYieldLoss_Total) == 1, NA, AvgYieldLoss_Temp/AvgYieldLoss_Total),
    TTr_sdYieldLoss = ifelse((sdYieldLoss_Temp/sdYieldLoss_Total) == 1, NA, sdYieldLoss_Temp/sdYieldLoss_Total),
    TTr_minYieldLoss = ifelse((minYieldLoss_Temp/minYieldLoss_Total) == 1, NA, minYieldLoss_Temp/minYieldLoss_Total),
    TTr_maxYieldLoss = ifelse((maxYieldLoss_Temp/maxYieldLoss_Total) == 1, NA, maxYieldLoss_Temp/maxYieldLoss_Total),
    TTr_medYieldLoss = ifelse((medYieldLoss_Temp/medYieldLoss_Total) == 1, NA, medYieldLoss_Temp/medYieldLoss_Total),
    TTr_cvYieldLoss = ifelse((cvYieldLoss_Temp/cvYieldLoss_Total) == 1, NA, cvYieldLoss_Temp/cvYieldLoss_Total),
    TTr_AvgPctYieldLoss = ifelse((AvgPctYieldLoss_Temp/AvgPctYieldLoss_Total) == 1, NA, AvgPctYieldLoss_Temp/AvgPctYieldLoss_Total),
    TTr_sdPctYieldLoss = ifelse((sdPctYieldLoss_Temp/sdPctYieldLoss_Total) == 1, NA, sdPctYieldLoss_Temp/sdPctYieldLoss_Total),
    TTr_minPctYieldLoss = ifelse((minPctYieldLoss_Temp/minPctYieldLoss_Total) == 1, NA, minPctYieldLoss_Temp/minPctYieldLoss_Total),
    TTr_maxPctYieldLoss = ifelse((maxPctYieldLoss_Temp/maxPctYieldLoss_Total) == 1, NA, maxPctYieldLoss_Temp/maxPctYieldLoss_Total),
    TTr_medPctYieldLoss = ifelse((medPctYieldLoss_Temp/medPctYieldLoss_Total) == 1, NA, medPctYieldLoss_Temp/medPctYieldLoss_Total),
    TTr_cvPctYieldLoss = ifelse((cvPctYieldLoss_Temp/cvPctYieldLoss_Total) == 1, NA, cvPctYieldLoss_Temp/cvPctYieldLoss_Total),
    TTr_AvgPlanted = ifelse((AvgPlanted_Temp/AvgPlanted_Total) == 1, NA, AvgPlanted_Temp/AvgPlanted_Total),
    TTr_sdPlanted = ifelse((sdPlanted_Temp/sdPlanted_Total) == 1, NA, sdPlanted_Temp/sdPlanted_Total),
    TTr_cvPlanted = ifelse((cvPlanted_Temp/cvPlanted_Total) == 1, NA, cvPlanted_Temp/cvPlanted_Total),
    TTr_AvgHarvested = ifelse((AvgHarvested_Temp/AvgHarvested_Total) == 1, NA, AvgHarvested_Temp/AvgHarvested_Total),
    TTr_sdHarvested = ifelse((sdHarvested_Temp/sdHarvested_Total) == 1, NA, sdHarvested_Temp/sdHarvested_Total),
    TTr_cvHarvested = ifelse((cvHarvested_Temp/cvHarvested_Total) == 1, NA, cvHarvested_Temp/cvHarvested_Total),
    TTr_AvgLost = ifelse((AvgLost_Temp/AvgLost_Total) == 1, NA, AvgLost_Temp/AvgLost_Total),
    TTr_sdLost = ifelse((sdLost_Temp/sdLost_Total) == 1, NA, sdLost_Temp/sdLost_Total),
    TTr_cvLost = ifelse((cvLost_Temp/cvLost_Total) == 1, NA, cvLost_Temp/cvLost_Total),
    TTr_AvgProduct = ifelse((AvgProduct_Temp/AvgProduct_Total) == 1, NA, AvgProduct_Temp/AvgProduct_Total),
    TTr_sdProduct = ifelse((sdProduct_Temp/sdProduct_Total) == 1, NA, sdProduct_Temp/sdProduct_Total),
    TTr_cvProduct = ifelse((cvProduct_Temp/cvProduct_Total) == 1, NA, cvProduct_Temp/cvProduct_Total)
  ) %>% ungroup() %>% 
  mutate(
    # irrigated maize % of total maize cultivation
    AvgPctMaizeArea_Irrig = AvgArea_Maize_Irrig / AvgArea_Maize_Total,
    AvgPctMaizeArea_Irrig = ifelse(is.nan(AvgPctMaizeArea_Irrig), 0, AvgPctMaizeArea_Irrig),
    AvgPctMaizeArea_Irrig = ifelse(is.na(AvgPctMaizeArea_Irrig), 0, AvgPctMaizeArea_Irrig),
    AvgPctMaizeArea_Irrig = ifelse(AvgPctMaizeArea_Irrig > 1, 1, AvgPctMaizeArea_Irrig),
    # temporal maize % of total maize cultivation 
    AvgPctMaizeArea_Temp = AvgArea_Maize_Temp / AvgArea_Maize_Total,
    AvgPctMaizeArea_Temp = ifelse(is.nan(AvgPctMaizeArea_Temp), 0, AvgPctMaizeArea_Temp),
    AvgPctMaizeArea_Temp = ifelse(is.na(AvgPctMaizeArea_Temp), 0, AvgPctMaizeArea_Temp),
    AvgPctMaizeArea_Temp = ifelse(AvgPctMaizeArea_Temp > 1, 1, AvgPctMaizeArea_Temp),
    # irrigated % of total cultivation 
    AvgPctArea_Irrig = AvgArea_Irrig / AvgArea_Total,#BY MUNICIPIO (both AGTypes have same value!)
    AvgPctArea_Irrig = ifelse(is.nan(AvgPctArea_Irrig), 0, AvgPctArea_Irrig),
    AvgPctArea_Irrig = ifelse(is.na(AvgPctArea_Irrig), 0, AvgPctArea_Irrig),
    AvgPctArea_Irrig = ifelse(AvgPctArea_Irrig > 1, 1, AvgPctArea_Irrig),
    # temporal % of total cultivation 
    AvgPctArea_Temp = AvgArea_Temp / AvgArea_Total,
    AvgPctArea_Temp = ifelse(is.nan(AvgPctArea_Temp), 0, AvgPctArea_Temp),
    AvgPctArea_Temp = ifelse(is.na(AvgPctArea_Temp), 0, AvgPctArea_Temp),
    AvgPctArea_Temp = ifelse(AvgPctArea_Temp > 1, 1, AvgPctArea_Temp))
rm(x)

write.csv(SIAP_2b, paste0(wd$data_p,"SIAP_2_rescale.csv"))

write.csv(SIAP_3_rs, paste0(wd$data_p,"SIAP_3_rescale.csv"))

write.csv(SIAP_4_rs, paste0(wd$data_p,"SIAP_4_rescale.csv"))

write.csv(SIAP_5_rs, paste0(wd$data_p,"SIAP_5_rescale.csv"))

write.csv(SIAP_6_rs, paste0(wd$data_p,"SIAP_6_rescale.csv"))

SIAP_5_remove_cases_rs = SIAP_5_rs %>% 
# remove irrigation maize yield cases for some municipalities that lack irrigation agriculture in the land use data
  filter(!(EstadoMunicipio %in% c("Chigmecatitlan, Puebla", 
                                  "Huitzilac, Morelos", 
                                  "San Jose Teacalco, Tlaxcala", 
                                  "Tlalnepantla, Morelos", 
                                  "Totolapan, Morelos", 
                                  "Acajete, Puebla", 
                                  "Almoloya, Hidalgo", 
                                  "Apan, Hidalgo", 
                                  "Atlatlahucan, Morelos", 
                                  "Emiliano Zapata, Hidalgo", 
                                  "Mazatecochco de Jose Maria Morelos, Tlaxcala", 
                                  "San Francisco Tetlanohcan, Tlaxcala", 
                                  "San Pablo del Monte, Tlaxcala", 
                                  "Tolcayuca, Hidalgo", 
                                  "Amaxac de Guerrero, Tlaxcala", 
                                  "Jaltenco, Mexico") & AGType %in% "Riego")) %>% 
# remove Temporal maize yield cases for  municipalities that lack Temporal agriculture in the land use data
  filter(!(EstadoMunicipio %in% c("Tonanitla, Mexico") & AGType %in% "Temporal"))

LU2000e <- st_read(paste0(wd$data_p, "LU2000e.gpkg")) 

SIAP_LU_poly = LU2000e %>% left_join(SIAP_5_remove_cases_rs, by = c("EstadoMunicipio", "AGType")) %>% select(-ddr_ID, -ddr, -Cader_ID, -Cader, -Municipio_ID.y, -Municipio.y, -Estado_ID.y, -Estado.y, -Area_m2) %>% rename( Municipio = Municipio.x, Estado = Estado.x, Estado_ID = Estado_ID.x, Municipio_ID = Municipio_ID.x, AGType_Area_ha = Area_ha)

Census2000s <- read.csv(paste0(wd$data_p,"CensusData2000s.csv")) %>% select(-Estado_ID, -Municipio_ID, -X)
#Census2000s_poly <- st_read(paste0(wd$data_p, "Census2000s_poly.gpkg")) 

Data2000s_poly_rs = SIAP_LU_poly %>% left_join(Census2000s, by = c("EstadoMunicipio", "Estado", "Municipio"))

Data2000s_poly_rs <- Data2000s_poly_rs %>% mutate(
  LU_Total_DensArable = ifelse(LU_Total_DensArable > 3.5, 3.5, LU_Total_DensArable),
  AG_Workers_DensArable = ifelse(AG_Workers_DensArable > 1, 1, AG_Workers_DensArable),
  #MechanizEquip_DensArable = MechanizEquip / Arable_ha,
  #DraftAnimals_DensArable = DraftAnimals_Total / Arable_ha,
  PrimaryEmploy_DensArable = ifelse(PrimaryEmploy_DensArable > 1.3, 1.3, PrimaryEmploy_DensArable),
  TotalLabor_DensArable = ifelse(TotalLabor_DensArable > 2.5, 2.5, TotalLabor_DensArable),
  Pop_DensArable = ifelse(Pop_DensArable > 100, 100, Pop_DensArable),
  PopRural_DensArable = ifelse(PopRural_DensArable > 7, 7, PopRural_DensArable))

#########################################################################


# Labor and laboresque capital input metrics modified by percent total area planted in maize by AGType &
# Intensive labor and laboresque capital input metrics using SIAP Maize planted area by AGType as denominator

Data2000s_poly_rs <- Data2000s_poly_rs %>% rowwise() %>% mutate(

  # Modify labor and laboresque capital input metrics by the percentage of average total cultivated area planted in maize
  # This is done by agriculture type, so that the value for each row reflects its average % of cultivated area (either irrigated or temporal), rather than the municipal total
  # This assumes that the percent of total labor devoted to maize cultivation is directly proportional to its fraction of total cultivation (i.e. that average labor allocation to a crop is proportional to its proportion of the average cultivated area)
  PctAGPU_Temp = Temporal_PU / Primary_PU,
  PctAGPU_Irrig = Riego_PU / Primary_PU,
  Resid_AvgPctMaizeArea_Temp = AvgPctMaizeArea_Temp - AvgPctArea_Temp,
  Resid_AvgPctMaizeArea_Irrig = AvgPctMaizeArea_Irrig - AvgPctArea_Irrig,
  PctMaizePU_Temp = PctAGPU_Temp + Resid_AvgPctMaizeArea_Temp,
  PctMaizePU_Irrig = PctAGPU_Irrig + Resid_AvgPctMaizeArea_Irrig,
  PU_Maize_Temp = PctMaizePU_Temp * PU_Maize,
  PU_Maize_Irrig = PctMaizePU_Irrig * PU_Maize,
  PctAGPU_Maize_Temp = PU_Maize_Temp / Primary_PU,
  PctAGPU_Maize_Irrig = PU_Maize_Irrig / Primary_PU,
  
  AvgPctArea_ofTotal = AvgArea_Maize / AvgArea_Total,
  AvgPctArea_ofArable = AvgArea_Maize / Arable_ha,
  #AvgPctArea_ofTotal = case_when(
  #  EstadoMunicipio == "High Elevation" ~ 0.4700912,
  #  .default = AvgPctArea_ofTotal),
  #AvgPctArea_ofArable = case_when(
  #  EstadoMunicipio == "High Elevation" ~ 0.2847692,
  #  .default = AvgPctArea_ofArable),
  PopRuralMz = ifelse(AGType == "Temporal", (Pop_Rural * PctAGPU_Maize_Temp), (Pop_Rural * PctAGPU_Maize_Irrig)),
  PrimaryMz = ifelse(AGType == "Temporal", (Primary * PctAGPU_Maize_Temp), (Primary * PctAGPU_Maize_Irrig)),
  AGWorkersMz = ifelse(AGType == "Temporal", (AG_Workers * PctAGPU_Maize_Temp), (AG_Workers * PctAGPU_Maize_Irrig)),
  TotalLaborMz = ifelse(AGType == "Temporal", (TotalLabor * PctAGPU_Maize_Temp), (TotalLabor * PctAGPU_Maize_Irrig)),
  LUTotalMz = ifelse(AGType == "Temporal", (LU_Total * PctAGPU_Maize_Temp), (LU_Total * PctAGPU_Maize_Irrig)), 
  ContractLaboTotMz = ifelse(AGType == "Temporal", (ContractLabor_Tot * PctAGPU_Maize_Temp), (ContractLabor_Tot * PctAGPU_Maize_Irrig)), 
  ContractLaborFullMz = ifelse(AGType == "Temporal", (ContractLabor_More6Mo * PctAGPU_Maize_Temp), (ContractLabor_More6Mo * PctAGPU_Maize_Irrig)), 
  ContractLaboPartMz = ifelse(AGType == "Temporal", (ContractLabor_Less6Mo * PctAGPU_Maize_Temp), (ContractLabor_Less6Mo * PctAGPU_Maize_Irrig)), 
  FamLaborMz = ifelse(AGType == "Temporal", (FamLabor_Tot * PctAGPU_Maize_Temp), (FamLabor_Tot * PctAGPU_Maize_Irrig)), 
  MechanizEquipMz = ifelse(AGType == "Temporal", (MechanizEquip * PctAGPU_Maize_Temp), (MechanizEquip * PctAGPU_Maize_Irrig)), 
  DraftAnimalsMz = ifelse(AGType == "Temporal", (DraftAnimals_Total * PctAGPU_Maize_Temp), (DraftAnimals_Total * PctAGPU_Maize_Irrig)), 
  TractorsMz = ifelse(AGType == "Temporal", (Tractors * PctAGPU_Maize_Temp), (Tractors * PctAGPU_Maize_Irrig)),
  
  # Calculate the intensity of maize labor and laboresque capital input metrics per unit area (hectares)
  # This is done by agriculture type, so that the value for each row reflects its average % of cultivated area (either irrigated or temporal), rather than the municipal total
  # This assumes that the inter-annual average cultivated area for maize (by AGType) is representative
  
  PopRuralMz_perMzHa = PopRuralMz / AvgPctArea_ofTotal,
  #PopRuralMz_perMzHa = ifelse(PopRuralMz_perMzHa > 150, 150, PopRuralMz_perMzHa),
  PrimaryMz_perMzHa = PrimaryMz / AvgPctArea_ofTotal,
  AGWorkersMz_perMzHa = AGWorkersMz / AvgPctArea_ofTotal,
  TotalLaborMz_perMzHa = TotalLaborMz / AvgPctArea_ofTotal,
  LUTotalMz_perMzHa = LUTotalMz / AvgPctArea_ofTotal,
  ContractLaboTotMz_perMzHa = ContractLaboTotMz / AvgPctArea_ofTotal,
  ContractLaborFullMz_perMzHa = ContractLaborFullMz / AvgPctArea_ofTotal,
  ContractLaboPartMz_perMzHa = ContractLaboPartMz / AvgPctArea_ofTotal,
  FamLaborMz_perMzHa = FamLaborMz / AvgPctArea_ofTotal,
  MechanizEquipMz_perMzHa = MechanizEquipMz / AvgPctArea_ofTotal,
  DraftAnimalsMz_perMzHa = DraftAnimalsMz / AvgPctArea_ofTotal,
  TractorsMz_perMzHa = TractorsMz / AvgPctArea_ofTotal) %>% ungroup()

st_write(Data2000s_poly_rs, paste0(wd$data_p, "Data2000s_poly_rescale.gpkg"), driver = "GPKG", overwrite=TRUE, append=FALSE)

rm(SIAP_5_remove_cases_rs, Census2000s, LU2000e, SIAP_LU_poly)

x = SIAP_4_rs %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  group_by(Municipio, Estado, EstadoMunicipio, Year) %>% 
  summarize(AGType = "Total",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T))

SIAP_annual_rs = SIAP_4_rs %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Yield) %>%
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp")) %>% 
  bind_rows(x) %>% group_by(Municipio, Estado, EstadoMunicipio, Year, AGType) %>% 
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "Y_{Year}_{AGType}",
    values_from = Yield)
rm(x)

SIAP_averages_rs = SIAP_6_rs %>% select(-Estado_ID, -ddr, -ddr_ID, -Cader, -Cader_ID, -Municipio_ID)

z = SIAP_4_rs %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Harvested, Product) %>%
  group_by(Municipio, Estado, EstadoMunicipio, Year) %>% 
  summarize(AGType = "Total",
    Yield = sum(Product, na.rm=T) / sum(Harvested, na.rm=T)) %>% 
  ungroup() %>% 
  group_by(EstadoMunicipio) %>%
  mutate(avg = mean(Yield, na.rm=T),
         sd = sd(Yield, na.rm=T)) %>% ungroup() %>% 
  mutate(Zfluct_Yield = (Yield - avg) / sd) %>%
  ungroup() %>% 
  select(-Yield,-avg,-sd)
  
SIAP_ZFluct_long_rs = SIAP_4_rs %>% 
  select(Municipio, Estado, EstadoMunicipio, Year, AGType, Yield) %>%
  group_by(EstadoMunicipio, AGType) %>%
  mutate(Zfluct_Yield = (Yield - mean(Yield, na.rm=T)) / sd(Yield, na.rm=T)) %>%
  ungroup() %>% 
  select(-Yield) %>% 
  bind_rows(z)

rm(z)

SIAP_ZFluct_rs = SIAP_ZFluct_long_rs %>% 
  mutate(AGType = case_when(
    AGType == "Riego" ~ "Irrig",
    AGType == "Temporal" ~ "Temp",
    AGType == "Total" ~ "Total")) %>% 
  pivot_wider(
    names_from = c(Year, AGType),
    names_glue = "YZf_{Year}_{AGType}",
    values_from = Zfluct_Yield)

rm(SIAP_ZFluct_long_rs)

SIAP_yields_rs = SIAP_annual_rs %>% left_join(SIAP_averages_rs, by = c("Municipio", "Estado", "EstadoMunicipio")) 

rm(SIAP_annual_rs, SIAP_averages_rs)

AGC1960 <- read.csv(paste0(wd$data_p,"AGC1960.csv"))
AGC1970 <- read.csv(paste0(wd$data_p,"AGC1970.csv"))
AGC1991 <- read.csv(paste0(wd$data_p,"AGC1991.csv"))
AGC2007 <- read.csv(paste0(wd$data_p,"AGC2007.csv"))
Municipios2000s <- st_read(paste0(wd$data_p, "Municipios2000s_Data.gpkg"))

scale2 <- function(x) (x - mean(x, na.rm = T)) / sd(x, na.rm = T)
  
MunicipioYields_rs <- Municipios2000s %>% 
  left_join(AGC1960, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC1970, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC1991, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(AGC2007, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  left_join(SIAP_yields_rs, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  select(-Area_m2)#-AGType.x, -AGType.y, 

MunicipioYields_Z_rs <- MunicipioYields_rs %>% 
  mutate(across(where(is.numeric), scale2)) %>%
  left_join(SIAP_ZFluct_rs, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  mutate(CoT_1960_SIAP_dif = AvgYield_Total - Y_1960_Total,
         CoT_1960_SIAP_rat = AvgYield_Total / Y_1960_Total)


MunicipioYields_rs <- MunicipioYields_rs %>% 
  left_join(SIAP_ZFluct_rs, by = c("Municipio", "Estado", "EstadoMunicipio")) %>%
  mutate(CoT_1960_SIAP_dif = AvgYield_Total - Y_1960_Total,
         CoT_1960_SIAP_rat = AvgYield_Total / Y_1960_Total)

st_write(MunicipioYields_rs, paste0(wd$data_p, "MunicipioYields_rs.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)
st_write(MunicipioYields_Z_rs, paste0(wd$data_p, "MunicipioYields_Z_rs.gpkg"), driver = "GPKG", overwrite=T, append=FALSE)

rm(SIAP_ZFluct_rs, AGC1960, AGC1970, AGC1991, AGC2007, Municipios2000s, SIAP_yields_rs)

rm(MunicipioYields_rs, MunicipioYields_Z_rs, SIAP_3_rs, SIAP_4_rs, SIAP_5_rs, SIAP_6_rs, Data2000s_poly_rs)



```


## Load Data


```{r}
SIAP_4_rs <- read.csv(paste0(wd$data_p,"SIAP_4_rescale.csv"))
SIAP_5_rs <- read.csv(paste0(wd$data_p,"SIAP_5_rescale.csv"))
SIAP_4 <- read.csv(paste0(wd$data_p,"SIAP_4.csv"))
SIAP_5 <- read.csv(paste0(wd$data_p,"SIAP_5.csv"))
#SIAP_6_rs <- read.csv(paste0(wd$data_r,"SIAP_6_rescale.csv"))
#MunicipioYields_rs <- st_read(paste0(wd$data_p, "MunicipioYields_rs.gpkg"))
MunicipioYields_Z_rs <- st_read(paste0(wd$data_p, "MunicipioYields_Z_rs.gpkg"))



Data2000s_poly_rs <- st_read(paste0(wd$data_p, "Data2000s_poly_rescale.gpkg"))

```


## Histograms


#### Average Yield Histograms 

```{r, label='SIAP Yield Histograms', message=FALSE,warning=FALSE}

h1 = ggplot(SIAP_4,aes(x = Yield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 300, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Actual SIAP Maize Yields (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,12000), breaks=seq(0,12000,2000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))

h2 = ggplot(SIAP_4_rs,aes(x = Yield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 150, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("cyan1", "indianred1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=180 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("cyan2", "firebrick1"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Rescaled SIAP Maize Yields (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,6000), breaks=seq(0,6000,1000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))


h3 = ggplot(SIAP_5,aes(x = AvgYield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 300, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("dodgerblue", "goldenrod"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=360 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("dodgerblue3", "goldenrod4"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Actual SIAP Maize Yields (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,12000), breaks=seq(0,12000,2000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))


h4 = ggplot(SIAP_5_rs,aes(x = AvgYield)) +
  geom_histogram(aes(group = AGType, fill = AGType),alpha = 0.5, position = "identity", binwidth = 150, color = "black") +
  scale_fill_manual(name = "Agriculture Type", values = c("dodgerblue", "goldenrod"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  geom_density(aes(group = AGType, color = AGType, y=180 * ..count..), adjust = 2, size=1, alpha=0.5)+
  scale_color_manual(name = "Agriculture Type",values = c("dodgerblue3", "goldenrod4"), breaks = c("Riego", "Temporal"), labels = c("Irrigation", "Temporal"))+
  labs(x ="Rescaled SIAP Maize Yields (kg / ha)", y = "Count")+
    theme_bw()+
    scale_x_continuous(limits= c(0,6000), breaks=seq(0,6000,1000)) +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1, color="black", size=11), 
          axis.text.y = element_text(color="black", size=11), 
          axis.title.x = element_text(color="black", size=14, face="bold"),
          axis.title.y = element_text(color="black", size=14, face="bold"),
          legend.justification=c(0,1), legend.position=c(0.5,0.85), 
          legend.title=element_blank(),
          legend.box.background = element_rect(colour = "black"),
          legend.text = element_text(colour="black", size = 12),
          legend.background = element_rect(fill="white",size=0.5, linetype="solid", color ="black"))



ggp2 = plot_grid(h1, h2, h3, h4, labels = c('A', 'B', 'C', 'D'), label_size = 24, rows=2, cols=2, label_y = 1.03)


#save figure
ggsave("Hists_RescaledYields_AGType.png", plot = ggp2, device = "png", path = wd$figs, scale = 1, width = 8, height = 7,   units = "in",  dpi = 1500)

YieldIrrig = SIAP_4 %>% filter(AGType == "Riego") %>% pull(Yield) %>% na.omit
YieldTemp = SIAP_4 %>% filter(AGType == "Temporal") %>% pull(Yield) %>% na.omit
YieldIrrig_rs = SIAP_4_rs %>% filter(AGType == "Riego") %>% pull(Yield) %>% na.omit
YieldTemp_rs = SIAP_4_rs %>% filter(AGType == "Temporal") %>% pull(Yield) %>% na.omit
AvgYieldIrrig = SIAP_5 %>% filter(AGType == "Riego") %>% pull(AvgYield) %>% na.omit
AvgYieldTemp = SIAP_5 %>% filter(AGType == "Temporal") %>% pull(AvgYield) %>% na.omit
AvgYieldIrrig_rs = SIAP_5_rs %>% filter(AGType == "Riego") %>% pull(AvgYield) %>% na.omit
AvgYieldTemp_rs = SIAP_5_rs %>% filter(AGType == "Temporal") %>% pull(AvgYield) %>% na.omit


gamma_test(YieldIrrig[YieldIrrig > 0])
gamma_test(YieldTemp[YieldTemp > 0])
gamma_test(YieldIrrig_rs[YieldIrrig_rs > 0])
gamma_test(YieldTemp_rs[YieldTemp_rs > 0])

gamma_test(AvgYieldIrrig[AvgYieldIrrig > 0])
gamma_test(AvgYieldTemp[AvgYieldTemp > 0])
gamma_test(AvgYieldIrrig_rs[AvgYieldIrrig_rs > 0])
gamma_test(AvgYieldTemp_rs[AvgYieldTemp_rs > 0])

rm(ggp2, h1, h2, h3, h4, df, df2, YieldIrrig, YieldTemp, YieldIrrig_rs, YieldTemp_rs, AvgYieldIrrig, AvgYieldTemp, AvgYieldIrrig_rs, AvgYieldTemp_rs)

# import figure for display
knitr::include_graphics(paste0(wd$figs,"Hists_RescaledYields_AGType.png"), FALSE)
```


#### C.V. Yield Histograms



## Tables

descriptive stats for SIAP 4, 5 rescale vs actual data


## Maps



## Remove Unneeded Data

```{r}

rm(SIAP_2b, SIAP_4, SIAP_4_rs, SIAP_5, SIAP_5_rs)

```


# Construct RF Training Dataset


## Environmental Raster Data


### Load Environmental Predictor Data from Previous Scripts

```{r, label='Import Data', message=FALSE,warning=FALSE}

Topo <- rast(paste0(wd$data_p, "Topo_r_resampled.tif"))

Soil <- rast(paste0(wd$data_p, "Soil_r_resampled.tif"))

Clim <- rast(paste0(wd$data_p, "Clim_r_resampled.tif"))

```





### Subset Raster Data

```{r, label='Subset Environmental Data Rasters', message=FALSE,warning=FALSE}

Soil_sub <- subset(Soil, c("BDRICM", "BDTICM", "AWCtS", "AWCtS_2m", "S", "Z", "C", "CF", "SOC", "CEC","OCD", "N", "SOCS"))

Topo_sub <- subset(Topo, c("DEM", "Slope","Accum", "TWI", "STI", "SPI","DistStreams", "DistStreams2", "ElevAboveStreams", "ElevAboveStreams2", "elev_watershed", "FloodOrder_Rel"))
Slope_sqrt <- Topo_sub[[2]]^0.5
names(Slope_sqrt) = "Slope_sqrt"
Topo_sub <- c(Topo_sub, Slope_sqrt)

pr_april = subset(Clim, c("pr_05"))
pr_may = subset(Clim, c("pr_05"))
pr_june = subset(Clim, c("pr_06"))
pr_spring45 = app(subset(Clim, c("pr_04","pr_05")), mean)
pr_spring56 = app(subset(Clim, c("pr_05","pr_06")), mean)
pr_summer78 = app(subset(Clim, c("pr_07","pr_08")), sum)
pr_summer678 = app(subset(Clim, c("pr_06", "pr_07","pr_08")), sum)
pr_fall = app(subset(Clim, c("pr_09", "pr_10")), sum)
pr_sept = subset(Clim, c("pr_09"))
pr_oct = subset(Clim, c("pr_10"))

pet_april = subset(Clim, c("pet_04"))
pet_may = subset(Clim, c("pet_05"))
pet_june = subset(Clim, c("pet_06"))
pet_spring45 = app(subset(Clim, c("pet_04","pet_05")), mean)
pet_spring56 = app(subset(Clim, c("pet_05","pet_06")), mean)
pet_summer78 = app(subset(Clim, c("pet_07","pet_08")), mean)
pet_summer678 = app(subset(Clim, c("pet_06", "pet_07","pet_08")), mean)
pet_fall = app(subset(Clim, c("pet_09","pet_10")), mean)
pet_sept = subset(Clim, c("pet_09"))
pet_oct = subset(Clim, c("pet_10"))

cmi_april = subset(Clim, c("cmi_04"))
cmi_may = subset(Clim, c("cmi_05"))
cmi_spring45 = app(subset(Clim, c("cmi_04","cmi_05")), mean)
cmi_june = subset(Clim, c("cmi_06"))
cmi_spring56 = app(subset(Clim, c("cmi_05","cmi_06")), mean)
cmi_summer78 = app(subset(Clim, c("cmi_07","cmi_08")), mean)
cmi_summer678 = app(subset(Clim, c("cmi_06", "cmi_07","cmi_08")), mean)
cmi_fall = app(subset(Clim, c("cmi_09", "cmi_10")), mean)
cmi_sept = subset(Clim, c("cmi_09"))
cmi_oct = subset(Clim, c("cmi_10"))

clt_may = subset(Clim, c("clt_05"))
clt_june = subset(Clim, c("clt_06"))
clt_spring56 = app(subset(Clim, c("clt_05","clt_06")), mean)
clt_summer678 = app(subset(Clim, c("clt_06", "clt_07","clt_08")), mean)
clt_summer78 = app(subset(Clim, c("clt_07","clt_08")), mean)
clt_fall = app(subset(Clim, c("clt_09", "clt_10")), mean)
clt_sept = subset(Clim, c("clt_09"))
clt_oct = subset(Clim, c("clt_10"))

rsds_may = subset(Clim, c("rsds_05"))
rsds_june = subset(Clim, c("rsds_06"))
rsds_spring = app(subset(Clim, c("rsds_05", "rsds_06")), mean)
rsds_summer78 = app(subset(Clim, c("rsds_07","rsds_08")), mean)
rsds_summer789 = app(subset(Clim, c("rsds_07","rsds_08", "rsds_09")), mean)
rsds_sept = subset(Clim, c("rsds_09"))
rsds_oct = subset(Clim, c("rsds_10"))
rsds_fall = app(subset(Clim, c("rsds_09", "rsds_10")), mean)

Clim_sub <- subset(Clim, c("npp", "swb", "gdd10"))

Clim_sub <- c(Clim_sub, pr_april, pr_may, pr_june, pr_spring45, pr_spring56, pr_summer78, pr_summer678, pr_fall, pr_sept, pr_oct, pet_april, pet_may, pet_june, pet_spring45, pet_spring56, pet_summer78, pet_summer678, pet_fall, pet_sept, pet_oct, cmi_april, cmi_may, cmi_spring45, cmi_june, cmi_spring56, cmi_summer78, cmi_summer678, cmi_fall, cmi_sept, cmi_oct, clt_may, clt_june, clt_spring56, clt_summer678, clt_summer78, clt_fall, clt_sept, clt_oct, rsds_may, rsds_june, rsds_spring, rsds_summer78, rsds_summer789, rsds_sept, rsds_oct, rsds_fall)

names(Clim_sub) <- c("npp", "swb", "gdd10", "pr_april", "pr_may", "pr_june", "pr_spring45", "pr_spring56", "pr_summer78", "pr_summer678", "pr_fall", "pr_sept", "pr_oct", "pet_april", "pet_may", "pet_june", "pet_spring45", "pet_spring56", "pet_summer78", "pet_summer678", "pet_fall", "pet_sept", "pet_oct", "cmi_april", "cmi_may", "cmi_spring45", "cmi_june", "cmi_spring56", "cmi_summer78", "cmi_summer678", "cmi_fall", "cmi_sept", "cmi_oct", "clt_may", "clt_june", "clt_spring56", "clt_summer678", "clt_summer78", "clt_fall", "clt_sept", "clt_oct", "rsds_may", "rsds_june", "rsds_spring", "rsds_summer78", "rsds_summer789", "rsds_sept", "rsds_oct", "rsds_fall")

writeRaster(Clim_sub, filename = paste0(wd$data_p, "Clim_sub_RF.tif"), overwrite=TRUE)

rm(Clim_sub, pr_april, pr_may, pr_june, pr_spring45, pr_spring56, pr_summer78, pr_summe678r, pr_fall, pr_sept, pr_oct, pet_april, pet_may, pet_june, pet_spring45, pet_spring56, pet_summer78, pet_summer678, pet_fall, pet_sept, pet_oct, cmi_april, cmi_may, cmi_spring45, cmi_june, cmi_spring56, cmi_summer78, cmi_summer678, cmi_fall, cmi_sept, cmi_oct, clt_may, clt_june, clt_spring56, clt_summer678, clt_summer78, clt_fall, clt_sept, clt_oct, rsds_may, rsds_june, rsds_spring, rsds_summer78, rsds_summer789, rsds_sept, rsds_oct, rsds_fall, Clim, Soil)

Clim_sub <- rast(paste0(wd$data_p, "Clim_sub_RF.tif"))

Env_sub = c(Topo_sub, Soil_sub, Clim_sub)

writeRaster(Env_sub, filename = paste0(wd$data_p, "Env_sub_RF.tif"), overwrite=TRUE)

Env_sub <- rast(paste0(wd$data_p, "Env_sub_RF.tif"))

#rm(Clim_sub, Topo_sub, Soil_sub)
```


### Extract Raster Values

```{r, label='Extract Raster Values', message=FALSE,warning=FALSE}

env_vals <- exact_extract(x = Env_sub, y = Data2000s_poly_rs, fun = "mean", 
                           max_cells_in_memory = 8e+08, stack_apply=T, 
                           append_cols = c("EstadoMunicipio","Estado", "Municipio", "AGType"))

```


## Agricultural Data



### Select Variables

```{r}
y = env_vals %>% select(-Estado, -Municipio, -EstadoMunicipio, -AGType)

Train_sf = Data2000s_poly_rs %>% select(
  
  EstadoMunicipio, Estado, Municipio, AvgYield, cvYield, AGType, 
  
  PopDens, Pop_Urban, Pop_Rural, 
  PopDensRural, UrbRatio,
  
  Pct_Primary, Pct_AG_Workers, 
  
  Pct_Rest_ha, Pct_Fallow_ha, 
  
  Pct_Tract_Mechaniz_pu, Pct_Tract_Animal_pu, Pct_Tract_Manual_pu, 
  
  Pct_Herbicides_ha, #Pct_FertilChem_ha, Pct_FertilManure_ha, Pct_ImprovSeed_ha, Pct_Insecticides_ha, Pct_ControlledBurn_ha, 
  
  Fertilizer, #Techniques, 
  
  #IrrigPU_EarthenCanals, IrrigPU_CoatedCanals, IrrigPU_CanalsTotal, IrrigPU_Modern, IrrigPU_Other, IrrigPUWater_River, IrrigPUWater_Spring, IrrigPUWater_Dam, IrrigPUWater_Modern, IrrigPUWater_Other,
  
  PopRuralMz_perMzHa,  PrimaryMz_perMzHa,  AGWorkersMz_perMzHa,  TotalLaborMz_perMzHa,  LUTotalMz_perMzHa,
  ContractLaboTotMz_perMzHa,  ContractLaborFullMz_perMzHa,  ContractLaboPartMz_perMzHa,  FamLaborMz_perMzHa,
  MechanizEquipMz_perMzHa,  DraftAnimalsMz_perMzHa,  TractorsMz_perMzHa,
  
   AvgPctArea_ofTotal, AvgPctArea_ofArable, #AvgArea_Maize,AvgPctMaizeArea_Irrig, AvgPctMaizeArea_Temp, AvgPctArea_Irrig, AvgPctArea_Temp,
  
  LU_Total_DensArable, AG_Workers_DensArable, PrimaryEmploy_DensArable, TotalLabor_DensArable, Pop_DensArable, PopRural_DensArable #PctMun_Arable
  #MechanizEquip_DensArable, DraftAnimals_DensArable, PctMun_Settlement, AvgMunSettlementDens
  ) %>% mutate(Pop_Urban = as.numeric(Pop_Urban), Pop_Rural = as.numeric(Pop_Rural))


Train_sf = cbind(Train_sf, y)



rm(y)
```



### Remove Cases

Teotihuacan, Mexico
Otumba, Mexico
Tezoyuca, Mexico
San Martin de las Piramides, Mexico
Acolman, Mexico


```{r}

#Remove Irrigation
E_TLAXCALA = c("Emiliano Zapata, Tlaxcala", "Lazaro Cardenas, Tlaxcala", "Terrenate, Tlaxcala", "Xaloztoc, Tlaxcala", "Tzompantepec, Tlaxcala", "Tocatlan, Tlaxcala", "Huamantla, Tlaxcala", "Altzayanca, Tlaxcala", "Cuapiaxtla, Tlaxcala", "El Carmen Tequexquitla, Tlaxcala", "Zitlaltepec de Trinidad Sanchez Santos, Tlaxcala", "Ixtenco, Tlaxcala", "Nopalucan, Puebla", "Rafael Lara Grajales, Puebla", "Soltepec, Puebla", "Mazapiltepec de Juarez, Puebla","San Jose Chiapa, Puebla")

Remove_Irrigation = c("Chicoloapan, Mexico", "Chimalhuacan, Mexico", "Atenco, Mexico", "Chiconcuac, Mexico", "Ecatepec de Morelos, Mexico", "Coacalco de Berriozabal, Mexico", "Papalotla, Mexico")

#RESCALE Irrigation
S_HIDALGO = c("Mixquiahuala de Juarez, Hidalgo", "Tezontepec de Aldama, Hidalgo", "Tepetitlan, Hidalgo", "Tula de Allende, Hidalgo", "Tepeji del Rio de Ocampo, Hidalgo", "Tlaxcoapan, Hidalgo", "Tlahuelilpan, Hidalgo", "Atitalaquia, Hidalgo", "Atotonilco de Tula, Hidalgo", "Francisco I. Madero, Hidalgo", "Tetepango, Hidalgo", "Ajacuba, Hidalgo", "Tetepango, Hidalgo")

Remove_Temporal = c("Milpa Alta, Distrito Federal", "Tlalpan, Distrito Federal", "Xochimilco, Distrito Federal", "Tlahuac, Distrito Federal", "La Magdalena Contreras, Distrito Federal", "Alvaro Obregon, Distrito Federal", "Cuajimalpa de Morelos, Distrito Federal", "Jilotzingo, Mexico", "Naucalpan de Juarez, Mexico", "Atizapan de Zaragoza, Mexico", "Tlalnepantla de Baz, Mexico", "Coacalco de Berriozabal, Mexico", "Jaltenco, Mexico", "Coyotepec, Mexico", "La Paz, Mexico", "Chimalhuacan, Mexico", "Domingo Arenas, Puebla", "San Felipe Teotlalcingo, Puebla", "Puebla, Puebla") #"Chicoloapan, Mexico", "Ixtapaluca, Mexico"



Train_sf = Train_sf %>% 
  
  #filter(!(EstadoMunicipio %in% c("Ixtapaluca, Mexico", "Axapusco, Mexico") & AGType %in% "Riego")) %>% 
  
  filter(!(EstadoMunicipio %in% S_HIDALGO)) %>% 
  
  filter(!(EstadoMunicipio %in% E_TLAXCALA & AGType %in% "Riego")) %>% 
  
  filter(!(EstadoMunicipio %in% Remove_Irrigation & AGType %in% "Riego")) %>% 
  
  filter(!(EstadoMunicipio %in% Remove_Temporal & AGType %in% "Temporal")) %>% 
  
  ###left_join(y, by = c("EstadoMunicipio", "AGType")) %>% 
  
  mutate(AGType = factor(AGType, levels = c("Temporal", "Riego")))

#Train_df[, c("IrrigPU_EarthenCanals", "IrrigPU_CoatedCanals", "IrrigPU_CanalsTotal", "IrrigPU_Modern", "IrrigPU_Other", "IrrigPUWater_River", "IrrigPUWater_Spring", "IrrigPUWater_Dam", "IrrigPUWater_Modern", "IrrigPUWater_Other")][is.na(Train_df[, c("IrrigPU_EarthenCanals", "IrrigPU_CoatedCanals", "IrrigPU_CanalsTotal", "IrrigPU_Modern", "IrrigPU_Other", "IrrigPUWater_River", "IrrigPUWater_Spring", "IrrigPUWater_Dam", "IrrigPUWater_Modern", "IrrigPUWater_Other")])] <- 0

Train_df_Temp_AvgYield = Train_df %>% filter(AGType == "Temporal") #%>% select(-AGType, -cvYield, -IrrigPU_EarthenCanals, -IrrigPU_CoatedCanals, -IrrigPU_CanalsTotal, -IrrigPU_Modern, -IrrigPU_Other, -IrrigPUWater_River, -IrrigPUWater_Spring, -IrrigPUWater_Dam, -IrrigPUWater_Modern, -IrrigPUWater_Other, -AvgPctArea_Irrig, -AvgPctMaizeArea_Irrig) %>% filter(complete.cases(.))

#Train_df_Irrig_AvgYield = Train_df %>% filter(AGType == "Riego") %>% select(-AGType, -cvYield, -Pct_Rest_ha, -Pct_Fallow_ha, -Pct_ControlledBurn_ha, -AvgPctArea_Temp, -AvgPctMaizeArea_Temp) %>% filter(complete.cases(.))

Train_sf_Both_AvgYield = Train_sf %>% select( -cvYield) #%>% filter(complete.cases(.))-AvgPctArea_Temp,, -AvgPctMaizeArea_Temp

#Train_df_Temp_cvYield = Train_df %>% filter(AGType == "Temporal") %>% select(-AGType, -AvgYield, -IrrigPU_EarthenCanals, -IrrigPU_CoatedCanals, -IrrigPU_CanalsTotal, -IrrigPU_Modern, -IrrigPU_Other, -IrrigPUWater_River, -IrrigPUWater_Spring, -IrrigPUWater_Dam, -IrrigPUWater_Modern, -IrrigPUWater_Other, -AvgPctArea_Irrig, -AvgPctMaizeArea_Irrig) %>% filter(complete.cases(.))

#Train_df_Irrig_cvYield = Train_df %>% filter(AGType == "Riego") %>% select(-AGType, -AvgYield, -Pct_Rest_ha, -Pct_Fallow_ha, -Pct_ControlledBurn_ha, -AvgPctArea_Temp, -AvgPctMaizeArea_Temp) %>% filter(complete.cases(.))

Train_sf_Both_cvYield = Train_sf %>% select(-AvgYield)# %>% filter(complete.cases(.))


Train_df = st_drop_geometry(Train_sf)

```





### Shortcut Import


```{r, label='Shortcut Import', message=FALSE,warning=FALSE}

RF_df_Temp <- read_csv(paste0(wd$data_p,"YieldRFRast_df_Temp.csv.gz")) %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")))

RF_df_Irrig <- read_csv(paste0(wd$data_p,"YieldRFRast_df_Irrig.csv.gz")) %>% 
  mutate(AGType = factor(AGType, levels = c("Temporal", "Irrigation")))

AGRastsRF_Temp <- rast(paste0(wd$data_p, "AGRastsRF_Temp.tif"))

AGRastsRF_Irrig <- rast(paste0(wd$data_p, "AGRastsRF_Irrig.tif"))

```





