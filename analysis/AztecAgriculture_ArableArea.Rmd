---
title: "Aztec Agricultural Productivity Model"
subtitle: "Random Forest Model for Arable Area"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```


# Setup 

All of the data and scripts are downloadable from the [Aztec Agriculture github repository](https://https://github.com/rcesaret/AztecAgriculture), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/Huexotzinco/HuexTlaxAnal2022/HuexTlax2022Analysis/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", "dismo", 
              "purrr", "spatialEco", "whitebox", "classInt","ggnewscale", "lbmech", 
              "data.table", "tidyterra","gridExtra", "cowplot", "scam", "rmarkdown", 
              "spatialreg","spdep", "ggridges", "ggnewscale", "scales", "ggstatsplot",
              "stringi", "fuzzyjoin", "mgcv", "randomForest", "ranger", "kableExtra", 
              "Boruta", "mlbench", "caret", "readr")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R")#"splitByAttributes.R", 
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```


# Arable Area

All you really need to do is modify the CONABIO_2015_LandUse_30m raster for the prehispanic:
Categories are 
"Unknown"
"Wetland", == same as CONABIO???
***"Settlement", == dense archy settlements and a random fraction of less dense settlements proportional to pop/survey/ceramic density
"Water", == saltwater lakes; other lakes; deep lakes
"Glacial" == same as CONABIO


You could decide to use the full "Data2000s_poly.gpkg" that includes higher elevations rather than the "Data2000s_poly_mod_Elevation.gpkg" where some fields were deleted 2900-3100 masl and all above 3100 masl


Tou might also increase the training data sample size from 400,000. It CAN handle more. Perhaps 500,000-600,000


Also possibly include: 
Streams and their order
Dist from streams


## Prepare Data


### Predictor Variables

```{r, label='Arable Area - Prepare Predictor Data', message=FALSE,warning=FALSE}

### DEM and Topographic Data ###

resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
DEM <- rast(paste0(wd$data_r,"DEM.tif"))
DEM <- resample(DEM, resample_30m, method = "bilinear")
writeRaster(DEM,paste0(wd$data_p,"DEM_30m.tif"), overwrite=TRUE)

TRI <- terra::terrain(DEM, v="TRI")# calc Terrain Ruggedness Index
slope <- terra::terrain(DEM, v="slope", unit="degrees")#Slope
writeRaster(slope,paste0(wd$data_p,"temp_rasts/Slope_30m.tif"), overwrite=TRUE)

wbt_breach_depressions(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/DEM_breach_30m.tif"))

wbt_d8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach_30m.tif"), output=paste0(wd$data_p,"temp_rasts/Accum_30m.tif"), out_type = "specific contributing area")

Accum <- rast(paste0(wd$data_p, "temp_rasts/Accum_30m.tif"))
wbt_wetness_index(sca=paste0(wd$data_p,"temp_rasts/Accum_30m.tif"), slope=paste0(wd$data_p,"temp_rasts/Slope_30m.tif"), output=paste0(wd$data_p,"temp_rasts/TWI_30m.tif"), verbose_mode = FALSE)
TWI <- rast(paste0(wd$data_p, "temp_rasts/TWI_30m.tif"))
TWI <- focal(TWI, w=17, fun='max', na.policy="only", na.rm=T)
wbt_stream_power_index(sca=paste0(wd$data_p,"temp_rasts/Accum_30m.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope_30m.tif"),output=paste0(wd$data_p,"temp_rasts/SPI_30m.tif"),exponent = 1)
SPI <- rast(paste0(wd$data_p, "temp_rasts/SPI_30m.tif"))
wbt_fd8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach_30m.tif"), output=paste0(wd$data_p,"temp_rasts/Accum_fd8_30m.tif"), out_type = "specific contributing area")
Accum_fd8 <- rast(paste0(wd$data_p, "temp_rasts/Accum_fd8_30m.tif"))
wbt_sediment_transport_index(sca=paste0(wd$data_p,"temp_rasts/Accum_fd8_30m.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope_30m.tif"),output=paste0(wd$data_p,"temp_rasts/STI_30m.tif"))
STI <- rast(paste0(wd$data_p, "temp_rasts/STI_30m.tif"))

wbt_flood_order(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/flood_order_30m.tif"))
flood_order <- rast(paste0(wd$data_p, "temp_rasts/flood_order_30m.tif"))

#wbt_extract_valleys(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/valleys_lq_30m.tif"))
#valleys_lq <- rast(paste0(wd$data_p, "temp_rasts/valleys_lq_30m.tif"))

#wbt_elev_relative_to_watershed_min_max(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/elev_watershed_30m.tif"))
#elev_watershed <- rast(paste0(wd$data_p, "temp_rasts/elev_watershed_30m.tif"))

#wbt_vertical_excess_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_vert_excess_30m.tif"))
#curv_vert_excess <- rast(paste0(wd$data_p, "temp_rasts/curv_vert_excess_30m.tif"))

#wbt_horizontal_excess_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_horiz_excess_30m.tif"))
#curv_horiz_excess <- rast(paste0(wd$data_p, "temp_rasts/curv_horiz_excess_30m.tif"))

wbt_minimal_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_min_30m.tif"))
curv_min <- rast(paste0(wd$data_p, "temp_rasts/curv_min_30m.tif"))

wbt_maximal_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_max_30m.tif"))
curv_max <- rast(paste0(wd$data_p, "temp_rasts/curv_max_30m.tif"))

wbt_mean_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_mean_30m.tif"))
curv_mean <- rast(paste0(wd$data_p, "temp_rasts/curv_mean_30m.tif"))


Topo_r_30m <- c(DEM, slope, Accum_fd8, TRI, TWI, STI, SPI, flood_order, curv_min, curv_max, curv_mean) #valleys_lq, elev_watershed, curv_vert_excess, curv_horiz_excess,

names(Topo_r_30m) = c("DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "flood_order", "curv_min", "curv_max", "curv_mean") #"valleys_lq", "elev_watershed", "curv_vert_excess", "curv_horiz_excess", 

rm(slope, Accum, Accum_fd8, TRI, TWI, STI, SPI, flood_order, curv_min, curv_max, curv_mean, nam)#valleys_lq, elev_watershed, curv_vert_excess, curv_horiz_excess, 

writeRaster(Topo_r_30m, filename = paste0(wd$data_p, "Topo_r_30m.tif"), overwrite=TRUE)
rm(Topo_r_30m)
#Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))

### Soil Data ###

Soil <- rast(paste0(wd$data_p, "Soil_r_resampled.tif"))

z <- resample(Soil[[1]], DEM, method = "bilinear")

for (i in 2:(nlyr(Soil)-1)) {
  a = resample(Soil[[i]], DEM, method = "bilinear")
  z = c(z,a)
}
WRB <- resample(Soil[[nlyr(Soil)]], DEM, method = "near") #Soil[[13]]
Soil_30m = c(z, WRB)
rm(z,a, Soil, WRB)

writeRaster(Soil_30m, filename = paste0(wd$data_p, "Soil_r_30m.tif"), overwrite=TRUE)
rm(Soil_30m)
#Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))


### Geomorphons ###


Geomorphons <- rast(paste0(wd$data_p,"CMex_30m_Geomorphons.tif"))
Geomorphons <- as.factor(Geomorphons)
levels(Geomorphons) = as.data.frame(levels(Geomorphons)[[1]]) %>% select(-Geomorphons) %>%
  mutate(Geomorphons = case_when(
    ID == 1 ~ "Flat",
    ID == 2 ~ "Summit",
    ID == 3 ~ "Ridge",
    ID == 4 ~ "Shoulder",
    ID == 5 ~ "Spur",
    ID == 6 ~ "Slope",
    ID == 7 ~ "Hollow",
    ID == 8 ~ "Footslope",
    ID == 9 ~ "Valley",
    ID == 10 ~ "Depression"))
#Geomorphons <- resample(Geomorphons, DEM, method = "near")
writeRaster(Geomorphons, filename = paste0(wd$data_p, "CMex_30m_Geomorphons.tif"), overwrite=TRUE)
rm(Geomorphons)
#Geomorphons <- rast(paste0(wd$data_p,"CMex_30m_Geomorphons.tif"))


CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_r,"CONABIO_2015_LandUse_30m.tif"))
CONABIO_2015_LandUse_30m <- as.factor(CONABIO_2015_LandUse_30m)
levels(CONABIO_2015_LandUse_30m) = levels(CONABIO_2015_LandUse_30m)[[1]] %>% select(-CONABIO_2015_LandUse_30m) %>%
  mutate(
    #LandUse = case_when(
            #ID == 1 ~ "Forest_Coniferous_Temperate",
            #ID == 2 ~ "Forest_Coniferous_Subpolar",
            #ID == 3 ~ "Forest_Evergreen_Subtropical",
            #ID == 4 ~ "Forest_Deciduous_Subtropical",
            #ID == 5 ~ "Forest_Deciduous_Temperate",
            #ID == 6 ~ "Forest_Mixed",
            #ID == 7 ~ "Scrub_Subtropical",
            #ID == 8 ~ "Scrub_Temperate",
            #ID == 9 ~ "Grass_Subtropical",
            #ID == 10 ~ "Grass_Temperate",
            #ID == 14 ~ "Wetland",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Bare_Soil",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Water",
            #ID == 19 ~ "Glacial"),
        #LandUseGroups = case_when(
            #ID == 1 ~ "Forest_High",
            #ID == 2 ~ "Forest_High",
            #ID == 3 ~ "Forest_Low",
            #ID == 4 ~ "Forest_Low",
            #ID == 5 ~ "Forest_Low",
            #ID == 6 ~ "Forest_Low",
            #ID == 7 ~ "Scrub",
            #ID == 8 ~ "Scrub",
            #ID == 9 ~ "Grass",
            #ID == 10 ~ "Grass",
            #ID == 14 ~ "Wetland",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Bare_Soil",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Water",
            #ID == 19 ~ "Glacial"),
        #Sampling = case_when(
            #ID == 1 ~ "Inarable_Sample_High",
            #ID == 2 ~ "Inarable_Sample_High",
            #ID == 3 ~ "Inarable_Sample_Med",
            #ID == 4 ~ "Inarable_Sample_Med",
            #ID == 5 ~ "Inarable_Sample_Med",
            #ID == 6 ~ "Inarable_Sample_Med",
            #ID == 7 ~ "Inarable_Sample_High",
            #ID == 8 ~ "Inarable_Sample_High",
            #ID == 9 ~ "Inarable_Sample_High",
            #ID == 10 ~ "Inarable_Sample_High",
            #ID == 14 ~ "Inarable_Sample_Med",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Inarable_Sample_High",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Inarable_All",
            #ID == 19 ~ "Inarable_All"),
        #Sampling2 = case_when(
            #ID == 1 ~ "Sample",
            #ID == 2 ~ "Sample",
            #ID == 3 ~ "Sample",
            #ID == 4 ~ "Sample",
            #ID == 5 ~ "Sample",
            #ID == 6 ~ "Sample",
            #ID == 7 ~ "Sample",
            #ID == 8 ~ "Sample",
            #ID == 9 ~ "Sample",
            #ID == 10 ~ "Sample",
            #ID == 14 ~ "Sample",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Sample",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Inarable",
            #ID == 19 ~ "Inarable"),
        LandUseArchy = case_when(
            ID == 1 ~ "Unknown",
            ID == 2 ~ "Unknown",
            ID == 3 ~ "Unknown",
            ID == 4 ~ "Unknown",
            ID == 5 ~ "Unknown",
            ID == 6 ~ "Unknown",
            ID == 7 ~ "Unknown",
            ID == 8 ~ "Unknown",
            ID == 9 ~ "Unknown",
            ID == 10 ~ "Unknown",
            ID == 14 ~ "Wetland",
            ID == 15 ~ "Unknown",
            ID == 16 ~ "Unknown",
            ID == 17 ~ "Settlement",
            ID == 18 ~ "Water",
            ID == 19 ~ "Glacial"))

activeCat(CONABIO_2015_LandUse_30m) <- "LandUseArchy"

CONABIO_2015_LandUse_30m <- resample(CONABIO_2015_LandUse_30m, DEM, method = "near")
CONABIO_2015_LandUse_30m <- crop(CONABIO_2015_LandUse_30m, DEM)

writeRaster(CONABIO_2015_LandUse_30m, filename = paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"), overwrite=TRUE)
rm(CONABIO_2015_LandUse_30m)
#CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"))

#Clim_r <- rast(paste0(wd$data_p, "Clim_r_resampled.tif"))
#Clim_r_15m <- subset(Clim_r, c("tmin_04","tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10","tmin_11"))
#Clim_r_15m <- resample(Clim_r, DEM, method = "bilinear")


```
r.carve - Generates stream channels.
Takes vector stream data, transforms it to raster and subtracts depth from the output DEM.
r.watershed - Calculates hydrological parameters and RUSLE factors.
r.terraflow - Performs flow computation for massive grids.
r.stream.extract - Performs stream network extraction.
SAGA Valley Depth

--Distance from streams
r.grow.distance

### Dependent Variables

```{r, label='Arable Area - Prepare Dependent Variable Data', message=FALSE,warning=FALSE}
#########################################################

SIAP_2015_Mask <- vect(paste0(wd$data_r,"SIAP_2015_Mask.gpkg"))
SIAP_2015_Mask <- terra::rasterize(SIAP_2015_Mask, DEM, values = 1, background = NA)
writeRaster(SIAP_2015_Mask, filename = paste0(wd$data_p, "SIAP_2015_Mask.tif"), overwrite=TRUE)
rm(SIAP_2015_Mask)
#SIAP_2015_Mask <- rast(paste0(wd$data_p,"SIAP_2015_Mask.tif"))


SIAP_2015_Fields <- vect(paste0(wd$data_r,"SIAP_2015_Fields.gpkg"))
SIAP_2015_Fields <- rasterize(SIAP_2015_Fields, DEM, values = 1, background = 0)
SIAP_2015_Fields <- as.factor(SIAP_2015_Fields)
levels(SIAP_2015_Fields) = levels(SIAP_2015_Fields)[[1]] %>% select(-layer) %>%
  mutate(SIAP_2015_Fields = case_when(
    ID == 0 ~ "Uncultivated",
    ID == 1 ~ "Cultivated"))
writeRaster(SIAP_2015_Fields, filename = paste0(wd$data_p, "SIAP_2015_Fields.tif"), overwrite=TRUE)
rm(SIAP_2015_Fields)
#SIAP_2015_Fields <- rast(paste0(wd$data_p,"SIAP_2015_Fields.tif"))
#SIAP_2015_Fields <- mask(SIAP_2015_Fields, SIAP_2015_Mask)


#########################################################

CMex_Mask <- st_read(paste0(wd$data_r, "Municipios_Sample_Central.gpkg"))
CMex_Mask = vect(CMex_Mask)
CMex_Mask <- terra::rasterize(CMex_Mask, DEM, values = 1, background = NA)
writeRaster(CMex_Mask, filename = paste0(wd$data_p, "CMex_Mask.tif"), overwrite=TRUE)
rm(CMex_Mask)
#CMex_Mask <- rast(paste0(wd$data_p,"CMex_Mask.tif"))

CMex_Mask2 <- st_read(paste0(wd$data_r, "Municipios_Sample_Peripheral.gpkg"))
CMex_Mask2 = vect(CMex_Mask2)
CMex_Mask2 <- terra::rasterize(CMex_Mask2, DEM, values = 1, background = NA)
writeRaster(CMex_Mask2, filename = paste0(wd$data_p, "CMex_Mask2.tif"), overwrite=TRUE)
rm(CMex_Mask2)
#CMex_Mask2 <- rast(paste0(wd$data_p,"CMex_Mask2.tif"))


SIAP_LU_Fields <- st_read(paste0(wd$data_r, "Data2000s_poly_mod_Elevation.gpkg"))
SIAP_LU_Fields <- st_buffer(SIAP_LU_Fields, dist=-60)
#streams <- st_read(paste0(wd$data_r, "CMex_Streams.gpkg"))
#streams <- st_buffer(streams, dist=15)
#SIAP_LU_Fields <- st_difference(SIAP_LU_Fields, streams) 


SIAP_LU_Fields_AGType <- SIAP_LU_Fields %>% select(AGType) %>% 
  mutate(AGType = ifelse(AGType == "Riego", 2, 1))
SIAP_LU_Fields_AGType <- SIAP_LU_Fields_AGType %>% filter(!st_is_empty(.))
irrig <- SIAP_LU_Fields_AGType %>% filter(AGType == 2)
irrig = vect(irrig)
irrig <- terra::rasterize(irrig, DEM, values = 2, background = 0)
irrig <- ifel(irrig > 0, 2, 0)
temp <- SIAP_LU_Fields_AGType %>% filter(AGType == 1)
temp = vect(temp)
temp <- terra::rasterize(temp, DEM, values = 1, background = 0)
SIAP_LU_Fields_AGType <- irrig + temp
SIAP_LU_Fields_AGType <- ifel(SIAP_LU_Fields_AGType == 0, NA, SIAP_LU_Fields_AGType)
SIAP_LU_Fields_AGType <- as.factor(SIAP_LU_Fields_AGType)
levels(SIAP_LU_Fields_AGType) = levels(SIAP_LU_Fields_AGType)[[1]] %>% select(-layer) %>%
  mutate(SIAP_LU_Fields_AGType = case_when(
    ID == 1 ~ "Temporal",
    ID == 2 ~ "Irrigation"))
writeRaster(SIAP_LU_Fields_AGType, filename = paste0(wd$data_p, "SIAP_LU_Fields_AGType.tif"), overwrite=TRUE)
rm(SIAP_LU_Fields_AGType, streams, irrig, temp)
#SIAP_LU_Fields_AGType <- rast(paste0(wd$data_p,"SIAP_LU_Fields_AGType.tif"))
#SIAP_LU_Fields_AGType <- mask(SIAP_LU_Fields_AGType, CMex_Mask)


SIAP_LU_Fields = vect(SIAP_LU_Fields)
SIAP_LU_Fields <- rasterize(SIAP_LU_Fields, DEM, values = 1, background = 0)
SIAP_LU_Fields <- as.factor(SIAP_LU_Fields)
levels(SIAP_LU_Fields) = levels(SIAP_LU_Fields)[[1]] %>% select(-layer) %>%
  mutate(SIAP_LU_Fields = case_when(
    ID == 0 ~ "Uncultivated",
    ID == 1 ~ "Cultivated"))
writeRaster(SIAP_LU_Fields, filename = paste0(wd$data_p, "SIAP_LU_Fields.tif"), overwrite=TRUE)
rm(SIAP_LU_Fields)
#SIAP_LU_Fields <- rast(paste0(wd$data_p,"SIAP_LU_Fields.tif"))
#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)

rm(resample_30m)
```





### Shortcut Import #1

```{r, label='Arable Area - Shortcut Import #1', message=FALSE,warning=FALSE}

DEM <- rast(paste0(wd$data_p, "DEM_30m.tif"))

Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))

Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))

Geomorphons <- rast(paste0(wd$data_p, "CMex_30m_Geomorphons.tif"))

CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"))

#SIAP_2015_Mask <- rast(paste0(wd$data_p,"SIAP_2015_Mask.tif"))

#SIAP_2015_Fields <- rast(paste0(wd$data_p,"SIAP_2015_Fields.tif"))
#SIAP_2015_Fields <- mask(SIAP_2015_Fields, SIAP_2015_Mask)

CMex_Mask <- rast(paste0(wd$data_p,"CMex_Mask.tif"))

SIAP_LU_Fields <- rast(paste0(wd$data_p,"SIAP_LU_Fields.tif"))
SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)

#SIAP_2015_Fields_f <- as.factor(SIAP_2015_Fields)
#levels(SIAP_2015_Fields_f) = levels(SIAP_2015_Fields_f)[[1]] %>% select(-layer) %>%
#  mutate(SIAP_2015_Fields = case_when(
#    ID == 0 ~ "Uncultivated",
#    ID == 1 ~ "Cultivated"))

#SIAP_2015_FieldsNA <- ifel(SIAP_2015_Fields == 0, NA, SIAP_2015_Fields)
#SIAP_LU_FieldsNA <- ifel(SIAP_LU_Fields == 0, NA, SIAP_LU_Fields)

#Inarable_Sampling_Area <- rast(paste0(wd$data_p, "Inarable_Sampling_Area.tif"))
#InarableSample1 <- rast(paste0(wd$data_p, "InarableSample1.tif"))
#InarableSample2 <- rast(paste0(wd$data_p, "InarableSample2.tif"))
#Inarable_Sampling_Area1 <- rast(paste0(wd$data_p, "Inarable_Sampling_Area1.tif"))
#Inarable_Sampling_Area2 <- rast(paste0(wd$data_p, "Inarable_Sampling_Area2.tif"))

#Predictors = c(Topo_r_30m, Soil_30m, Geomorphons, CONABIO_2015_LandUse_30m)
#Predictors_FieldsNA <- mask(Predictors, SIAP_2015_FieldsNA)
#Predictors = mask(Predictors, SIAP_2015_Mask)
```




### Combine Data

```{r, label='Arable Area - Combine Data', message=FALSE,warning=FALSE}
#dat = "SIAP_2015_Fields"
dat = "SIAP_LU_Fields"

if (dat == "SIAP_LU_Fields") {
  Cultiv <- SIAP_LU_Fields
  x = c(Cultiv, CONABIO_2015_LandUse_30m, Geomorphons, Topo_r_30m, Soil_30m)
  #xf <- mask(x, SIAP_LU_FieldsNA)
  x = mask(x, SIAP_LU_Fields)
}
if (dat == "SIAP_2015_Fields") {
  Cultiv <- SIAP_2015_Fields
  x = c(Cultiv, CONABIO_2015_LandUse_30m, Geomorphons, Topo_r_30m, Soil_30m)
  #xf <- mask(x, SIAP_2015_FieldsNA)
  x = mask(x, SIAP_2015_Mask)
}

rm(Topo_r_30m, Soil_30m, CMex_Mask, SIAP_2015_Mask, SIAP_2015_Fields, SIAP_LU_Fields)

writeRaster(x, filename = paste0(wd$data_p, "Arable_Raster_Data.tif"), overwrite=TRUE)
rm(x, dat, Geomorphons, Cultiv, CONABIO_2015_LandUse_30m)

```

##### Shortcut Import #2


```{r, label='Arable Area - Shortcut Import #2', message=FALSE,warning=FALSE}

x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
Cultiv <- x[[1]]
x <- subset(x, c("SIAP_LU_Fields", "LandUseArchy", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "BDRICM", "BDRLOG", "BDTICM", "BD", "SOC", "OCD", "N", "SOCS", "WRB" ))


CONABIO_2015_LandUse_30m <- x[[2]]
Geomorphons <- x[[3]]
#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)
```




### Convert Data from Raster Stack to Dataframe 

```{r, label='Arable Area - Convert Data from Raster Stack to Dataframe ', message=FALSE,warning=FALSE}

x_df <- as.data.frame(x[[1]])
names(x_df) <- "Cultiv"
x_df <- rownames_to_column(x_df, var = "Cells")

for (i in 2:nlyr(x)) {
  
  t = as.data.frame(x[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(x[[i]]))
  x_df <- x_df %>% left_join(t, by="Cells")
  #Train_df <- cbind(Train_df, t[,1])
  #names(Train_df) <- c(names(Train_df)[1:(i-1)], names(Train[[i]]))
}
x_df = x_df[complete.cases(x_df), ]

#write_csv(x_df, paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
#rm(x_df)
#Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))

Arable_RF_df <- x_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         #LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

rm(x_df)

Arable_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data4",
    TRUE ~ "ArableArea_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("ArableArea_RFModel_Data1", "ArableArea_RFModel_Data2", "ArableArea_RFModel_Data3", "ArableArea_RFModel_Data4", "ArableArea_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

```






### Exploratory Data Analysis

#### Descriptive Statistics

```{r, label='Arable Area - EDA Descriptive Statistics', message=FALSE,warning=FALSE}

Cultiv2 <- as.numeric(Cultiv)

#y = c(CONABIO_2015_LandUse_30m, Geomorphons)
fLU = freq(CONABIO_2015_LandUse_30m, usenames=T, zones=Cultiv2, wide=T)
fLU = fLU %>% mutate(zone = case_when(
    zone == 1 ~ "Uncultivated",
    zone == 2 ~ "Cultivated")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Unknown:Water))) %>% ungroup()
column_sums <- as.numeric(colSums(fLU[, -c(1:2)]))
y = as.matrix(fLU[, -c(1, 2)])
d = fLU[, c(1:2)]
fLU_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fLU[, -c(1:2)]))
fLU_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fWRB = freq(x[["WRB"]], usenames=T, zones=Cultiv2, wide=T)
fWRB = fWRB %>% mutate(zone = case_when(
    zone == 1 ~ "Uncultivated",
    zone == 2 ~ "Cultivated")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(NoData:Vertisols))) %>% ungroup()
column_sums <- as.numeric(colSums(fWRB[, -c(1:2)]))
y = as.matrix(fWRB[, -c(1, 2)])
d = fWRB[, c(1:2)]
fWRB_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fWRB[, -c(1:2)]))
fWRB_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fgeo = freq(Geomorphons, usenames=T, zones=Cultiv2, wide=T)
fgeo = fgeo %>% mutate(zone = case_when(
    zone == 1 ~ "Uncultivated",
    zone == 2 ~ "Cultivated")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Flat:Depression))) %>% ungroup()
column_sums <- as.numeric(colSums(fgeo[, -c(1:2)]))
y = as.matrix(fgeo[, -c(1, 2)])
d = fgeo[, c(1:2)]
fgeo_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fgeo[, -c(1:2)]))
fgeo_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

rm(column_sums, row_sums, y, d )

z1 = zonal(x[[4:nlyr(x)]], Cultiv2, fun="mean", na.rm=T)
z1$stat = "Mean"
z2 = zonal(x[[4:nlyr(x)]], Cultiv2, fun="min", na.rm=T)
z2$stat = "Min"
z3 = zonal(x[[4:nlyr(x)]], Cultiv2, fun="max", na.rm=T)
z3$stat = "Max"
z = rbind(z1, z2, z3) %>% mutate(zone = case_when(
    SIAP_LU_Fields == 0 ~ "Uncultivated",
    SIAP_LU_Fields == 1 ~ "Cultivated"))

rm(z1, z2, z3, Cultiv2)
```



#### Histograms

```{r, label='Arable Area - EDA Histograms', message=FALSE,warning=FALSE}

#Hist_DEM <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = DEM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Elevation (masl)", y = "Count") + theme_classic()

#Hist_Slope <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = Slope, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Slope (degrees)", y = "Count") + theme_classic()

#Hist_TRI <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = TRI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Topographic Roughness Index (TRI)", y = "Count") + theme_classic()

#Hist_TWI <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = TWI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Topographic Wetness Index (TWI)", y = "Count") + theme_classic()

#Hist_STI <- 
Arable_RF_df %>% filter(STI <= 100) %>% ggplot() +
geom_histogram(aes(x = STI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Sediment Transport Index (STI)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

#Hist_SPI <- 
Arable_RF_df %>% filter(SPI <= 1200) %>% ggplot() +
geom_histogram(aes(x = SPI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Stream Power Index (SPI)", y = "Count") + theme_classic()

#Hist_BDRICM <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRICM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Depth to bedrock up to 200cm (BDRICM)", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRLOG, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Probability of R horizon (BDRLOG)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BDTICM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Absolute depth to bedrock in cm (BDTICM)", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_min, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Minimum Curvature", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_max, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Maximum Curvature", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_mean, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Mean Curvature", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = SOC, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Soil Organic Carbon", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BD, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Bulk Density", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = OCD, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Organic Carbon Density", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = N, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Nitrogen", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = SOCS, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Soil Organic Carbon Stock", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = S, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Sand", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = Z, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Silt", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = C, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Clay", y = "Count") + theme_classic()

```




 [1] "SIAP_LU_Fields" "LandUse"        "Geomorphons"    "DEM"            "Slope"                "TRI"                  "STI"           
[10]           "curv_min"       "curv_max"       "curv_mean"      "BDRICM"         "BDRLOG"         "BDTICM"         "BD"            
[19]               "SOC"            "CEC"            "OCD"            "N"              "SOCS"           "WRB"   

 "SPI"  "Accum_fd8""TWI"        "flood_order" 
"S"              "Z"              "C"

### Subset Predictors

```{r, label='Arable Area - Subset Predictors', message=FALSE,warning=FALSE}
#x <- subset(x, c("DEM", "Slope","Accum", "TRI", "TWI", "STI", "SPI"))


Arable_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data4",
    TRUE ~ "ArableArea_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("ArableArea_RFModel_Data1", "ArableArea_RFModel_Data2", "ArableArea_RFModel_Data3", "ArableArea_RFModel_Data4", "ArableArea_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )
```



#### Shortcut Import #3


```{r, label='Arable Area - Shortcut Import #3', message=FALSE,warning=FALSE}

x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
Cultiv <- x[[1]]




Arable_RF_df <- Arable_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))


```





### Sampling the Dataframe

```{r, label='Arable Area - Sampling the Dataframe', message=FALSE,warning=FALSE}

#zzz

Arable_RF_df <- Arable_RF_df %>% 
  mutate(Cultiv2 = case_when(
         Cultiv == "Uncultivated" ~ 1,
         Cultiv == "Cultivated" ~ 2),
    #Problem = FALSE,
         #Cultiv_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, FALSE),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Water", TRUE, Problem),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Wetland", TRUE, Problem),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Settlement", TRUE, Problem),
         #Problem_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, Problem),
         
         #Cultiv_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, FALSE),
         Cultiv2 = ifelse(Cultiv == "Cultivated" & LandUseArchy == "Water", 1, Cultiv2),
         Cultiv2 = ifelse(Cultiv == "Cultivated" & LandUseArchy == "Wetland", 1, Cultiv2),
         Cultiv2 = ifelse(Cultiv == "Cultivated" & LandUseArchy == "Settlement", 1, Cultiv2),
         #Cultiv = ifelse(Cultiv == "Cultivated" & DEM >= 3100, "Uncultivated", Cultiv),

         Cultiv = factor(Cultiv2, levels = c(1, 2), labels = c("Uncultivated", "Cultivated"))) %>%
  select(-Cultiv2) %>% 
  mutate(Inarable1_wt = 0,
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & DEM >= 3100, (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUseArchy == "Water", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUseArchy == "Wetland", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUseArchy == "Settlement", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUseArchy == "Glacial", (Inarable1_wt+1), Inarable1_wt),
         Inarable1 = ifelse(Inarable1_wt > 0, TRUE, FALSE),
         
         #Inarable_3100masl = ifelse(Cultiv == "Uncultivated" & DEM >= 3100, TRUE, FALSE),
         #Inarable_water = ifelse(Cultiv == "Uncultivated" & LandUse == "Water", TRUE, FALSE),
         #Inarable_wetland = ifelse(Cultiv == "Uncultivated" & LandUse == "Wetland", TRUE, FALSE),
         #Inarable_settlement = ifelse(Cultiv == "Uncultivated" & LandUse == "Settlement", TRUE, FALSE),
         #Inarable_glacial = ifelse(Cultiv == "Uncultivated" & LandUse == "Glacial", TRUE, FALSE),
         
         Inarable2_wt = 0,
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & DEM >= 2850 & DEM < 3100, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Slope > 15, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Accum_fd8 > xxx, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & STI > 15, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & TRI > 15, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SPI > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & TWI > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & flood_order > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & valleys_lq > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & elev_watershed > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_vert_excess > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_horiz_excess > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_min > 0.0024170212, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_min < -0.002, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_max > 0.0015, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_max < -0.0015, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_mean > 0.001, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_mean < -0.001, (Inarable2_wt+1), Inarable2_wt),
         
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDRLOG > 70, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDRICM < 62.87024, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDTICM <= 3.36, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SOC > 350, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BD < 108, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & OCD > 350, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & N > 300, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SOCS > 80, (Inarable2_wt+1), Inarable2_wt),
         
         
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Summit", (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Depression", (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Valley", (Inarable2_wt+1), Inarable2_wt),
         Inarable2 = ifelse(Inarable2_wt > 0, TRUE, FALSE),
         Inarable2 = ifelse(Inarable1 == T & Inarable2 == T & Inarable2_wt <= Inarable1_wt, F, Inarable2),
         Inarable1 = ifelse(Inarable1 == T & Inarable2 == T & Inarable2_wt > Inarable1_wt, F, Inarable1),
         #|
         Arable = ifelse(Cultiv == "Cultivated", TRUE, FALSE),
         Arable_wt = ifelse(Cultiv == "Cultivated", 1, 0),
         
         wt = Inarable1_wt + Inarable2_wt + Arable_wt,

         Stratum = case_when(
                Arable == TRUE ~ "ArableSample",
                Inarable1 == TRUE ~ "InarableSample1",
                Inarable2 == TRUE ~ "InarableSample2",
                .default = "Unsampled"),
         SampSize = case_when(
                Stratum == "ArableSample" ~ 225000,
                Stratum == "InarableSample1" ~ 50000,
                Stratum == "InarableSample2" ~ 125000,
                .default = 0))

dt = setDT(Arable_RF_df)

a <- dt[Stratum == "ArableSample"][sample(.N, 225000, replace = FALSE)]

i1 <- dt[Stratum == "InarableSample1"][sample(.N, 50000, replace = FALSE, prob = wt)]

i2 <- dt[Stratum == "InarableSample2"][sample(.N, 125000, replace = FALSE, prob = wt)]

dt <- rbindlist(list(a, i1, i2))

rm(i1, i2, a)

Arable_RF_Train_df <- as.data.frame(dt)

rm(dt)

write_csv(Arable_RF_Train_df, paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))
rm(Arable_RF_Train_df)
Arable_RF_Train_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))

tt = Arable_RF_Train_df %>% select(Cells) %>% mutate(TraningSample = TRUE, Cells = as.character(Cells))

Arable_RF_df = Arable_RF_df %>% left_join(tt, by = "Cells") %>%
  mutate(TraningSample = ifelse(is.na(TraningSample), F, TraningSample))

rm(tt)

#Arable_RF_df <- zzz

#rm(zzz)


Arable_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data4",
    TRUE ~ "ArableArea_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("ArableArea_RFModel_Data1", "ArableArea_RFModel_Data2", "ArableArea_RFModel_Data3", "ArableArea_RFModel_Data4", "ArableArea_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )




#a = zzz %>% filter(Stratum == "ArableSample") %>% slice_sample(n = 225000, weight_by = wt, replace = FALSE)

#i1 = zzz %>% filter(Stratum == "InarableSample1") %>% slice_sample(n = 50000, weight_by = wt, replace = FALSE)

#i2 = zzz %>% filter(Stratum == "InarableSample2") %>% slice_sample(n = 125000, weight_by = wt, replace = FALSE)

#Arable_RF_Train_df = rbind(a, i1, i2)
#rm(a, i1, i2)

#Arable_RF_Train_df = Arable_RF_df %>% group_by(Stratum) %>%
  #slice_sample(n = SampSize[1], weight_by = wt, replace = FALSE) #prop, by = NULL, 



#tt = Arable_RF_Train_df %>% select(Cells) %>% mutate(TraningSample = TRUE)

#zzz = zzz %>% left_join(tt, by = "Cells") %>%
#  mutate(TraningSample = ifelse(TraningSample == TRUE, TRUE, FALSE),
#         PredictionData = ifelse(TraningSample == TRUE, FALSE, TRUE))
#Arable_RF_df = Arable_RF_df %>% left_join(tt, by = "Cells") %>%
#  mutate(TraningSample = ifelse(TraningSample == TRUE, TRUE, FALSE),
#         PredictionData = ifelse(TraningSample == TRUE, FALSE, TRUE))
#rm(tt)

#write_csv(Arable_RF_df, paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
#rm(Arable_RF_df)
#Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))

#Arable_RF_Predict_df = zzz %>% filter(PredictionData == T)#Arable_RF_df
  
#write_csv(Arable_RF_Predict_df, paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))
#rm(Arable_RF_Predict_df)
#Arable_RF_Predict_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))

rm(z, fgeo, fgeo_col_pc, fgeo_row_pc, fLU_row_pc, fLU_col_pc, fLU, CONABIO_2015_LandUse_30m, Geomorphons)

```



#### Shortcut Import #4


```{r, label='Arable Area - Shortcut Import #4', message=FALSE,warning=FALSE}

Arable_RF_Train_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))

Arable_RF_Train_df <- Arable_RF_Train_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))


l = 1:5
file_paths <- paste0(wd$data_p, "ArableArea_RFModel_Data", l, ".csv.gz")

Arable_RF_df <- file_paths %>%
  map_dfr(~ read_csv(.x))

Arable_RF_df <- Arable_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))



x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
Cultiv <- x[[1]]
x <- subset(x, c("SIAP_LU_Fields", "LandUseArchy", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "BDRICM", "BDRLOG", "BDTICM", "BD", "SOC", "OCD", "N", "SOCS", "WRB" ))
  
  
  
#x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
#Cultiv <- x[[1]]
#Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
#Arable_RF_Predict_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))
#Arable_RF_Train_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))



#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)
```



## Random Forest Model

### Variable Selection

```{r, label='Arable Area - RF Model Variable Selection', message=FALSE,warning=FALSE}
#boruta = readRDS(paste0(wd$data_p,"ArableArea_RFModel_boruta.rda"))

boruta <- Boruta(Cultiv ~ ., data = Arable_RF_Train_df[,c(2:23)], maxRuns = 100)#, doTrace = 2
print(boruta)
boruta[["finalDecision"]]
plot(boruta, las = 2, cex.axis = 0.7)
#bor <- TentativeRoughFix(boruta)
#bor[["finalDecision"]]
attStats(boruta)
form=getConfirmedFormula(boruta)

# saving the model
saveRDS(boruta, file = paste0(wd$data_p,"ArableArea_RFModel_boruta.rda"))
rm(boruta)
#loading the model
#boruta = readRDS(paste0(wd$data_p,"ArableArea_RFModel_boruta.rda"))
```




### Train the Model

```{r, label='Arable Area - RF Model Training', message=FALSE,warning=FALSE}

#ArableArea_RF_model = readRDS(paste0(wd$data_p,"ArableArea_RFModel_Ranger.rda"))

ArableArea_RF_model <- ranger(formula = form, data = Arable_RF_Train_df)

print(ArableArea_RF_model)


# saving the model
saveRDS(ArableArea_RF_model, file = paste0(wd$data_p,"ArableArea_RFModel_Ranger.rda"))

#loading the model
#ArableArea_RF_model = readRDS(paste0(wd$data_p,"ArableArea_RFModel_Ranger.rda"))
```



### Model Predictions


```{r, label='Arable Area - RF Model Predictions', message=FALSE,warning=FALSE}
parts = c("ArableArea_RFModel_Data1", "ArableArea_RFModel_Data2", "ArableArea_RFModel_Data3", "ArableArea_RFModel_Data4", "ArableArea_RFModel_Data5")

pred_list = list()

i=1
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=2
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=3
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=4
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=5
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)


#for (i in 1:length(parts)) {
#  paste(i)
#  pred_df = Arable_RF_df %>% filter(part == parts[i])
  
#  RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
  
#  pred_df <- pred_df %>% select(Cells)
  
#  pred_df$Predictions <- RFModel_predict$predictions
  
#  pred_list[[i]] <- pred_df
  
#  rm(pred_df, RFModel_predict)
#}


pred_df <- do.call(rbind, pred_list)

rm(pred_list)

Arable_RF_df = Arable_RF_df %>% left_join(pred_df, by = "Cells")

rm(pred_df)


Cultiv <- x[[1]]
ArableArea <- classify(Cultiv, matrix(c(-0.5, 0.5, 1,  0.5, 1.5, 2), ncol=3, byrow=TRUE))
ArableArea <- as.factor(ArableArea)
levels(ArableArea) = levels(ArableArea)[[1]] %>% select(-SIAP_LU_Fields) %>%
  mutate(ArableArea = case_when(
    ID == 1 ~ "Uncultivated",
    ID == 2 ~ "Cultivated"))
names(ArableArea) <- "ArableArea"

ArableArea[Arable_RF_df$Cells] <- Arable_RF_df$Predictions

writeRaster(ArableArea, filename = paste0(wd$data_p, "ArableArea1.tif"), overwrite=TRUE)
rm(Cultiv, ArableArea)
ArableArea1 <- rast(paste0(wd$data_p,"ArableArea1.tif"))



Arable_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data1",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data2",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data3",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data4",
    TRUE ~ "ArableArea_RFModel_Data5"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("ArableArea_RFModel_Data1", "ArableArea_RFModel_Data2", "ArableArea_RFModel_Data3", "ArableArea_RFModel_Data4", "ArableArea_RFModel_Data5"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

rm(Arable_RF_Train_df, Arable_RF_df, ArableArea_RF_model, x, form, i, l, parts)
```




  
### Model Cross-Validation

```{r, label='Arable Area - Peripheral Cases Data Setup', message=FALSE,warning=FALSE}
p.ra <- predict(m.lzn.ra, data=meuse)
str(p.ra)

summary(r.rap <- meuse$logZn - p.ra$predictions)

(rmse.ra <- sqrt(sum(r.rap^2)/length(r.rap)))

plot(meuse$logZn ~ p.ra$predictions, asp=1, pch=20, xlab="fitted", ylab="actual", xlim=c(2,3.3),          ylim=c(2,3.3), main="log10(Zn), Meuse topsoils, Ranger")
grid(); abline(0,1)


summary(m.lzn.ra$predictions)

plot(meuse$logZn ~ m.lzn.ra$predictions, asp=1, pch=20,
     ylab="actual", xlab="OOB X-validation estimates",
    xlim=c(2,3.3), ylim=c(2,3.3),
    main="ranger")
abline(0,1); grid()


```




## Peripheral Cases

### Data Setup

```{r, label='Arable Area - Peripheral Cases Data Setup', message=FALSE,warning=FALSE}

DEM <- rast(paste0(wd$data_p, "DEM_30m.tif"))

Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))

Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))

Geomorphons <- rast(paste0(wd$data_p, "CMex_30m_Geomorphons.tif"))

CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"))

CMex_Mask2 <- rast(paste0(wd$data_p,"CMex_Mask2.tif"))

SIAP_LU_Fields <- rast(paste0(wd$data_p,"SIAP_LU_Fields.tif"))
SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask2)

Cultiv <- SIAP_LU_Fields
  x = c(Cultiv, CONABIO_2015_LandUse_30m, Geomorphons, Topo_r_30m, Soil_30m)
  x = mask(x, SIAP_LU_Fields)
 rm(Topo_r_30m, Soil_30m, CMex_Mask2, SIAP_LU_Fields, CONABIO_2015_LandUse_30m, Geomorphons)
writeRaster(x, filename = paste0(wd$data_p, "Arable_Raster_Data2.tif"), overwrite=TRUE)
rm(x)
x <- rast(paste0(wd$data_p,"Arable_Raster_Data2.tif"))
x <- subset(x, c("SIAP_LU_Fields", "LandUseArchy", "Geomorphons", "DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "curv_min", "curv_max", "curv_mean", "BDRICM", "BDRLOG", "BDTICM", "BD", "SOC", "OCD", "N", "SOCS", "WRB" ))

Arable_RF_df <- as.data.frame(x[[1]])
names(Arable_RF_df) <- "Cultiv"
Arable_RF_df <- rownames_to_column(Arable_RF_df, var = "Cells")

for (i in 2:nlyr(x)) {
  
  t = as.data.frame(x[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(x[[i]]))
  Arable_RF_df <- Arable_RF_df %>% left_join(t, by="Cells")

}
Arable_RF_df = Arable_RF_df[complete.cases(Arable_RF_df), ]

Arable_RF_df <- Arable_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

Arable_RF_df$Cells = as.numeric(Arable_RF_df$Cells)
Arable_RF_df$Inarable1_wt = NA
Arable_RF_df$Inarable1 = NA
Arable_RF_df$Inarable2_wt = NA
Arable_RF_df$Inarable2 = NA
Arable_RF_df$Arable = NA
Arable_RF_df$Arable_wt = NA
Arable_RF_df$wt = NA
Arable_RF_df$Stratum = NA
Arable_RF_df$SampSize = NA
Arable_RF_df$TraningSample = NA

Arable_RF_df <- Arable_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data6",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data7",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data8",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data9",
    TRUE ~ "ArableArea_RFModel_Data10"
  ))
```


### Model Predictions

```{r, label='Arable Area - Peripheral Cases Model Predictions', message=FALSE,warning=FALSE}
ArableArea_RF_model = readRDS(paste0(wd$data_p,"ArableArea_RFModel_Ranger.rda"))

parts = c("ArableArea_RFModel_Data6", "ArableArea_RFModel_Data7", "ArableArea_RFModel_Data8", "ArableArea_RFModel_Data9", "ArableArea_RFModel_Data10")
pred_list <- list()
i=1
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=2
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=3
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=4
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

i=5
pred_df = Arable_RF_df %>% filter(part == parts[i])
RFModel_predict <- predict(ArableArea_RF_model, data=pred_df)
pred_df <- pred_df %>% select(Cells)
pred_df$Predictions <- RFModel_predict$predictions
pred_list[[i]] <- pred_df
rm(pred_df, RFModel_predict)

pred_df <- do.call(rbind, pred_list)

rm(pred_list)

Arable_RF_df = Arable_RF_df %>% left_join(pred_df, by = "Cells")

rm(pred_df)


Cultiv <- x[[1]]
ArableArea2 <- classify(Cultiv, matrix(c(-0.5, 0.5, 1,  0.5, 1.5, 2), ncol=3, byrow=TRUE))
ArableArea2 <- as.factor(ArableArea2)
levels(ArableArea2) = levels(ArableArea2)[[1]] %>% select(-SIAP_LU_Fields) %>%
  mutate(ArableArea = case_when(
    ID == 1 ~ "Uncultivated",
    ID == 2 ~ "Cultivated"))
names(ArableArea2) <- "ArableArea"

ArableArea2[Arable_RF_df$Cells] <- Arable_RF_df$Predictions

writeRaster(ArableArea2, filename = paste0(wd$data_p, "ArableArea2.tif"), overwrite=TRUE)
rm(Cultiv, ArableArea2)
ArableArea2 <- rast(paste0(wd$data_p,"ArableArea2.tif"))

Arable_RF_df <- Arable_RF_df %>%
  mutate(part = case_when(
    row_number() <= ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data6",
    row_number() <= 2 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data7",
    row_number() <= 3 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data8",
    row_number() <= 4 * ceiling(nrow(.) / 5) ~ "ArableArea_RFModel_Data9",
    TRUE ~ "ArableArea_RFModel_Data10"
  )) %>%
  group_split(part) %>%
  purrr::walk2(
    .,
    c("ArableArea_RFModel_Data6", "ArableArea_RFModel_Data7", "ArableArea_RFModel_Data8", "ArableArea_RFModel_Data9", "ArableArea_RFModel_Data10"),
    ~ write_csv(.x, file = paste0(wd$data_p, .y, ".csv.gz"))
  )

```


## Merge and Export Outputs


```{r, label='Arable Area - Merge and Export Outputs', message=FALSE,warning=FALSE}
ArableArea1 <- rast(paste0(wd$data_p,"ArableArea1.tif"))

ArableArea <- merge(ArableArea1, ArableArea2)
writeRaster(ArableArea, filename = paste0(wd$data_p, "ArableArea.tif"), overwrite=TRUE)

DEM_r <- rast(paste0(wd$data_r,"DEM_r.tif"))
ArableArea_100m <- resample(ArableArea, DEM_r, method = "near")
writeRaster(ArableArea_100m, filename = paste0(wd$data_p, "ArableArea_100m.tif"), overwrite=TRUE)
rm(DEM_r,ArableArea_100m)


#rm(Arable_RF_Train_df, Arable_RF_df, RF_pred, Arable_RF_Predict_df, RF_model, boruta, Cultiv)


```






# OLD



#### Import and Rasterize Data

```{r, label='Shortcut', message=FALSE,warning=FALSE}
SIAP_2015_Fields <- vect(paste0(wd$data_r,"SIAP_2015_Fields.gpkg"))
SIAP_2015_Fields <- rasterize(SIAP_2015_Fields, DEM, values = 1, background = 0)
writeRaster(SIAP_2015_Fields, filename = paste0(wd$data_p, "SIAP_2015_Fields.tif"), overwrite=TRUE)

SIAP_2015_Mask <- vect(paste0(wd$data_r,"SIAP_2015_Mask.gpkg"))
SIAP_2015_Mask <- terra::rasterize(SIAP_2015_Mask, DEM, values = 1, background = NA)
writeRaster(SIAP_2015_Mask, filename = paste0(wd$data_p, "SIAP_2015_Mask.tif"), overwrite=TRUE)

SIAP_2015_Fields <- mask(SIAP_2015_Fields, SIAP_2015_Mask)

#rc <- c(-0.5, 0.5, 1,  0.5, 1.5, NA)
#rc <- matrix(c(-0.5, 0.5, 1,  0.5, 1.5, NA), ncol=3, byrow=TRUE)
Inarable_Sampling_Area <- classify(SIAP_2015_Fields, matrix(c(-0.5, 0.5, 1,  0.5, 1.5, NA), ncol=3, byrow=TRUE))
writeRaster(Inarable_Sampling_Area, filename = paste0(wd$data_p, "Inarable_Sampling_Area.tif"), overwrite=TRUE)

rm(SIAP_2015_Fields)

```


#### Absence (Inarable) Sample of Background Points



##### Inarable Sample #1: Totally Inarable

```{r, label='Inarable Sample #1: Totally Inarable', message=FALSE,warning=FALSE}

InarableSample1 = Inarable_Sampling_Area

#Elevation >= 3100 masl
q = DEM * InarableSample1
q = ifel(q >= 3100, 1, 0)
InarableSample1 <- q + InarableSample1

#CONABIO_2015_LandUse_15m == 18 and 19
q = ifel(CONABIO_2015_LandUse_30m == 18 | CONABIO_2015_LandUse_30m == 19, 1, 0)
InarableSample1 <- q + InarableSample1

InarableSample1 <- ifel(InarableSample1 > 1, 1, NA)
Inarable_Sampling_Area1 <- InarableSample1
writeRaster(Inarable_Sampling_Area1, filename = paste0(wd$data_p, "Inarable_Sampling_Area1.tif"), overwrite=TRUE)

#table(values(Sampling_Area1))
s = spatSample(InarableSample1, size = 50000, method="random", replace=FALSE, na.rm=T, exhaustive=T, cells=T) #40000 = 0.0639091

v <- unique(s$cell)
InarableSample1 = ifel(InarableSample1 > 0, 0, NA)
InarableSample1[v] <- 2
InarableSample1 = ifel(InarableSample1 > 1, 2, 0)

writeRaster(InarableSample1, filename = paste0(wd$data_p, "InarableSample1.tif"), overwrite=TRUE)

InarableSample1 <- rast(paste0(wd$data_p, "InarableSample1.tif"))

rm(s, v, q)

```


##### Inarable Sample #2: High Likelihood Inarable

```{r, label='Inarable Sample #2: High Likelihood Inarable', message=FALSE,warning=FALSE}

### Sampling Area2
InarableSample2 <- mosaic(Inarable_Sampling_Area1, Inarable_Sampling_Area, fun=sum)
InarableSample2 = ifel(InarableSample2 > 1, NA, 0)

#Sampled areas from CONABIO_2015_LandUse_15m c(1:14, 16)
q = ifel(CONABIO_2015_LandUse_30m < 15 | CONABIO_2015_LandUse_30m == 16, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled geomorphons == 9,10 with higher accum
q = ifel(Geomorphons == 9 | Geomorphons == 10 | Geomorphons == 2, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled BDRICM < 100
q = ifel(Soil_30m[["BDRICM"]] < 100, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled BDRLOG > 40
q = ifel(Soil_30m[["BDRLOG"]] > 40, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled Elevation > 2850
q = ifel(DEM >= 2850, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled Slopes > 15
q = ifel(Topo_r_30m[["Slope"]] > 15, 1, 0)
InarableSample2 <- q + InarableSample2

#STI >15*********
q = ifel(Topo_r_30m[["STI"]] > 15, 1, 0)
InarableSample2 <- q + InarableSample2

#TRI >15
q = ifel(Topo_r_30m[["TRI"]] > 15, 1, 0)
InarableSample2 <- q + InarableSample2
#Accum>4500
#TWI > 15
#SPI >300-500

t = freq(InarableSample2)
t = t[-c(1),]
t$prob = c(0.004, 0.008, 0.015, 0.03, 0.06, 0.25, 1.0)
t$sample = round((t$prob * t$count),0)
sum(t$sample)

# Create a list to store the individual rasters
r_list <- list()

# Loop through each unique value
for (i in t$value) {
  # Create a binary mask for the current value
  masked_raster <- ifel(InarableSample2 == t$value[i], 1, NA)
  
  s2 = spatSample(x = masked_raster, size = t$n[i], method="random", replace=FALSE, na.rm=T, exhaustive=T, cells=T) #

  # Store the masked raster in the list
  r_list[[as.character(unique_values[i])]] <- s2
}

s2 = do.call(rbind, r_list)

v <- unique(s2$cell)
InarableSample2 <- ifel(Inarable_Sampling_Area > 0, 0, NA)
InarableSample2[v] <- 2
InarableSample2 = ifel(InarableSample2 > 1, 2, 0)

writeRaster(InarableSample2, filename = paste0(wd$data_r, "InarableSample2.tif"), overwrite=TRUE)

rm(s, v, q, s2, t)

```
##### Combining the Inarable Samples

```{r}

InarableSample <- mosaic(inarable1, inarable2, fun=sum)
writeRaster(InarableSample, filename = paste0(wd$data_r, "InarableSample.tif"), overwrite=TRUE)
```


##### Arable Sample

```{r}
Arable <- rasterize(SIAP_2015_Fields, DEM, values = 0, background = NA) #values = 0
table(values(Arable))
sa = spatSample(Arable, size = 233000, method="random", replace=FALSE, na.rm=T, exhaustive=T, cells=T) #225000 == 0.06222285

v <- unique(sa$cell)
ArableSamp = Arable
ArableSamp[v] <- 2
ArableSamp = ifel(ArableSamp > 1, 2, 0)
ArableSample <- mosaic(Arable, ArableSamp, fun=sum)

writeRaster(ArableSample, filename = paste0(wd$data_r, "ArableSample.tif"), overwrite=TRUE)


```



### Training Dataset


```{r}
rm(q, s, s2, sa, Sampling_Area2, Sampling_Area1, r_list, v, mask, masked_raster, cls, rc, t, wts, Soil, inarable1, inarable2, ArableSamp, Arable)

Covariates = c(Topo_r_30m, Soil_30m, Geomorphons, CONABIO_2015_LandUse_30m)

rm(Topo_r_30m, Soil_30m, Geomorphons, CONABIO_2015_LandUse_30m)

Prediction2 <- ifel(InarableSample == 0, 1, NA)
Predict_Supp_ArableUnsampled <- ifel(ArableSample == 0, 1, NA)#ArableSample == 0
InarableSample = ifel(InarableSample > 0, 1, 0)
InarableSample = ifel(is.na(InarableSample), 0, InarableSample)
ArableSample = ifel(is.na(ArableSample), 0, ArableSample)
Response <- mosaic(ArableSample, InarableSample, fun=sum)
Response <- mask(Response, SIAP_2015_Mask)
Prediction <- ifel(Response == 0, 1, NA)
Response <- ifel(Response == 0, NA, Response)

Response <- as.factor(Response)
cls = as.data.frame(levels(Response)[[1]])
cls = cls %>% select(-layer) %>%
  mutate(Response = case_when(
    ID == 1 ~ "Inarable",
    ID == 2 ~ "Arable"))
levels(Response) <- cls

Train = c(Response, Covariates)
Train <- mask(Train, Response)



Predict = c(Prediction, Covariates)
Predict <- mask(Predict, Prediction)

#plot(Train[[2]])
#plot(Predict[[2]])

rm(SIAP_2015_Fields, ArableSample, InarableSample, cls, DEM)



activeCat(Train[[14]]) <- "LandUseGroups"

Train_df <- as.data.frame(Train[[1]])
names(Train_df) <- "Arable"
Train_df <- rownames_to_column(Train_df, var = "Cells")

for (i in 2:nlyr(Train)) {
  
  t = as.data.frame(Train[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(Train[[i]]))
  Train_df <- Train_df %>% left_join(t, by="Cells")
  #Train_df <- cbind(Train_df, t[,1])
  #names(Train_df) <- c(names(Train_df)[1:(i-1)], names(Train[[i]]))
}
Train_df = Train_df[complete.cases(Train_df), ]

```


### Prediction Dataset

```{r}

activeCat(Predict[[14]]) <- "LandUseGroups"

Predict_df <- as.data.frame(Predict[[2]])
names(Predict_df) <- "DEM"
Predict_df <- rownames_to_column(Predict_df, var = "Cells")

for (i in 3:nlyr(Predict)) {
  
  t = as.data.frame(Predict[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(Predict[[i]]))
  Predict_df <- Predict_df %>% left_join(t, by="Cells")

}
Predict_df = Predict_df[complete.cases(Predict_df), ]

```

















# Extras

```{r}

#rc <- c(-101, -98, 1,  0.25, 1.5, NA)
#rc <- matrix(rc, ncol=3, byrow=TRUE)
#Sampling_Area <- classify(SIAP_2015_Fields, rc)
                         
f <- names(train)
  f <- f[f != names(r)]
  form <- paste(names(r), "~", paste(f, collapse = " + "))
  form <- as.formula(form)
  

```


mtry = NULL,

probability = T #Grow a probability forest as in Malley et al. (2012).


regularization.factor = 1,Regularization factor (gain penalization), either a vector of length p or one value
for all variables.

regularization.usedepth = FALSE,Consider the depth in regularization

quantreg = FALSE,Prepare quantile prediction as in quantile regression forests (Meinshausen 2006).
Regression only. Set keep.inbag = TRUE to prepare out-of-bag quantile prediction.

importance = "none",Variable importance mode, one of none, impurity, impurity_corrected, permutation. The impurity measure is the Gini index for classification, the variance of the responses for regression and the sum of test statistics (see splitrule)
for survival.
keep.inbag = FALSE,
inbag = NULL,Save how often observations are in-bag in each tree.

save.memory = FALSE  Use memory saving (but slower) splitting mode. No effect for survival and
GWAS data. Warning: This option slows down the tree growing, use only if you
encounter memory problems.

classification = NULL, Set to TRUE to grow a classification forest. Only needed if the data is a matrix or
the response numeric.

midpoints of all arable polygons;
negative buffer so observations arent on edges



OOB (Out-of-Bag) prediction error, also known as OOB error, is a measure of prediction accuracy for models trained using bootstrap aggregating (bagging) techniques, such as random forests. It is commonly used to estimate the performance of a model without the need for an explicit validation set.

When training a bagging model, each base model (also known as a weak learner) is trained on a random subset of the original data, called a bootstrap sample. The remaining data points, on average around 36.8% of the original data, are not included in the bootstrap sample and are referred to as out-of-bag (OOB) observations.

The OOB prediction error is calculated by evaluating the performance of each base model on the OOB observations. For each data point that was not included in the bootstrap sample for a particular base model, the model's prediction is compared to the true target value. The OOB error is then computed as the average prediction error across all out-of-bag observations.

The OOB error serves as an estimate of the model's performance on unseen data. It can be useful for assessing the generalization capability of the model and comparing different models or tuning parameters within the same algorithm. However, it's important to note that the OOB error might not be as reliable as a dedicated validation set for model evaluation in some cases.

In summary, the OOB prediction error provides an estimate of the model's performance using the observations that were not included in the training process due to the bootstrap sampling. It is a useful tool for evaluating bagging-based models such as random forests.














