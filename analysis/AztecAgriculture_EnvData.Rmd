---
title: "Aztec Agricultural Productivity Model"
subtitle: "Part 1: Environmental Data"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```

This R markdown document prepares the data used in the Aztec agricultural productivity random forest model, which is undertaken in Part 2 (the subsequent R markdown script). This involves the following:

  1. Load, reorganize and integrate the modern agricultural analogue dataset, which includes:
      + Contemporary municipio polygons from INEGI
      + 2010 municipal population census statistics
      + 2007 municipal agricultural census statistics
      + FASII and INEGI geospatial land use polygons from the 2000s and 2010s
      + SIAP 2003-2021 crop yield data
      + 
  2. Load, Resample and Calculate topographic variable rasters, which include:
      + 
      + 
      + 
      + 
      + 
      + 
      + 
      + 
      + 
  3. Load, resample and RF impute ISRIC SoilGrids250 rasters, which include:
      + 
      + 
      + 
      + 
      + 
  4. Load and resample CHELSA monthly climate variable rasters, which include:
      + 
      + 
      + 
  
  Topographic/environmental metrics
  
Function to Interpolate Missing Soil Raster Values Using Random Forest Model

Function for RF soil raster imputation of missing values

Resample raster data to 100m x 100m

CRS = WGS84 UTM Zone 14N (EPSG: 32614)


# Setup 

All of the data and scripts are downloadable from the [Aztec Agriculture github repository](https://https://github.com/rcesaret/AztecAgriculture), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/Huexotzinco/HuexTlaxAnal2022/HuexTlax2022Analysis/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", "dismo", 
              "purrr", "spatialEco", "whitebox", "classInt","ggnewscale", "lbmech", 
              "data.table", "tidyterra","gridExtra", "cowplot", "scam", "rmarkdown", 
              "spatialreg","spdep", "ggridges", "ggnewscale", "scales", "ggstatsplot",
              "stringi", "fuzzyjoin", "mgcv", "randomForest", "ranger", "kableExtra", 
              "Boruta", "mlbench", "caret", "readr", "ClimDatDownloadR", 
              "geoknife", "rnoaa", "ncdf4")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R", "pdsi.R", "C_pdsi.R")#"splitByAttributes.R", 
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```









# Topographic Variables




```{r, label='Load, Resample and Calculate Topographic Variable Rasters', message=FALSE,warning=FALSE}


resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
resample_100m <- disagg(resample_30m, 3)
resample_100m <- aggregate(resample_100m, 10)

## Import INEGI lidar-derived 15-meter DEM
## Continuo de Elevaciones Mexicanas 3.0 (2012)
## https://www.inegi.org.mx/app/geo2/elevacionesmex/#:~:text=El%20Continuo%20de%20Elevaciones%20Mexicano,le%20integran%20valores%20que%20representan


DEM <- rast(paste0(wd$data_r,"DEM_CEM_v3.0_15m_CMex.tif"))

DEM[DEM == 0 | is.nan(DEM)] <- NA

## SMOOTH RASTER
DEM <- focal(DEM, w=5, fun='mean', na.policy="only", na.rm=T)
DEM <- focal(DEM, w=5, fun='mean', na.policy="only", na.rm=T)
DEM <- focal(DEM, w=5, fun='mean', na.policy="only", na.rm=T)

DEM <- focal(DEM, w=5, fun='mean', na.rm=T)
DEM <- focal(DEM, w=7, fun='mean', na.rm=T)
DEM <- focal(DEM, w=9, fun='mean', na.rm=T)
DEM <- focal(DEM, w=11, fun='mean', na.rm=T)
DEM <- focal(DEM, w=13, fun='mean', na.rm=T)

writeRaster(DEM,paste0(wd$data_r,"DEM.tif"), overwrite=TRUE)
#DEM <- rast(paste0(wd$data_r,"DEM.tif"))

DEM_r <- resample(DEM, resample_100m, method = "bilinear")
writeRaster(DEM_r,paste0(wd$data_r,"DEM_r.tif"), overwrite=TRUE)

rm(DEM)

#create temp directory for rasters we will delete later
# we will stack and save these together at the end of this chunk

##### dir.create(paste0(wd$data_p,"temp_rasts"))

######### TRI ######### 

TRI <- terra::terrain(DEM_r, v="TRI")# calc Terrain Ruggedness Index
#TRI_r <- resample(TRI, resample_100m, method = "bilinear")


slope <- terra::terrain(DEM_r, v="slope", unit="degrees")#Slope
#slope_r <- resample(slope, resample_100m, method = "bilinear")
writeRaster(slope,paste0(wd$data_p,"temp_rasts/Slope.tif"), overwrite=TRUE)

######### TWI ######### 

wbt_breach_depressions(dem = paste0(wd$data_r,"DEM_r.tif"), output = paste0(wd$data_p,"temp_rasts/DEM_breach.tif"))
#DEM_breach <- rast(paste0(wd$data_p, "temp_rasts/DEM_breach.tif"))
#DEM_breach <- rast(paste0(wd$data_r,"DEM_breach.tif"))
#writeRaster(DEM_breach,paste0(wd$data_p,"temp_rasts/DEM_breach.tif"), overwrite=TRUE)
#writeRaster(DEM_breach,paste0(wd$data_r,"DEM_breach.tif"), overwrite=TRUE)


wbt_d8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach.tif"), output=paste0(wd$data_p,"temp_rasts/Accum.tif"), out_type = "specific contributing area")
Accum <- rast(paste0(wd$data_p, "temp_rasts/Accum.tif"))
#Accum <- rast(paste0(wd$data_r, "Accum.tif"))
#Accum[is.nan(Accum)] <- NA
#Accum_r <- resample(Accum, resample_100m, method = "bilinear")
#writeRaster(Accum,paste0(wd$data_p,"temp_rasts/Accum.tif"), overwrite=TRUE)
#writeRaster(Accum,paste0(wd$data_r,"Accum.tif"), overwrite=TRUE)

wbt_wetness_index(sca=paste0(wd$data_p,"temp_rasts/Accum.tif"), slope=paste0(wd$data_p,"temp_rasts/Slope.tif"), output=paste0(wd$data_p,"temp_rasts/TWI.tif"), verbose_mode = FALSE)
TWI <- rast(paste0(wd$data_p, "temp_rasts/TWI.tif"))
TWI <- focal(TWI, w=17, fun='max', na.policy="only", na.rm=T)
#TWI <- rast(paste0(wd$data_r, "TWI.tif"))
#TWI_r <- resample(TWI, resample_100m, method = "bilinear")
writeRaster(TWI,paste0(wd$data_p,"temp_rasts/TWI.tif"), overwrite=TRUE)
#writeRaster(TWI,paste0(wd$data_r,"TWI.tif"), overwrite=TRUE)


######### SPI ######### 

wbt_stream_power_index(sca=paste0(wd$data_p,"temp_rasts/Accum.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope.tif"),output=paste0(wd$data_p,"temp_rasts/SPI.tif"),exponent = 1)
SPI <- rast(paste0(wd$data_p, "temp_rasts/SPI.tif"))
#SPI <- rast(paste0(wd$data_r, "SPI.tif"))
#SPI_r <- resample(SPI, resample_100m, method = "bilinear")
#writeRaster(SPI,paste0(wd$data_p,"temp_rasts/SPI.tif"), overwrite=TRUE)
#writeRaster(SPI,paste0(wd$data_r,"SPI.tif"), overwrite=TRUE)

######### STI ######### 

wbt_fd8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach.tif"), output=paste0(wd$data_p,"temp_rasts/Accum_fd8.tif"), out_type = "specific contributing area")
Accum_fd8 <- rast(paste0(wd$data_p, "temp_rasts/Accum_fd8.tif"))
#Accum_fd8 <- rast(paste0(wd$data_r, "Accum_fd8.tif"))
#writeRaster(Accum_fd8,paste0(wd$data_p,"temp_rasts/Accum_fd8.tif"), overwrite=TRUE)
#writeRaster(Accum_fd8,paste0(wd$data_r,"Accum_fd8.tif"), overwrite=TRUE)

wbt_sediment_transport_index(sca=paste0(wd$data_p,"temp_rasts/Accum_fd8.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope.tif"),output=paste0(wd$data_p,"temp_rasts/STI.tif"))
STI <- rast(paste0(wd$data_p, "temp_rasts/STI.tif"))
#STI <- rast(paste0(wd$data_r, "STI.tif"))
#STI_r <- resample(STI, resample_100m, method = "bilinear")
#writeRaster(STI,paste0(wd$data_p,"temp_rasts/STI.tif"), overwrite=TRUE)
#writeRaster(STI,paste0(wd$data_r,"STI.tif"), overwrite=TRUE)



TopoEnvData <- (c(DEM_r, slope, Accum, Accum_fd8, TRI, TWI, STI, SPI))

rm(DEM_r, slope, Accum, Accum_fd8, TRI, TWI, STI, SPI)

nam = c("DEM", "Slope", "Accum", "Accum_fd8", "TRI", "TWI", "STI", "SPI")

names(TopoEnvData) = nam

writeRaster(TopoEnvData, filename = paste0(wd$data_p, "TopoEnvData.tif"), overwrite=TRUE)

TopoEnv_r <- rast(paste0(wd$data_r, "TopoEnvData.tif"))

rm(TopoEnvData)
```




# Soil Data

ISRIC  SoilGrids250

https://www.isric.org/explore/soilgrids

```{r, label='Soil Depth huge downloads cropping', eval = FALSE}

# # SCRIPT FOR SAVING MULTI-GIGABYTE SOILGRID DOWNLOADS 
# # TO HUEXTLAXANAL2022 DATA-RAW/SOILGRIDS FOLDER

BDRICM <- raster("C:/Users/rcesaret/Downloads/BDRICM_M_250m_ll.tif")
X <- projectRaster(WRB, crs = "+proj=longlat +datum=WGS84 +no_defs")
r2 = raster(extent(X), resolution = c(0.00208, 0.00208), crs = crs(X))
BDRICM <- crop(BDRICM, r2)
BDRICM <- projectRaster(BDRICM, crs = prj)
BDRICM <- resample(BDRICM, BD, method = "bilinear")
writeRaster(BDRICM,paste0(wd$data_r,"SoilGrids/BDRICM.tif"), overwrite=TRUE)


BDRLOG <- raster("C:/Users/rcesaret/Downloads/BDRLOG_M_250m_ll.tif")
X <- projectRaster(WRB, crs = "+proj=longlat +datum=WGS84 +no_defs")
r2 = raster(extent(X), resolution = c(0.00208, 0.00208), crs = crs(X))
BDRLOG <- crop(BDRLOG, r2)
BDRLOG <- projectRaster(BDRLOG, crs = prj)
BDRLOG <- resample(BDRLOG, BD, method = "bilinear")
writeRaster(BDRLOG,paste0(wd$data_r,"SoilGrids/BDRLOG.tif"), overwrite=TRUE)


BDTICM <- raster("C:/Users/rcesaret/Downloads/BDTICM_M_250m_ll.tif")
X <- projectRaster(WRB, crs = "+proj=longlat +datum=WGS84 +no_defs")
r2 = raster(extent(X), resolution = c(0.00208, 0.00208), crs = crs(X))
BDTICM <- crop(BDTICM, r2)
BDTICM <- projectRaster(BDTICM, crs = prj)
BDTICM <- resample(BDTICM, BD, method = "bilinear")
writeRaster(BDTICM,paste0(wd$data_r,"SoilGrids/BDTICM.tif"), overwrite=TRUE)

```



```{r SoilGrids250Vars, echo = FALSE, warning = FALSE, message = FALSE, results = 'asis', fig.pos='!h'}
library(kableExtra)

Variable <- c("BDRICM", "BDRLOG", "BDTICM", "BD", "S", "Z", "C", "SOC", "CEC", "OCD", "N", "SOCS", "WRB")
Description <- c("Depth to bedrock (R horizon) up to 200 cm", "Probability of occurrence of R horizon", "Absolute depth to bedrock", "Bulk density (fine earth fraction)", "Weight percentage of the sand particles (0.05–2 mm)", "Weight percentage of the silt particles (0.0002–0.05 mm)", "Weight percentage of the clay particles (<0.0002 mm)", "Soil organic carbon content", "Cation exchange capacity at ph 7", "Soil organic carbon density", "Nitrogen content", "Soil organic carbon stock", "World Reference Base (2006) Soil Groups")
Units <- c("cm", "percentage", "cm", "kg/m^3", "percentage", "percentage", "percentage", "permille", "	cmolc/kg", "kg/m^3", "cg/kg", "ton/ha", "type (factor)")

data.frame(Variable, Description, Units) %>% 
    kbl(format = 'html',
        escape = FALSE,
        caption = "SoilGrids250 Rasters / Variables") %>% 
    kable_styling(font_size = 22) %>%
    gsub("font-size: initial !important;", 
         "font-size: 22pt !important;", 
         .)

rm(Variable, Description, Units)
```



```{r, label='Load, resample and RF impute Soil Rasters', message=FALSE, warning=FALSE}
###############################################
#resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
#resample_100m <- disagg(resample_30m, 3)
#resample_100m <- aggregate(resample_100m, 10)
#TopoEnv_r <- rast(paste0(wd$data_r, "TopoEnvData.tif"))
###############################################

# Covariates for input into RF_ImputeRast function
DEM_r <- TopoEnv_r[[1]]
Slope <- TopoEnv_r[[2]]

#Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))

# Create Municipios Mask Raster for input into RF_ImputeRast function
Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))
resample_100m_b = resample_100m
values(resample_100m_b) <- 1
m <- mask(resample_100m_b, Municipios2000s)
rm(resample_100m_b,Municipios2000s)

# Depths for each of the first three SoilGrids250 levels 
# for taking the weighted average for 0-30cm
DepthWeights = c(5,10,15) 


# Depth to bedrock (R horizon) up to 200 cm
BDRICM <- rast(paste0(wd$data_r, "SoilGrids/BDRICM.tif"))
BDRICM[BDRICM == 0] <- NA
BDRICM <- focal(BDRICM, w=5, fun='max', na.policy="only", na.rm=T)
BDRICM <- focal(BDRICM, w=5, fun='max', na.policy="only", na.rm=T)
BDRICM <- resample(BDRICM, resample_100m, method = "bilinear")
names(BDRICM) <- "BDRICM"
BDRICMi <- RF_ImputeRast(r = BDRICM, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BDRICM <- BDRICMi[[1]]
rm(BDRICMi)

#	Probability of occurrence of R horizon	percentage
BDRLOG <- rast(paste0(wd$data_r, "SoilGrids/BDRLOG.tif"))
BDRLOG[BDRLOG == 0] <- NA
BDRLOG <- focal(BDRLOG, w=5, fun='min', na.policy="only", na.rm=T)
BDRLOG <- focal(BDRLOG, w=5, fun='min', na.policy="only", na.rm=T)
BDRLOG <- resample(BDRLOG, resample_100m, method = "bilinear")
names(BDRLOG) <- "BDRLOG"
BDRLOGi <- RF_ImputeRast(r = BDRLOG, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BDRLOG <- BDRLOGi[[1]]
rm(BDRLOGi)



# Absolute depth to bedrock	cm
BDTICM <- rast(paste0(wd$data_r, "SoilGrids/BDTICM.tif"))
BDTICM[BDTICM == 0] <- NA
BDTICM <- focal(BDTICM, w=5, fun='max', na.policy="only", na.rm=T)
BDTICM <- focal(BDTICM, w=5, fun='max', na.policy="only", na.rm=T)
BDTICM <- resample(BDTICM, resample_100m, method = "bilinear")
names(BDTICM) <- "BDTICM"
BDTICMi <- RF_ImputeRast(r = BDTICM, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BDTICM <- BDTICMi[[1]]
rm(BDTICMi)

# World Reference Base (2006) Soil Groups
WRB <- rast(paste0(wd$data_r, "SoilGrids/WRB.tif"))
WRB <- as.factor(WRB)
cls = levels(WRB)[[1]] %>% select(-WRB) %>%
  mutate(WRB = case_when(
    ID == 0 ~ "NoData",
    ID == 3 ~ "Andosols",
    ID == 4 ~ "Arenosols",
    ID == 5 ~ "Calcisols",
    ID == 6 ~ "Cambisols",
    ID == 9 ~ "Durisols",
    ID == 11 ~ "Fluvisols",
    ID == 12 ~ "Gleysols",
    ID == 16 ~ "Leptosols",
    ID == 18 ~ "Luvisols",
    ID == 20 ~ "Phaeozems",
    ID == 24 ~ "Regosols",
    ID == 25 ~ "Solonchaks",
    ID == 26 ~ "Solonetz",
    ID == 28 ~ "Umbrisols",
    ID == 29 ~ "Vertisols"))
names(WRB) <- "WRB"
levels(WRB) <- cls
WRB <- resample(WRB, resample_100m, method = "near")

# Bulk Density
BD_0_5 <- raster(paste0(wd$data_r, "SoilGrids/BD_0_5.tif"))
BD_0_5[BD_0_5 == 0] <- NA
BD_5_15 <- raster(paste0(wd$data_r, "SoilGrids/BD_5_15.tif"))
BD_5_15[BD_5_15 == 0] <- NA
BD_15_30 <- raster(paste0(wd$data_r, "SoilGrids/BD_15_30.tif"))
BD_15_30[BD_15_30 == 0] <- NA
BD = stack(BD_0_5, BD_5_15, BD_15_30)
BD = weighted.mean(BD, DepthWeights, na.rm=T)
BD <- resample(rast(BD), resample_100m, method = "bilinear")
rm(BD_0_5, BD_5_15, BD_15_30)
names(BD) <- "BD"
BDi <- RF_ImputeRast(r = BD, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BD <- BDi[[1]]
rm(BDi)

# Clay fraction
C_0_5 <- raster(paste0(wd$data_r, "SoilGrids/C_0_5.tif"))
C_0_5[C_0_5 == 0] <- NA
C_5_15 <- raster(paste0(wd$data_r, "SoilGrids/C_5_15.tif"))
C_5_15[C_5_15 == 0] <- NA
C_15_30 <- raster(paste0(wd$data_r, "SoilGrids/C_15_30.tif"))
C_15_30[C_15_30 == 0] <- NA
C = stack(C_0_5, C_5_15, C_15_30)
C = weighted.mean(C, DepthWeights, na.rm=T)
C <- resample(rast(C), resample_100m, method = "bilinear")
rm(C_0_5, C_5_15, C_15_30)
names(C) <- "C"
Ci <- RF_ImputeRast(r = C, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
C <- Ci[[1]]
rm(Ci)

# Silt fraction
Z_0_5 <- raster(paste0(wd$data_r, "SoilGrids/Z_0_5.tif"))
Z_0_5[Z_0_5 == 0] <- NA
Z_5_15 <- raster(paste0(wd$data_r, "SoilGrids/Z_5_15.tif"))
Z_5_15[Z_5_15 == 0] <- NA
Z_15_30 <- raster(paste0(wd$data_r, "SoilGrids/Z_15_30.tif"))
Z_15_30[Z_15_30 == 0] <- NA
Z = stack(Z_0_5, Z_5_15, Z_15_30)
Z = weighted.mean(Z, DepthWeights, na.rm=T)
Z <- resample(rast(Z), resample_100m, method = "bilinear")
rm(Z_0_5, Z_5_15, Z_15_30)
names(Z) <- "Z"
Zi <- RF_ImputeRast(r = Z, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
Z <- Zi[[1]]
rm(Zi)

# Sand fraction
S_0_5 <- raster(paste0(wd$data_r, "SoilGrids/S_0_5.tif"))
S_0_5[S_0_5 == 0] <- NA
S_5_15 <- raster(paste0(wd$data_r, "SoilGrids/S_5_15.tif"))
S_5_15[S_5_15 == 0] <- NA
S_15_30 <- raster(paste0(wd$data_r, "SoilGrids/S_15_30.tif"))
S_15_30[S_15_30 == 0] <- NA
S = stack(S_0_5, S_5_15, S_15_30)
S = weighted.mean(S, DepthWeights, na.rm=T)
S <- resample(rast(S), resample_100m, method = "bilinear")
rm(S_0_5, S_5_15, S_15_30)
names(S) <- "S"
Si <- RF_ImputeRast(r = S, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
S <- Si[[1]]
rm(Si)

# Soil Organic Carbon content
SOC_0_5 <- raster(paste0(wd$data_r, "SoilGrids/SOC_0_5.tif"))
SOC_0_5[SOC_0_5 == 0] <- NA
SOC_5_15 <- raster(paste0(wd$data_r, "SoilGrids/SOC_5_15.tif"))
SOC_5_15[SOC_5_15 == 0] <- NA
SOC_15_30 <- raster(paste0(wd$data_r, "SoilGrids/SOC_15_30.tif"))
SOC_15_30[SOC_15_30 == 0] <- NA
SOC = stack(SOC_0_5, SOC_5_15, SOC_15_30)
SOC = weighted.mean(SOC, DepthWeights, na.rm=T)
SOC <- resample(rast(SOC), resample_100m, method = "bilinear")
rm(SOC_0_5, SOC_5_15, SOC_15_30)
names(SOC) <- "SOC"
SOCi <- RF_ImputeRast(r = SOC, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
SOC <- SOCi[[1]]
rm(SOCi)

# Cation Exchange Capacity
CEC_0_5 <- raster(paste0(wd$data_r, "SoilGrids/CEC_0_5.tif"))
CEC_0_5[CEC_0_5 == 0] <- NA
CEC_5_15 <- raster(paste0(wd$data_r, "SoilGrids/CEC_5_15.tif"))
CEC_5_15[CEC_5_15 == 0] <- NA
CEC_15_30 <- raster(paste0(wd$data_r, "SoilGrids/CEC_15_30.tif"))
CEC_15_30[CEC_15_30 == 0] <- NA
CEC = stack(CEC_0_5, CEC_5_15, CEC_15_30)
CEC = weighted.mean(CEC, DepthWeights, na.rm=T)
CEC <- resample(rast(CEC), resample_100m, method = "bilinear")
rm(CEC_0_5, CEC_5_15, CEC_15_30)
names(CEC) <- "CEC"
CECi <- RF_ImputeRast(r = CEC, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
CEC <- CECi[[1]]
rm(CECi)

# Organic Carbon Density
OCD_0_5 <- raster(paste0(wd$data_r, "SoilGrids/OCD_0_5.tif"))
OCD_0_5[OCD_0_5 == 0] <- NA
OCD_5_15 <- raster(paste0(wd$data_r, "SoilGrids/OCD_5_15.tif"))
OCD_5_15[OCD_5_15 == 0] <- NA
OCD_15_30 <- raster(paste0(wd$data_r, "SoilGrids/OCD_15_30.tif"))
OCD_15_30[OCD_15_30 == 0] <- NA
OCD = stack(OCD_0_5, OCD_5_15, OCD_15_30)
OCD = weighted.mean(OCD, DepthWeights, na.rm=T)
OCD <- resample(rast(OCD), resample_100m, method = "bilinear")
rm(OCD_0_5, OCD_5_15, OCD_15_30)
names(OCD) <- "OCD"
OCDi <- RF_ImputeRast(r = OCD, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
OCD <- OCDi[[1]]
rm(OCDi)

# Nitrogen
N_0_5 <- raster(paste0(wd$data_r, "SoilGrids/N_0_5.tif"))
N_0_5[N_0_5 == 0] <- NA
N_5_15 <- raster(paste0(wd$data_r, "SoilGrids/N_5_15.tif"))
N_5_15[N_5_15 == 0] <- NA
N_15_30 <- raster(paste0(wd$data_r, "SoilGrids/N_15_30.tif"))
N_15_30[N_15_30 == 0] <- NA
N = stack(N_0_5, N_5_15, N_15_30)
N = weighted.mean(N, DepthWeights, na.rm=T)
N <- resample(rast(N), resample_100m, method = "bilinear")
rm(N_0_5, N_5_15, N_15_30)
names(N) <- "N"
Ni <- RF_ImputeRast(r = N, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
N <- Ni[[1]]
rm(Ni)

#Soil organic carbon stock
SOCS <- rast(paste0(wd$data_r, "SoilGrids/SOCS_0_30.tif"))
SOCS[SOCS == 0] <- NA
SOCS <- resample(SOCS, resample_100m, method = "bilinear")
names(SOCS) <- "SOCS"
SOCSi <- RF_ImputeRast(r = SOCS, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
SOCS <- SOCSi[[1]]
rm(SOCSi)

#Stack Rasters
Soil = c(BDRICM, BDRLOG, BDTICM, BD, S, Z, C, SOC, CEC, OCD, N, SOCS, WRB)

# Export Soil Raster Stack
writeRaster(Soil, filename = paste0(wd$data_p, "Soil_r_resampled.tif"), overwrite=TRUE)

#Remove unnecessary variables
rm(DEM_r, Slope, DepthWeights, m)
rm(BDRICM, BDRLOG, BDTICM, BD, S, Z, C, SOC, CEC, OCD, N, SOCS, WRB)

```


### Function to Interpolate Missing Soil Raster Values Using Random Forest Model

```{r, label='Function for RF soil raster imputation of missing values', message=FALSE,warning=FALSE, eval = FALSE}

resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
resample_100m <- disagg(resample_30m, 3)
resample_100m <- aggregate(resample_100m, 10)

DEM_r <- TopoEnv_r[[1]]
Slope <- TopoEnv_r[[2]]
Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))

resample_100m_b = resample_100m
values(resample_100m_b) <- 1
m <- mask(resample_100m_b, Municipios2000s)#Data2000s_poly)

r = SOCS
rnam = names(r)
covs = c(DEM_r,Slope)
Mask = m
SampFrac = 0.3
save_mem = FALSE

library(tidyverse)
library(terra)
library(ranger)

RF_ImputeRast <- function(r, # Terra SpatRast raster object
                          rnam = names(r), # name for df variable for raster values from focal SpatRast object
                          covs = NULL, # Terra SpatRast raster object with 1 or more stacked layers 
                          Mask = NULL, # mask of focal area under consideration. Used in reducing the sample for the training dataset; training dataset first excludes areas outside of the mask before applying the sampling fraction
                          SampFrac = 0.3, # sampling fraction for training dataset; applied after mask exclusions, if present (see Mask, above)
                          save_mem = FALSE # whether the save.memory parameter should be used for the ranger random forest function
) {
  
  if (!is.null(Mask)){
    m_df = Terra_df(Mask, "mask")
    names(m_df) <- c("x", "y", "mask", "outside")
    r_df = Terra_df(r, rnam)
    r_df = merge(r_df, m_df, all = F, sort = F)
  } else {
    r_df = Terra_df(r, rnam)
  }
  
  if (!is.null(covs)){
    out_list <- list()  # or result_vector <- c()
    for (i in 1:nlyr(covs)) {
      out_list[[i]] = Terra_df(covs[[i]], names(covs[[i]]))
      out_list[[i]] = out_list[[i]] %>% select(-na_cells)
    }
    covs_df <- Reduce(function(x, y) merge(x, y, all = F, sort = F), out_list)
    r_df = merge(r_df, covs_df, all = F, sort = F)
  }
  
  if (!is.null(Mask)){
    
    train = r_df %>% filter(outside == F) %>% filter(complete.cases(.)) %>% 
      select(-na_cells, -outside, -mask) %>% sample_frac(SampFrac)
    
  } else {
    
    train = r_df %>% filter(complete.cases(.)) %>% select(-na_cells) %>% 
      sample_frac(SampFrac)
  }
  
  f <- names(train)
  f <- f[f != names(r)]
  form <- paste(names(r), "~", paste(f, collapse = " + "))
  form <- as.formula(form)
  
  model <- ranger(
    formula = form,
    data = train,
    save.memory = save_mem 
  )
  
  if (!is.null(Mask)){
    
    pred = r_df %>% select(-na_cells, -outside, -mask) %>% select(-!!sym(rnam)) %>% filter(complete.cases(.))
    
  } else {
    
    pred = r_df %>% select(-na_cells) %>% select(-!!sym(rnam)) %>% filter(complete.cases(.))
    
  }
  
  predicted_vals <- predict(model, pred)
  pred$pred <- predicted_vals$predictions
  
  x = r_df %>% left_join(pred, by = f)
  
  r2 = r
  raster_values <- values(r2)
  missing_values <- is.na(raster_values)
  df_values <- x$pred[missing_values]
  r2[missing_values] <- df_values
  names(r2) <- rnam
  
  out <- list()
  out[[1]] <- r2
  out[[2]] <- model$r.squared
  out[[3]] <- model$prediction.error
  out[[4]] <- model$num.trees
  
  return(out)
}


writeRaster(r2,paste0(wd$data_r,"C_RF_interpolated.tif"), overwrite=TRUE)


```





# Climate Data

## CHELSA

gain(x)

offs(x)
offs(x) <- value
gain(x) <- value
### Climatologies
remove prec
remove tmax
remove tmin
remove tmean

pet
tas
tasmax
tasmin
npp
kg0
fcf

```{r, label='Load and Resample Climate Rasters', message=FALSE,warning=FALSE}
chwd = "D:/Dropbox (ASU)/AztecAgricultureModel/GIS_Data/CHELSA/"
prj = "epsg:32614"
t <- rast(paste0(wd$data_r, "TopoEnvData.tif"))
EXT <- project(t[[1]], crs="epsg:4326")
rm(t)
###############################################
resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
resample_100m <- disagg(resample_30m, 3)
resample_100m <- aggregate(resample_100m, 10)
###############################################
#mo = c(31,28,31,30,31,30,31,31,30,31,30,31)
#divide_layer <- function(x, y) {
#  x / y
#}

# Potential evapotranspiration for each month; calculated with the Penman-Monteith equation
pet_01 = rast(paste0(chwd, "pet/CHELSA_pet_penman_01_1981-2010_V.2.1.tif"))
pet_02 = rast(paste0(chwd, "pet/CHELSA_pet_penman_02_1981-2010_V.2.1.tif"))
pet_03 = rast(paste0(chwd, "pet/CHELSA_pet_penman_03_1981-2010_V.2.1.tif"))
pet_04 = rast(paste0(chwd, "pet/CHELSA_pet_penman_04_1981-2010_V.2.1.tif"))
pet_05 = rast(paste0(chwd, "pet/CHELSA_pet_penman_05_1981-2010_V.2.1.tif"))
pet_06 = rast(paste0(chwd, "pet/CHELSA_pet_penman_06_1981-2010_V.2.1.tif"))
pet_07 = rast(paste0(chwd, "pet/CHELSA_pet_penman_07_1981-2010_V.2.1.tif"))
pet_08 = rast(paste0(chwd, "pet/CHELSA_pet_penman_08_1981-2010_V.2.1.tif"))
pet_09 = rast(paste0(chwd, "pet/CHELSA_pet_penman_09_1981-2010_V.2.1.tif"))
pet_10 = rast(paste0(chwd, "pet/CHELSA_pet_penman_10_1981-2010_V.2.1.tif"))
pet_11 = rast(paste0(chwd, "pet/CHELSA_pet_penman_11_1981-2010_V.2.1.tif"))
pet_12 = rast(paste0(chwd, "pet/CHELSA_pet_penman_12_1981-2010_V.2.1.tif"))
pet = c(pet_01, pet_02, pet_03, pet_04, pet_05, pet_06, pet_07, pet_08, pet_09, pet_10, pet_11, pet_12)
pet <- crop(pet, EXT, snap = "out")
pet <- project(pet, crs = prj)
gain(pet) <- 0.01
#offs(pet) <- value
names(pet) <- c("pet_01", "pet_02", "pet_03", "pet_04", "pet_05", "pet_06", "pet_07", "pet_08", "pet_09", "pet_10", "pet_11", "pet_12")
rm(pet_01, pet_02, pet_03, pet_04, pet_05, pet_06, pet_07, pet_08, pet_09, pet_10, pet_11, pet_12)
pet_r <- resample(pet, resample_100m, method = "bilinear")
rm(pet)
#writeRaster(prec_r, filename = paste0(wd$data_r, "prec_r.tif"))


# Daily mean air temperature at 2 metres from hourly ERA5 data for each month
tas_01 = rast(paste0(chwd, "tas/CHELSA_tas_01_1981-2010_V.2.1.tif"))
tas_02 = rast(paste0(chwd, "tas/CHELSA_tas_02_1981-2010_V.2.1.tif"))
tas_03 = rast(paste0(chwd, "tas/CHELSA_tas_03_1981-2010_V.2.1.tif"))
tas_04 = rast(paste0(chwd, "tas/CHELSA_tas_04_1981-2010_V.2.1.tif"))
tas_05 = rast(paste0(chwd, "tas/CHELSA_tas_05_1981-2010_V.2.1.tif"))
tas_06 = rast(paste0(chwd, "tas/CHELSA_tas_06_1981-2010_V.2.1.tif"))
tas_07 = rast(paste0(chwd, "tas/CHELSA_tas_07_1981-2010_V.2.1.tif"))
tas_08 = rast(paste0(chwd, "tas/CHELSA_tas_08_1981-2010_V.2.1.tif"))
tas_09 = rast(paste0(chwd, "tas/CHELSA_tas_09_1981-2010_V.2.1.tif"))
tas_10 = rast(paste0(chwd, "tas/CHELSA_tas_10_1981-2010_V.2.1.tif"))
tas_11 = rast(paste0(chwd, "tas/CHELSA_tas_11_1981-2010_V.2.1.tif"))
tas_12 = rast(paste0(chwd, "tas/CHELSA_tas_12_1981-2010_V.2.1.tif"))
tas = c(tas_01, tas_02, tas_03, tas_04, tas_05, tas_06, tas_07, tas_08, tas_09, tas_10, tas_11, tas_12)
tas <- crop(tas, EXT, snap = "out")
tas <- project(tas, crs = prj)
gain(tas) <- 0.1
offs(tas) <- -273.15 
names(tas) <- c("tas_01", "tas_02", "tas_03", "tas_04", "tas_05", "tas_06", "tas_07", "tas_08", "tas_09", "tas_10", "tas_11", "tas_12")
rm(tas_01, tas_02, tas_03, tas_04, tas_05, tas_06, tas_07, tas_08, tas_09, tas_10, tas_11, tas_12)
tas_r <- resample(tas, resample_100m, method = "bilinear")
rm(tas)

# Daily maximum air temperature at 2 metres from hourly ERA5 data for each month
tasmax_01 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_01_1981-2010_V.2.1.tif"))
tasmax_02 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_02_1981-2010_V.2.1.tif"))
tasmax_03 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_03_1981-2010_V.2.1.tif"))
tasmax_04 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_04_1981-2010_V.2.1.tif"))
tasmax_05 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_05_1981-2010_V.2.1.tif"))
tasmax_06 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_06_1981-2010_V.2.1.tif"))
tasmax_07 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_07_1981-2010_V.2.1.tif"))
tasmax_08 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_08_1981-2010_V.2.1.tif"))
tasmax_09 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_09_1981-2010_V.2.1.tif"))
tasmax_10 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_10_1981-2010_V.2.1.tif"))
tasmax_11 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_11_1981-2010_V.2.1.tif"))
tasmax_12 = rast(paste0(chwd, "tasmax/CHELSA_tasmax_12_1981-2010_V.2.1.tif"))
tasmax = c(tasmax_01, tasmax_02, tasmax_03, tasmax_04, tasmax_05, tasmax_06, tasmax_07, tasmax_08, tasmax_09, tasmax_10, tasmax_11, tasmax_12)
tasmax <- crop(tasmax, EXT, snap = "out")
tasmax <- project(tasmax, crs = prj)
gain(tasmax) <- 0.1
offs(tasmax) <- -273.15 
names(tasmax) <- c("tasmax_01", "tasmax_02", "tasmax_03", "tasmax_04", "tasmax_05", "tasmax_06", "tasmax_07", "tasmax_08", "tasmax_09", "tasmax_10", "tasmax_11", "tasmax_12")
rm(tasmax_01, tasmax_02, tasmax_03, tasmax_04, tasmax_05, tasmax_06, tasmax_07, tasmax_08, tasmax_09, tasmax_10, tasmax_11, tasmax_12)
tasmax_r <- resample(tasmax, resample_100m, method = "bilinear")
rm(tasmax)

# Daily minimum air temperature at 2 metres from hourly ERA5 data for each month
tasmin_01 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_01_1981-2010_V.2.1.tif"))
tasmin_02 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_02_1981-2010_V.2.1.tif"))
tasmin_03 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_03_1981-2010_V.2.1.tif"))
tasmin_04 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_04_1981-2010_V.2.1.tif"))
tasmin_05 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_05_1981-2010_V.2.1.tif"))
tasmin_06 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_06_1981-2010_V.2.1.tif"))
tasmin_07 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_07_1981-2010_V.2.1.tif"))
tasmin_08 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_08_1981-2010_V.2.1.tif"))
tasmin_09 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_09_1981-2010_V.2.1.tif"))
tasmin_10 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_10_1981-2010_V.2.1.tif"))
tasmin_11 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_11_1981-2010_V.2.1.tif"))
tasmin_12 = rast(paste0(chwd, "tasmin/CHELSA_tasmin_12_1981-2010_V.2.1.tif"))
tasmin = c(tasmin_01, tasmin_02, tasmin_03, tasmin_04, tasmin_05, tasmin_06, tasmin_07, tasmin_08, tasmin_09, tasmin_10, tasmin_11, tasmin_12)
tasmin <- crop(tasmin, EXT, snap = "out")
tasmin <- project(tasmin, crs = prj)
gain(tasmin) <- 0.1
offs(tasmin) <- -273.15 
names(tasmin) <- c("tasmin_01", "tasmin_02", "tasmin_03", "tasmin_04", "tasmin_05", "tasmin_06", "tasmin_07", "tasmin_08", "tasmin_09", "tasmin_10", "tasmin_11", "tasmin_12")
rm(tasmin_01, tasmin_02, tasmin_03, tasmin_04, tasmin_05, tasmin_06, tasmin_07, tasmin_08, tasmin_09, tasmin_10, tasmin_11, tasmin_12)
tasmin_r <- resample(tasmin, resample_100m, method = "bilinear")
rm(tasmin)

# Precipitation amount"Amount" means mass per unit area. "Precipitation" in the
# earth's atmosphere means precipitation of water in all phases.

pr_01 = rast(paste0(chwd, "pr/CHELSA_pr_01_1981-2010_V.2.1.tif"))
pr_02 = rast(paste0(chwd, "pr/CHELSA_pr_02_1981-2010_V.2.1.tif"))
pr_03 = rast(paste0(chwd, "pr/CHELSA_pr_03_1981-2010_V.2.1.tif"))
pr_04 = rast(paste0(chwd, "pr/CHELSA_pr_04_1981-2010_V.2.1.tif"))
pr_05 = rast(paste0(chwd, "pr/CHELSA_pr_05_1981-2010_V.2.1.tif"))
pr_06 = rast(paste0(chwd, "pr/CHELSA_pr_06_1981-2010_V.2.1.tif"))
pr_07 = rast(paste0(chwd, "pr/CHELSA_pr_07_1981-2010_V.2.1.tif"))
pr_08 = rast(paste0(chwd, "pr/CHELSA_pr_08_1981-2010_V.2.1.tif"))
pr_09 = rast(paste0(chwd, "pr/CHELSA_pr_09_1981-2010_V.2.1.tif"))
pr_10 = rast(paste0(chwd, "pr/CHELSA_pr_10_1981-2010_V.2.1.tif"))
pr_11 = rast(paste0(chwd, "pr/CHELSA_pr_11_1981-2010_V.2.1.tif"))
pr_12 = rast(paste0(chwd, "pr/CHELSA_pr_12_1981-2010_V.2.1.tif"))
pr = c(pr_01, pr_02, pr_03, pr_04, pr_05, pr_06, pr_07, pr_08, pr_09, pr_10, pr_11, pr_12)
pr <- crop(pr, EXT, snap = "out")
pr <- project(pr, crs = prj)
gain(pr) <- 0.1
#offs(pr) <- 0 
names(pr) <- c("pr_01", "pr_02", "pr_03", "pr_04", "pr_05", "pr_06", "pr_07", "pr_08", "pr_09", "pr_10", "pr_11", "pr_12")
rm(pr_01, pr_02, pr_03, pr_04, pr_05, pr_06, pr_07, pr_08, pr_09, pr_10, pr_11, pr_12)
pr_r <- resample(pr_r, resample_100m, method = "bilinear")
###rm(pr)

# Total % cloud cover for each month
clt_01 = rast(paste0(chwd, "clt/CHELSA_clt_01_1981-2010_V.2.1.tif"))
clt_02 = rast(paste0(chwd, "clt/CHELSA_clt_02_1981-2010_V.2.1.tif"))
clt_03 = rast(paste0(chwd, "clt/CHELSA_clt_03_1981-2010_V.2.1.tif"))
clt_04 = rast(paste0(chwd, "clt/CHELSA_clt_04_1981-2010_V.2.1.tif"))
clt_05 = rast(paste0(chwd, "clt/CHELSA_clt_05_1981-2010_V.2.1.tif"))
clt_06 = rast(paste0(chwd, "clt/CHELSA_clt_06_1981-2010_V.2.1.tif"))
clt_07 = rast(paste0(chwd, "clt/CHELSA_clt_07_1981-2010_V.2.1.tif"))
clt_08 = rast(paste0(chwd, "clt/CHELSA_clt_08_1981-2010_V.2.1.tif"))
clt_09 = rast(paste0(chwd, "clt/CHELSA_clt_09_1981-2010_V.2.1.tif"))
clt_10 = rast(paste0(chwd, "clt/CHELSA_clt_10_1981-2010_V.2.1.tif"))
clt_11 = rast(paste0(chwd, "clt/CHELSA_clt_11_1981-2010_V.2.1.tif"))
clt_12 = rast(paste0(chwd, "clt/CHELSA_clt_12_1981-2010_V.2.1.tif"))
clt = c(clt_01, clt_02, clt_03, clt_04, clt_05, clt_06, clt_07, clt_08, clt_09, clt_10, clt_11, clt_12)
clt <- crop(clt, EXT, snap = "out")
clt <- project(clt, crs = prj)
gain(clt) <- 0.01
#offs(clt) <- 0
#r2 = raster(extent(pr), resolution = c(875, 922), crs = crs(pr))
#clt <- resample(clt, r2, method = "bilinear")
names(clt) <- c("clt_01", "clt_02", "clt_03", "clt_04", "clt_05", "clt_06", "clt_07", "clt_08", "clt_09", "clt_10", "clt_11", "clt_12")
rm(clt_01, clt_02, clt_03, clt_04, clt_05, clt_06, clt_07, clt_08, clt_09, clt_10, clt_11, clt_12, r2)
clt_r <- resample(clt_r, resample_100m, method = "bilinear")
rm(clt, pr)

# Surface downwelling shortwave flux in air
rsds_01 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_01_V.2.1.tif"))
rsds_02 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_02_V.2.1.tif"))
rsds_03 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_03_V.2.1.tif"))
rsds_04 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_04_V.2.1.tif"))
rsds_05 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_05_V.2.1.tif"))
rsds_06 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_06_V.2.1.tif"))
rsds_07 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_07_V.2.1.tif"))
rsds_08 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_08_V.2.1.tif"))
rsds_09 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_09_V.2.1.tif"))
rsds_10 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_10_V.2.1.tif"))
rsds_11 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_11_V.2.1.tif"))
rsds_12 = rast(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_12_V.2.1.tif"))
rsds = c(rsds_01, rsds_02, rsds_03, rsds_04, rsds_05, rsds_06, rsds_07, rsds_08, rsds_09, rsds_10, rsds_11, rsds_12)
rsds <- crop(rsds, EXT, snap = "out")
rsds <- project(rsds, crs = prj, snap = "out")
gain(rsds) <- 0.001
#offs(rsds) <- 0
names(rsds) <- c("rsds_01", "rsds_02", "rsds_03", "rsds_04", "rsds_05", "rsds_06", "rsds_07", "rsds_08", "rsds_09", "rsds_10", "rsds_11", "rsds_12")
rm(rsds_01, rsds_02, rsds_03, rsds_04, rsds_05, rsds_06, rsds_07, rsds_08, rsds_09, rsds_10, rsds_11, rsds_12)
rsds_r <- resample(rsds_r, resample_100m, method = "bilinear")
rm(rsds)

#Net primary productivity Calculated based on the ‘Miami model’, Lieth, H., 1972. "Modelling the primary productivity of the earth. Nature and resources", UNESCO, VIII, 2:5-10.
npp = rast(paste0(chwd, "bio/CHELSA_npp_1981-2010_V.2.1.tif"))
npp <- crop(npp, EXT, snap = "out")
npp <- project(npp, crs = prj, snap = "out")
gain(npp) <- 0.1
names(npp) <- "npp"
npp_r <- resample(npp_r, resample_100m, method = "bilinear")


#Köppen-Geiger climate classification
kg0 = rast(paste0(chwd, "bio/CHELSA_kg0_1981-2010_V.2.1.tif"))
kg0 <- crop(kg0, EXT, snap = "out")
kg0 <- project(kg0, crs = prj, snap = "out")
names(kg0) <- "kg0"
kg0 <- as.factor(kg0)
kg0_r <- resample(kg0_r, resample_100m, method = "near")


#Frost change frequency; count; Number of events in which tmin or tmax go above, or below 0°C
fcf = rast(paste0(chwd, "bio/CHELSA_fcf_1981-2010_V.2.1.tif"))
fcf <- crop(fcf, EXT, snap = "out")
fcf <- project(fcf, crs = prj, snap = "out")
names(fcf) <- "fcf"
fcf_r <- resample(fcf_r, resample_100m, method = "bilinear")

# PDSI
pdsi_r = pdsi(pr[1], pet[1])
for (i in 1:12) {
  temp = pdsi(pr[i], pet[i])
  q = ifelse(i < 10, "0", "")
  names(temp) <- paste0("pdsi_", q, i)
  pdsi_r = c(pdsi_r, temp)
}
rm(temp, q)


Clim_r <- c(pet_r,pr_r,tas_r,tasmax_r,tasmin_r,clt_r,rsds_r,npp_r, kg0_r, fcf_r)
#names(Clim_r)
writeRaster(Clim_r, filename = paste0(wd$data_p, "Clim_r_resampled.tif"), overwrite=TRUE, append=FALSE)

rm(pet_r,pr_r,tas_r,tasmax_r,tasmin_r,clt_r,rsds_r,npp_r, kg0_r, fcf_r)
rm(pet,pr,tas,tasmax,tasmin,clt,rsds,npp, kg0, fcf)
```

### CHELSA-TraCE21k – 1km climate timeseries since the LGM

https://chelsa-climate.org/chelsa-trace21k/

CHELSA-TraCE21k data provides monthly climate data for temperature and precipitation at 30 arcsec spatial resolution in 100-yeartime steps for the last 21,000 years. Paleo orography at high spatial resolution and at each timestep is created by combining high resolution information on glacial cover from current and Last Glacial Maximum (LGM) glacier databases with the interpolation of a dynamic ice sheet model (ICE6G) and a coupling to mean annual temperatures from CCSM3-TraCE21k. Based on the reconstructed paleo orography, mean annual temperature and precipitation was downscaled using the CHELSA V1.2 algorithm.


Time ID == 12-20

Variables:
* tasmax
* tasmin
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 
* 


### 2003-2019 Timeseries



```{r}
HTTP <- "https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V2/GLOBAL/monthly/"
var <- c("pet")
var2 <- c("pet_penman")
month <- c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12")
year <- as.character(c(2003:2019))
URLs <- vector("character", length = 0)

for (i in 1:length(var)) {
  for (j in 1:length(year)) {
    temp <- paste0(HTTP, var[i], "/CHELSA_", var2[i], "_", month, "_", year[j], "_V.2.1.tif")
    URLs <- c(URLs, temp)
  }
}
options(timeout=10000)
files <- gsub(HTTP, "", URLs)
#files <- paste0(files)
#curl_download(URLs[1],destfile=paste0(wd$data_r, "CHELSA/",files[1]))
for (i in 1:length(URLs)){#length(URLs)
  source_url <- file.path(URLs[i])
  destination <- paste0(wd$data_r, "CHELSA/",files[i])
  download.file(source_url, destination, mode="wb")
}





```




## Mexican Drought Atlas

Mexican Drought Atlas (MXDA) 600 Year scPDSI Reconstructions

Stahle, D.W., E.R. Cook, D.J. Burnette, J. Villanueva, J. Cerano, J.N. Burns, D. Griffin, B.I. Cook, R. Acuña, M.C.A. Torbenson, P. Szejner, and I.M. Howard, 2016:  The Mexican Drought Atlas:  Tree-ring reconstructions of the soil moisture balance during the late pre-Hispanic, colonial, and modern eras.  Quaternary Science Reviews, 149, 34-60.

 summer (June-August) reconstructions of the self-calibrating Palmer Drought Severity Index (PDSI) on a 0.5° latitude/longitude grid centered over Mexico from AD 1400-2012.  The reconstructions are derived from 252 tree-ring chronologies over subtropical North America.


Central Mexico included from AD 1400-2005

http://drought.memphis.edu/MXDA/
https://www.sciencedirect.com/science/article/pii/S0277379116302244
https://www.ncei.noaa.gov/access/paleo-search/study/20353

### Import Data from NOAA

```{r}
MXDA_Reconstructed_JJA_PDSI <- rast("C:/Users/rcesaret/Downloads/MXDA_Reconstructed_JJA_PDSI.tif")
MXDA_Instrumental_PDSI <- rast("C:/Users/rcesaret/Downloads/MXDA_Instrumental_PDSI.tif")
#MXDA_Reconstructed_JJA_PDSI <- ifel(MXDA_Reconstructed_JJA_PDSI < 1000, NA, MXDA_Reconstructed_JJA_PDSI)

recon_data_url <- "http://www1.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-recon-jja-scpdsi-1400-2012.txt"
grid_points_url <- "http://www1.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-grid-points.txt"
instr_data_url <- "https://www.ncei.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-inst-jja-scpdsi-1901-2012.txt"

recon_data <- read.table(recon_data_url, header = TRUE, sep = "\t")
recon_data <- data.frame(do.call(rbind, strsplit(recon_data[,1], "\\s+")))
z <- paste0("scPDSI_", as.character(recon_data[,2]))
recon_data <- as.data.frame(t(as.matrix(recon_data[,-c(1:2)])))
colnames(recon_data) <- z
row.names(recon_data) <- NULL
rownames(recon_data) <- 1:nrow(recon_data)

grid_points <- read.table(grid_points_url, header = F)
names(grid_points) <- c("Lon", "Lat", "UNK_1", "UNK_2", "Variable")

instr_data <- read.table(instr_data_url, header = TRUE, sep = "\t")
instr_data <- as.data.frame(instr_data[-c(1:3),])
instr_data <- data.frame(do.call(rbind, strsplit(instr_data[,1], "\\s+")))
z <- paste0("scPDSI_", as.character(instr_data[,2]))
instr_data <- as.data.frame(t(as.matrix(instr_data[,-c(1:2)])))
colnames(instr_data) <- z
row.names(instr_data) <- NULL
rownames(instr_data) <- 1:nrow(instr_data)

instr_data <- cbind(grid_points[,c(1:2)], instr_data)
recon_data <- cbind(grid_points[,c(1:2)], recon_data)

instr_scPDSI <- rast(instr_data, type="xyz", extent = ext(MXDA_Instrumental_PDSI), crs="epsg:4326")
recon_scPDSI <- rast(recon_data, type="xyz", extent = ext(MXDA_Reconstructed_JJA_PDSI), crs="epsg:4326")

writeRaster(instr_scPDSI, filename = paste0(wd$data_r, "MXDA_instr_scPDSI.tif"), overwrite=TRUE)
writeRaster(recon_scPDSI, filename = paste0(wd$data_r, "MXDA_recon_scPDSI.tif"), overwrite=TRUE)

rm(recon_data, instr_data, z, grid_points, recon_data_url, grid_points_url, instr_data_url, MXDA_Reconstructed_JJA_PDSI, MXDA_Instrumental_PDSI)

```


### Downscale

```{r}
instr_scPDSI <- rast(paste0(wd$data_r, "MXDA_instr_scPDSI.tif"))
recon_scPDSI <- rast(paste0(wd$data_r, "MXDA_recon_scPDSI.tif"))

spatialEco::raster.downscale(
  x,
  y,
  scatter = FALSE,
  full.res = FALSE,
  residuals = FALSE,
  se = FALSE,
  p = 0.95,
  uncertainty = c("none", "prediction", "confidence")
)

```

https://rdrr.io/cran/spatialEco/man/raster.downscale.html





#Unused

```{r}
Clim_r <- rast(paste0(wd$data_p, "Clim_r_resampled.tif"))
target_CRS = crs(Clim_r)
t <- rast(paste0(wd$data_r, "TopoEnvData.tif"))
EXT <- project(t[[1]],"epsg:4326")


# Read the NetCDF file as a RasterBrick object using the raster package
NADApdsi04 <- raster::brick(paste0(wd$data_r, "NADApdsi04.nc"))
# Convert the RasterBrick to a SpatRasterStack object using terra
NADApdsi04 <- terra::rast(NADApdsi04)

years = rev(-1:2003)
time(NADApdsi04, tstep="years")<-years
varnames(NADApdsi04)<-"scPDSI"
names(NADApdsi04) <- paste0("scPDSI_", years)
NADApdsi04 <- subset(NADApdsi04, names(NADApdsi04)[1:604])
q <- subset(NADApdsi04, names(NADApdsi04)[1:3])
q <- crop(q, EXT, snap = "out")
NADApdsi04 <- crop(NADApdsi04, EXT, snap = "out")

NADApdsi04 <- app(NADApdsi04, FUN = function(x) project(x, crs = target_CRS))


# Read the NetCDF file as a RasterBrick object using the raster package
MADApdsiz <- raster::brick(paste0(wd$data_r, "MADApdsi-z.nc"))
# Convert the RasterBrick to a SpatRasterStack object using terra
MADApdsiz <- terra::rast(MADApdsiz)
MADApdsiz
plot(MADApdsiz[[1]])

# Read the NetCDF file as a RasterBrick object using the raster package
nada_hd2_cl <- raster::brick(paste0(wd$data_r, "nada_hd2_cl.nc"))
# Convert the RasterBrick to a SpatRasterStack object using terra
nada_hd2_cl <- terra::rast(nada_hd2_cl)
recon_data_url <- "http://www1.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-recon-jja-scpdsi-1400-2012.txt"
grid_points_url <- "http://www1.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-grid-points.txt"
instr_data_url <- "https://www.ncei.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-inst-jja-scpdsi-1901-2012.txt"

recon_data <- read.table(recon_data_url, header = TRUE, sep = "\t")
recon_data <- data.frame(do.call(rbind, strsplit(recon_data[,1], "\\s+")))
z <- paste0("scPDSI_", as.character(recon_data[,2]))
recon_data <- as.data.frame(t(as.matrix(recon_data[,-c(1:2)])))
colnames(recon_data) <- z
row.names(recon_data) <- NULL
rownames(recon_data) <- 1:nrow(recon_data)

grid_points <- read.table(grid_points_url, header = F)
names(grid_points) <- c("Lon", "Lat", "UNK_1", "UNK_2", "Variable")

instr_data <- read.table(instr_data_url, header = TRUE, sep = "\t")
instr_data <- as.data.frame(instr_data[-c(1:3),])
instr_data <- data.frame(do.call(rbind, strsplit(instr_data[,1], "\\s+")))
z <- paste0("scPDSI_", as.character(instr_data[,2]))
instr_data <- as.data.frame(t(as.matrix(instr_data[,-c(1:2)])))
colnames(instr_data) <- z
row.names(instr_data) <- NULL
rownames(instr_data) <- 1:nrow(instr_data)

instr_data <- cbind(grid_points[,c(1:2)], instr_data)
recon_data <- cbind(grid_points[,c(1:2)], recon_data)

instr_scPDSI <- rast(instr_data, type="xyz", extent = ext(MXDA_Reconstructed_JJA_PDSI), crs="epsg:4326")
instr_scPDSI <- rast(instr_data, type="xyz", extent = ext(MXDA_Reconstructed_JJA_PDSI), crs="epsg:4326")

MXDA_Reconstructed_JJA_PDSI.tif

instr_data[, c(1:2,3)]
nclimgrid_pmdi2017 <- raster::brick("C:/Users/rcesaret/Downloads/nclimgrid_pmdi-2017.nc")
nclimgrid_pmdi2017 <- terra::rast(nclimgrid_pmdi2017)
```















```{r}
install.packages("rnoaa")
library(rnoaa)

data <- ncdc(datasetid = "paleo", stationid = "GHCND:USW00023129", 
             startdate = "1850-01-01", enddate = "2010-12-31")

data_list <- list()
for (year in years) {
  for (variable in variables) {
    data <- ncdc(datasetid = "GHCND", stationid = "GHCND:USW00023272", datatypeid = variable,
                 startdate = paste0(year, "-01-01"), enddate = paste0(year, "-12-31"),
                 limit = 1000, token = "YOUR_TOKEN")
    data_list[[paste(variable, year, sep = "_")]] <- data
  }
}
```



The "Living Blended Drought Atlas (LBDA)" North American Drought Reconstruction for the last 2000 years

Cook, E.R., Seager, R., Heim, R.R., Vose, R.S., Herweijer, C., and Woodhouse, C. 2010. Megadroughts in North America: Placing IPCC projections of hydroclimatic change in a long-term paleoclimate context. Journal of Quaternary Science, 25(1), 48-61. doi: 10.1002/jqs.1303


NOAA Study Page:
https://www.ncei.noaa.gov/access/paleo-search/study/19119



```{r}
# Instrumental PMDI metadata - one line per grid point data set
#CC	GRDBX	LON	LAT	AV.ELEV	%LAND	IBYR	CO	AWC	B	H	TLA
LBDA_metadata <- read.csv(paste0(wd$data_r,"LBDA_PMDI_Instrumental_metadata.csv"))



URL = "https://www.ncei.noaa.gov/pub/data/paleo/drought/LBDA2010/LBDA_PMDI_Instrumental_metadata.txt"
LBDA_metadata <- read.table(URL, header = TRUE, sep = "", skip = 1)

# 	Reconstructed PMDI - one column per grid point
"https://www.ncei.noaa.gov/pub/data/paleo/drought/LBDA2010/LBDA_PMDI_JJA_Recons.txt"
```

	Reconstructed PMDI calibration/verification statistics
https://www.ncei.noaa.gov/pub/data/paleo/drought/LBDA2010/LBDA_PMDI_JJA_Recons_cal-ver_stats.txt

	Instrumental PMDI data used for calibration/verification
https://www.ncei.noaa.gov/pub/data/paleo/drought/LBDA2010/LBDA_PMDI_Instrumental_data.txt

recon_data_url <- "http://www1.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-recon-jja-scpdsi-1400-2012.txt"
grid_points_url <- "http://www1.ncdc.noaa.gov/pub/data/paleo/treering/reconstructions/mexico/mxda/mxda-grid-points.txt"

recon_data <- read.table(recon_data_url, header = TRUE, sep = "\t")
grid_points <- read.table(grid_points_url, header = F)



