---
title: "Aztec Agricultural Productivity Model"
subtitle: "Part 1: Environmental Data"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---

```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```

This R markdown document prepares the data used in the Aztec agricultural productivity random forest model, which is undertaken in Part 2 (the subsequent R markdown script). This involves the following:

  1. Load, reorganize and integrate the modern agricultural analogue dataset, which includes:
      + Contemporary municipio polygons from INEGI
      + 2010 municipal population census statistics
      + 2007 municipal agricultural census statistics
      + FASII and INEGI geospatial land use polygons from the 2000s and 2010s
      + SIAP 2003-2021 crop yield data
      + 
  2. Load, Resample and Calculate topographic variable rasters, which include:
      + 
      + 
      + 
      + 
      + 
      + 
      + 
      + 
      + 
  3. Load, resample and RF impute ISRIC SoilGrids250 rasters, which include:
      + 
      + 
      + 
      + 
      + 
  4. Load and resample CHELSA monthly climate variable rasters, which include:
      + 
      + 
      + 
  
  Topographic/environmental metrics
  
Function to Interpolate Missing Soil Raster Values Using Random Forest Model

Function for RF soil raster imputation of missing values

Resample raster data to 100m x 100m

CRS = WGS84 UTM Zone 14N (EPSG: 32614)


# Setup 

All of the data and scripts are downloadable from the [Aztec Agriculture github repository](https://https://github.com/rcesaret/AztecAgriculture), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "D:/Dropbox (ASU)/AztecAgricultureModel/AztecAgriculture/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/Huexotzinco/HuexTlaxAnal2022/HuexTlax2022Analysis/"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```



## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("tidyverse", "rgdal", "rgeos", "sp", "sf", "GISTools", "raster", 
              "Matrix", "terra","gdistance", "lwgeom", "tidyr", "stars", "dismo", 
              "purrr", "spatialEco", "whitebox", "classInt","ggnewscale", "lbmech", 
              "data.table", "tidyterra","gridExtra", "cowplot", "scam", "rmarkdown", 
              "spatialreg","spdep", "ggridges", "ggnewscale", "scales", "ggstatsplot",
              "stringi", "fuzzyjoin", "mgcv", "randomForest", "ranger", "kableExtra", 
              "Boruta", "mlbench", "caret", "readr")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("RescaleSpatRast.R", "Terra_df.R", "RF_ImputeRast.R")#"splitByAttributes.R", 
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```









# Topographic Variables




```{r, label='Load, Resample and Calculate Topographic Variable Rasters', message=FALSE,warning=FALSE}


resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
resample_100m <- disagg(resample_30m, 3)
resample_100m <- aggregate(resample_100m, 10)

## Import INEGI lidar-derived 15-meter DEM
## Continuo de Elevaciones Mexicanas 3.0 (2012)
## https://www.inegi.org.mx/app/geo2/elevacionesmex/#:~:text=El%20Continuo%20de%20Elevaciones%20Mexicano,le%20integran%20valores%20que%20representan


DEM <- rast(paste0(wd$data_r,"DEM_CEM_v3.0_15m_CMex.tif"))

DEM[DEM == 0 | is.nan(DEM)] <- NA

## SMOOTH RASTER
DEM <- focal(DEM, w=5, fun='mean', na.policy="only", na.rm=T)
DEM <- focal(DEM, w=5, fun='mean', na.policy="only", na.rm=T)
DEM <- focal(DEM, w=5, fun='mean', na.policy="only", na.rm=T)

DEM <- focal(DEM, w=5, fun='mean', na.rm=T)
DEM <- focal(DEM, w=7, fun='mean', na.rm=T)
DEM <- focal(DEM, w=9, fun='mean', na.rm=T)
DEM <- focal(DEM, w=11, fun='mean', na.rm=T)
DEM <- focal(DEM, w=13, fun='mean', na.rm=T)

writeRaster(DEM,paste0(wd$data_r,"DEM.tif"), overwrite=TRUE)
#DEM <- rast(paste0(wd$data_r,"DEM.tif"))

DEM_r <- resample(DEM, resample_100m, method = "bilinear")
writeRaster(DEM_r,paste0(wd$data_r,"DEM_r.tif"), overwrite=TRUE)

rm(DEM)

#create temp directory for rasters we will delete later
# we will stack and save these together at the end of this chunk

##### dir.create(paste0(wd$data_p,"temp_rasts"))

######### TRI ######### 

TRI <- terra::terrain(DEM_r, v="TRI")# calc Terrain Ruggedness Index
#TRI_r <- resample(TRI, resample_100m, method = "bilinear")


slope <- terra::terrain(DEM_r, v="slope", unit="degrees")#Slope
#slope_r <- resample(slope, resample_100m, method = "bilinear")
writeRaster(slope,paste0(wd$data_p,"temp_rasts/Slope.tif"), overwrite=TRUE)

######### TWI ######### 

wbt_breach_depressions(dem = paste0(wd$data_r,"DEM_r.tif"), output = paste0(wd$data_p,"temp_rasts/DEM_breach.tif"))
#DEM_breach <- rast(paste0(wd$data_p, "temp_rasts/DEM_breach.tif"))
#DEM_breach <- rast(paste0(wd$data_r,"DEM_breach.tif"))
#writeRaster(DEM_breach,paste0(wd$data_p,"temp_rasts/DEM_breach.tif"), overwrite=TRUE)
#writeRaster(DEM_breach,paste0(wd$data_r,"DEM_breach.tif"), overwrite=TRUE)


wbt_d8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach.tif"), output=paste0(wd$data_p,"temp_rasts/Accum.tif"), out_type = "specific contributing area")
Accum <- rast(paste0(wd$data_p, "temp_rasts/Accum.tif"))
#Accum <- rast(paste0(wd$data_r, "Accum.tif"))
#Accum[is.nan(Accum)] <- NA
#Accum_r <- resample(Accum, resample_100m, method = "bilinear")
#writeRaster(Accum,paste0(wd$data_p,"temp_rasts/Accum.tif"), overwrite=TRUE)
#writeRaster(Accum,paste0(wd$data_r,"Accum.tif"), overwrite=TRUE)

wbt_wetness_index(sca=paste0(wd$data_p,"temp_rasts/Accum.tif"), slope=paste0(wd$data_p,"temp_rasts/Slope.tif"), output=paste0(wd$data_p,"temp_rasts/TWI.tif"), verbose_mode = FALSE)
TWI <- rast(paste0(wd$data_p, "temp_rasts/TWI.tif"))
TWI <- focal(TWI, w=17, fun='max', na.policy="only", na.rm=T)
#TWI <- rast(paste0(wd$data_r, "TWI.tif"))
#TWI_r <- resample(TWI, resample_100m, method = "bilinear")
writeRaster(TWI,paste0(wd$data_p,"temp_rasts/TWI.tif"), overwrite=TRUE)
#writeRaster(TWI,paste0(wd$data_r,"TWI.tif"), overwrite=TRUE)


######### SPI ######### 

wbt_stream_power_index(sca=paste0(wd$data_p,"temp_rasts/Accum.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope.tif"),output=paste0(wd$data_p,"temp_rasts/SPI.tif"),exponent = 1)
SPI <- rast(paste0(wd$data_p, "temp_rasts/SPI.tif"))
#SPI <- rast(paste0(wd$data_r, "SPI.tif"))
#SPI_r <- resample(SPI, resample_100m, method = "bilinear")
#writeRaster(SPI,paste0(wd$data_p,"temp_rasts/SPI.tif"), overwrite=TRUE)
#writeRaster(SPI,paste0(wd$data_r,"SPI.tif"), overwrite=TRUE)

######### STI ######### 

wbt_fd8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach.tif"), output=paste0(wd$data_p,"temp_rasts/Accum_fd8.tif"), out_type = "specific contributing area")
Accum_fd8 <- rast(paste0(wd$data_p, "temp_rasts/Accum_fd8.tif"))
#Accum_fd8 <- rast(paste0(wd$data_r, "Accum_fd8.tif"))
#writeRaster(Accum_fd8,paste0(wd$data_p,"temp_rasts/Accum_fd8.tif"), overwrite=TRUE)
#writeRaster(Accum_fd8,paste0(wd$data_r,"Accum_fd8.tif"), overwrite=TRUE)

wbt_sediment_transport_index(sca=paste0(wd$data_p,"temp_rasts/Accum_fd8.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope.tif"),output=paste0(wd$data_p,"temp_rasts/STI.tif"))
STI <- rast(paste0(wd$data_p, "temp_rasts/STI.tif"))
#STI <- rast(paste0(wd$data_r, "STI.tif"))
#STI_r <- resample(STI, resample_100m, method = "bilinear")
#writeRaster(STI,paste0(wd$data_p,"temp_rasts/STI.tif"), overwrite=TRUE)
#writeRaster(STI,paste0(wd$data_r,"STI.tif"), overwrite=TRUE)



TopoEnvData <- (c(DEM_r, slope, Accum, Accum_fd8, TRI, TWI, STI, SPI))

rm(DEM_r, slope, Accum, Accum_fd8, TRI, TWI, STI, SPI)

nam = c("DEM", "Slope", "Accum", "Accum_fd8", "TRI", "TWI", "STI", "SPI")

names(TopoEnvData) = nam

writeRaster(TopoEnvData, filename = paste0(wd$data_p, "TopoEnvData.tif"), overwrite=TRUE)

TopoEnv_r <- rast(paste0(wd$data_r, "TopoEnvData.tif"))

rm(TopoEnvData)
```




# Soil Data

ISRIC  SoilGrids250

https://www.isric.org/explore/soilgrids

```{r, label='Soil Depth huge downloads cropping', eval = FALSE}

# # SCRIPT FOR SAVING MULTI-GIGABYTE SOILGRID DOWNLOADS 
# # TO HUEXTLAXANAL2022 DATA-RAW/SOILGRIDS FOLDER

BDRICM <- raster("C:/Users/rcesaret/Downloads/BDRICM_M_250m_ll.tif")
X <- projectRaster(WRB, crs = "+proj=longlat +datum=WGS84 +no_defs")
r2 = raster(extent(X), resolution = c(0.00208, 0.00208), crs = crs(X))
BDRICM <- crop(BDRICM, r2)
BDRICM <- projectRaster(BDRICM, crs = prj)
BDRICM <- resample(BDRICM, BD, method = "bilinear")
writeRaster(BDRICM,paste0(wd$data_r,"SoilGrids/BDRICM.tif"), overwrite=TRUE)


BDRLOG <- raster("C:/Users/rcesaret/Downloads/BDRLOG_M_250m_ll.tif")
X <- projectRaster(WRB, crs = "+proj=longlat +datum=WGS84 +no_defs")
r2 = raster(extent(X), resolution = c(0.00208, 0.00208), crs = crs(X))
BDRLOG <- crop(BDRLOG, r2)
BDRLOG <- projectRaster(BDRLOG, crs = prj)
BDRLOG <- resample(BDRLOG, BD, method = "bilinear")
writeRaster(BDRLOG,paste0(wd$data_r,"SoilGrids/BDRLOG.tif"), overwrite=TRUE)


BDTICM <- raster("C:/Users/rcesaret/Downloads/BDTICM_M_250m_ll.tif")
X <- projectRaster(WRB, crs = "+proj=longlat +datum=WGS84 +no_defs")
r2 = raster(extent(X), resolution = c(0.00208, 0.00208), crs = crs(X))
BDTICM <- crop(BDTICM, r2)
BDTICM <- projectRaster(BDTICM, crs = prj)
BDTICM <- resample(BDTICM, BD, method = "bilinear")
writeRaster(BDTICM,paste0(wd$data_r,"SoilGrids/BDTICM.tif"), overwrite=TRUE)

```



```{r SoilGrids250Vars, echo = FALSE, warning = FALSE, message = FALSE, results = 'asis', fig.pos='!h'}
library(kableExtra)

Variable <- c("BDRICM", "BDRLOG", "BDTICM", "BD", "S", "Z", "C", "SOC", "CEC", "OCD", "N", "SOCS", "WRB")
Description <- c("Depth to bedrock (R horizon) up to 200 cm", "Probability of occurrence of R horizon", "Absolute depth to bedrock", "Bulk density (fine earth fraction)", "Weight percentage of the sand particles (0.05–2 mm)", "Weight percentage of the silt particles (0.0002–0.05 mm)", "Weight percentage of the clay particles (<0.0002 mm)", "Soil organic carbon content", "Cation exchange capacity at ph 7", "Soil organic carbon density", "Nitrogen content", "Soil organic carbon stock", "World Reference Base (2006) Soil Groups")
Units <- c("cm", "percentage", "cm", "kg/m^3", "percentage", "percentage", "percentage", "permille", "	cmolc/kg", "kg/m^3", "cg/kg", "ton/ha", "type (factor)")

data.frame(Variable, Description, Units) %>% 
    kbl(format = 'html',
        escape = FALSE,
        caption = "SoilGrids250 Rasters / Variables") %>% 
    kable_styling(font_size = 22) %>%
    gsub("font-size: initial !important;", 
         "font-size: 22pt !important;", 
         .)

rm(Variable, Description, Units)
```



```{r, label='Load, resample and RF impute Soil Rasters', message=FALSE, warning=FALSE}
###############################################
#resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
#resample_100m <- disagg(resample_30m, 3)
#resample_100m <- aggregate(resample_100m, 10)
#TopoEnv_r <- rast(paste0(wd$data_r, "TopoEnvData.tif"))
###############################################

# Covariates for input into RF_ImputeRast function
DEM_r <- TopoEnv_r[[1]]
Slope <- TopoEnv_r[[2]]

#Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))

# Create Municipios Mask Raster for input into RF_ImputeRast function
Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))
resample_100m_b = resample_100m
values(resample_100m_b) <- 1
m <- mask(resample_100m_b, Municipios2000s)
rm(resample_100m_b,Municipios2000s)

# Depths for each of the first three SoilGrids250 levels 
# for taking the weighted average for 0-30cm
DepthWeights = c(5,10,15) 


# Depth to bedrock (R horizon) up to 200 cm
BDRICM <- rast(paste0(wd$data_r, "SoilGrids/BDRICM.tif"))
BDRICM[BDRICM == 0] <- NA
BDRICM <- focal(BDRICM, w=5, fun='max', na.policy="only", na.rm=T)
BDRICM <- focal(BDRICM, w=5, fun='max', na.policy="only", na.rm=T)
BDRICM <- resample(BDRICM, resample_100m, method = "bilinear")
names(BDRICM) <- "BDRICM"
BDRICMi <- RF_ImputeRast(r = BDRICM, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BDRICM <- BDRICMi[[1]]
rm(BDRICMi)

#	Probability of occurrence of R horizon	percentage
BDRLOG <- rast(paste0(wd$data_r, "SoilGrids/BDRLOG.tif"))
BDRLOG[BDRLOG == 0] <- NA
BDRLOG <- focal(BDRLOG, w=5, fun='min', na.policy="only", na.rm=T)
BDRLOG <- focal(BDRLOG, w=5, fun='min', na.policy="only", na.rm=T)
BDRLOG <- resample(BDRLOG, resample_100m, method = "bilinear")
names(BDRLOG) <- "BDRLOG"
BDRLOGi <- RF_ImputeRast(r = BDRLOG, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BDRLOG <- BDRLOGi[[1]]
rm(BDRLOGi)



# Absolute depth to bedrock	cm
BDTICM <- rast(paste0(wd$data_r, "SoilGrids/BDTICM.tif"))
BDTICM[BDTICM == 0] <- NA
BDTICM <- focal(BDTICM, w=5, fun='max', na.policy="only", na.rm=T)
BDTICM <- focal(BDTICM, w=5, fun='max', na.policy="only", na.rm=T)
BDTICM <- resample(BDTICM, resample_100m, method = "bilinear")
names(BDTICM) <- "BDTICM"
BDTICMi <- RF_ImputeRast(r = BDTICM, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BDTICM <- BDTICMi[[1]]
rm(BDTICMi)

# World Reference Base (2006) Soil Groups
WRB <- rast(paste0(wd$data_r, "SoilGrids/WRB.tif"))
WRB <- as.factor(WRB)
cls = levels(WRB)[[1]] %>% select(-WRB) %>%
  mutate(WRB = case_when(
    ID == 0 ~ "NoData",
    ID == 3 ~ "Andosols",
    ID == 4 ~ "Arenosols",
    ID == 5 ~ "Calcisols",
    ID == 6 ~ "Cambisols",
    ID == 9 ~ "Durisols",
    ID == 11 ~ "Fluvisols",
    ID == 12 ~ "Gleysols",
    ID == 16 ~ "Leptosols",
    ID == 18 ~ "Luvisols",
    ID == 20 ~ "Phaeozems",
    ID == 24 ~ "Regosols",
    ID == 25 ~ "Solonchaks",
    ID == 26 ~ "Solonetz",
    ID == 28 ~ "Umbrisols",
    ID == 29 ~ "Vertisols"))
names(WRB) <- "WRB"
levels(WRB) <- cls
WRB <- resample(WRB, resample_100m, method = "near")

# Bulk Density
BD_0_5 <- raster(paste0(wd$data_r, "SoilGrids/BD_0_5.tif"))
BD_0_5[BD_0_5 == 0] <- NA
BD_5_15 <- raster(paste0(wd$data_r, "SoilGrids/BD_5_15.tif"))
BD_5_15[BD_5_15 == 0] <- NA
BD_15_30 <- raster(paste0(wd$data_r, "SoilGrids/BD_15_30.tif"))
BD_15_30[BD_15_30 == 0] <- NA
BD = stack(BD_0_5, BD_5_15, BD_15_30)
BD = weighted.mean(BD, DepthWeights, na.rm=T)
BD <- resample(rast(BD), resample_100m, method = "bilinear")
rm(BD_0_5, BD_5_15, BD_15_30)
names(BD) <- "BD"
BDi <- RF_ImputeRast(r = BD, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
BD <- BDi[[1]]
rm(BDi)

# Clay fraction
C_0_5 <- raster(paste0(wd$data_r, "SoilGrids/C_0_5.tif"))
C_0_5[C_0_5 == 0] <- NA
C_5_15 <- raster(paste0(wd$data_r, "SoilGrids/C_5_15.tif"))
C_5_15[C_5_15 == 0] <- NA
C_15_30 <- raster(paste0(wd$data_r, "SoilGrids/C_15_30.tif"))
C_15_30[C_15_30 == 0] <- NA
C = stack(C_0_5, C_5_15, C_15_30)
C = weighted.mean(C, DepthWeights, na.rm=T)
C <- resample(rast(C), resample_100m, method = "bilinear")
rm(C_0_5, C_5_15, C_15_30)
names(C) <- "C"
Ci <- RF_ImputeRast(r = C, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
C <- Ci[[1]]
rm(Ci)

# Silt fraction
Z_0_5 <- raster(paste0(wd$data_r, "SoilGrids/Z_0_5.tif"))
Z_0_5[Z_0_5 == 0] <- NA
Z_5_15 <- raster(paste0(wd$data_r, "SoilGrids/Z_5_15.tif"))
Z_5_15[Z_5_15 == 0] <- NA
Z_15_30 <- raster(paste0(wd$data_r, "SoilGrids/Z_15_30.tif"))
Z_15_30[Z_15_30 == 0] <- NA
Z = stack(Z_0_5, Z_5_15, Z_15_30)
Z = weighted.mean(Z, DepthWeights, na.rm=T)
Z <- resample(rast(Z), resample_100m, method = "bilinear")
rm(Z_0_5, Z_5_15, Z_15_30)
names(Z) <- "Z"
Zi <- RF_ImputeRast(r = Z, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
Z <- Zi[[1]]
rm(Zi)

# Sand fraction
S_0_5 <- raster(paste0(wd$data_r, "SoilGrids/S_0_5.tif"))
S_0_5[S_0_5 == 0] <- NA
S_5_15 <- raster(paste0(wd$data_r, "SoilGrids/S_5_15.tif"))
S_5_15[S_5_15 == 0] <- NA
S_15_30 <- raster(paste0(wd$data_r, "SoilGrids/S_15_30.tif"))
S_15_30[S_15_30 == 0] <- NA
S = stack(S_0_5, S_5_15, S_15_30)
S = weighted.mean(S, DepthWeights, na.rm=T)
S <- resample(rast(S), resample_100m, method = "bilinear")
rm(S_0_5, S_5_15, S_15_30)
names(S) <- "S"
Si <- RF_ImputeRast(r = S, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
S <- Si[[1]]
rm(Si)

# Soil Organic Carbon content
SOC_0_5 <- raster(paste0(wd$data_r, "SoilGrids/SOC_0_5.tif"))
SOC_0_5[SOC_0_5 == 0] <- NA
SOC_5_15 <- raster(paste0(wd$data_r, "SoilGrids/SOC_5_15.tif"))
SOC_5_15[SOC_5_15 == 0] <- NA
SOC_15_30 <- raster(paste0(wd$data_r, "SoilGrids/SOC_15_30.tif"))
SOC_15_30[SOC_15_30 == 0] <- NA
SOC = stack(SOC_0_5, SOC_5_15, SOC_15_30)
SOC = weighted.mean(SOC, DepthWeights, na.rm=T)
SOC <- resample(rast(SOC), resample_100m, method = "bilinear")
rm(SOC_0_5, SOC_5_15, SOC_15_30)
names(SOC) <- "SOC"
SOCi <- RF_ImputeRast(r = SOC, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
SOC <- SOCi[[1]]
rm(SOCi)

# Cation Exchange Capacity
CEC_0_5 <- raster(paste0(wd$data_r, "SoilGrids/CEC_0_5.tif"))
CEC_0_5[CEC_0_5 == 0] <- NA
CEC_5_15 <- raster(paste0(wd$data_r, "SoilGrids/CEC_5_15.tif"))
CEC_5_15[CEC_5_15 == 0] <- NA
CEC_15_30 <- raster(paste0(wd$data_r, "SoilGrids/CEC_15_30.tif"))
CEC_15_30[CEC_15_30 == 0] <- NA
CEC = stack(CEC_0_5, CEC_5_15, CEC_15_30)
CEC = weighted.mean(CEC, DepthWeights, na.rm=T)
CEC <- resample(rast(CEC), resample_100m, method = "bilinear")
rm(CEC_0_5, CEC_5_15, CEC_15_30)
names(CEC) <- "CEC"
CECi <- RF_ImputeRast(r = CEC, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
CEC <- CECi[[1]]
rm(CECi)

# Organic Carbon Density
OCD_0_5 <- raster(paste0(wd$data_r, "SoilGrids/OCD_0_5.tif"))
OCD_0_5[OCD_0_5 == 0] <- NA
OCD_5_15 <- raster(paste0(wd$data_r, "SoilGrids/OCD_5_15.tif"))
OCD_5_15[OCD_5_15 == 0] <- NA
OCD_15_30 <- raster(paste0(wd$data_r, "SoilGrids/OCD_15_30.tif"))
OCD_15_30[OCD_15_30 == 0] <- NA
OCD = stack(OCD_0_5, OCD_5_15, OCD_15_30)
OCD = weighted.mean(OCD, DepthWeights, na.rm=T)
OCD <- resample(rast(OCD), resample_100m, method = "bilinear")
rm(OCD_0_5, OCD_5_15, OCD_15_30)
names(OCD) <- "OCD"
OCDi <- RF_ImputeRast(r = OCD, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
OCD <- OCDi[[1]]
rm(OCDi)

# Nitrogen
N_0_5 <- raster(paste0(wd$data_r, "SoilGrids/N_0_5.tif"))
N_0_5[N_0_5 == 0] <- NA
N_5_15 <- raster(paste0(wd$data_r, "SoilGrids/N_5_15.tif"))
N_5_15[N_5_15 == 0] <- NA
N_15_30 <- raster(paste0(wd$data_r, "SoilGrids/N_15_30.tif"))
N_15_30[N_15_30 == 0] <- NA
N = stack(N_0_5, N_5_15, N_15_30)
N = weighted.mean(N, DepthWeights, na.rm=T)
N <- resample(rast(N), resample_100m, method = "bilinear")
rm(N_0_5, N_5_15, N_15_30)
names(N) <- "N"
Ni <- RF_ImputeRast(r = N, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
N <- Ni[[1]]
rm(Ni)

#Soil organic carbon stock
SOCS <- rast(paste0(wd$data_r, "SoilGrids/SOCS_0_30.tif"))
SOCS[SOCS == 0] <- NA
SOCS <- resample(SOCS, resample_100m, method = "bilinear")
names(SOCS) <- "SOCS"
SOCSi <- RF_ImputeRast(r = SOCS, covs = c(DEM_r,Slope), Mask = m, SampFrac = 0.3, save_mem = FALSE)
SOCS <- SOCSi[[1]]
rm(SOCSi)

#Stack Rasters
Soil = c(BDRICM, BDRLOG, BDTICM, BD, S, Z, C, SOC, CEC, OCD, N, SOCS, WRB)

# Export Soil Raster Stack
writeRaster(Soil, filename = paste0(wd$data_p, "Soil_r_resampled.tif"), overwrite=TRUE)

#Remove unnecessary variables
rm(DEM_r, Slope, DepthWeights, m)
rm(BDRICM, BDRLOG, BDTICM, BD, S, Z, C, SOC, CEC, OCD, N, SOCS, WRB)

```


### Function to Interpolate Missing Soil Raster Values Using Random Forest Model

```{r, label='Function for RF soil raster imputation of missing values', message=FALSE,warning=FALSE, eval = FALSE}

resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
resample_100m <- disagg(resample_30m, 3)
resample_100m <- aggregate(resample_100m, 10)

DEM_r <- TopoEnv_r[[1]]
Slope <- TopoEnv_r[[2]]
Municipios2000s <- st_read(paste0(wd$data_r, "AG_Model_2000s/CMex_Municipios_2000s.gpkg"))

resample_100m_b = resample_100m
values(resample_100m_b) <- 1
m <- mask(resample_100m_b, Municipios2000s)#Data2000s_poly)

r = SOCS
rnam = names(r)
covs = c(DEM_r,Slope)
Mask = m
SampFrac = 0.3
save_mem = FALSE

library(tidyverse)
library(terra)
library(ranger)

RF_ImputeRast <- function(r, # Terra SpatRast raster object
                          rnam = names(r), # name for df variable for raster values from focal SpatRast object
                          covs = NULL, # Terra SpatRast raster object with 1 or more stacked layers 
                          Mask = NULL, # mask of focal area under consideration. Used in reducing the sample for the training dataset; training dataset first excludes areas outside of the mask before applying the sampling fraction
                          SampFrac = 0.3, # sampling fraction for training dataset; applied after mask exclusions, if present (see Mask, above)
                          save_mem = FALSE # whether the save.memory parameter should be used for the ranger random forest function
) {
  
  if (!is.null(Mask)){
    m_df = Terra_df(Mask, "mask")
    names(m_df) <- c("x", "y", "mask", "outside")
    r_df = Terra_df(r, rnam)
    r_df = merge(r_df, m_df, all = F, sort = F)
  } else {
    r_df = Terra_df(r, rnam)
  }
  
  if (!is.null(covs)){
    out_list <- list()  # or result_vector <- c()
    for (i in 1:nlyr(covs)) {
      out_list[[i]] = Terra_df(covs[[i]], names(covs[[i]]))
      out_list[[i]] = out_list[[i]] %>% select(-na_cells)
    }
    covs_df <- Reduce(function(x, y) merge(x, y, all = F, sort = F), out_list)
    r_df = merge(r_df, covs_df, all = F, sort = F)
  }
  
  if (!is.null(Mask)){
    
    train = r_df %>% filter(outside == F) %>% filter(complete.cases(.)) %>% 
      select(-na_cells, -outside, -mask) %>% sample_frac(SampFrac)
    
  } else {
    
    train = r_df %>% filter(complete.cases(.)) %>% select(-na_cells) %>% 
      sample_frac(SampFrac)
  }
  
  f <- names(train)
  f <- f[f != names(r)]
  form <- paste(names(r), "~", paste(f, collapse = " + "))
  form <- as.formula(form)
  
  model <- ranger(
    formula = form,
    data = train,
    save.memory = save_mem 
  )
  
  if (!is.null(Mask)){
    
    pred = r_df %>% select(-na_cells, -outside, -mask) %>% select(-!!sym(rnam)) %>% filter(complete.cases(.))
    
  } else {
    
    pred = r_df %>% select(-na_cells) %>% select(-!!sym(rnam)) %>% filter(complete.cases(.))
    
  }
  
  predicted_vals <- predict(model, pred)
  pred$pred <- predicted_vals$predictions
  
  x = r_df %>% left_join(pred, by = f)
  
  r2 = r
  raster_values <- values(r2)
  missing_values <- is.na(raster_values)
  df_values <- x$pred[missing_values]
  r2[missing_values] <- df_values
  names(r2) <- rnam
  
  out <- list()
  out[[1]] <- r2
  out[[2]] <- model$r.squared
  out[[3]] <- model$prediction.error
  out[[4]] <- model$num.trees
  
  return(out)
}


writeRaster(r2,paste0(wd$data_r,"C_RF_interpolated.tif"), overwrite=TRUE)


```





# Climate Data

```{r, label='Load and Resample Climate Rasters', message=FALSE,warning=FALSE}
chwd = "D:/Dropbox (ASU)/AztecAgricultureModel/GIS_Data/CHELSA/"
prj = "+proj=utm +zone=14 +datum=WGS84 +units=m +no_defs"
t <- raster(paste0(wd$data_r, "TopoEnvData.tif"))
EXT <- projectRaster(t[[1]], crs = "+proj=longlat +datum=WGS84 +no_defs")
###############################################
#resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
#resample_100m <- disagg(resample_30m, 3)
#resample_100m <- aggregate(resample_100m, 10)
###############################################
mo = c(31,28,31,30,31,30,31,31,30,31,30,31)
#divide_layer <- function(x, y) {
#  x / y
#}

# precipitation amount; amount refeers to means mass per unit area. precipitation in the earth's
# atmosphere means precipitation of water in all phases.

prec_01 = raster(paste0(chwd, "prec/CHELSA_prec_01_V1.2_land.tif"))
prec_02 = raster(paste0(chwd, "prec/CHELSA_prec_02_V1.2_land.tif"))
prec_03 = raster(paste0(chwd, "prec/CHELSA_prec_03_V1.2_land.tif"))
prec_04 = raster(paste0(chwd, "prec/CHELSA_prec_04_V1.2_land.tif"))
prec_05 = raster(paste0(chwd, "prec/CHELSA_prec_05_V1.2_land.tif"))
prec_06 = raster(paste0(chwd, "prec/CHELSA_prec_06_V1.2_land.tif"))
prec_07 = raster(paste0(chwd, "prec/CHELSA_prec_07_V1.2_land.tif"))
prec_08 = raster(paste0(chwd, "prec/CHELSA_prec_08_V1.2_land.tif"))
prec_09 = raster(paste0(chwd, "prec/CHELSA_prec_09_V1.2_land.tif"))
prec_10 = raster(paste0(chwd, "prec/CHELSA_prec_10_V1.2_land.tif"))
prec_11 = raster(paste0(chwd, "prec/CHELSA_prec_11_V1.2_land.tif"))
prec_12 = raster(paste0(chwd, "prec/CHELSA_prec_12_V1.2_land.tif"))
prec = stack(prec_01, prec_02, prec_03, prec_04, prec_05, prec_06, prec_07, prec_08, prec_09, prec_10, prec_11, prec_12)
prec <- crop(prec, EXT)
prec <- projectRaster(prec, crs = prj)
for (i in 1:nlayers(prec)) {
  prec[[i]] = prec[[i]]/mo[i]
}
names(prec) <- c("prec_01", "prec_02", "prec_03", "prec_04", "prec_05", "prec_06", "prec_07", "prec_08", "prec_09", "prec_10", "prec_11", "prec_12")
rm(prec_01, prec_02, prec_03, prec_04, prec_05, prec_06, prec_07, prec_08, prec_09, prec_10, prec_11, prec_12)
prec <- rast(prec)
prec_r <- resample(prec, resample_100m, method = "bilinear")
rm(prec)
#writeRaster(prec_r, filename = paste0(wd$data_r, "prec_r.tif"))


# daily mean air temperatures at 2 metres averaged over 1 month
tmean_01 = raster(paste0(chwd, "temp/CHELSA_temp10_01_1979-2013_V1.2_land.tif"))
tmean_02 = raster(paste0(chwd, "temp/CHELSA_temp10_02_1979-2013_V1.2_land.tif"))
tmean_03 = raster(paste0(chwd, "temp/CHELSA_temp10_03_1979-2013_V1.2_land.tif"))
tmean_04 = raster(paste0(chwd, "temp/CHELSA_temp10_04_1979-2013_V1.2_land.tif"))
tmean_05 = raster(paste0(chwd, "temp/CHELSA_temp10_05_1979-2013_V1.2_land.tif"))
tmean_06 = raster(paste0(chwd, "temp/CHELSA_temp10_06_1979-2013_V1.2_land.tif"))
tmean_07 = raster(paste0(chwd, "temp/CHELSA_temp10_07_1979-2013_V1.2_land.tif"))
tmean_08 = raster(paste0(chwd, "temp/CHELSA_temp10_08_1979-2013_V1.2_land.tif"))
tmean_09 = raster(paste0(chwd, "temp/CHELSA_temp10_09_1979-2013_V1.2_land.tif"))
tmean_10 = raster(paste0(chwd, "temp/CHELSA_temp10_10_1979-2013_V1.2_land.tif"))
tmean_11 = raster(paste0(chwd, "temp/CHELSA_temp10_11_1979-2013_V1.2_land.tif"))
tmean_12 = raster(paste0(chwd, "temp/CHELSA_temp10_12_1979-2013_V1.2_land.tif"))
tmean = stack(tmean_01, tmean_02, tmean_03, tmean_04, tmean_05, tmean_06, tmean_07, tmean_08, tmean_09, tmean_10, tmean_11, tmean_12)
tmean <- crop(tmean, EXT)
tmean <- projectRaster(tmean, crs = prj)
names(tmean) <- c("tmean_01", "tmean_02", "tmean_03", "tmean_04", "tmean_05", "tmean_06", "tmean_07", "tmean_08", "tmean_09", "tmean_10", "tmean_11", "tmean_12")
rm(tmean_01, tmean_02, tmean_03, tmean_04, tmean_05, tmean_06, tmean_07, tmean_08, tmean_09, tmean_10, tmean_11, tmean_12)
tmean_r <- rast(tmean)
tmean_r <- resample(tmean_r, resample_100m, method = "bilinear")
rm(tmean)

# daily maximum air temperatures at 2 metres averaged over 1 month
tmax_01 = raster(paste0(chwd, "tmax/CHELSA_tmax10_01_1979-2013_V1.2_land.tif"))
tmax_02 = raster(paste0(chwd, "tmax/CHELSA_tmax10_02_1979-2013_V1.2_land.tif"))
tmax_03 = raster(paste0(chwd, "tmax/CHELSA_tmax10_03_1979-2013_V1.2_land.tif"))
tmax_04 = raster(paste0(chwd, "tmax/CHELSA_tmax10_04_1979-2013_V1.2_land.tif"))
tmax_05 = raster(paste0(chwd, "tmax/CHELSA_tmax10_05_1979-2013_V1.2_land.tif"))
tmax_06 = raster(paste0(chwd, "tmax/CHELSA_tmax10_06_1979-2013_V1.2_land.tif"))
tmax_07 = raster(paste0(chwd, "tmax/CHELSA_tmax10_07_1979-2013_V1.2_land.tif"))
tmax_08 = raster(paste0(chwd, "tmax/CHELSA_tmax10_08_1979-2013_V1.2_land.tif"))
tmax_09 = raster(paste0(chwd, "tmax/CHELSA_tmax10_09_1979-2013_V1.2_land.tif"))
tmax_10 = raster(paste0(chwd, "tmax/CHELSA_tmax10_10_1979-2013_V1.2_land.tif"))
tmax_11 = raster(paste0(chwd, "tmax/CHELSA_tmax10_11_1979-2013_V1.2_land.tif"))
tmax_12 = raster(paste0(chwd, "tmax/CHELSA_tmax10_12_1979-2013_V1.2_land.tif"))
tmax = stack(tmax_01, tmax_02, tmax_03, tmax_04, tmax_05, tmax_06, tmax_07, tmax_08, tmax_09, tmax_10, tmax_11, tmax_12)
tmax <- crop(tmax, EXT)
tmax <- projectRaster(tmax, crs = prj)
names(tmax) <- c("tmax_01", "tmax_02", "tmax_03", "tmax_04", "tmax_05", "tmax_06", "tmax_07", "tmax_08", "tmax_09", "tmax_10", "tmax_11", "tmax_12")
rm(tmax_01, tmax_02, tmax_03, tmax_04, tmax_05, tmax_06, tmax_07, tmax_08, tmax_09, tmax_10, tmax_11, tmax_12)
tmax_r <- rast(tmax)
tmax_r <- resample(tmax_r, resample_100m, method = "bilinear")
rm(tmax)

# daily minimum air temperatures at 2 metres averaged over 1 month
tmin_01 = raster(paste0(chwd, "tmin/CHELSA_tmin10_01_1979-2013_V1.2_land.tif"))
tmin_02 = raster(paste0(chwd, "tmin/CHELSA_tmin10_02_1979-2013_V1.2_land.tif"))
tmin_03 = raster(paste0(chwd, "tmin/CHELSA_tmin10_03_1979-2013_V1.2_land.tif"))
tmin_04 = raster(paste0(chwd, "tmin/CHELSA_tmin10_04_1979-2013_V1.2_land.tif"))
tmin_05 = raster(paste0(chwd, "tmin/CHELSA_tmin10_05_1979-2013_V1.2_land.tif"))
tmin_06 = raster(paste0(chwd, "tmin/CHELSA_tmin10_06_1979-2013_V1.2_land.tif"))
tmin_07 = raster(paste0(chwd, "tmin/CHELSA_tmin10_07_1979-2013_V1.2_land.tif"))
tmin_08 = raster(paste0(chwd, "tmin/CHELSA_tmin10_08_1979-2013_V1.2_land.tif"))
tmin_09 = raster(paste0(chwd, "tmin/CHELSA_tmin10_09_1979-2013_V1.2_land.tif"))
tmin_10 = raster(paste0(chwd, "tmin/CHELSA_tmin10_10_1979-2013_V1.2_land.tif"))
tmin_11 = raster(paste0(chwd, "tmin/CHELSA_tmin10_11_1979-2013_V1.2_land.tif"))
tmin_12 = raster(paste0(chwd, "tmin/CHELSA_tmin10_12_1979-2013_V1.2_land.tif"))
tmin = stack(tmin_01, tmin_02, tmin_03, tmin_04, tmin_05, tmin_06, tmin_07, tmin_08, tmin_09, tmin_10, tmin_11, tmin_12)
tmin <- crop(tmin, EXT)
tmin <- projectRaster(tmin, crs = prj)
names(tmin) <- c("tmin_01", "tmin_02", "tmin_03", "tmin_04", "tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10", "tmin_11", "tmin_12")
rm(tmin_01, tmin_02, tmin_03, tmin_04, tmin_05, tmin_06, tmin_07, tmin_08, tmin_09, tmin_10, tmin_11, tmin_12)
tmin_r <- rast(tmin)
tmin_r <- resample(tmin_r, resample_100m, method = "bilinear")
rm(tmin)

# Precipitation amount"Amount" means mass per unit area. "Precipitation" in the
# earth's atmosphere means precipitation of water in all phases.

pr_01 = raster(paste0(chwd, "pr/CHELSA_pr_01_1981-2010_V.2.1.tif"))
pr_02 = raster(paste0(chwd, "pr/CHELSA_pr_02_1981-2010_V.2.1.tif"))
pr_03 = raster(paste0(chwd, "pr/CHELSA_pr_03_1981-2010_V.2.1.tif"))
pr_04 = raster(paste0(chwd, "pr/CHELSA_pr_04_1981-2010_V.2.1.tif"))
pr_05 = raster(paste0(chwd, "pr/CHELSA_pr_05_1981-2010_V.2.1.tif"))
pr_06 = raster(paste0(chwd, "pr/CHELSA_pr_06_1981-2010_V.2.1.tif"))
pr_07 = raster(paste0(chwd, "pr/CHELSA_pr_07_1981-2010_V.2.1.tif"))
pr_08 = raster(paste0(chwd, "pr/CHELSA_pr_08_1981-2010_V.2.1.tif"))
pr_09 = raster(paste0(chwd, "pr/CHELSA_pr_09_1981-2010_V.2.1.tif"))
pr_10 = raster(paste0(chwd, "pr/CHELSA_pr_10_1981-2010_V.2.1.tif"))
pr_11 = raster(paste0(chwd, "pr/CHELSA_pr_11_1981-2010_V.2.1.tif"))
pr_12 = raster(paste0(chwd, "pr/CHELSA_pr_12_1981-2010_V.2.1.tif"))
pr = stack(pr_01, pr_02, pr_03, pr_04, pr_05, pr_06, pr_07, pr_08, pr_09, pr_10, pr_11, pr_12)
pr <- crop(pr, EXT)
pr <- projectRaster(pr, crs = prj)
for (i in 1:nlayers(pr)) {
  pr[[i]] = pr[[i]]/mo[i]
}
names(pr) <- c("pr_01", "pr_02", "pr_03", "pr_04", "pr_05", "pr_06", "pr_07", "pr_08", "pr_09", "pr_10", "pr_11", "pr_12")
rm(pr_01, pr_02, pr_03, pr_04, pr_05, pr_06, pr_07, pr_08, pr_09, pr_10, pr_11, pr_12)
pr_r <- rast(pr)
pr_r <- resample(pr_r, resample_100m, method = "bilinear")
###rm(pr)

# Total % cloud cover for each month
clt_01 = raster(paste0(chwd, "clt/CHELSA_clt_01_1981-2010_V.2.1.tif"))
clt_02 = raster(paste0(chwd, "clt/CHELSA_clt_02_1981-2010_V.2.1.tif"))
clt_03 = raster(paste0(chwd, "clt/CHELSA_clt_03_1981-2010_V.2.1.tif"))
clt_04 = raster(paste0(chwd, "clt/CHELSA_clt_04_1981-2010_V.2.1.tif"))
clt_05 = raster(paste0(chwd, "clt/CHELSA_clt_05_1981-2010_V.2.1.tif"))
clt_06 = raster(paste0(chwd, "clt/CHELSA_clt_06_1981-2010_V.2.1.tif"))
clt_07 = raster(paste0(chwd, "clt/CHELSA_clt_07_1981-2010_V.2.1.tif"))
clt_08 = raster(paste0(chwd, "clt/CHELSA_clt_08_1981-2010_V.2.1.tif"))
clt_09 = raster(paste0(chwd, "clt/CHELSA_clt_09_1981-2010_V.2.1.tif"))
clt_10 = raster(paste0(chwd, "clt/CHELSA_clt_10_1981-2010_V.2.1.tif"))
clt_11 = raster(paste0(chwd, "clt/CHELSA_clt_11_1981-2010_V.2.1.tif"))
clt_12 = raster(paste0(chwd, "clt/CHELSA_clt_12_1981-2010_V.2.1.tif"))
clt = stack(clt_01, clt_02, clt_03, clt_04, clt_05, clt_06, clt_07, clt_08, clt_09, clt_10, clt_11, clt_12)
clt <- crop(clt, EXT)
clt <- projectRaster(clt, crs = prj)
# Resample to new resolution
r2 = raster(extent(pr), resolution = c(875, 922), crs = crs(pr))
clt <- resample(clt, r2, method = "bilinear")
names(clt) <- c("clt_01", "clt_02", "clt_03", "clt_04", "clt_05", "clt_06", "clt_07", "clt_08", "clt_09", "clt_10", "clt_11", "clt_12")
rm(clt_01, clt_02, clt_03, clt_04, clt_05, clt_06, clt_07, clt_08, clt_09, clt_10, clt_11, clt_12, r2)
clt_r <- rast(clt)
clt_r <- resample(clt_r, resample_100m, method = "bilinear")
rm(clt, pr)

# Surface downwelling shortwave flux in air
rsds_01 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_01_V.2.1.tif"))
rsds_02 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_02_V.2.1.tif"))
rsds_03 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_03_V.2.1.tif"))
rsds_04 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_04_V.2.1.tif"))
rsds_05 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_05_V.2.1.tif"))
rsds_06 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_06_V.2.1.tif"))
rsds_07 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_07_V.2.1.tif"))
rsds_08 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_08_V.2.1.tif"))
rsds_09 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_09_V.2.1.tif"))
rsds_10 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_10_V.2.1.tif"))
rsds_11 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_11_V.2.1.tif"))
rsds_12 = raster(paste0(chwd, "rsds/CHELSA_rsds_1981-2010_12_V.2.1.tif"))
rsds = stack(rsds_01, rsds_02, rsds_03, rsds_04, rsds_05, rsds_06, rsds_07, rsds_08, rsds_09, rsds_10, rsds_11, rsds_12)
rsds <- crop(rsds, EXT)
rsds <- projectRaster(rsds, crs = prj)
names(rsds) <- c("rsds_01", "rsds_02", "rsds_03", "rsds_04", "rsds_05", "rsds_06", "rsds_07", "rsds_08", "rsds_09", "rsds_10", "rsds_11", "rsds_12")
rm(rsds_01, rsds_02, rsds_03, rsds_04, rsds_05, rsds_06, rsds_07, rsds_08, rsds_09, rsds_10, rsds_11, rsds_12)
rsds_r <- rast(rsds)
rsds_r <- resample(rsds_r, resample_100m, method = "bilinear")
rm(rsds)


Clim_r <- c(prec_r,pr_r,tmean_r,tmax_r,tmin_r,clt_r,rsds_r)
#names(Clim_r)
writeRaster(Clim_r, filename = paste0(wd$data_p, "Clim_r_resampled.tif"), overwrite=TRUE, append=FALSE)


```



# Arable Area


Streams and their order
Elevation
Slope

0. Load
--DEM
--CONABIO_2015_LandUse_30m
--FASII_Centro_AG_LandUse -- THIS NEEDS TO BE CROPPED
--Mask for Tlaxcala, Hidalgo, Morelos + Some Municipios in DF
--

1. Rasterize 
--SIAP_2015_Fields
--FASII_Centro_AG_LandUse

2. Get all rasters on the same resolution

3. Calculate Topo Vars
--incl streams... geomorphons??
--curv

4. Separate into Training and Prediction
TRAINING
--modern fields in Tlax_Hgo_Mor_partsDF == Arable (Present) == MASK

Subtract modern fields from CONABIO_2015_LandUse_30m


--Sample inarable == Inrable (Absent) **after mask is applied**
Elevation == All areas >= 3100 masl
All Slopes over 30 degrees
All CONABIO_2015_LandUse_30m == 18 or 19
All geomorphons == 2
--Sampled areas from CONABIO_2015_LandUse_30m c(1:14, 16)
--Sampled geomorphons == 9 with higher accum
--Sampled BDRICM < 100
--Sampled BDRLOG > 40
--Sampled Elevation > 2850
--Sampled Slopes > 15

PREDICTION
all areas not in the SIAP_2015_Fields raster

5. Stack all of the data

~~~Predict Irrigation~~~
Both Training and Prediction within Predicted Arable Area
Irrigation sampled from Irrigation land use area (rasterized)

## Prepare Data


### Predictor Variables

```{r, label='Prepare Predictor Data', message=FALSE,warning=FALSE}

### DEM and Topographic Data ###

resample_30m <- rast(paste0(wd$data_r, "resample_30m.tif"))
DEM <- rast(paste0(wd$data_r,"DEM.tif"))
DEM <- resample(DEM, resample_30m, method = "bilinear")
writeRaster(DEM,paste0(wd$data_p,"DEM_30m.tif"), overwrite=TRUE)

TRI <- terra::terrain(DEM, v="TRI")# calc Terrain Ruggedness Index
slope <- terra::terrain(DEM, v="slope", unit="degrees")#Slope
writeRaster(slope,paste0(wd$data_p,"temp_rasts/Slope_30m.tif"), overwrite=TRUE)

wbt_breach_depressions(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/DEM_breach_30m.tif"))

wbt_d8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach_30m.tif"), output=paste0(wd$data_p,"temp_rasts/Accum_30m.tif"), out_type = "specific contributing area")

Accum <- rast(paste0(wd$data_p, "temp_rasts/Accum_30m.tif"))
wbt_wetness_index(sca=paste0(wd$data_p,"temp_rasts/Accum_30m.tif"), slope=paste0(wd$data_p,"temp_rasts/Slope_30m.tif"), output=paste0(wd$data_p,"temp_rasts/TWI_30m.tif"), verbose_mode = FALSE)
TWI <- rast(paste0(wd$data_p, "temp_rasts/TWI_30m.tif"))
TWI <- focal(TWI, w=17, fun='max', na.policy="only", na.rm=T)
wbt_stream_power_index(sca=paste0(wd$data_p,"temp_rasts/Accum_30m.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope_30m.tif"),output=paste0(wd$data_p,"temp_rasts/SPI_30m.tif"),exponent = 1)
SPI <- rast(paste0(wd$data_p, "temp_rasts/SPI_30m.tif"))
wbt_fd8_flow_accumulation(paste0(wd$data_p,"temp_rasts/DEM_breach_30m.tif"), output=paste0(wd$data_p,"temp_rasts/Accum_fd8_30m.tif"), out_type = "specific contributing area")
Accum_fd8 <- rast(paste0(wd$data_p, "temp_rasts/Accum_fd8_30m.tif"))
wbt_sediment_transport_index(sca=paste0(wd$data_p,"temp_rasts/Accum_fd8_30m.tif"),slope=paste0(wd$data_p,"temp_rasts/Slope_30m.tif"),output=paste0(wd$data_p,"temp_rasts/STI_30m.tif"))
STI <- rast(paste0(wd$data_p, "temp_rasts/STI_30m.tif"))

wbt_flood_order(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/flood_order_30m.tif"))
flood_order <- rast(paste0(wd$data_p, "temp_rasts/flood_order_30m.tif"))

#wbt_extract_valleys(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/valleys_lq_30m.tif"))
#valleys_lq <- rast(paste0(wd$data_p, "temp_rasts/valleys_lq_30m.tif"))

#wbt_elev_relative_to_watershed_min_max(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/elev_watershed_30m.tif"))
#elev_watershed <- rast(paste0(wd$data_p, "temp_rasts/elev_watershed_30m.tif"))

#wbt_vertical_excess_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_vert_excess_30m.tif"))
#curv_vert_excess <- rast(paste0(wd$data_p, "temp_rasts/curv_vert_excess_30m.tif"))

#wbt_horizontal_excess_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_horiz_excess_30m.tif"))
#curv_horiz_excess <- rast(paste0(wd$data_p, "temp_rasts/curv_horiz_excess_30m.tif"))

wbt_minimal_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_min_30m.tif"))
curv_min <- rast(paste0(wd$data_p, "temp_rasts/curv_min_30m.tif"))

wbt_maximal_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_max_30m.tif"))
curv_max <- rast(paste0(wd$data_p, "temp_rasts/curv_max_30m.tif"))

wbt_mean_curvature(dem = paste0(wd$data_p,"DEM_30m.tif"), output = paste0(wd$data_p,"temp_rasts/curv_mean_30m.tif"))
curv_mean <- rast(paste0(wd$data_p, "temp_rasts/curv_mean_30m.tif"))


Topo_r_30m <- c(DEM, slope, Accum_fd8, TRI, TWI, STI, SPI, flood_order, curv_min, curv_max, curv_mean) #valleys_lq, elev_watershed, curv_vert_excess, curv_horiz_excess,

names(Topo_r_30m) = c("DEM", "Slope", "Accum_fd8", "TRI", "TWI", "STI", "SPI", "flood_order", "curv_min", "curv_max", "curv_mean") #"valleys_lq", "elev_watershed", "curv_vert_excess", "curv_horiz_excess", 

rm(slope, Accum, Accum_fd8, TRI, TWI, STI, SPI, flood_order, curv_min, curv_max, curv_mean, nam)#valleys_lq, elev_watershed, curv_vert_excess, curv_horiz_excess, 

writeRaster(Topo_r_30m, filename = paste0(wd$data_p, "Topo_r_30m.tif"), overwrite=TRUE)
rm(Topo_r_30m)
#Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))

### Soil Data ###

Soil <- rast(paste0(wd$data_p, "Soil_r_resampled.tif"))

z <- resample(Soil[[1]], DEM, method = "bilinear")

for (i in 2:(nlyr(Soil)-1)) {
  a = resample(Soil[[i]], DEM, method = "bilinear")
  z = c(z,a)
}
WRB <- resample(Soil[[nlyr(Soil)]], DEM, method = "near") #Soil[[13]]
Soil_30m = c(z, WRB)
rm(z,a, Soil, WRB)

writeRaster(Soil_30m, filename = paste0(wd$data_p, "Soil_r_30m.tif"), overwrite=TRUE)
rm(Soil_30m)
#Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))


### Geomorphons ###


Geomorphons <- rast(paste0(wd$data_p,"CMex_30m_Geomorphons.tif"))
Geomorphons <- as.factor(Geomorphons)
levels(Geomorphons) = as.data.frame(levels(Geomorphons)[[1]]) %>% select(-Geomorphons) %>%
  mutate(Geomorphons = case_when(
    ID == 1 ~ "Flat",
    ID == 2 ~ "Summit",
    ID == 3 ~ "Ridge",
    ID == 4 ~ "Shoulder",
    ID == 5 ~ "Spur",
    ID == 6 ~ "Slope",
    ID == 7 ~ "Hollow",
    ID == 8 ~ "Footslope",
    ID == 9 ~ "Valley",
    ID == 10 ~ "Depression"))
#Geomorphons <- resample(Geomorphons, DEM, method = "near")
writeRaster(Geomorphons, filename = paste0(wd$data_p, "CMex_30m_Geomorphons.tif"), overwrite=TRUE)
rm(Geomorphons)
#Geomorphons <- rast(paste0(wd$data_p,"CMex_30m_Geomorphons.tif"))


CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_r,"CONABIO_2015_LandUse_30m.tif"))
CONABIO_2015_LandUse_30m <- as.factor(CONABIO_2015_LandUse_30m)
levels(CONABIO_2015_LandUse_30m) = levels(CONABIO_2015_LandUse_30m)[[1]] %>% select(-CONABIO_2015_LandUse_30m) %>%
  mutate(
    #LandUse = case_when(
            #ID == 1 ~ "Forest_Coniferous_Temperate",
            #ID == 2 ~ "Forest_Coniferous_Subpolar",
            #ID == 3 ~ "Forest_Evergreen_Subtropical",
            #ID == 4 ~ "Forest_Deciduous_Subtropical",
            #ID == 5 ~ "Forest_Deciduous_Temperate",
            #ID == 6 ~ "Forest_Mixed",
            #ID == 7 ~ "Scrub_Subtropical",
            #ID == 8 ~ "Scrub_Temperate",
            #ID == 9 ~ "Grass_Subtropical",
            #ID == 10 ~ "Grass_Temperate",
            #ID == 14 ~ "Wetland",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Bare_Soil",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Water",
            #ID == 19 ~ "Glacial"),
        #LandUseGroups = case_when(
            #ID == 1 ~ "Forest_High",
            #ID == 2 ~ "Forest_High",
            #ID == 3 ~ "Forest_Low",
            #ID == 4 ~ "Forest_Low",
            #ID == 5 ~ "Forest_Low",
            #ID == 6 ~ "Forest_Low",
            #ID == 7 ~ "Scrub",
            #ID == 8 ~ "Scrub",
            #ID == 9 ~ "Grass",
            #ID == 10 ~ "Grass",
            #ID == 14 ~ "Wetland",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Bare_Soil",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Water",
            #ID == 19 ~ "Glacial"),
        #Sampling = case_when(
            #ID == 1 ~ "Inarable_Sample_High",
            #ID == 2 ~ "Inarable_Sample_High",
            #ID == 3 ~ "Inarable_Sample_Med",
            #ID == 4 ~ "Inarable_Sample_Med",
            #ID == 5 ~ "Inarable_Sample_Med",
            #ID == 6 ~ "Inarable_Sample_Med",
            #ID == 7 ~ "Inarable_Sample_High",
            #ID == 8 ~ "Inarable_Sample_High",
            #ID == 9 ~ "Inarable_Sample_High",
            #ID == 10 ~ "Inarable_Sample_High",
            #ID == 14 ~ "Inarable_Sample_Med",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Inarable_Sample_High",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Inarable_All",
            #ID == 19 ~ "Inarable_All"),
        #Sampling2 = case_when(
            #ID == 1 ~ "Sample",
            #ID == 2 ~ "Sample",
            #ID == 3 ~ "Sample",
            #ID == 4 ~ "Sample",
            #ID == 5 ~ "Sample",
            #ID == 6 ~ "Sample",
            #ID == 7 ~ "Sample",
            #ID == 8 ~ "Sample",
            #ID == 9 ~ "Sample",
            #ID == 10 ~ "Sample",
            #ID == 14 ~ "Sample",
            #ID == 15 ~ "Agriculture",
            #ID == 16 ~ "Sample",
            #ID == 17 ~ "Settlement",
            #ID == 18 ~ "Inarable",
            #ID == 19 ~ "Inarable"),
        LandUseArchy = case_when(
            ID == 1 ~ "Unknown",
            ID == 2 ~ "Unknown",
            ID == 3 ~ "Unknown",
            ID == 4 ~ "Unknown",
            ID == 5 ~ "Unknown",
            ID == 6 ~ "Unknown",
            ID == 7 ~ "Unknown",
            ID == 8 ~ "Unknown",
            ID == 9 ~ "Unknown",
            ID == 10 ~ "Unknown",
            ID == 14 ~ "Wetland",
            ID == 15 ~ "Unknown",
            ID == 16 ~ "Unknown",
            ID == 17 ~ "Settlement",
            ID == 18 ~ "Water",
            ID == 19 ~ "Glacial"))

activeCat(CONABIO_2015_LandUse_30m) <- "LandUseArchy"

CONABIO_2015_LandUse_30m <- resample(CONABIO_2015_LandUse_30m, DEM, method = "near")
CONABIO_2015_LandUse_30m <- crop(CONABIO_2015_LandUse_30m, DEM)

writeRaster(CONABIO_2015_LandUse_30m, filename = paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"), overwrite=TRUE)
rm(CONABIO_2015_LandUse_30m)
#CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"))

#Clim_r <- rast(paste0(wd$data_p, "Clim_r_resampled.tif"))
#Clim_r_15m <- subset(Clim_r, c("tmin_04","tmin_05", "tmin_06", "tmin_07", "tmin_08", "tmin_09", "tmin_10","tmin_11"))
#Clim_r_15m <- resample(Clim_r, DEM, method = "bilinear")


```
r.carve - Generates stream channels.
Takes vector stream data, transforms it to raster and subtracts depth from the output DEM.
r.watershed - Calculates hydrological parameters and RUSLE factors.
r.terraflow - Performs flow computation for massive grids.
r.stream.extract - Performs stream network extraction.
SAGA Valley Depth

--Distance from streams
r.grow.distance

### Dependent Variables

```{r}
#########################################################

SIAP_2015_Mask <- vect(paste0(wd$data_r,"SIAP_2015_Mask.gpkg"))
SIAP_2015_Mask <- terra::rasterize(SIAP_2015_Mask, DEM, values = 1, background = NA)
writeRaster(SIAP_2015_Mask, filename = paste0(wd$data_p, "SIAP_2015_Mask.tif"), overwrite=TRUE)
rm(SIAP_2015_Mask)
#SIAP_2015_Mask <- rast(paste0(wd$data_p,"SIAP_2015_Mask.tif"))


SIAP_2015_Fields <- vect(paste0(wd$data_r,"SIAP_2015_Fields.gpkg"))
SIAP_2015_Fields <- rasterize(SIAP_2015_Fields, DEM, values = 1, background = 0)
SIAP_2015_Fields <- as.factor(SIAP_2015_Fields)
levels(SIAP_2015_Fields) = levels(SIAP_2015_Fields)[[1]] %>% select(-layer) %>%
  mutate(SIAP_2015_Fields = case_when(
    ID == 0 ~ "Uncultivated",
    ID == 1 ~ "Cultivated"))
writeRaster(SIAP_2015_Fields, filename = paste0(wd$data_p, "SIAP_2015_Fields.tif"), overwrite=TRUE)
rm(SIAP_2015_Fields)
#SIAP_2015_Fields <- rast(paste0(wd$data_p,"SIAP_2015_Fields.tif"))
#SIAP_2015_Fields <- mask(SIAP_2015_Fields, SIAP_2015_Mask)


#########################################################

CMex_Mask <- st_read(paste0(wd$data_r, "Municipios2000s_Data.gpkg"))
CMex_Mask = vect(CMex_Mask)
CMex_Mask <- terra::rasterize(CMex_Mask, DEM, values = 1, background = NA)
writeRaster(CMex_Mask, filename = paste0(wd$data_p, "CMex_Mask.tif"), overwrite=TRUE)
rm(CMex_Mask)
#CMex_Mask <- rast(paste0(wd$data_p,"CMex_Mask.tif"))


SIAP_LU_Fields <- st_read(paste0(wd$data_r, "Data2000s_poly_mod_Elevation.gpkg"))
SIAP_LU_Fields <- st_buffer(SIAP_LU_Fields, dist=-60)
#streams <- st_read(paste0(wd$data_r, "CMex_Streams.gpkg"))
#streams <- st_buffer(streams, dist=15)
#SIAP_LU_Fields <- st_difference(SIAP_LU_Fields, streams) 


SIAP_LU_Fields_AGType <- SIAP_LU_Fields %>% select(AGType) %>% 
  mutate(AGType = ifelse(AGType == "Riego", 2, 1))
SIAP_LU_Fields_AGType <- SIAP_LU_Fields_AGType %>% filter(!st_is_empty(.))
irrig <- SIAP_LU_Fields_AGType %>% filter(AGType == 2)
irrig = vect(irrig)
irrig <- terra::rasterize(irrig, DEM, values = 2, background = 0)
irrig <- ifel(irrig > 0, 2, 0)
temp <- SIAP_LU_Fields_AGType %>% filter(AGType == 1)
temp = vect(temp)
temp <- terra::rasterize(temp, DEM, values = 1, background = 0)
SIAP_LU_Fields_AGType <- irrig + temp
SIAP_LU_Fields_AGType <- ifel(SIAP_LU_Fields_AGType == 0, NA, SIAP_LU_Fields_AGType)
SIAP_LU_Fields_AGType <- as.factor(SIAP_LU_Fields_AGType)
levels(SIAP_LU_Fields_AGType) = levels(SIAP_LU_Fields_AGType)[[1]] %>% select(-layer) %>%
  mutate(SIAP_LU_Fields_AGType = case_when(
    ID == 1 ~ "Temporal",
    ID == 2 ~ "Irrigation"))
writeRaster(SIAP_LU_Fields_AGType, filename = paste0(wd$data_p, "SIAP_LU_Fields_AGType.tif"), overwrite=TRUE)
rm(SIAP_LU_Fields_AGType, streams, irrig, temp)
#SIAP_LU_Fields_AGType <- rast(paste0(wd$data_p,"SIAP_LU_Fields_AGType.tif"))
#SIAP_LU_Fields_AGType <- mask(SIAP_LU_Fields_AGType, CMex_Mask)


SIAP_LU_Fields = vect(SIAP_LU_Fields)
SIAP_LU_Fields <- rasterize(SIAP_LU_Fields, DEM, values = 1, background = 0)
SIAP_LU_Fields <- as.factor(SIAP_LU_Fields)
levels(SIAP_LU_Fields) = levels(SIAP_LU_Fields)[[1]] %>% select(-layer) %>%
  mutate(SIAP_LU_Fields = case_when(
    ID == 0 ~ "Uncultivated",
    ID == 1 ~ "Cultivated"))
writeRaster(SIAP_LU_Fields, filename = paste0(wd$data_p, "SIAP_LU_Fields.tif"), overwrite=TRUE)
rm(SIAP_LU_Fields)
#SIAP_LU_Fields <- rast(paste0(wd$data_p,"SIAP_LU_Fields.tif"))
#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)

rm(resample_30m)
```





### Shortcut Import #1

```{r, label='Shortcut', message=FALSE,warning=FALSE}

DEM <- rast(paste0(wd$data_p, "DEM_30m.tif"))

Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))

Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))

Geomorphons <- rast(paste0(wd$data_p, "CMex_30m_Geomorphons.tif"))

CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"))

SIAP_2015_Mask <- rast(paste0(wd$data_p,"SIAP_2015_Mask.tif"))

SIAP_2015_Fields <- rast(paste0(wd$data_p,"SIAP_2015_Fields.tif"))
SIAP_2015_Fields <- mask(SIAP_2015_Fields, SIAP_2015_Mask)

CMex_Mask <- rast(paste0(wd$data_p,"CMex_Mask.tif"))

SIAP_LU_Fields <- rast(paste0(wd$data_p,"SIAP_LU_Fields.tif"))
SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)

#SIAP_2015_Fields_f <- as.factor(SIAP_2015_Fields)
#levels(SIAP_2015_Fields_f) = levels(SIAP_2015_Fields_f)[[1]] %>% select(-layer) %>%
#  mutate(SIAP_2015_Fields = case_when(
#    ID == 0 ~ "Uncultivated",
#    ID == 1 ~ "Cultivated"))

#SIAP_2015_FieldsNA <- ifel(SIAP_2015_Fields == 0, NA, SIAP_2015_Fields)
#SIAP_LU_FieldsNA <- ifel(SIAP_LU_Fields == 0, NA, SIAP_LU_Fields)

#Inarable_Sampling_Area <- rast(paste0(wd$data_p, "Inarable_Sampling_Area.tif"))
#InarableSample1 <- rast(paste0(wd$data_p, "InarableSample1.tif"))
#InarableSample2 <- rast(paste0(wd$data_p, "InarableSample2.tif"))
#Inarable_Sampling_Area1 <- rast(paste0(wd$data_p, "Inarable_Sampling_Area1.tif"))
#Inarable_Sampling_Area2 <- rast(paste0(wd$data_p, "Inarable_Sampling_Area2.tif"))

#Predictors = c(Topo_r_30m, Soil_30m, Geomorphons, CONABIO_2015_LandUse_30m)
#Predictors_FieldsNA <- mask(Predictors, SIAP_2015_FieldsNA)
#Predictors = mask(Predictors, SIAP_2015_Mask)
```




### Combine Data

```{r}
#dat = "SIAP_2015_Fields"
dat = "SIAP_LU_Fields"

if (dat == "SIAP_LU_Fields") {
  Cultiv <- SIAP_LU_Fields
  x = c(Cultiv, CONABIO_2015_LandUse_30m, Geomorphons, Topo_r_30m, Soil_30m)
  #xf <- mask(x, SIAP_LU_FieldsNA)
  x = mask(x, SIAP_LU_Fields)
}
if (dat == "SIAP_2015_Fields") {
  Cultiv <- SIAP_2015_Fields
  x = c(Cultiv, CONABIO_2015_LandUse_30m, Geomorphons, Topo_r_30m, Soil_30m)
  #xf <- mask(x, SIAP_2015_FieldsNA)
  x = mask(x, SIAP_2015_Mask)
}

rm(Topo_r_30m, Soil_30m, CMex_Mask, SIAP_2015_Mask, SIAP_2015_Fields, SIAP_LU_Fields)

writeRaster(x, filename = paste0(wd$data_p, "Arable_Raster_Data.tif"), overwrite=TRUE)
rm(x, dat, Geomorphons, Cultiv, CONABIO_2015_LandUse_30m)

```

### Shortcut Import #2


```{r}

x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
Cultiv <- x[[1]]
CONABIO_2015_LandUse_30m <- x[[2]]
Geomorphons <- x[[3]]
#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)
```


### Prelim Stats



```{r}

Cultiv2 <- as.numeric(Cultiv)

#y = c(CONABIO_2015_LandUse_30m, Geomorphons)
fLU = freq(CONABIO_2015_LandUse_30m, usenames=T, zones=Cultiv2, wide=T)
fLU = fLU %>% mutate(zone = case_when(
    zone == 1 ~ "Uncultivated",
    zone == 2 ~ "Cultivated")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Unknown:Water))) %>% ungroup()
column_sums <- as.numeric(colSums(fLU[, -c(1:2)]))
y = as.matrix(fLU[, -c(1, 2)])
d = fLU[, c(1:2)]
fLU_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fLU[, -c(1:2)]))
fLU_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fWRB = freq(x[["WRB"]], usenames=T, zones=Cultiv2, wide=T)
fWRB = fWRB %>% mutate(zone = case_when(
    zone == 1 ~ "Uncultivated",
    zone == 2 ~ "Cultivated")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(NoData:Vertisols))) %>% ungroup()
column_sums <- as.numeric(colSums(fWRB[, -c(1:2)]))
y = as.matrix(fWRB[, -c(1, 2)])
d = fWRB[, c(1:2)]
fWRB_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fWRB[, -c(1:2)]))
fWRB_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fgeo = freq(Geomorphons, usenames=T, zones=Cultiv2, wide=T)
fgeo = fgeo %>% mutate(zone = case_when(
    zone == 1 ~ "Uncultivated",
    zone == 2 ~ "Cultivated")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Flat:Depression))) %>% ungroup()
column_sums <- as.numeric(colSums(fgeo[, -c(1:2)]))
y = as.matrix(fgeo[, -c(1, 2)])
d = fgeo[, c(1:2)]
fgeo_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fgeo[, -c(1:2)]))
fgeo_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

rm(column_sums, row_sums, y, d )

z1 = zonal(x[[4:nlyr(x)]], Cultiv2, fun="mean", na.rm=T)
z1$stat = "Mean"
z2 = zonal(x[[4:nlyr(x)]], Cultiv2, fun="min", na.rm=T)
z2$stat = "Min"
z3 = zonal(x[[4:nlyr(x)]], Cultiv2, fun="max", na.rm=T)
z3$stat = "Max"
z = rbind(z1, z2, z3) %>% mutate(zone = case_when(
    SIAP_LU_Fields == 0 ~ "Uncultivated",
    SIAP_LU_Fields == 1 ~ "Cultivated"))

rm(z1, z2, z3, Cultiv2)
```


### Raster Stack to Dataframe 

```{r}

x_df <- as.data.frame(x[[1]])
names(x_df) <- "Cultiv"
x_df <- rownames_to_column(x_df, var = "Cells")

for (i in 2:nlyr(x)) {
  
  t = as.data.frame(x[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(x[[i]]))
  x_df <- x_df %>% left_join(t, by="Cells")
  #Train_df <- cbind(Train_df, t[,1])
  #names(Train_df) <- c(names(Train_df)[1:(i-1)], names(Train[[i]]))
}
x_df = x_df[complete.cases(x_df), ]

write_csv(x_df, paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
rm(x_df)
Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))

Arable_RF_df <- Arable_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))
#%>%
  #rename(Cultivated = SIAP_2015_Fields_f)
Arable_RF_df = Arable_RF_df[complete.cases(Arable_RF_df), ]
```




### Histograms

```{r}

#Hist_DEM <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = DEM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Elevation (masl)", y = "Count") + theme_classic()

#Hist_Slope <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = Slope, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Slope (degrees)", y = "Count") + theme_classic()

#Hist_TRI <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = TRI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Topographic Roughness Index (TRI)", y = "Count") + theme_classic()

#Hist_TWI <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = TWI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Topographic Wetness Index (TWI)", y = "Count") + theme_classic()

#Hist_STI <- 
Arable_RF_df %>% filter(STI <= 100) %>% ggplot() +
geom_histogram(aes(x = STI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Sediment Transport Index (STI)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

#Hist_SPI <- 
Arable_RF_df %>% filter(SPI <= 1200) %>% ggplot() +
geom_histogram(aes(x = SPI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Stream Power Index (SPI)", y = "Count") + theme_classic()

#Hist_BDRICM <- 
Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRICM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Depth to bedrock up to 200cm (BDRICM)", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRLOG, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Probability of R horizon (BDRLOG)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = BDTICM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Absolute depth to bedrock in cm (BDTICM)", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_min, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Minimum Curvature", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_max, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Maximum Curvature", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_mean, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Mean Curvature", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = SOC, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Soil Organic Carbon", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = OCD, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Organic Carbon Density", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = N, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Nitrogen", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = SOCS, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Soil Organic Carbon Stock", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = S, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Sand", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = Z, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Silt", y = "Count") + theme_classic()

Arable_RF_df %>% ggplot() +
geom_histogram(aes(x = C, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "green"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "green4"), guide = "none")+
  labs(x ="Clay", y = "Count") + theme_classic()

```

 [1] "SIAP_LU_Fields" "LandUse"        "Geomorphons"    "DEM"            "Slope"          "Accum_fd8"      "TRI"            "TWI"            "STI"           
[10] "SPI"            "flood_order"    "curv_min"       "curv_max"       "curv_mean"      "BDRICM"         "BDRLOG"         "BDTICM"         "BD"            
[19] "S"              "Z"              "C"              "SOC"            "CEC"            "OCD"            "N"              "SOCS"           "WRB"   



### Shortcut Import #3


```{r}

x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
Cultiv <- x[[1]]
Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))

Arable_RF_df <- Arable_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

Arable_RF_df = Arable_RF_df[complete.cases(Arable_RF_df), ]
```




 [1] "SIAP_LU_Fields" "LandUse"        "Geomorphons"    "DEM"            "Slope"                "TRI"                  "STI"           
[10]           "curv_min"       "curv_max"       "curv_mean"      "BDRICM"         "BDRLOG"         "BDTICM"         "BD"            
[19]               "SOC"            "CEC"            "OCD"            "N"              "SOCS"           "WRB"   

 "SPI"  "Accum_fd8""TWI"        "flood_order" 
"S"              "Z"              "C"

### Subset Predictors

```{r}
#TopoEnv_r_sub <- subset(x, c("DEM", "Slope","Accum", "TRI", "TWI", "STI", "SPI"))

```



### Sampling the Dataframe

```{r}

Arable_RF_df <- Arable_RF_df %>% 
  mutate(#Problem = FALSE,
         #Cultiv_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, FALSE),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Water", TRUE, Problem),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Wetland", TRUE, Problem),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Settlement", TRUE, Problem),
         #Problem_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, Problem),
         
         
         #Cultiv_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, FALSE),
         Cultiv = ifelse(Cultiv == "Cultivated" & LandUse == "Water", "Uncultivated", Cultiv),
         Cultiv = ifelse(Cultiv == "Cultivated" & LandUse == "Wetland", "Uncultivated", Cultiv),
         Cultiv = ifelse(Cultiv == "Cultivated" & LandUse == "Settlement", "Uncultivated", Cultiv),
         #Cultiv = ifelse(Cultiv == "Cultivated" & DEM >= 3100, "Uncultivated", Cultiv),

         Inarable1_wt = 0,
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & DEM >= 3100, (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Water", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Wetland", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Settlement", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Glacial", (Inarable1_wt+1), Inarable1_wt),
         Inarable1 = ifelse(Inarable1_wt > 0, TRUE, FALSE),
         
         #Inarable_3100masl = ifelse(Cultiv == "Uncultivated" & DEM >= 3100, TRUE, FALSE),
         #Inarable_water = ifelse(Cultiv == "Uncultivated" & LandUse == "Water", TRUE, FALSE),
         #Inarable_wetland = ifelse(Cultiv == "Uncultivated" & LandUse == "Wetland", TRUE, FALSE),
         #Inarable_settlement = ifelse(Cultiv == "Uncultivated" & LandUse == "Settlement", TRUE, FALSE),
         #Inarable_glacial = ifelse(Cultiv == "Uncultivated" & LandUse == "Glacial", TRUE, FALSE),
         
         Inarable2_wt = 0,
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & DEM >= 2850 & DEM < 3100, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Slope > 15, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Accum_fd8 > xxx, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & STI > 15, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & TRI > 15, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SPI > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & TWI > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & flood_order > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & valleys_lq > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & elev_watershed > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_vert_excess > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_horiz_excess > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_min > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_max > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_mean > XXX, (Inarable2_wt+1), Inarable2_wt),
         
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDRLOG > 70, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDRICM < 40.79, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDTICM <= 3.36, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SOC > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BD > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & OCD > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & N > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SOCS > XXX, (Inarable2_wt+1), Inarable2_wt),
         
         
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Summit", (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Depression", (Inarable2_wt+1), Inarable2_wt),
         Inarable2 = ifelse(Inarable2_wt > 0, TRUE, FALSE),
         
         Arable = ifelse(Cultiv == "Cultivated" & Problem == FALSE, TRUE, FALSE),
         Arable_wt = ifelse(Cultiv == "Cultivated" & Problem == FALSE, 1, 0),
         
         wt = Inarable2_wt + Inarable2_wt + Arable_wt,
         
         Stratum = ifelse(Arable == TRUE, "ArableSample", Stratum),
         Stratum = case_when(
                Arable == TRUE ~ "ArableSample",
                Inarable1 == TRUE ~ "InarableSample1",
                Inarable2 == TRUE ~ "InarableSample2",
                .default = "Unsampled"),
         SampSize = case_when(
                Stratum == "ArableSample" ~ 225000,
                Stratum == "InarableSample1" ~ 50000,
                Stratum == "InarableSample2" ~ "125000",
                .default = 0))


Arable_RF_Train_df = Arable_RF_df %>% group_by(Stratum) %>%
  slice_sample(n = SampSize[1], weight_by = wt, replace = FALSE) #prop, by = NULL, 

write_csv(Arable_RF_Train_df, paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))
rm(Arable_RF_Train_df)
Arable_RF_Train_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))

tt = Arable_RF_Train_df %>% select(Cells) %>% mutate(TraningSample = TRUE)

Arable_RF_df = Arable_RF_df %>% left_join(tt, by = "Cells") %>%
  mutate(TraningSample = ifelse(TraningSample == TRUE, TRUE, FALSE),
         PredictionData = ifelse(TraningSample == TRUE, FALSE, TRUE))

rm(tt)

write_csv(Arable_RF_df, paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
rm(Arable_RF_df)
Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))

Arable_RF_Predict_df = Arable_RF_df %>% filter(PredictionData = T)
  
write_csv(Arable_RF_Predict_df, paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))
rm(Arable_RF_Predict_df)
Arable_RF_Predict_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))

rm(z, fgeo, fgeo_col_pc, fgeo_row_pc, fLU_row_pc, fLU_col_pc, fLU, CONABIO_2015_LandUse_30m, Geomorphons)

```



### Shortcut Import #4


```{r}

x <- rast(paste0(wd$data_p,"Arable_Raster_Data.tif"))
Cultiv <- x[[1]]
Arable_RF_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
Arable_RF_Predict_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))
Arable_RF_Train_df <- read_csv(paste0(wd$data_p,"ArableArea_RFModel_TrainData.csv.gz"))


#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)
```



## Random Forest Model

### Variable Selection

```{r}


boruta <- Boruta(Cultiv ~ ., data = Arable_RF_Train_df, maxRuns = 1000)#, doTrace = 2
print(boruta)
boruta[["finalDecision"]]
plot(boruta, las = 2, cex.axis = 0.7)
#bor <- TentativeRoughFix(boruta)
#bor[["finalDecision"]]
attStats(boruta)
form=getConfirmedFormula(boruta)


```


### Train the Model

```{r}

RF_model <- ranger(Arable ~ DEM + Slope + Accum_fd8 + TRI + TWI + STI + SPI + BDRICM + BDRLOG + BDTICM + Geomorphons + LandUseGroups, data = Train_df, importance = 'impurity')

print(RF_model)

```



### Model Predictions

```{r}
RF_pred <- predict(RF_model, data=Arable_RF_Predict_df)
RF_pred

```


```{r}



Arable_RF_Predict_df$Predictions <- RF_pred$predictions
  
pred = Arable_RF_Predict_df %>% select(Cells, Predictions)
  
Arable_RF_df = Arable_RF_df %>% left_join(pred, by = "Cells") %>%
  mutate(Predictions = ifelse(is.na(Predictions), Cultiv, Predictions))

rm(pred)

ArableArea = Cultiv
ArableArea[Arable_RF_df$Cells] <- Arable_RF_df$Predictions
names(ArableArea) <- "ArableArea"
writeRaster(ArableArea, filename = paste0(wd$data_p, "ArableArea.tif"), overwrite=TRUE)
rm(ArableArea)
ArableArea <- rast(paste0(wd$data_r,"ArableArea.tif"))

DEM_r <- rast(paste0(wd$data_r,"DEM_r.tif"))
ArableArea_100m <- resample(ArableArea, DEM_r, method = "bilinear")
writeRaster(ArableArea_100m, filename = paste0(wd$data_p, "ArableArea_100m.tif"), overwrite=TRUE)
rm(DEM_r,ArableArea_100m)

write_csv(Arable_RF_Predict_df, paste0(wd$data_p,"ArableArea_RFModel_PredictData.csv.gz"))
write_csv(Arable_RF_df, paste0(wd$data_p,"ArableArea_RFModel_Data.csv.gz"))
```


  predicted_vals <- predict(model, pred)
  pred$pred <- predicted_vals$predictions
  
  x = r_df %>% left_join(pred, by = f)
  
  r2 = r
  raster_values <- values(r2)
  missing_values <- is.na(raster_values)
  df_values <- x$pred[missing_values]
  r2[missing_values] <- df_values
  names(r2) <- rnam
  
### Model Cross-Validation

```{r}
p.ra <- predict(m.lzn.ra, data=meuse)
str(p.ra)

summary(r.rap <- meuse$logZn - p.ra$predictions)

(rmse.ra <- sqrt(sum(r.rap^2)/length(r.rap)))

plot(meuse$logZn ~ p.ra$predictions, asp=1, pch=20, xlab="fitted", ylab="actual", xlim=c(2,3.3),          ylim=c(2,3.3), main="log10(Zn), Meuse topsoils, Ranger")
grid(); abline(0,1)


summary(m.lzn.ra$predictions)

plot(meuse$logZn ~ m.lzn.ra$predictions, asp=1, pch=20,
     ylab="actual", xlab="OOB X-validation estimates",
    xlim=c(2,3.3), ylim=c(2,3.3),
    main="ranger")
abline(0,1); grid()


```


### Delete Objects

```{r}

rm(Arable_RF_Train_df, Arable_RF_df, RF_pred, Arable_RF_Predict_df, RF_model, boruta, Cultiv)


```



# AGType

## Prepare Data

### Shortcut Import

```{r, label='Shortcut', message=FALSE,warning=FALSE}

DEM <- rast(paste0(wd$data_p, "DEM_30m.tif"))

Topo_r_30m <- rast(paste0(wd$data_p, "Topo_r_30m.tif"))

Soil_30m <- rast(paste0(wd$data_p, "Soil_r_30m.tif"))

Geomorphons <- rast(paste0(wd$data_p, "CMex_30m_Geomorphons.tif"))

CONABIO_2015_LandUse_30m <- rast(paste0(wd$data_p, "CONABIO_2015_LandUse_30m.tif"))

CMex_Mask <- rast(paste0(wd$data_p,"CMex_Mask.tif"))

SIAP_LU_Fields_AGType <- rast(paste0(wd$data_p,"SIAP_LU_Fields_AGType.tif"))
SIAP_LU_Fields_AGType <- mask(SIAP_LU_Fields_AGType, CMex_Mask)

```




### Combine Data

```{r}
Cultiv <- SIAP_LU_Fields_AGType
x = c(Cultiv, CONABIO_2015_LandUse_30m, Geomorphons, Topo_r_30m, Soil_30m)
#xf <- mask(x, SIAP_LU_Fields_AGTypeNA)
x = mask(x, SIAP_LU_Fields_AGType)

writeRaster(x, filename = paste0(wd$data_p, "AGType_Raster_Data.tif"), overwrite=TRUE)

rm(Topo_r_30m, Soil_30m, SIAP_LU_Fields_AGType, CMex_Mask, x, Geomorphons, Cultiv, CONABIO_2015_LandUse_30m)

```


### Shortcut Import #2


```{r}

x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))
Cultiv <- x[[1]]
CONABIO_2015_LandUse_30m <- x[[2]]
Geomorphons <- x[[3]]

```



### Prelim Stats


```{r}
Cultiv2 <- as.numeric(Cultiv)
#y = c(CONABIO_2015_LandUse_30m, Geomorphons)
fLU = freq(CONABIO_2015_LandUse_30m, usenames=T, zones=Cultiv2, wide=T)
fLU = fLU %>% mutate(zone = case_when(
    zone == 1 ~ "Temporal",
    zone == 2 ~ "Irrigation")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Flat:Depression))) %>% ungroup()
column_sums <- as.numeric(colSums(fLU[, -c(1:2)]))
y = as.matrix(fLU[, -c(1, 2)])
d = fLU[, c(1:2)]
fLU_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fLU[, -c(1:2)]))
fLU_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fWRB = freq(x[["WRB"]], usenames=T, zones=Cultiv2, wide=T)
fWRB = fWRB %>% mutate(zone = case_when(
    zone == 1 ~ "Temporal",
    zone == 2 ~ "Irrigation")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(NoData:Vertisols))) %>% ungroup()
column_sums <- as.numeric(colSums(fWRB[, -c(1:2)]))
y = as.matrix(fWRB[, -c(1, 2)])
d = fWRB[, c(1:2)]
fWRB_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fWRB[, -c(1:2)]))
fWRB_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

fgeo = freq(Geomorphons, usenames=T, zones=Cultiv2, wide=T)
fgeo = fgeo %>% mutate(zone = case_when(
    zone == 1 ~ "Temporal",
    zone == 2 ~ "Irrigation")) %>% rowwise() %>% 
  mutate(Total = sum(c_across(Forest_Coniferous_Temperate:Water))) %>% ungroup()
column_sums <- as.numeric(colSums(fgeo[, -c(1:2)]))
y = as.matrix(fgeo[, -c(1, 2)])
d = fgeo[, c(1:2)]
fgeo_col_pc = cbind(d, as.data.frame(sweep(y, 2, column_sums, `/`)*100))
row_sums <- as.numeric(rowSums(fgeo[, -c(1:2)]))
fgeo_row_pc = cbind(d, as.data.frame(sweep(y, 1, row_sums, `/`)*200))

rm(column_sums, row_sums, y, d )

z1 = zonal(c(Topo_r_30m, Soil_30m), Cultiv, fun="mean", na.rm=T)
z1$stat = "Mean"
z2 = zonal(c(Topo_r_30m, Soil_30m), Cultiv, fun="min", na.rm=T)
z2$stat = "Min"
z3 = zonal(c(Topo_r_30m, Soil_30m), Cultiv, fun="max", na.rm=T)
z3$stat = "Max"
z = rbind(z1, z2, z3) %>% mutate(zone = case_when(
    layer == 0 ~ "Temporal",
    layer == 1 ~ "Irrigation"))

rm(z1, z2, z3)
```


### Raster Stack to Dataframe 

```{r}

x_df <- as.data.frame(x[[1]])
names(x_df) <- "Cultiv"
x_df <- rownames_to_column(x_df, var = "Cells")

for (i in 2:nlyr(x)) {
  
  t = as.data.frame(x[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(x[[i]]))
  x_df <- x_df %>% left_join(t, by="Cells")
  #Train_df <- cbind(Train_df, t[,1])
  #names(Train_df) <- c(names(Train_df)[1:(i-1)], names(Train[[i]]))
}
x_df = x_df[complete.cases(x_df), ]

write_csv(x_df, paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))
rm(x_df)
AGType_RF_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))

AGType_RF_df <- AGType_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

AGType_RF_df = AGType_RF_df[complete.cases(AGType_RF_df), ]
```


### Histograms

```{r}

#Hist_DEM <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = DEM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Elevation (masl)", y = "Count") + theme_classic()

#Hist_Slope <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Slope, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Slope (degrees)", y = "Count") + theme_classic()

#Hist_TRI <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = TRI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Topographic Roughness Index (TRI)", y = "Count") + theme_classic()

#Hist_TWI <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = TWI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Topographic Wetness Index (TWI)", y = "Count") + theme_classic()

#Hist_STI <- 
AGType_RF_df %>% filter(STI <= 100) %>% ggplot() +
geom_histogram(aes(x = STI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Sediment Transport Index (STI)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

#Hist_SPI <- 
AGType_RF_df %>% filter(SPI <= 1200) %>% ggplot() +
geom_histogram(aes(x = SPI, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Stream Power Index (SPI)", y = "Count") + theme_classic()

#Hist_BDRICM <- 
AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRICM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Depth to bedrock up to 200cm (BDRICM)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = BDRLOG, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Probability of R horizon (BDRLOG)", y = "Count") + theme_classic() +
  scale_x_continuous( breaks=seq(0,100,5))

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = BDTICM, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Absolute depth to bedrock in cm (BDTICM)", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_min, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Minimum Curvature", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_max, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Maximum Curvature", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = curv_mean, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Mean Curvature", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = SOC, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Soil Organic Carbon", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = OCD, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Organic Carbon Density", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = N, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Nitrogen", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = SOCS, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Soil Organic Carbon Stock", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = S, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Sand", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = Z, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Silt", y = "Count") + theme_classic()

AGType_RF_df %>% ggplot() +
geom_histogram(aes(x = C, color = Cultiv, fill = Cultiv), alpha = 0.4, position = "identity") +
  scale_fill_manual(values = c("indianred1", "cyan1"), guide = "none")+
  scale_color_manual(values = c("firebrick1", "cyan2"), guide = "none")+
  labs(x ="Clay", y = "Count") + theme_classic()



```

### Shortcut Import #3


```{r}
x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))
Cultiv <- x[[1]]
AGType_RF_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))

AGType_RF_df <- AGType_RF_df %>% 
  mutate(Cultiv = factor(Cultiv, levels = c("Uncultivated", "Cultivated")),
         LandUseArchy = factor(LandUseArchy, levels = c("Unknown", "Wetland", "Settlement", "Water", "Glacial")),
         Geomorphons = factor(Geomorphons, levels = c("Flat", "Summit", "Ridge", "Shoulder", "Spur", "Slope", "Hollow", "Footslope", "Valley", "Depression")),
         WRB = factor(WRB, levels = c("NoData", "Andosols", "Arenosols", "Calcisols", "Cambisols", "Durisols", "Fluvisols", "Gleysols", "Leptosols", "Luvisols", "Phaeozems", "Regosols", "Solonchaks", "Solonetz", "Umbrisols", "Vertisols")))

AGType_RF_df = AGType_RF_df[complete.cases(AGType_RF_df), ]

```

### Subset Predictors

```{r}
#TopoEnv_r_sub <- subset(x, c("DEM", "Slope","Accum", "TRI", "TWI", "STI", "SPI"))

```



### Sampling the Dataframe

```{r}

AGType_RF_df <- AGType_RF_df %>% 
  mutate(#Problem = FALSE,
         #Cultiv_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, FALSE),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Water", TRUE, Problem),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Wetland", TRUE, Problem),
         #Problem = ifelse(Cultiv == "Cultivated" & LandUse == "Settlement", TRUE, Problem),
         #Problem_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, Problem),
         
         
         #Cultiv_3100masl = ifelse(Cultiv == "Cultivated" & DEM >= 3100, TRUE, FALSE),
         Cultiv = ifelse(Cultiv == "Cultivated" & LandUse == "Water", "Uncultivated", Cultiv),
         Cultiv = ifelse(Cultiv == "Cultivated" & LandUse == "Wetland", "Uncultivated", Cultiv),
         Cultiv = ifelse(Cultiv == "Cultivated" & LandUse == "Settlement", "Uncultivated", Cultiv),
         #Cultiv = ifelse(Cultiv == "Cultivated" & DEM >= 3100, "Uncultivated", Cultiv),

         Inarable1_wt = 0,
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & DEM >= 3100, (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Water", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Wetland", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Settlement", (Inarable1_wt+1), Inarable1_wt),
         Inarable1_wt = ifelse(Cultiv == "Uncultivated" & LandUse == "Glacial", (Inarable1_wt+1), Inarable1_wt),
         Inarable1 = ifelse(Inarable1_wt > 0, TRUE, FALSE),
         
         #InAGType_3100masl = ifelse(Cultiv == "Uncultivated" & DEM >= 3100, TRUE, FALSE),
         #InAGType_water = ifelse(Cultiv == "Uncultivated" & LandUse == "Water", TRUE, FALSE),
         #InAGType_wetland = ifelse(Cultiv == "Uncultivated" & LandUse == "Wetland", TRUE, FALSE),
         #InAGType_settlement = ifelse(Cultiv == "Uncultivated" & LandUse == "Settlement", TRUE, FALSE),
         #InAGType_glacial = ifelse(Cultiv == "Uncultivated" & LandUse == "Glacial", TRUE, FALSE),
         
         Inarable2_wt = 0,
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & DEM >= 2850 & DEM < 3100, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Slope > 15, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Accum_fd8 > xxx, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & STI > 15, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & TRI > 15, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SPI > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & TWI > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & flood_order > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & valleys_lq > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & elev_watershed > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_vert_excess > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_horiz_excess > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_min > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_max > XXX, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & curv_mean > XXX, (Inarable2_wt+1), Inarable2_wt),
         
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDRLOG > 70, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDRICM < 40.79, (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BDTICM <= 3.36, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SOC > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & BD > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & OCD > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & N > XXX, (Inarable2_wt+1), Inarable2_wt),
         #Inarable2_wt = ifelse(Cultiv == "Uncultivated" & SOCS > XXX, (Inarable2_wt+1), Inarable2_wt),
         
         
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Summit", (Inarable2_wt+1), Inarable2_wt),
         Inarable2_wt = ifelse(Cultiv == "Uncultivated" & Geomorphons == "Depression", (Inarable2_wt+1), Inarable2_wt),
         Inarable2 = ifelse(Inarable2_wt > 0, TRUE, FALSE),
         
         Arable = ifelse(Cultiv == "Cultivated" & Problem == FALSE, TRUE, FALSE),
         AGType_wt = ifelse(Cultiv == "Cultivated" & Problem == FALSE, 1, 0),
         
         wt = Inarable2_wt + Inarable2_wt + AGType_wt,
         
         Stratum = ifelse(Arable == TRUE, "ArableSample", Stratum),
         Stratum = case_when(
                Arable == TRUE ~ "ArableSample",
                Inarable1 == TRUE ~ "InarableSample1",
                Inarable2 == TRUE ~ "InarableSample2",
                .default = "Unsampled"),
         SampSize = case_when(
                Stratum == "ArableSample" ~ 225000,
                Stratum == "InarableSample1" ~ 50000,
                Stratum == "InarableSample2" ~ "125000",
                .default = 0))


AGType_RF_Train_df = AGType_RF_df %>% group_by(Stratum) %>%
  slice_sample(n = SampSize[1], weight_by = wt, replace = FALSE) #prop, by = NULL, 

write_csv(AGType_RF_Train_df, paste0(wd$data_p,"AGType_RFModel_TrainData.csv.gz"))
rm(AGType_RF_Train_df)
AGType_RF_Train_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_TrainData.csv.gz"))

tt = AGType_RF_Train_df %>% select(Cells) %>% mutate(TraningSample = TRUE)

AGType_RF_df = AGType_RF_df %>% left_join(tt, by = "Cells") %>%
  mutate(TraningSample = ifelse(TraningSample == TRUE, TRUE, FALSE),
         PredictionData = ifelse(TraningSample == TRUE, FALSE, TRUE))

rm(tt)

write_csv(AGType_RF_df, paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))
rm(AGType_RF_df)
AGType_RF_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))

AGType_RF_Predict_df = AGType_RF_df %>% filter(PredictionData = T)
  
write_csv(AGType_RF_Predict_df, paste0(wd$data_p,"AGType_RFModel_PredictData.csv.gz"))
rm(AGType_RF_Predict_df)
AGType_RF_Predict_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_PredictData.csv.gz"))

rm(z, fgeo, fgeo_col_pc, fgeo_row_pc, fLU_row_pc, fLU_col_pc, fLU, CONABIO_2015_LandUse_30m, Geomorphons)

```



### Shortcut Import #4


```{r}

x <- rast(paste0(wd$data_p,"AGType_Raster_Data.tif"))
Cultiv <- x[[1]]
AGType_RF_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))
Arable_RF_Predict_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_PredictData.csv.gz"))
Arable_RF_Train_df <- read_csv(paste0(wd$data_p,"AGType_RFModel_TrainData.csv.gz"))


#SIAP_LU_Fields <- mask(SIAP_LU_Fields, CMex_Mask)
```

## Random Forest Model

### Variable Selection

```{r}


boruta <- Boruta(Cultiv ~ ., data = AGType_RF_Train_df, maxRuns = 1000)#, doTrace = 2
print(boruta)
boruta[["finalDecision"]]
plot(boruta, las = 2, cex.axis = 0.7)
#bor <- TentativeRoughFix(boruta)
#bor[["finalDecision"]]
attStats(boruta)
form=getConfirmedFormula(boruta)


```


### Train the Model

```{r}

RF_model <- ranger(Arable ~ DEM + Slope + Accum_fd8 + TRI + TWI + STI + SPI + BDRICM + BDRLOG + BDTICM + Geomorphons + LandUseGroups, data = Train_df, importance = 'impurity')

print(RF_model)

```



### Model Predictions

```{r}
RF_pred <- predict(RF_model, data=AGType_RF_Predict_df)
RF_pred

```


```{r}



AGType_RF_Predict_df$Predictions <- RF_pred$predictions
  
pred = AGType_RF_Predict_df %>% select(Cells, Predictions)
  
AGType_RF_df = AGType_RF_df %>% left_join(pred, by = "Cells") %>%
  mutate(Predictions = ifelse(is.na(Predictions), Cultiv, Predictions))

rm(pred)

AGTypeArea = Cultiv
AGTypeArea[AGType_RF_df$Cells] <- AGType_RF_df$Predictions
names(AGTypeArea) <- "ArableArea"
writeRaster(AGTypeArea, filename = paste0(wd$data_p, "AGTypeArea.tif"), overwrite=TRUE)
rm(AGTypeArea)
AGTypeArea <- rast(paste0(wd$data_r,"AGTypeArea.tif"))

DEM_r <- rast(paste0(wd$data_r,"DEM_r.tif"))
AGTypeArea_100m <- resample(ArableArea, DEM_r, method = "bilinear")
writeRaster(AGTypeArea_100m, filename = paste0(wd$data_p, "AGTypeArea_100m.tif"), overwrite=TRUE)
rm(DEM_r,AGTypeArea_100m)

write_csv(AGType_RF_Predict_df, paste0(wd$data_p,"AGType_RFModel_PredictData.csv.gz"))
write_csv(AGType_RF_df, paste0(wd$data_p,"AGType_RFModel_Data.csv.gz"))
```

  predicted_vals <- predict(model, pred)
  pred$pred <- predicted_vals$predictions
  
  x = r_df %>% left_join(pred, by = f)
  
  r2 = r
  raster_values <- values(r2)
  missing_values <- is.na(raster_values)
  df_values <- x$pred[missing_values]
  r2[missing_values] <- df_values
  names(r2) <- rnam
  
### Model Cross-Validation

```{r}
p.ra <- predict(m.lzn.ra, data=meuse)
str(p.ra)

summary(r.rap <- meuse$logZn - p.ra$predictions)

(rmse.ra <- sqrt(sum(r.rap^2)/length(r.rap)))

plot(meuse$logZn ~ p.ra$predictions, asp=1, pch=20, xlab="fitted", ylab="actual", xlim=c(2,3.3),          ylim=c(2,3.3), main="log10(Zn), Meuse topsoils, Ranger")
grid(); abline(0,1)


summary(m.lzn.ra$predictions)

plot(meuse$logZn ~ m.lzn.ra$predictions, asp=1, pch=20,
     ylab="actual", xlab="OOB X-validation estimates",
    xlim=c(2,3.3), ylim=c(2,3.3),
    main="ranger")
abline(0,1); grid()


```


### Delete Objects

```{r}

rm(AGType_RF_Train_df, AGType_RF_df, RF_pred, AGType_RF_Predict_df, RF_model, boruta, Cultiv)


```



# OLD



#### Import and Rasterize Data

```{r, label='Shortcut', message=FALSE,warning=FALSE}
SIAP_2015_Fields <- vect(paste0(wd$data_r,"SIAP_2015_Fields.gpkg"))
SIAP_2015_Fields <- rasterize(SIAP_2015_Fields, DEM, values = 1, background = 0)
writeRaster(SIAP_2015_Fields, filename = paste0(wd$data_p, "SIAP_2015_Fields.tif"), overwrite=TRUE)

SIAP_2015_Mask <- vect(paste0(wd$data_r,"SIAP_2015_Mask.gpkg"))
SIAP_2015_Mask <- terra::rasterize(SIAP_2015_Mask, DEM, values = 1, background = NA)
writeRaster(SIAP_2015_Mask, filename = paste0(wd$data_p, "SIAP_2015_Mask.tif"), overwrite=TRUE)

SIAP_2015_Fields <- mask(SIAP_2015_Fields, SIAP_2015_Mask)

#rc <- c(-0.5, 0.5, 1,  0.5, 1.5, NA)
#rc <- matrix(c(-0.5, 0.5, 1,  0.5, 1.5, NA), ncol=3, byrow=TRUE)
Inarable_Sampling_Area <- classify(SIAP_2015_Fields, matrix(c(-0.5, 0.5, 1,  0.5, 1.5, NA), ncol=3, byrow=TRUE))
writeRaster(Inarable_Sampling_Area, filename = paste0(wd$data_p, "Inarable_Sampling_Area.tif"), overwrite=TRUE)

rm(SIAP_2015_Fields)

```


#### Absence (Inarable) Sample of Background Points



##### Inarable Sample #1: Totally Inarable

```{r, label='Inarable Sample #1: Totally Inarable', message=FALSE,warning=FALSE}

InarableSample1 = Inarable_Sampling_Area

#Elevation >= 3100 masl
q = DEM * InarableSample1
q = ifel(q >= 3100, 1, 0)
InarableSample1 <- q + InarableSample1

#CONABIO_2015_LandUse_15m == 18 and 19
q = ifel(CONABIO_2015_LandUse_30m == 18 | CONABIO_2015_LandUse_30m == 19, 1, 0)
InarableSample1 <- q + InarableSample1

InarableSample1 <- ifel(InarableSample1 > 1, 1, NA)
Inarable_Sampling_Area1 <- InarableSample1
writeRaster(Inarable_Sampling_Area1, filename = paste0(wd$data_p, "Inarable_Sampling_Area1.tif"), overwrite=TRUE)

#table(values(Sampling_Area1))
s = spatSample(InarableSample1, size = 50000, method="random", replace=FALSE, na.rm=T, exhaustive=T, cells=T) #40000 = 0.0639091

v <- unique(s$cell)
InarableSample1 = ifel(InarableSample1 > 0, 0, NA)
InarableSample1[v] <- 2
InarableSample1 = ifel(InarableSample1 > 1, 2, 0)

writeRaster(InarableSample1, filename = paste0(wd$data_p, "InarableSample1.tif"), overwrite=TRUE)

InarableSample1 <- rast(paste0(wd$data_p, "InarableSample1.tif"))

rm(s, v, q)

```


##### Inarable Sample #2: High Likelihood Inarable

```{r, label='Inarable Sample #2: High Likelihood Inarable', message=FALSE,warning=FALSE}

### Sampling Area2
InarableSample2 <- mosaic(Inarable_Sampling_Area1, Inarable_Sampling_Area, fun=sum)
InarableSample2 = ifel(InarableSample2 > 1, NA, 0)

#Sampled areas from CONABIO_2015_LandUse_15m c(1:14, 16)
q = ifel(CONABIO_2015_LandUse_30m < 15 | CONABIO_2015_LandUse_30m == 16, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled geomorphons == 9,10 with higher accum
q = ifel(Geomorphons == 9 | Geomorphons == 10 | Geomorphons == 2, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled BDRICM < 100
q = ifel(Soil_30m[["BDRICM"]] < 100, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled BDRLOG > 40
q = ifel(Soil_30m[["BDRLOG"]] > 40, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled Elevation > 2850
q = ifel(DEM >= 2850, 1, 0)
InarableSample2 <- q + InarableSample2

#Sampled Slopes > 15
q = ifel(Topo_r_30m[["Slope"]] > 15, 1, 0)
InarableSample2 <- q + InarableSample2

#STI >15*********
q = ifel(Topo_r_30m[["STI"]] > 15, 1, 0)
InarableSample2 <- q + InarableSample2

#TRI >15
q = ifel(Topo_r_30m[["TRI"]] > 15, 1, 0)
InarableSample2 <- q + InarableSample2
#Accum>4500
#TWI > 15
#SPI >300-500

t = freq(InarableSample2)
t = t[-c(1),]
t$prob = c(0.004, 0.008, 0.015, 0.03, 0.06, 0.25, 1.0)
t$sample = round((t$prob * t$count),0)
sum(t$sample)

# Create a list to store the individual rasters
r_list <- list()

# Loop through each unique value
for (i in t$value) {
  # Create a binary mask for the current value
  masked_raster <- ifel(InarableSample2 == t$value[i], 1, NA)
  
  s2 = spatSample(x = masked_raster, size = t$n[i], method="random", replace=FALSE, na.rm=T, exhaustive=T, cells=T) #

  # Store the masked raster in the list
  r_list[[as.character(unique_values[i])]] <- s2
}

s2 = do.call(rbind, r_list)

v <- unique(s2$cell)
InarableSample2 <- ifel(Inarable_Sampling_Area > 0, 0, NA)
InarableSample2[v] <- 2
InarableSample2 = ifel(InarableSample2 > 1, 2, 0)

writeRaster(InarableSample2, filename = paste0(wd$data_r, "InarableSample2.tif"), overwrite=TRUE)

rm(s, v, q, s2, t)

```
##### Combining the Inarable Samples

```{r}

InarableSample <- mosaic(inarable1, inarable2, fun=sum)
writeRaster(InarableSample, filename = paste0(wd$data_r, "InarableSample.tif"), overwrite=TRUE)
```


##### Arable Sample

```{r}
Arable <- rasterize(SIAP_2015_Fields, DEM, values = 0, background = NA) #values = 0
table(values(Arable))
sa = spatSample(Arable, size = 233000, method="random", replace=FALSE, na.rm=T, exhaustive=T, cells=T) #225000 == 0.06222285

v <- unique(sa$cell)
ArableSamp = Arable
ArableSamp[v] <- 2
ArableSamp = ifel(ArableSamp > 1, 2, 0)
ArableSample <- mosaic(Arable, ArableSamp, fun=sum)

writeRaster(ArableSample, filename = paste0(wd$data_r, "ArableSample.tif"), overwrite=TRUE)


```



### Training Dataset


```{r}
rm(q, s, s2, sa, Sampling_Area2, Sampling_Area1, r_list, v, mask, masked_raster, cls, rc, t, wts, Soil, inarable1, inarable2, ArableSamp, Arable)

Covariates = c(Topo_r_30m, Soil_30m, Geomorphons, CONABIO_2015_LandUse_30m)

rm(Topo_r_30m, Soil_30m, Geomorphons, CONABIO_2015_LandUse_30m)

Prediction2 <- ifel(InarableSample == 0, 1, NA)
Predict_Supp_ArableUnsampled <- ifel(ArableSample == 0, 1, NA)#ArableSample == 0
InarableSample = ifel(InarableSample > 0, 1, 0)
InarableSample = ifel(is.na(InarableSample), 0, InarableSample)
ArableSample = ifel(is.na(ArableSample), 0, ArableSample)
Response <- mosaic(ArableSample, InarableSample, fun=sum)
Response <- mask(Response, SIAP_2015_Mask)
Prediction <- ifel(Response == 0, 1, NA)
Response <- ifel(Response == 0, NA, Response)

Response <- as.factor(Response)
cls = as.data.frame(levels(Response)[[1]])
cls = cls %>% select(-layer) %>%
  mutate(Response = case_when(
    ID == 1 ~ "Inarable",
    ID == 2 ~ "Arable"))
levels(Response) <- cls

Train = c(Response, Covariates)
Train <- mask(Train, Response)



Predict = c(Prediction, Covariates)
Predict <- mask(Predict, Prediction)

#plot(Train[[2]])
#plot(Predict[[2]])

rm(SIAP_2015_Fields, ArableSample, InarableSample, cls, DEM)



activeCat(Train[[14]]) <- "LandUseGroups"

Train_df <- as.data.frame(Train[[1]])
names(Train_df) <- "Arable"
Train_df <- rownames_to_column(Train_df, var = "Cells")

for (i in 2:nlyr(Train)) {
  
  t = as.data.frame(Train[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(Train[[i]]))
  Train_df <- Train_df %>% left_join(t, by="Cells")
  #Train_df <- cbind(Train_df, t[,1])
  #names(Train_df) <- c(names(Train_df)[1:(i-1)], names(Train[[i]]))
}
Train_df = Train_df[complete.cases(Train_df), ]

```


### Prediction Dataset

```{r}

activeCat(Predict[[14]]) <- "LandUseGroups"

Predict_df <- as.data.frame(Predict[[2]])
names(Predict_df) <- "DEM"
Predict_df <- rownames_to_column(Predict_df, var = "Cells")

for (i in 3:nlyr(Predict)) {
  
  t = as.data.frame(Predict[[i]])
  t <- rownames_to_column(t, var = "Cells")
  names(t) <- c("Cells", names(Predict[[i]]))
  Predict_df <- Predict_df %>% left_join(t, by="Cells")

}
Predict_df = Predict_df[complete.cases(Predict_df), ]

```

















# Extras

```{r}

#rc <- c(-101, -98, 1,  0.25, 1.5, NA)
#rc <- matrix(rc, ncol=3, byrow=TRUE)
#Sampling_Area <- classify(SIAP_2015_Fields, rc)
                         
f <- names(train)
  f <- f[f != names(r)]
  form <- paste(names(r), "~", paste(f, collapse = " + "))
  form <- as.formula(form)
  

```


mtry = NULL,

probability = T #Grow a probability forest as in Malley et al. (2012).


regularization.factor = 1,Regularization factor (gain penalization), either a vector of length p or one value
for all variables.

regularization.usedepth = FALSE,Consider the depth in regularization

quantreg = FALSE,Prepare quantile prediction as in quantile regression forests (Meinshausen 2006).
Regression only. Set keep.inbag = TRUE to prepare out-of-bag quantile prediction.

importance = "none",Variable importance mode, one of ’none’, ’impurity’, ’impurity_corrected’, ’permutation’. The ’impurity’ measure is the Gini index for classification, the variance of the responses for regression and the sum of test statistics (see splitrule)
for survival.
keep.inbag = FALSE,
inbag = NULL,Save how often observations are in-bag in each tree.

save.memory = FALSE  Use memory saving (but slower) splitting mode. No effect for survival and
GWAS data. Warning: This option slows down the tree growing, use only if you
encounter memory problems.

classification = NULL, Set to TRUE to grow a classification forest. Only needed if the data is a matrix or
the response numeric.

midpoints of all arable polygons;
negative buffer so observations arent on edges



OOB (Out-of-Bag) prediction error, also known as OOB error, is a measure of prediction accuracy for models trained using bootstrap aggregating (bagging) techniques, such as random forests. It is commonly used to estimate the performance of a model without the need for an explicit validation set.

When training a bagging model, each base model (also known as a weak learner) is trained on a random subset of the original data, called a bootstrap sample. The remaining data points, on average around 36.8% of the original data, are not included in the bootstrap sample and are referred to as out-of-bag (OOB) observations.

The OOB prediction error is calculated by evaluating the performance of each base model on the OOB observations. For each data point that was not included in the bootstrap sample for a particular base model, the model's prediction is compared to the true target value. The OOB error is then computed as the average prediction error across all out-of-bag observations.

The OOB error serves as an estimate of the model's performance on unseen data. It can be useful for assessing the generalization capability of the model and comparing different models or tuning parameters within the same algorithm. However, it's important to note that the OOB error might not be as reliable as a dedicated validation set for model evaluation in some cases.

In summary, the OOB prediction error provides an estimate of the model's performance using the observations that were not included in the training process due to the bootstrap sampling. It is a useful tool for evaluating bagging-based models such as random forests.

